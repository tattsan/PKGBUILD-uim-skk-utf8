diff --git a/scm/Makefile.am b/scm/Makefile.am
index 9fba04c60..f5119a078 100644
--- a/scm/Makefile.am
+++ b/scm/Makefile.am
@@ -23,6 +23,8 @@ SCM_FILES = plugin.scm im.scm im-custom.scm lazy-load.scm init.scm \
  xmload.scm \
  japanese.scm japanese-azik.scm japanese-kana.scm \
  japanese-act.scm japanese-kzik.scm japanese-custom.scm \
+ japanese-utf8.scm japanese-azik-utf8.scm japanese-kana-utf8.scm \
+ japanese-act-utf8.scm japanese-kzik-utf8.scm japanese-custom-utf8.scm \
  anthy.scm anthy-custom.scm anthy-key-custom.scm \
  anthy-utf8.scm anthy-utf8-custom.scm \
  canna.scm cannav3-socket.scm canna-custom.scm canna-key-custom.scm \
@@ -30,6 +32,7 @@ SCM_FILES = plugin.scm im.scm im-custom.scm lazy-load.scm init.scm \
  sj3.scm sj3-custom.scm sj3-key-custom.scm sj3v2-socket.scm \
  prime.scm prime-custom.scm prime-key-custom.scm \
  skk.scm skk-editor.scm skk-custom.scm skk-key-custom.scm skk-dialog.scm \
+ skk-eucjp.scm skk-custom-eucjp.scm \
  mana.scm mana-custom.scm mana-key-custom.scm \
  tcode.scm trycode.scm \
  tutcode.scm tutcode-custom.scm tutcode-key-custom.scm tutcode-bushu.scm \
diff --git a/scm/japanese-act-utf8.scm b/scm/japanese-act-utf8.scm
new file mode 100644
index 000000000..0eec13b08
--- /dev/null
+++ b/scm/japanese-act-utf8.scm
@@ -0,0 +1,705 @@
+;;;
+;;; Copyright (c) 2010-2013 uim Project https://github.com/uim/uim
+;;;
+;;; All rights reserved.
+;;;
+;;; Redistribution and use in source and binary forms, with or without
+;;; modification, are permitted provided that the following conditions
+;;; are met:
+;;; 1. Redistributions of source code must retain the above copyright
+;;;    notice, this list of conditions and the following disclaimer.
+;;; 2. Redistributions in binary form must reproduce the above copyright
+;;;    notice, this list of conditions and the following disclaimer in the
+;;;    documentation and/or other materials provided with the distribution.
+;;; 3. Neither the name of authors nor the names of its contributors
+;;;    may be used to endorse or promote products derived from this software
+;;;    without specific prior written permission.
+;;;
+;;; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND
+;;; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+;;; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+;;; ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE
+;;; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+;;; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+;;; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+;;; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+;;; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+;;; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+;;; SUCH DAMAGE.
+;;;;
+
+;; UTF-8
+(define ja-act-rule-basic
+  '( 
+
+((("a"). ())("あ" "ア" "ｱ"))
+((("b" "a"). ())("ば" "バ" "ﾊﾞ"))
+((("b" "e"). ())("べ" "ベ" "ﾍﾞ"))
+((("b" "i"). ())("び" "ビ" "ﾋﾞ"))
+((("b" "o"). ())("ぼ" "ボ" "ﾎﾞ"))
+((("b" "u"). ())("ぶ" "ブ" "ﾌﾞ"))
+((("d" "a"). ())("だ" "ダ" "ﾀﾞ"))
+((("d" "e"). ())("で" "デ" "ﾃﾞ"))
+((("d" "i"). ())("ぢ" "ヂ" "ﾁﾞ"))
+((("d" "o"). ())("ど" "ド" "ﾄﾞ"))
+((("d" "u"). ())("づ" "ヅ" "ﾂﾞ"))
+((("e"). ())("え" "エ" "ｴ"))
+((("f" "a"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ")))
+((("f" "e"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ")))
+((("f" "i"). ())(("ふ" "フ" "ﾌ") ("ぃ" "ィ" "ｨ")))
+((("f" "o"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ")))
+((("f" "u"). ())("ふ" "フ" "ﾌ"))
+((("g" "a"). ())("が" "ガ" "ｶﾞ"))
+((("g" "e"). ())("げ" "ゲ" "ｹﾞ"))
+((("g" "i"). ())("ぎ" "ギ" "ｷﾞ"))
+((("g" "o"). ())("ご" "ゴ" "ｺﾞ"))
+((("g" "u"). ())("ぐ" "グ" "ｸﾞ"))
+((("h" "a"). ())("は" "ハ" "ﾊ"))
+((("h" "e"). ())("へ" "ヘ" "ﾍ"))
+((("h" "i"). ())("ひ" "ヒ" "ﾋ"))
+((("h" "o"). ())("ほ" "ホ" "ﾎ"))
+((("h" "u"). ())("ふ" "フ" "ﾌ"))
+((("i"). ())("い" "イ" "ｲ"))
+((("m" "a"). ())("ま" "マ" "ﾏ"))
+((("m" "e"). ())("め" "メ" "ﾒ"))
+((("m" "i"). ())("み" "ミ" "ﾐ"))
+((("m" "o"). ())("も" "モ" "ﾓ"))
+((("m" "u"). ())("む" "ム" "ﾑ"))
+((("n"). ())("ん" "ン" "ﾝ"))
+((("n" "a"). ())("な" "ナ" "ﾅ"))
+((("n" "e"). ())("ね" "ネ" "ﾈ"))
+((("n" "i"). ())("に" "ニ" "ﾆ"))
+((("n" "n"). ())("ん" "ン" "ﾝ"))
+((("n" "o"). ())("の" "ノ" "ﾉ"))
+((("n" "u"). ())("ぬ" "ヌ" "ﾇ"))
+((("o"). ())("お" "オ" "ｵ"))
+((("p" "a"). ())("ぱ" "パ" "ﾊﾟ"))
+((("p" "e"). ())("ぺ" "ペ" "ﾍﾟ"))
+((("p" "i"). ())("ぴ" "ピ" "ﾋﾟ"))
+((("p" "o"). ())("ぽ" "ポ" "ﾎﾟ"))
+((("p" "u"). ())("ぷ" "プ" "ﾌﾟ"))
+((("r" "a"). ())("ら" "ラ" "ﾗ"))
+((("r" "e"). ())("れ" "レ" "ﾚ"))
+((("r" "i"). ())("り" "リ" "ﾘ"))
+((("r" "o"). ())("ろ" "ロ" "ﾛ"))
+((("r" "u"). ())("る" "ル" "ﾙ"))
+((("s" "a"). ())("さ" "サ" "ｻ"))
+((("s" "e"). ())("せ" "セ" "ｾ"))
+((("s" "h" "a"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ")))
+((("s" "h" "e"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ")))
+((("s" "h" "i"). ())("し" "シ" "ｼ"))
+((("s" "h" "o"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ")))
+((("s" "h" "u"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ")))
+((("s" "i"). ())("し" "シ" "ｼ"))
+((("s" "o"). ())("そ" "ソ" "ｿ"))
+((("s" "u"). ())("す" "ス" "ｽ"))
+((("t" "a"). ())("た" "タ" "ﾀ"))
+((("t" "e"). ())("て" "テ" "ﾃ"))
+((("t" "i"). ())("ち" "チ" "ﾁ"))
+((("t" "o"). ())("と" "ト" "ﾄ"))
+((("t" "u"). ())("つ" "ツ" "ﾂ"))
+((("u"). ())("う" "ウ" "ｳ"))
+((("v" "a"). ())(("う゛" "ヴ" "ｳﾞ") ("ぁ" "ァ" "ｧ")))
+((("v" "e"). ())(("う゛" "ヴ" "ｳﾞ") ("ぇ" "ェ" "ｪ")))
+((("v" "i"). ())(("う゛" "ヴ" "ｳﾞ") ("ぃ" "ィ" "ｨ")))
+((("v" "o"). ())(("う゛" "ヴ" "ｳﾞ") ("ぉ" "ォ" "ｫ")))
+((("v" "u"). ())("う゛" "ヴ" "ｳﾞ"))
+((("w" "a"). ())("わ" "ワ" "ﾜ"))
+((("w" "e"). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ")))
+((("w" "i"). ())(("う" "ウ" "ｳ") ("ぃ" "ィ" "ｨ")))
+((("w" "o"). ())("を" "ヲ" "ｦ"))
+((("w" "u"). ())("う" "ウ" "ｳ"))
+((("y" "a"). ())("や" "ヤ" "ﾔ"))
+((("y" "e"). ())(("い" "イ" "ｲ") ("ぇ" "ェ" "ｪ")))
+((("y" "o"). ())("よ" "ヨ" "ﾖ"))
+((("y" "u"). ())("ゆ" "ユ" "ﾕ"))
+((("z" "a"). ())("ざ" "ザ" "ｻﾞ"))
+((("z" "e"). ())("ぜ" "ゼ" "ｾﾞ"))
+((("z" "i"). ())("じ" "ジ" "ｼﾞ"))
+((("z" "o"). ())("ぞ" "ゾ" "ｿﾞ"))
+((("z" "u"). ())("ず" "ズ" "ｽﾞ"))
+((("'"). ())("っ" "ッ" "ｯ"))
+((("`" "a"). ())("ぁ" "ァ" "ｧ"))
+((("`" "i"). ())("ぃ" "ィ" "ｨ"))
+((("`" "u"). ())("ぅ" "ゥ" "ｩ"))
+((("`" "e"). ())("ぇ" "ェ" "ｪ"))
+((("`" "o"). ())("ぉ" "ォ" "ｫ"))
+((("`" "c" "a"). ())("か" "ヵ" "ｶ"))
+((("`" "c" "e"). ())("け" "ヶ" "ｹ"))
+((("`" "w" "a"). ())("ゎ" "ヮ" "ﾜ"))
+((("`" "w" "e"). ())("ゑ" "ヱ" "ｴ"))
+((("`" "w" "i"). ())("ゐ" "ヰ" "ｲ"))
+((("`" "y" "a"). ())("ゃ" "ャ" "ｬ"))
+((("`" "y" "o"). ())("ょ" "ョ" "ｮ"))
+((("`" "y" "u"). ())("ゅ" "ュ" "ｭ"))
+((("`" "y" "s"). ())("ゃ" "ャ" "ｬ"))
+((("`" "y" "n"). ())("ょ" "ョ" "ｮ"))
+((("`" "y" "h"). ())("ゅ" "ュ" "ｭ"))
+((("c" "a"). ())("か" "カ" "ｶ"))
+((("c" "i"). ())("き" "キ" "ｷ"))
+((("c" "u"). ())("く" "ク" "ｸ"))
+((("c" "e"). ())("け" "ケ" "ｹ"))
+((("c" "o"). ())("こ" "コ" "ｺ"))
+(((";"). ())(("あ" "ア" "ｱ") ("ん" "ン" "ﾝ")))
+((("x"). ())(("い" "イ" "ｲ") ("ん" "ン" "ﾝ")))
+((("k"). ())(("う" "ウ" "ｳ") ("ん" "ン" "ﾝ")))
+((("j"). ())(("え" "エ" "ｴ") ("ん" "ン" "ﾝ")))
+((("q"). ())(("お" "オ" "ｵ") ("ん" "ン" "ﾝ")))
+((("c" ";"). ())(("か" "カ" "ｶ") ("ん" "ン" "ﾝ")))
+((("c" "x"). ())(("き" "キ" "ｷ") ("ん" "ン" "ﾝ")))
+((("c" "k"). ())(("く" "ク" "ｸ") ("ん" "ン" "ﾝ")))
+((("c" "j"). ())(("け" "ケ" "ｹ") ("ん" "ン" "ﾝ")))
+((("c" "q"). ())(("こ" "コ" "ｺ") ("ん" "ン" "ﾝ")))
+((("c" "'"). ())(("か" "カ" "ｶ") ("い" "イ" "ｲ")))
+((("c" "p"). ())(("く" "ク" "ｸ") ("う" "ウ" "ｳ")))
+((("c" "."). ())(("け" "ケ" "ｹ") ("い" "イ" "ｲ")))
+((("c" ","). ())(("こ" "コ" "ｺ") ("う" "ウ" "ｳ")))
+((("s" ";"). ())(("さ" "サ" "ｻ") ("ん" "ン" "ﾝ")))
+((("s" "x"). ())(("し" "シ" "ｼ") ("ん" "ン" "ﾝ")))
+((("s" "k"). ())(("す" "ス" "ｽ") ("ん" "ン" "ﾝ")))
+((("s" "j"). ())(("せ" "セ" "ｾ") ("ん" "ン" "ﾝ")))
+((("s" "q"). ())(("そ" "ソ" "ｿ") ("ん" "ン" "ﾝ")))
+((("s" "'"). ())(("さ" "サ" "ｻ") ("い" "イ" "ｲ")))
+((("s" "p"). ())(("す" "ス" "ｽ") ("う" "ウ" "ｳ")))
+((("s" "."). ())(("せ" "セ" "ｾ") ("い" "イ" "ｲ")))
+((("s" ","). ())(("そ" "ソ" "ｿ") ("う" "ウ" "ｳ")))
+((("t" ";"). ())(("た" "タ" "ﾀ") ("ん" "ン" "ﾝ")))
+((("t" "x"). ())(("ち" "チ" "ﾁ") ("ん" "ン" "ﾝ")))
+((("t" "k"). ())(("つ" "ツ" "ﾂ") ("ん" "ン" "ﾝ")))
+((("t" "j"). ())(("て" "テ" "ﾃ") ("ん" "ン" "ﾝ")))
+((("t" "q"). ())(("と" "ト" "ﾄ") ("ん" "ン" "ﾝ")))
+((("t" "'"). ())(("た" "タ" "ﾀ") ("い" "イ" "ｲ")))
+((("t" "p"). ())(("つ" "ツ" "ﾂ") ("う" "ウ" "ｳ")))
+((("t" "."). ())(("て" "テ" "ﾃ") ("い" "イ" "ｲ")))
+((("t" ","). ())(("と" "ト" "ﾄ") ("う" "ウ" "ｳ")))
+((("n" ";"). ())(("な" "ナ" "ﾅ") ("ん" "ン" "ﾝ")))
+((("n" "x"). ())(("に" "ニ" "ﾆ") ("ん" "ン" "ﾝ")))
+((("n" "k"). ())(("ぬ" "ヌ" "ﾇ") ("ん" "ン" "ﾝ")))
+((("n" "j"). ())(("ね" "ネ" "ﾈ") ("ん" "ン" "ﾝ")))
+((("n" "q"). ())(("の" "ノ" "ﾉ") ("ん" "ン" "ﾝ")))
+((("n" "'"). ())(("な" "ナ" "ﾅ") ("い" "イ" "ｲ")))
+((("n" "p"). ())(("ぬ" "ヌ" "ﾇ") ("う" "ウ" "ｳ")))
+((("n" "."). ())(("ね" "ネ" "ﾈ") ("い" "イ" "ｲ")))
+((("n" ","). ())(("の" "ノ" "ﾉ") ("う" "ウ" "ｳ")))
+((("h" ";"). ())(("は" "ハ" "ﾊ") ("ん" "ン" "ﾝ")))
+((("h" "x"). ())(("ひ" "ヒ" "ﾋ") ("ん" "ン" "ﾝ")))
+((("h" "k"). ())(("ふ" "フ" "ﾌ") ("ん" "ン" "ﾝ")))
+((("h" "j"). ())(("へ" "ヘ" "ﾍ") ("ん" "ン" "ﾝ")))
+((("h" "q"). ())(("ほ" "ホ" "ﾎ") ("ん" "ン" "ﾝ")))
+((("h" "'"). ())(("は" "ハ" "ﾊ") ("い" "イ" "ｲ")))
+((("h" "p"). ())(("ふ" "フ" "ﾌ") ("う" "ウ" "ｳ")))
+((("h" "."). ())(("へ" "ヘ" "ﾍ") ("い" "イ" "ｲ")))
+((("h" ","). ())(("ほ" "ホ" "ﾎ") ("う" "ウ" "ｳ")))
+((("m" ";"). ())(("ま" "マ" "ﾏ") ("ん" "ン" "ﾝ")))
+((("m" "x"). ())(("み" "ミ" "ﾐ") ("ん" "ン" "ﾝ")))
+((("m" "k"). ())(("む" "ム" "ﾑ") ("ん" "ン" "ﾝ")))
+((("m" "j"). ())(("め" "メ" "ﾒ") ("ん" "ン" "ﾝ")))
+((("m" "q"). ())(("も" "モ" "ﾓ") ("ん" "ン" "ﾝ")))
+((("m" "'"). ())(("ま" "マ" "ﾏ") ("い" "イ" "ｲ")))
+((("m" "p"). ())(("む" "ム" "ﾑ") ("う" "ウ" "ｳ")))
+((("m" "."). ())(("め" "メ" "ﾒ") ("い" "イ" "ｲ")))
+((("m" ","). ())(("も" "モ" "ﾓ") ("う" "ウ" "ｳ")))
+((("y" ";"). ())(("や" "ヤ" "ﾔ") ("ん" "ン" "ﾝ")))
+((("y" "k"). ())(("ゆ" "ユ" "ﾕ") ("ん" "ン" "ﾝ")))
+((("y" "q"). ())(("よ" "ヨ" "ﾖ") ("ん" "ン" "ﾝ")))
+((("y" "'"). ())(("や" "ヤ" "ﾔ") ("い" "イ" "ｲ")))
+((("y" "p"). ())(("ゆ" "ユ" "ﾕ") ("う" "ウ" "ｳ")))
+((("y" "."). ())(("い" "イ" "ｲ") ("う" "ウ" "ｳ")))
+((("y" ","). ())(("よ" "ヨ" "ﾖ") ("う" "ウ" "ｳ")))
+((("r" ";"). ())(("ら" "ラ" "ﾗ") ("ん" "ン" "ﾝ")))
+((("r" "x"). ())(("り" "リ" "ﾘ") ("ん" "ン" "ﾝ")))
+((("r" "k"). ())(("る" "ル" "ﾙ") ("ん" "ン" "ﾝ")))
+((("r" "j"). ())(("れ" "レ" "ﾚ") ("ん" "ン" "ﾝ")))
+((("r" "q"). ())(("ろ" "ロ" "ﾛ") ("ん" "ン" "ﾝ")))
+((("r" "'"). ())(("ら" "ラ" "ﾗ") ("い" "イ" "ｲ")))
+((("r" "p"). ())(("る" "ル" "ﾙ") ("う" "ウ" "ｳ")))
+((("r" "."). ())(("れ" "レ" "ﾚ") ("い" "イ" "ｲ")))
+((("r" ","). ())(("ろ" "ロ" "ﾛ") ("う" "ウ" "ｳ")))
+((("w" ";"). ())(("わ" "ワ" "ﾜ") ("ん" "ン" "ﾝ")))
+((("w" "x"). ())(("う" "ウ" "ｳ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("w" "k"). ())(("う" "ウ" "ｳ") ("ん" "ン" "ﾝ")))
+((("w" "j"). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("w" "q"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ") ("ん" "ン" "ﾝ")))
+((("w" "'"). ())(("わ" "ワ" "ﾜ") ("い" "イ" "ｲ")))
+((("w" "p"). ())(("う" "ウ" "ｳ") ("ぅ" "ゥ" "ｩ")))
+((("w" "."). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("w" ","). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+((("g" ";"). ())(("が" "ガ" "ｶﾞ") ("ん" "ン" "ﾝ")))
+((("g" "x"). ())(("ぎ" "ギ" "ｷﾞ") ("ん" "ン" "ﾝ")))
+((("g" "k"). ())(("ぐ" "グ" "ｸﾞ") ("ん" "ン" "ﾝ")))
+((("g" "j"). ())(("げ" "ゲ" "ｹﾞ") ("ん" "ン" "ﾝ")))
+((("g" "q"). ())(("ご" "ゴ" "ｺﾞ") ("ん" "ン" "ﾝ")))
+((("g" "'"). ())(("が" "ガ" "ｶﾞ") ("い" "イ" "ｲ")))
+((("g" "p"). ())(("ぐ" "グ" "ｸﾞ") ("う" "ウ" "ｳ")))
+((("g" "."). ())(("げ" "ゲ" "ｹﾞ") ("い" "イ" "ｲ")))
+((("g" ","). ())(("ご" "ゴ" "ｺﾞ") ("う" "ウ" "ｳ")))
+((("z" ";"). ())(("ざ" "ザ" "ｻﾞ") ("ん" "ン" "ﾝ")))
+((("z" "x"). ())(("じ" "ジ" "ｼﾞ") ("ん" "ン" "ﾝ")))
+((("z" "k"). ())(("ず" "ズ" "ｽﾞ") ("ん" "ン" "ﾝ")))
+((("z" "j"). ())(("ぜ" "ゼ" "ｾﾞ") ("ん" "ン" "ﾝ")))
+((("z" "q"). ())(("ぞ" "ゾ" "ｿﾞ") ("ん" "ン" "ﾝ")))
+((("z" "'"). ())(("ざ" "ザ" "ｻﾞ") ("い" "イ" "ｲ")))
+((("z" "p"). ())(("ず" "ズ" "ｽﾞ") ("う" "ウ" "ｳ")))
+((("z" "."). ())(("ぜ" "ゼ" "ｾﾞ") ("い" "イ" "ｲ")))
+((("z" ","). ())(("ぞ" "ゾ" "ｿﾞ") ("う" "ウ" "ｳ")))
+((("d" ";"). ())(("だ" "ダ" "ﾀﾞ") ("ん" "ン" "ﾝ")))
+((("d" "x"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ん" "ン" "ﾝ")))
+((("d" "k"). ())(("づ" "ヅ" "ﾂﾞ") ("ん" "ン" "ﾝ")))
+((("d" "j"). ())(("で" "デ" "ﾃﾞ") ("ん" "ン" "ﾝ")))
+((("d" "q"). ())(("ど" "ド" "ﾄﾞ") ("ん" "ン" "ﾝ")))
+((("d" "'"). ())(("だ" "ダ" "ﾀﾞ") ("い" "イ" "ｲ")))
+((("d" "p"). ())(("づ" "ヅ" "ﾂﾞ") ("う" "ウ" "ｳ")))
+((("d" "."). ())(("で" "デ" "ﾃﾞ") ("い" "イ" "ｲ")))
+((("d" ","). ())(("ど" "ド" "ﾄﾞ") ("う" "ウ" "ｳ")))
+((("b" ";"). ())(("ば" "バ" "ﾊﾞ") ("ん" "ン" "ﾝ")))
+((("b" "x"). ())(("び" "ビ" "ﾋﾞ") ("ん" "ン" "ﾝ")))
+((("b" "k"). ())(("ぶ" "ブ" "ﾌﾞ") ("ん" "ン" "ﾝ")))
+((("b" "j"). ())(("べ" "ベ" "ﾍﾞ") ("ん" "ン" "ﾝ")))
+((("b" "q"). ())(("ぼ" "ボ" "ﾎﾞ") ("ん" "ン" "ﾝ")))
+((("b" "'"). ())(("ば" "バ" "ﾊﾞ") ("い" "イ" "ｲ")))
+((("b" "p"). ())(("ぶ" "ブ" "ﾌﾞ") ("う" "ウ" "ｳ")))
+((("b" "."). ())(("べ" "ベ" "ﾍﾞ") ("い" "イ" "ｲ")))
+((("b" ","). ())(("ぼ" "ボ" "ﾎﾞ") ("う" "ウ" "ｳ")))
+((("p" ";"). ())(("ぱ" "パ" "ﾊﾟ") ("ん" "ン" "ﾝ")))
+((("p" "x"). ())(("ぴ" "ピ" "ﾋﾟ") ("ん" "ン" "ﾝ")))
+((("p" "k"). ())(("ぷ" "プ" "ﾌﾟ") ("ん" "ン" "ﾝ")))
+((("p" "j"). ())(("ぺ" "ペ" "ﾍﾟ") ("ん" "ン" "ﾝ")))
+((("p" "q"). ())(("ぽ" "ポ" "ﾎﾟ") ("ん" "ン" "ﾝ")))
+((("p" "'"). ())(("ぱ" "パ" "ﾊﾟ") ("い" "イ" "ｲ")))
+((("p" "p"). ())(("ぷ" "プ" "ﾌﾟ") ("う" "ウ" "ｳ")))
+((("p" "."). ())(("ぺ" "ペ" "ﾍﾟ") ("い" "イ" "ｲ")))
+((("p" ","). ())(("ぽ" "ポ" "ﾎﾟ") ("う" "ウ" "ｳ")))
+((("c" "g" "a"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ")))
+((("c" "g" "i"). ())(("き" "キ" "ｷ") ("ぃ" "ィ" "ｨ")))
+((("c" "g" "u"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ")))
+((("c" "g" "e"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ")))
+((("c" "g" "o"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ")))
+((("c" "g" ";"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("c" "g" "x"). ())(("き" "キ" "ｷ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("c" "g" "k"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("c" "g" "j"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("c" "g" "q"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("c" "g" "'"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("c" "g" "p"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("c" "g" "."). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("c" "g" ","). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("s" "h" "a"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ")))
+((("s" "h" "i"). ())(("し" "シ" "ｼ") ("ぃ" "ィ" "ｨ")))
+((("s" "h" "u"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ")))
+((("s" "h" "e"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ")))
+((("s" "h" "o"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ")))
+((("s" "h" ";"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("s" "h" "x"). ())(("し" "シ" "ｼ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("s" "h" "k"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("s" "h" "j"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("s" "h" "q"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("s" "h" "'"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("s" "h" "p"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("s" "h" "."). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("s" "h" ","). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("t" "h" "a"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ")))
+((("t" "h" "i"). ())(("ち" "チ" "ﾁ") ("ぃ" "ィ" "ｨ")))
+((("t" "h" "u"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ")))
+((("t" "h" "e"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ")))
+((("t" "h" "o"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ")))
+((("t" "h" ";"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("t" "h" "x"). ())(("ち" "チ" "ﾁ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("t" "h" "k"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("t" "h" "j"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("t" "h" "q"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("t" "h" "'"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("t" "h" "p"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("t" "h" "."). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("t" "h" ","). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("n" "h" "a"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ")))
+((("n" "h" "i"). ())(("に" "ニ" "ﾆ") ("ぃ" "ィ" "ｨ")))
+((("n" "h" "u"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ")))
+((("n" "h" "e"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ")))
+((("n" "h" "o"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ")))
+((("n" "h" ";"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("n" "h" "x"). ())(("に" "ニ" "ﾆ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("n" "h" "k"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("n" "h" "j"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("n" "h" "q"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("n" "h" "'"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("n" "h" "p"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("n" "h" "."). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("n" "h" ","). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("h" "n" "a"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ")))
+((("h" "n" "i"). ())(("ひ" "ヒ" "ﾋ") ("ぃ" "ィ" "ｨ")))
+((("h" "n" "u"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ")))
+((("h" "n" "e"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ")))
+((("h" "n" "o"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ")))
+((("h" "n" ";"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("h" "n" "x"). ())(("ひ" "ヒ" "ﾋ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("h" "n" "k"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("h" "n" "j"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("h" "n" "q"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("h" "n" "'"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("h" "n" "p"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("h" "n" "."). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("h" "n" ","). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("m" "v" "a"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ")))
+((("m" "v" "i"). ())(("み" "ミ" "ﾐ") ("ぃ" "ィ" "ｨ")))
+((("m" "v" "u"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ")))
+((("m" "v" "e"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ")))
+((("m" "v" "o"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ")))
+((("m" "v" ";"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("m" "v" "x"). ())(("み" "ミ" "ﾐ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("m" "v" "k"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("m" "v" "j"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("m" "v" "q"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("m" "v" "'"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("m" "v" "p"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("m" "v" "."). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("m" "v" ","). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("r" "g" "a"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ")))
+((("r" "g" "i"). ())(("り" "リ" "ﾘ") ("ぃ" "ィ" "ｨ")))
+((("r" "g" "u"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ")))
+((("r" "g" "e"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ")))
+((("r" "g" "o"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ")))
+((("r" "g" ";"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("r" "g" "x"). ())(("り" "リ" "ﾘ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("r" "g" "k"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("r" "g" "j"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("r" "g" "q"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("r" "g" "'"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("r" "g" "p"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("r" "g" "."). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("r" "g" ","). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("g" "r" "a"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ")))
+((("g" "r" "i"). ())(("ぎ" "ギ" "ｷﾞ") ("ぃ" "ィ" "ｨ")))
+((("g" "r" "u"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ")))
+((("g" "r" "e"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ")))
+((("g" "r" "o"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ")))
+((("g" "r" ";"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("g" "r" "x"). ())(("ぎ" "ギ" "ｷﾞ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("g" "r" "k"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("g" "r" "j"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("g" "r" "q"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("g" "r" "'"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("g" "r" "p"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("g" "r" "."). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("g" "r" ","). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("z" "m" "a"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ")))
+((("z" "m" "i"). ())(("じ" "ジ" "ｼﾞ") ("ぃ" "ィ" "ｨ")))
+((("z" "m" "u"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+((("z" "m" "e"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ")))
+((("z" "m" "o"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ")))
+((("z" "m" ";"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("z" "m" "x"). ())(("じ" "ジ" "ｼﾞ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("z" "m" "k"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("z" "m" "j"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("z" "m" "q"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("z" "m" "'"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("z" "m" "p"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("z" "m" "."). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("z" "m" ","). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("d" "n" "a"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ゃ" "ャ" "ｬ")))
+((("d" "n" "i"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ぃ" "ィ" "ｨ")))
+((("d" "n" "u"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ゅ" "ュ" "ｭ")))
+((("d" "n" "e"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ぇ" "ェ" "ｪ")))
+((("d" "n" "o"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ょ" "ョ" "ｮ")))
+((("d" "n" ";"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("d" "n" "x"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("d" "n" "k"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("d" "n" "j"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("d" "n" "q"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("d" "n" "'"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("d" "n" "p"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("d" "n" "."). ())(("ぢ" "ヂ" "ﾁﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("d" "n" ","). ())(("ぢ" "ヂ" "ﾁﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("b" "v" "a"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ")))
+((("b" "v" "i"). ())(("び" "ビ" "ﾋﾞ") ("ぃ" "ィ" "ｨ")))
+((("b" "v" "u"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ")))
+((("b" "v" "e"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ")))
+((("b" "v" "o"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ")))
+((("b" "v" ";"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("b" "v" "x"). ())(("び" "ビ" "ﾋﾞ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("b" "v" "k"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("b" "v" "j"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("b" "v" "q"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("b" "v" "'"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("b" "v" "p"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("b" "v" "."). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("b" "v" ","). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("p" "n" "a"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ")))
+((("p" "n" "i"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぃ" "ィ" "ｨ")))
+((("p" "n" "u"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ")))
+((("p" "n" "e"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ")))
+((("p" "n" "o"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ")))
+((("p" "n" ";"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("p" "n" "x"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("p" "n" "k"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("p" "n" "j"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("p" "n" "q"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("p" "n" "'"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+((("p" "n" "p"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("p" "n" "."). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("p" "n" ","). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("f" ";"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ") ("ん" "ン" "ﾝ")))
+((("f" "x"). ())(("ふ" "フ" "ﾌ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("f" "k"). ())(("ふ" "フ" "ﾌ") ("ん" "ン" "ﾝ")))
+((("f" "j"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("f" "q"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ") ("ん" "ン" "ﾝ")))
+((("f" "'"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ") ("い" "イ" "ｲ")))
+((("f" "p"). ())(("ふ" "フ" "ﾌ") ("う" "ウ" "ｳ")))
+((("f" "."). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("f" ","). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+((("v" ";"). ())(("う゛" "ヴ" "ｳﾞ") ("ぁ" "ァ" "ｧ") ("ん" "ン" "ﾝ")))
+((("v" "x"). ())(("う゛" "ヴ" "ｳﾞ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("v" "k"). ())(("う゛" "ヴ" "ｳﾞ") ("ん" "ン" "ﾝ")))
+((("v" "j"). ())(("う゛" "ヴ" "ｳﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("v" "q"). ())(("う゛" "ヴ" "ｳﾞ") ("ぉ" "ォ" "ｫ") ("ん" "ン" "ﾝ")))
+((("v" "'"). ())(("う゛" "ヴ" "ｳﾞ") ("ぁ" "ァ" "ｧ") ("い" "イ" "ｲ")))
+((("v" "p"). ())(("う゛" "ヴ" "ｳﾞ") ("ー" "ー" "ｰ")))
+((("v" "."). ())(("う゛" "ヴ" "ｳﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("v" ","). ())(("う゛" "ヴ" "ｳﾞ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+((("p" "c"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("p" "l"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("f" "c"). ())(("ふ" "フ" "ﾌ") ("ゅ" "ュ" "ｭ") ("ー" "ー" "ｰ")))
+((("f" "l"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+((("g" "c"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("g" "l"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("c" "c"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("c" "l"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("r" "c"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("r" "l"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("h" "t"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("h" "s"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("t" "t"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("t" "s"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("n" "t"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("n" "s"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("s" "t"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("s" "s"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("b" "w"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("b" "z"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("m" "w"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("ー" "ー" "ｰ")))
+((("m" "z"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("w" "z"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+((("v" "w"). ())(("う゛" "ヴ" "ｳﾞ") ("ゅ" "ュ" "ｭ") ("ー" "ー" "ｰ")))
+((("v" "z"). ())(("う゛" "ヴ" "ｳﾞ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+((("z" "w"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("z" "z"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("g" "r" "r"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("く" "ク" "ｸ")))
+((("g" "r" "l"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("c" "g" "r"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("く" "ク" "ｸ")))
+((("c" "g" "l"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("r" "g" "r"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("く" "ク" "ｸ")))
+((("r" "g" "l"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("h" "n" "s"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("t" "h" "n"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("く" "ク" "ｸ")))
+((("t" "h" "s"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("n" "h" "n"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("く" "ク" "ｸ")))
+((("n" "h" "s"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("s" "h" "n"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("く" "ク" "ｸ")))
+((("s" "h" "s"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("s" "h" "t"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("つ" "ツ" "ﾂ")))
+((("p" "n" "s"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("b" "v" "v"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("く" "ク" "ｸ")))
+((("b" "v" "z"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("m" "v" "v"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("く" "ク" "ｸ")))
+((("m" "v" "z"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("z" "m" "v"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("く" "ク" "ｸ")))
+((("z" "m" "z"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("く" "ク" "ｸ")))
+((("z" "m" "w"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("つ" "ツ" "ﾂ")))
+((("s" "h" "h"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("く" "ク" "ｸ")))
+((("z" "m" "m"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("く" "ク" "ｸ")))
+((("y" "h"). ())("ゆ" "ユ" "ﾕ"))
+((("y" "g"). ())(("ゆ" "ユ" "ﾕ") ("う" "ウ" "ｳ")))
+((("y" "z"). ())(("や" "ヤ" "ﾔ") ("ん" "ン" "ﾝ")))
+((("y" "m"). ())(("ゆ" "ユ" "ﾕ") ("ん" "ン" "ﾝ")))
+((("y" "v"). ())(("よ" "ヨ" "ﾖ") ("ん" "ン" "ﾝ")))
+((("p" "s"). ())("ぱ" "パ" "ﾊﾟ"))
+((("p" "d"). ())("ぴ" "ピ" "ﾋﾟ"))
+((("p" "h"). ())("ぷ" "プ" "ﾌﾟ"))
+((("p" "t"). ())("ぺ" "ペ" "ﾍﾟ"))
+((("p" "z"). ())(("ぱ" "パ" "ﾊﾟ") ("ん" "ン" "ﾝ")))
+((("p" "b"). ())(("ぴ" "ピ" "ﾋﾟ") ("ん" "ン" "ﾝ")))
+((("p" "m"). ())(("ぷ" "プ" "ﾌﾟ") ("ん" "ン" "ﾝ")))
+((("p" "w"). ())(("ぺ" "ペ" "ﾍﾟ") ("ん" "ン" "ﾝ")))
+((("p" "v"). ())(("ぽ" "ポ" "ﾎﾟ") ("ん" "ン" "ﾝ")))
+((("y" "y"). ())(("い" "イ" "ｲ") ("う" "ウ" "ｳ")))
+((("y" "f"). ())(("よ" "ヨ" "ﾖ") ("り" "リ" "ﾘ")))
+((("y" "c"). ())(("い" "イ" "ｲ") ("う" "ウ" "ｳ")))
+((("y" "r"). ())(("よ" "ヨ" "ﾖ") ("る" "ル" "ﾙ")))
+((("y" "l"). ())(("や" "ヤ" "ﾔ") ("る" "ル" "ﾙ")))
+((("y" "d"). ())(("よ" "ヨ" "ﾖ") ("い" "イ" "ｲ")))
+((("y" "t"). ())(("よ" "ヨ" "ﾖ") ("っ" "ッ" "ｯ") ("て" "テ" "ﾃ")))
+((("y" "n"). ())(("よ" "ヨ" "ﾖ") ("く" "ク" "ｸ")))
+((("y" "s"). ())(("や" "ヤ" "ﾔ") ("く" "ク" "ｸ")))
+((("y" "b"). ())(("ゆ" "ユ" "ﾕ") ("び" "ビ" "ﾋﾞ")))
+((("y" "w"). ())(("い" "イ" "ｲ") ("わ" "ワ" "ﾜ") ("れ" "レ" "ﾚ")))
+((("f" "f"). ())(("ふ" "フ" "ﾌ") ("り" "リ" "ﾘ")))
+((("f" "g"). ())(("ふ" "フ" "ﾌ") ("る" "ル" "ﾙ")))
+((("f" "r"). ())(("ふ" "フ" "ﾌ") ("る" "ル" "ﾙ")))
+((("f" "n"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ") ("ん" "ン" "ﾝ")))
+((("f" "m"). ())(("ふ" "フ" "ﾌ") ("む" "ム" "ﾑ")))
+((("g" "t"). ())(("ご" "ゴ" "ｺﾞ") ("と" "ト" "ﾄ")))
+((("g" "n"). ())(("ご" "ゴ" "ｺﾞ") ("く" "ク" "ｸ")))
+((("g" "s"). ())(("が" "ガ" "ｶﾞ") ("く" "ク" "ｸ")))
+((("c" "r"). ())(("か" "カ" "ｶ") ("ら" "ラ" "ﾗ")))
+((("c" "d"). ())(("か" "カ" "ｶ") ("た" "タ" "ﾀ")))
+((("c" "t"). ())(("こ" "コ" "ｺ") ("と" "ト" "ﾄ")))
+((("c" "b"). ())(("か" "カ" "ｶ") ("ん" "ン" "ﾝ") ("が" "ガ" "ｶﾞ") ("え" "エ" "ｴ")))
+((("c" "n"). ())(("こ" "コ" "ｺ") ("く" "ク" "ｸ")))
+((("c" "s"). ())(("か" "カ" "ｶ") ("く" "ク" "ｸ")))
+((("r" "r"). ())(("ら" "ラ" "ﾗ") ("れ" "レ" "ﾚ")))
+((("r" "n"). ())(("ら" "ラ" "ﾗ") ("ん" "ン" "ﾝ")))
+((("d" "g"). ())(("だ" "ダ" "ﾀﾞ") ("が" "ガ" "ｶﾞ")))
+((("d" "c"). ())(("で" "デ" "ﾃﾞ") ("き" "キ" "ｷ")))
+((("d" "r"). ())(("で" "デ" "ﾃﾞ") ("あ" "ア" "ｱ") ("る" "ル" "ﾙ")))
+((("d" "l"). ())(("で" "デ" "ﾃﾞ") ("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("d" "d"). ())(("の" "ノ" "ﾉ") ("で" "デ" "ﾃﾞ")))
+((("d" "t"). ())(("だ" "ダ" "ﾀﾞ") ("ち" "チ" "ﾁ")))
+((("d" "s"). ())(("で" "デ" "ﾃﾞ") ("す" "ス" "ｽ")))
+((("d" "m"). ())(("で" "デ" "ﾃﾞ") ("も" "モ" "ﾓ")))
+((("h" "g"). ())(("ふ" "フ" "ﾌ") ("る" "ル" "ﾙ")))
+((("h" "c"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("h" "r"). ())(("ひ" "ヒ" "ﾋ") ("と" "ト" "ﾄ") ("り" "リ" "ﾘ")))
+((("h" "l"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("h" "d"). ())(("ほ" "ホ" "ﾎ") ("ど" "ド" "ﾄﾞ")))
+((("h" "h"). ())(("ひ" "ヒ" "ﾋ") ("と" "ト" "ﾄ")))
+((("h" "z"). ())(("ひ" "ヒ" "ﾋ") ("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("t" "f"). ())(("と" "ト" "ﾄ") ("り" "リ" "ﾘ")))
+((("t" "g"). ())(("と" "ト" "ﾄ") ("し" "シ" "ｼ") ("て" "テ" "ﾃ")))
+((("t" "c"). ())(("つ" "ツ" "ﾂ") ("い" "イ" "ｲ") ("て" "テ" "ﾃ")))
+((("t" "r"). ())(("と" "ト" "ﾄ") ("こ" "コ" "ｺ") ("ろ" "ロ" "ﾛ")))
+((("t" "l"). ())(("と" "ト" "ﾄ") ("く" "ク" "ｸ")))
+((("t" "d"). ())(("と" "ト" "ﾄ") ("い" "イ" "ｲ") ("う" "ウ" "ｳ")))
+((("t" "n"). ())(("と" "ト" "ﾄ") ("の" "ノ" "ﾉ")))
+((("t" "b"). ())(("た" "タ" "ﾀ") ("び" "ビ" "ﾋﾞ")))
+((("t" "m"). ())(("た" "タ" "ﾀ") ("め" "メ" "ﾒ")))
+((("t" "v"). ())(("と" "ト" "ﾄ") ("き" "キ" "ｷ")))
+((("t" "z"). ())(("て" "テ" "ﾃ") ("き" "キ" "ｷ")))
+((("n" "f"). ())(("な" "ナ" "ﾅ") ("り" "リ" "ﾘ")))
+((("n" "c"). ())(("に" "ニ" "ﾆ") ("つ" "ツ" "ﾂ") ("い" "イ" "ｲ") ("て" "テ" "ﾃ")))
+((("n" "r"). ())(("な" "ナ" "ﾅ") ("る" "ル" "ﾙ")))
+((("n" "l"). ())(("な" "ナ" "ﾅ") ("っ" "ッ" "ｯ") ("た" "タ" "ﾀ")))
+((("n" "d"). ())(("な" "ナ" "ﾅ") ("ど" "ド" "ﾄﾞ")))
+((("n" "b"). ())(("な" "ナ" "ﾅ") ("け" "ケ" "ｹ") ("れ" "レ" "ﾚ") ("ば" "バ" "ﾊﾞ")))
+((("n" "m"). ())(("な" "ナ" "ﾅ") ("く" "ク" "ｸ") ("て" "テ" "ﾃ") ("も" "モ" "ﾓ")))
+((("n" "w"). ())(("な" "ナ" "ﾅ") ("く" "ク" "ｸ") ("て" "テ" "ﾃ") ("は" "ハ" "ﾊ")))
+((("n" "z"). ())(("な" "ナ" "ﾅ") ("く" "ク" "ｸ")))
+((("s" "f"). ())(("さ" "サ" "ｻ") ("り" "リ" "ﾘ")))
+((("s" "g"). ())(("さ" "サ" "ｻ") ("れ" "レ" "ﾚ")))
+((("s" "c"). ())(("し" "シ" "ｼ") ("た" "タ" "ﾀ")))
+((("s" "r"). ())(("す" "ス" "ｽ") ("る" "ル" "ﾙ")))
+((("s" "d"). ())(("さ" "サ" "ｻ") ("れ" "レ" "ﾚ")))
+((("s" "m"). ())(("し" "シ" "ｼ") ("も" "モ" "ﾓ")))
+((("s" "n" "b"). ())(("し" "シ" "ｼ") ("な" "ナ" "ﾅ") ("け" "ケ" "ｹ") ("れ" "レ" "ﾚ") ("ば" "バ" "ﾊﾞ")))
+((("s" "n" "m"). ())(("し" "シ" "ｼ") ("な" "ナ" "ﾅ") ("く" "ク" "ｸ") ("て" "テ" "ﾃ") ("も" "モ" "ﾓ")))
+((("s" "n" "t"). ())(("し" "シ" "ｼ") ("な" "ナ" "ﾅ") ("く" "ク" "ｸ") ("て" "テ" "ﾃ")))
+((("s" "n" "w"). ())(("し" "シ" "ｼ") ("な" "ナ" "ﾅ") ("く" "ク" "ｸ") ("て" "テ" "ﾃ") ("は" "ハ" "ﾊ")))
+((("s" "z"). ())(("そ" "ソ" "ｿ") ("れ" "レ" "ﾚ") ("ぞ" "ゾ" "ｿﾞ") ("れ" "レ" "ﾚ")))
+((("b" "c"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("b" "r"). ())(("ば" "バ" "ﾊﾞ") ("ら" "ラ" "ﾗ")))
+((("b" "l"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("b" "h"). ())(("ぶ" "ブ" "ﾌﾞ") ("つ" "ツ" "ﾂ")))
+((("b" "t"). ())(("べ" "ベ" "ﾍﾞ") ("つ" "ツ" "ﾂ")))
+((("m" "c"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("ー" "ー" "ｰ")))
+((("m" "r"). ())(("ま" "マ" "ﾏ") ("る" "ル" "ﾙ")))
+((("m" "l"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("m" "d"). ())(("ま" "マ" "ﾏ") ("で" "デ" "ﾃﾞ")))
+((("m" "t"). ())(("ま" "マ" "ﾏ") ("た" "タ" "ﾀ")))
+((("m" "n"). ())(("も" "モ" "ﾓ") ("の" "ノ" "ﾉ")))
+((("m" "s"). ())(("ま" "マ" "ﾏ") ("す" "ス" "ｽ")))
+((("m" "m"). ())(("お" "オ" "ｵ") ("も" "モ" "ﾓ")))
+((("w" "r"). ())(("わ" "ワ" "ﾜ") ("れ" "レ" "ﾚ")))
+((("w" "t"). ())(("わ" "ワ" "ﾜ") ("た" "タ" "ﾀ") ("し" "シ" "ｼ")))
+((("w" "n"). ())(("わ" "ワ" "ﾜ") ("れ" "レ" "ﾚ") ("わ" "ワ" "ﾜ") ("れ" "レ" "ﾚ")))
+((("v" "m"). ())(("こ" "コ" "ｺ") ("と" "ト" "ﾄ") ("な" "ナ" "ﾅ")))
+((("v" "v"). ())(("お" "オ" "ｵ") ("な" "ナ" "ﾅ") ("じ" "ジ" "ｼﾞ")))
+((("z" "c"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("z" "r"). ())(("ざ" "ザ" "ｻﾞ") ("る" "ル" "ﾙ")))
+((("z" "t"). ())(("ず" "ズ" "ｽﾞ") ("つ" "ツ" "ﾂ")))
+((("z" "n"). ())(("ぞ" "ゾ" "ｿﾞ") ("く" "ク" "ｸ")))
+((("z" "s"). ())(("ざ" "ザ" "ｻﾞ") ("く" "ク" "ｸ")))
+((("p" "f"). ())(("ぷ" "プ" "ﾌﾟ") ("り" "リ" "ﾘ")))
+((("p" "g"). ())(("ぷ" "プ" "ﾌﾟ") ("る" "ル" "ﾙ")))
+((("p" "r"). ())(("ぷ" "プ" "ﾌﾟ") ("ろ" "ロ" "ﾛ")))
+((("t" "w" "a"). ())(("て" "テ" "ﾃ") ("ゃ" "ャ" "ｬ")))
+((("t" "w" "i"). ())(("て" "テ" "ﾃ") ("ぃ" "ィ" "ｨ")))
+((("t" "w" "u"). ())(("て" "テ" "ﾃ") ("ゅ" "ュ" "ｭ")))
+((("t" "w" "e"). ())(("て" "テ" "ﾃ") ("ぇ" "ェ" "ｪ")))
+((("t" "w" "o"). ())(("て" "テ" "ﾃ") ("ょ" "ョ" "ｮ")))
+((("t" "w" ";"). ())(("て" "テ" "ﾃ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("t" "w" "x"). ())(("て" "テ" "ﾃ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("t" "w" "k"). ())(("て" "テ" "ﾃ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("t" "w" "j"). ())(("て" "テ" "ﾃ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("t" "w" "q"). ())(("て" "テ" "ﾃ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("t" "w" "'"). ())(("て" "テ" "ﾃ") ("ゃ" "ャ" "ｬ") ("う" "ウ" "ｳ")))
+((("t" "w" "p"). ())(("て" "テ" "ﾃ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("t" "w" "."). ())(("て" "テ" "ﾃ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("t" "w" ","). ())(("て" "テ" "ﾃ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("d" "b" "a"). ())(("で" "デ" "ﾃﾞ") ("ゃ" "ャ" "ｬ")))
+((("d" "b" "i"). ())(("で" "デ" "ﾃﾞ") ("ぃ" "ィ" "ｨ")))
+((("d" "b" "u"). ())(("で" "デ" "ﾃﾞ") ("ゅ" "ュ" "ｭ")))
+((("d" "b" "e"). ())(("で" "デ" "ﾃﾞ") ("ぇ" "ェ" "ｪ")))
+((("d" "b" "o"). ())(("で" "デ" "ﾃﾞ") ("ょ" "ョ" "ｮ")))
+((("d" "b" ";"). ())(("で" "デ" "ﾃﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+((("d" "b" "x"). ())(("で" "デ" "ﾃﾞ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("d" "b" "k"). ())(("で" "デ" "ﾃﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+((("d" "b" "j"). ())(("で" "デ" "ﾃﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("d" "b" "q"). ())(("で" "デ" "ﾃﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+((("d" "b" "'"). ())(("で" "デ" "ﾃﾞ") ("ゃ" "ャ" "ｬ") ("う" "ウ" "ｳ")))
+((("d" "b" "p"). ())(("で" "デ" "ﾃﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+((("d" "b" "."). ())(("で" "デ" "ﾃﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("d" "b" ","). ())(("で" "デ" "ﾃﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+((("w" "m" "a"). ())(("う" "ウ" "ｳ") ("ぁ" "ァ" "ｧ")))
+((("w" "m" "i"). ())(("う" "ウ" "ｳ") ("ぃ" "ィ" "ｨ")))
+((("w" "m" "u"). ())(("う" "ウ" "ｳ") ("ぅ" "ゥ" "ｩ")))
+((("w" "m" "e"). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ")))
+((("w" "m" "o"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ")))
+((("w" "m" ";"). ())(("う" "ウ" "ｳ") ("ぁ" "ァ" "ｧ") ("ん" "ン" "ﾝ")))
+((("w" "m" "x"). ())(("う" "ウ" "ｳ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+((("w" "m" "k"). ())(("う" "ウ" "ｳ") ("ぅ" "ゥ" "ｩ") ("ん" "ン" "ﾝ")))
+((("w" "m" "j"). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+((("w" "m" "q"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ") ("ん" "ン" "ﾝ")))
+((("w" "m" "'"). ())(("う" "ウ" "ｳ") ("ぁ" "ァ" "ｧ") ("う" "ウ" "ｳ")))
+((("w" "m" "p"). ())(("う" "ウ" "ｳ") ("ぅ" "ゥ" "ｩ") ("う" "ウ" "ｳ")))
+((("w" "m" "."). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+((("w" "m" ","). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ") ("う" "ウ" "ｳ")))
+((("c" "y"). ())(("く" "ク" "ｸ") ("い" "イ" "ｲ")))
+((("s" "y"). ())(("す" "ス" "ｽ") ("い" "イ" "ｲ")))
+((("t" "y"). ())(("つ" "ツ" "ﾂ") ("い" "イ" "ｲ")))
+((("n" "y"). ())(("ぬ" "ヌ" "ﾇ") ("い" "イ" "ｲ")))
+((("h" "y"). ())(("ふ" "フ" "ﾌ") ("い" "イ" "ｲ")))
+((("m" "y"). ())(("む" "ム" "ﾑ") ("い" "イ" "ｲ")))
+((("y" "y"). ())(("ゆ" "ユ" "ﾕ") ("い" "イ" "ｲ")))
+((("r" "y"). ())(("る" "ル" "ﾙ") ("い" "イ" "ｲ")))
+((("w" "y"). ())(("う" "ウ" "ｳ") ("い" "イ" "ｲ")))
+((("g" "y"). ())(("ぐ" "グ" "ｸﾞ") ("い" "イ" "ｲ")))
+((("z" "y"). ())(("ず" "ズ" "ｽﾞ") ("い" "イ" "ｲ")))
+((("d" "y"). ())(("づ" "ヅ" "ﾂﾞ") ("い" "イ" "ｲ")))
+((("b" "y"). ())(("ぶ" "ブ" "ﾌﾞ") ("い" "イ" "ｲ")))
+((("p" "y"). ())(("ぷ" "プ" "ﾌﾟ") ("い" "イ" "ｲ")))
+((("c" "g" "y"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("s" "h" "y"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("t" "h" "y"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("n" "h" "y"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("h" "n" "y"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("m" "v" "y"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("r" "g" "y"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("g" "r" "y"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("z" "m" "y"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("d" "n" "y"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("b" "v" "y"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("p" "n" "y"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("f" "y"). ())(("ふ" "フ" "ﾌ") ("い" "イ" "ｲ")))
+((("v" "y"). ())(("う゛" "ヴ" "ｳﾞ") ("い" "イ" "ｲ")))
+((("t" "w" "y"). ())(("て" "テ" "ﾃ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("d" "b" "y"). ())(("で" "デ" "ﾃﾞ") ("ゅ" "ュ" "ｭ") ("い" "イ" "ｲ")))
+((("w" "m" "y"). ())(("う" "ウ" "ｳ") ("ぅ" "ゥ" "ｩ") ("い" "イ" "ｲ")))
+
+))
+
+
+(define ja-act-rule (append ja-act-rule-basic (filter (lambda (x) (not (ichar-alphabetic? (string->charcode (caaar x))))) ja-rk-rule-basic)))
+
+(define ja-act-skk-okuri-char-alist '(("c" . "k") ("'" . "t") (";" . "a") ("q" . "o") ("j" . "e") ("k" . "u") ("x" . "i")))
+(define ja-act-skk-downcase-alist (alist->icharlist '(("\"" . "'") (":" . ";"))))
+(define ja-act-skk-set-henkan-point-key (map string->charcode '("'" ";" "q" "j" "k" "x")))
+
+
diff --git a/scm/japanese-azik-utf8.scm b/scm/japanese-azik-utf8.scm
new file mode 100644
index 000000000..dfa82bde2
--- /dev/null
+++ b/scm/japanese-azik-utf8.scm
@@ -0,0 +1,534 @@
+;;;
+;;; Copyright (c) 2003-2013 uim Project https://github.com/uim/uim
+;;;
+;;; All rights reserved.
+;;;
+;;; Redistribution and use in source and binary forms, with or without
+;;; modification, are permitted provided that the following conditions
+;;; are met:
+;;; 1. Redistributions of source code must retain the above copyright
+;;;    notice, this list of conditions and the following disclaimer.
+;;; 2. Redistributions in binary form must reproduce the above copyright
+;;;    notice, this list of conditions and the following disclaimer in the
+;;;    documentation and/or other materials provided with the distribution.
+;;; 3. Neither the name of authors nor the names of its contributors
+;;;    may be used to endorse or promote products derived from this software
+;;;    without specific prior written permission.
+;;;
+;;; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND
+;;; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+;;; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+;;; ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE
+;;; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+;;; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+;;; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+;;; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+;;; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+;;; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+;;; SUCH DAMAGE.
+;;;;
+
+(define ja-azik-rule-basic
+  '(
+
+    (((":"). ())("ー" "ー" "ｰ"))
+    (((";"). ())("っ" "ッ" "ｯ"))
+    ((("b" "d"). ())(("べ" "ベ" "ﾍﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "a"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("b" "g" "d"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "e"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("b" "g" "h"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("b" "g" "j"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "l"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "n"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "o"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ")))
+    ((("b" "g" "p"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("b" "g" "q"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("b" "g" "u"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("b" "g" "w"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("b" "g" "z"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("b" "h"). ())(("ぶ" "ブ" "ﾌﾞ") ("う" "ウ" "ｳ")))
+    ((("b" "j"). ())(("ぶ" "ブ" "ﾌﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "k"). ())(("び" "ビ" "ﾋﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "l"). ())(("ぼ" "ボ" "ﾎﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "n"). ())(("ば" "バ" "ﾊﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "p"). ())(("ぼ" "ボ" "ﾎﾞ") ("う" "ウ" "ｳ")))
+    ((("b" "q"). ())(("ば" "バ" "ﾊﾞ") ("い" "イ" "ｲ")))
+    ((("b" "t"). ())(("び" "ビ" "ﾋﾞ") ("と" "ト" "ﾄ")))
+    ((("b" "w"). ())(("べ" "ベ" "ﾍﾞ") ("い" "イ" "ｲ")))
+    ((("b" "y" "d"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("b" "y" "h"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("b" "y" "j"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("b" "y" "l"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("b" "y" "n"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("b" "y" "p"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("b" "y" "q"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("b" "y" "w"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("b" "y" "z"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("b" "z"). ())(("ば" "バ" "ﾊﾞ") ("ん" "ン" "ﾝ")))
+    ((("c" "a"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ")))
+    ((("c" "d"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("c" "e"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ")))
+    ((("c" "h"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("c" "j"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("c" "l"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("c" "n"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("c" "o"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ")))
+    ((("c" "p"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("c" "q"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("c" "u"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ")))
+    ((("c" "w"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("c" "y" "a"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ")))
+    ((("c" "y" "e"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ")))
+    ((("c" "y" "i"). ())(("ち" "チ" "ﾁ") ("ぃ" "ィ" "ｨ")))
+    ((("c" "y" "o"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ")))
+    ((("c" "y" "u"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ")))
+    ((("c" "z"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("d" "c" "i"). ())(("で" "デ" "ﾃﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("d" "c" "u"). ())(("ど" "ド" "ﾄﾞ") ("ぅ" "ゥ" "ｩ")))
+    ((("d" "d"). ())(("で" "デ" "ﾃﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "f"). ())("で" "デ" "ﾃﾞ"))
+    ((("d" "g" "i"). ())(("で" "デ" "ﾃﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("d" "g" "u"). ())(("ど" "ド" "ﾄﾞ") ("ぅ" "ゥ" "ｩ")))
+    ((("d" "h"). ())(("づ" "ヅ" "ﾂﾞ") ("う" "ウ" "ｳ")))
+    ((("d" "j"). ())(("づ" "ヅ" "ﾂﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "k"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "l"). ())(("ど" "ド" "ﾄﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "m"). ())(("で" "デ" "ﾃﾞ") ("も" "モ" "ﾓ")))
+    ((("d" "n"). ())(("だ" "ダ" "ﾀﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "p"). ())(("ど" "ド" "ﾄﾞ") ("う" "ウ" "ｳ")))
+    ((("d" "q"). ())(("だ" "ダ" "ﾀﾞ") ("い" "イ" "ｲ")))
+    ((("d" "s"). ())(("で" "デ" "ﾃﾞ") ("す" "ス" "ｽ")))
+    ((("d" "t"). ())(("だ" "ダ" "ﾀﾞ") ("ち" "チ" "ﾁ")))
+    ((("d" "w"). ())(("で" "デ" "ﾃﾞ") ("い" "イ" "ｲ")))
+    ((("d" "z"). ())(("だ" "ダ" "ﾀﾞ") ("ん" "ン" "ﾝ")))
+    ((("f" "d"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("f" "h"). ())(("ふ" "フ" "ﾌ") ("う" "ウ" "ｳ")))
+    ((("f" "j"). ())(("ふ" "フ" "ﾌ") ("ん" "ン" "ﾝ")))
+    ((("f" "k"). ())(("ふ" "フ" "ﾌ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+    ((("f" "l"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ") ("ん" "ン" "ﾝ")))
+    ((("f" "n"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ") ("ん" "ン" "ﾝ")))
+    ((("f" "p"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+    ((("f" "q"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ") ("い" "イ" "ｲ")))
+    ((("f" "w"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("f" "z"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ") ("ん" "ン" "ﾝ")))
+    ((("g" "d"). ())(("げ" "ゲ" "ｹﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "a"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("g" "g" "u"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("g" "g" "e"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("g" "g" "o"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ")))
+    ((("g" "g" "z"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "n"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "j"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "d"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "l"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "q"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("g" "g" "h"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("g" "g" "w"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("g" "g" "p"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("g" "h"). ())(("ぐ" "グ" "ｸﾞ") ("う" "ウ" "ｳ")))
+    ((("g" "j"). ())(("ぐ" "グ" "ｸﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "k"). ())(("ぎ" "ギ" "ｷﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "l"). ())(("ご" "ゴ" "ｺﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "n"). ())(("が" "ガ" "ｶﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "p"). ())(("ご" "ゴ" "ｺﾞ") ("う" "ウ" "ｳ")))
+    ((("g" "q"). ())(("が" "ガ" "ｶﾞ") ("い" "イ" "ｲ")))
+    ((("g" "r"). ())(("が" "ガ" "ｶﾞ") ("ら" "ラ" "ﾗ")))
+    ((("g" "t"). ())(("ご" "ゴ" "ｺﾞ") ("と" "ト" "ﾄ")))
+    ((("g" "w"). ())(("げ" "ゲ" "ｹﾞ") ("い" "イ" "ｲ")))
+    ((("g" "w" "a"). ())(("ぐ" "グ" "ｸﾞ") ("ぁ" "ァ" "ｧ")))
+    ((("g" "w" "e"). ())(("ぐ" "グ" "ｸﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("g" "w" "i"). ())(("ぐ" "グ" "ｸﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("g" "w" "o"). ())(("ぐ" "グ" "ｸﾞ") ("ぉ" "ォ" "ｫ")))
+    ((("g" "w" "u"). ())(("ぐ" "グ" "ｸﾞ") ("ぅ" "ゥ" "ｩ")))
+    ((("g" "y" "d"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("g" "y" "h"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("g" "y" "j"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("g" "y" "l"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("g" "y" "n"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("g" "y" "p"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("g" "y" "q"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("g" "y" "w"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("g" "y" "z"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("g" "z"). ())(("が" "ガ" "ｶﾞ") ("ん" "ン" "ﾝ")))
+    ((("h" "d"). ())(("へ" "ヘ" "ﾍ") ("ん" "ン" "ﾝ")))
+    ((("h" "f"). ())("ふ" "フ" "ﾌ"))
+    ((("h" "g" "a"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ")))
+    ((("h" "g" "d"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("h" "g" "e"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ")))
+    ((("h" "g" "h"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("h" "g" "j"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("h" "g" "l"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("h" "g" "n"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("h" "g" "o"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ")))
+    ((("h" "g" "p"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("h" "g" "q"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("h" "g" "u"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ")))
+    ((("h" "g" "w"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("h" "g" "z"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("h" "h"). ())(("ふ" "フ" "ﾌ") ("う" "ウ" "ｳ")))
+    ((("h" "j"). ())(("ふ" "フ" "ﾌ") ("ん" "ン" "ﾝ")))
+    ((("h" "k"). ())(("ひ" "ヒ" "ﾋ") ("ん" "ン" "ﾝ")))
+    ((("h" "l"). ())(("ほ" "ホ" "ﾎ") ("ん" "ン" "ﾝ")))
+    ((("h" "n"). ())(("は" "ハ" "ﾊ") ("ん" "ン" "ﾝ")))
+    ((("h" "p"). ())(("ほ" "ホ" "ﾎ") ("う" "ウ" "ｳ")))
+    ((("h" "q"). ())(("は" "ハ" "ﾊ") ("い" "イ" "ｲ")))
+    ((("h" "t"). ())(("ひ" "ヒ" "ﾋ") ("と" "ト" "ﾄ")))
+    ((("h" "w"). ())(("へ" "ヘ" "ﾍ") ("い" "イ" "ｲ")))
+    ((("h" "y" "d"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("h" "y" "h"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("h" "y" "j"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("h" "y" "l"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("h" "y" "n"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("h" "y" "p"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("h" "y" "q"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("h" "y" "w"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("h" "y" "z"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("h" "z"). ())(("は" "ハ" "ﾊ") ("ん" "ン" "ﾝ")))
+    ((("j" "d"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("j" "f"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("j" "h"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("j" "j"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("j" "k"). ())(("じ" "ジ" "ｼﾞ") ("ん" "ン" "ﾝ")))
+    ((("j" "l"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("j" "n"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("j" "p"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("j" "q"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("j" "w"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("j" "y" "a"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("j" "y" "e"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("j" "y" "i"). ())(("じ" "ジ" "ｼﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("j" "y" "o"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ")))
+    ((("j" "y" "u"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("j" "z"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "d"). ())(("け" "ケ" "ｹ") ("ん" "ン" "ﾝ")))
+    ((("k" "f"). ())("き" "キ" "ｷ"))
+    ((("k" "g" "a"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ")))
+    ((("k" "g" "d"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("k" "g" "e"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ")))
+    ((("k" "g" "h"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("k" "g" "j"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("k" "g" "l"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("k" "g" "n"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "g" "o"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ")))
+    ((("k" "g" "p"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("k" "g" "q"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("k" "g" "u"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ")))
+    ((("k" "g" "w"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("k" "g" "z"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "h"). ())(("く" "ク" "ｸ") ("う" "ウ" "ｳ")))
+    ((("k" "j"). ())(("く" "ク" "ｸ") ("ん" "ン" "ﾝ")))
+    ((("k" "k"). ())(("き" "キ" "ｷ") ("ん" "ン" "ﾝ")))
+    ((("k" "l"). ())(("こ" "コ" "ｺ") ("ん" "ン" "ﾝ")))
+    ((("k" "m"). ())(("か" "カ" "ｶ") ("も" "モ" "ﾓ")))
+    ((("k" "n"). ())(("か" "カ" "ｶ") ("ん" "ン" "ﾝ")))
+    ((("k" "p"). ())(("こ" "コ" "ｺ") ("う" "ウ" "ｳ")))
+    ((("k" "q"). ())(("か" "カ" "ｶ") ("い" "イ" "ｲ")))
+    ((("k" "r"). ())(("か" "カ" "ｶ") ("ら" "ラ" "ﾗ")))
+    ((("k" "t"). ())(("こ" "コ" "ｺ") ("と" "ト" "ﾄ")))
+    ((("k" "w"). ())(("け" "ケ" "ｹ") ("い" "イ" "ｲ")))
+    ((("k" "y" "d"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("k" "y" "h"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("k" "y" "j"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("k" "y" "l"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("k" "y" "n"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "y" "p"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("k" "y" "q"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("k" "y" "w"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("k" "y" "z"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "z"). ())(("か" "カ" "ｶ") ("ん" "ン" "ﾝ")))
+    ((("l" "a"). ())("ぁ" "ァ" "ｧ"))
+    ((("l" "e"). ())("ぇ" "ェ" "ｪ"))
+    ((("l" "i"). ())("ぃ" "ィ" "ｨ"))
+    ((("l" "o"). ())("ぉ" "ォ" "ｫ"))
+    ((("l" "u"). ())("ぅ" "ゥ" "ｩ"))
+    ((("l" "w" "a"). ())("ゎ" "ヮ" "ﾜ"))
+    ((("l" "y" "a"). ())("ゃ" "ャ" "ｬ"))
+    ((("l" "y" "e"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ")))
+    ((("l" "y" "i"). ())(("り" "リ" "ﾘ") ("ぃ" "ィ" "ｨ")))
+    ((("l" "y" "o"). ())("ょ" "ョ" "ｮ"))
+    ((("l" "y" "u"). ())("ゅ" "ュ" "ｭ"))
+    ((("m" "d"). ())(("め" "メ" "ﾒ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "a"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ")))
+    ((("m" "g" "d"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "e"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ")))
+    ((("m" "g" "h"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("m" "g" "j"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "l"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "n"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "o"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ")))
+    ((("m" "g" "p"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("m" "g" "q"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("m" "g" "u"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ")))
+    ((("m" "g" "w"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("m" "g" "z"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("m" "f"). ())("む" "ム" "ﾑ"))
+    ((("m" "h"). ())(("む" "ム" "ﾑ") ("う" "ウ" "ｳ")))
+    ((("m" "j"). ())(("む" "ム" "ﾑ") ("ん" "ン" "ﾝ")))
+    ((("m" "k"). ())(("み" "ミ" "ﾐ") ("ん" "ン" "ﾝ")))
+    ((("m" "l"). ())(("も" "モ" "ﾓ") ("ん" "ン" "ﾝ")))
+    ((("m" "n"). ())(("も" "モ" "ﾓ") ("の" "ノ" "ﾉ")))
+    ((("m" "p"). ())(("も" "モ" "ﾓ") ("う" "ウ" "ｳ")))
+    ((("m" "q"). ())(("ま" "マ" "ﾏ") ("い" "イ" "ｲ")))
+    ((("m" "s"). ())(("ま" "マ" "ﾏ") ("す" "ス" "ｽ")))
+    ((("m" "t"). ())(("ま" "マ" "ﾏ") ("た" "タ" "ﾀ")))
+    ((("m" "w"). ())(("め" "メ" "ﾒ") ("い" "イ" "ｲ")))
+    ((("m" "y" "d"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("m" "y" "h"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("m" "y" "j"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("m" "y" "l"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("m" "y" "n"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("m" "y" "p"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("m" "y" "q"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("m" "y" "w"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("m" "y" "z"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("m" "z"). ())(("ま" "マ" "ﾏ") ("ん" "ン" "ﾝ")))
+    ((("n"). ())("ん" "ン" "ﾝ"))
+    ((("n" "b"). ())(("ね" "ネ" "ﾈ") ("ば" "バ" "ﾊﾞ")))
+    ((("n" "d"). ())(("ね" "ネ" "ﾈ") ("ん" "ン" "ﾝ")))
+    ((("n" "f"). ())("ぬ" "ヌ" "ﾇ"))
+    ((("n" "g" "a"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ")))
+    ((("n" "g" "d"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("n" "g" "e"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ")))
+    ((("n" "g" "h"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("n" "g" "j"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("n" "g" "l"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("n" "g" "n"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("n" "g" "o"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ")))
+    ((("n" "g" "p"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("n" "g" "q"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("n" "g" "u"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ")))
+    ((("n" "g" "w"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("n" "g" "z"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("n" "h"). ())(("ぬ" "ヌ" "ﾇ") ("う" "ウ" "ｳ")))
+    ((("n" "j"). ())(("ぬ" "ヌ" "ﾇ") ("ん" "ン" "ﾝ")))
+    ((("n" "k"). ())(("に" "ニ" "ﾆ") ("ん" "ン" "ﾝ")))
+    ((("n" "l"). ())(("の" "ノ" "ﾉ") ("ん" "ン" "ﾝ")))
+    ((("n" "p"). ())(("の" "ノ" "ﾉ") ("う" "ウ" "ｳ")))
+    ((("n" "q"). ())(("な" "ナ" "ﾅ") ("い" "イ" "ｲ")))
+    ((("n" "r"). ())(("な" "ナ" "ﾅ") ("る" "ル" "ﾙ")))
+    ((("n" "t"). ())(("に" "ニ" "ﾆ") ("ち" "チ" "ﾁ")))
+    ((("n" "w"). ())(("ね" "ネ" "ﾈ") ("い" "イ" "ｲ")))
+    ((("n" "y" "d"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("n" "y" "h"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("n" "y" "j"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("n" "y" "l"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("n" "y" "n"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("n" "y" "p"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("n" "y" "q"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("n" "y" "w"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("n" "y" "z"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("n" "z"). ())(("な" "ナ" "ﾅ") ("ん" "ン" "ﾝ")))
+    ((("p" "d"). ())(("ぺ" "ペ" "ﾍﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "f"). ())(("ぽ" "ポ" "ﾎﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "a"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ")))
+    ((("p" "g" "d"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "e"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ")))
+    ((("p" "g" "h"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("p" "g" "j"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "l"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "n"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "o"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ")))
+    ((("p" "g" "p"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("p" "g" "q"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("p" "g" "u"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ")))
+    ((("p" "g" "w"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("p" "g" "z"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("p" "h"). ())(("ぷ" "プ" "ﾌﾟ") ("う" "ウ" "ｳ")))
+    ((("p" "j"). ())(("ぷ" "プ" "ﾌﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "k"). ())(("ぴ" "ピ" "ﾋﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "l"). ())(("ぽ" "ポ" "ﾎﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "n"). ())(("ぱ" "パ" "ﾊﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "p"). ())(("ぽ" "ポ" "ﾎﾟ") ("う" "ウ" "ｳ")))
+    ((("p" "q"). ())(("ぱ" "パ" "ﾊﾟ") ("い" "イ" "ｲ")))
+    ((("p" "w"). ())(("ぺ" "ペ" "ﾍﾟ") ("い" "イ" "ｲ")))
+    ((("p" "y" "d"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("p" "y" "h"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("p" "y" "j"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("p" "y" "l"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("p" "y" "n"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("p" "y" "p"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("p" "y" "q"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("p" "y" "w"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("p" "y" "z"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("p" "z"). ())(("ぱ" "パ" "ﾊﾟ") ("ん" "ン" "ﾝ")))
+    ((("q"). ())("ん" "ン" "ﾝ"))
+    ((("r" "d"). ())(("れ" "レ" "ﾚ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "a"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ")))
+    ((("r" "g" "d"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "e"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ")))
+    ((("r" "g" "h"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("r" "g" "j"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "l"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "n"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "o"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ")))
+    ((("r" "g" "p"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("r" "g" "q"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("r" "g" "u"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ")))
+    ((("r" "g" "w"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("r" "g" "z"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("r" "h"). ())(("る" "ル" "ﾙ") ("う" "ウ" "ｳ")))
+    ((("r" "j"). ())(("る" "ル" "ﾙ") ("ん" "ン" "ﾝ")))
+    ((("r" "k"). ())(("り" "リ" "ﾘ") ("ん" "ン" "ﾝ")))
+    ((("r" "l"). ())(("ろ" "ロ" "ﾛ") ("ん" "ン" "ﾝ")))
+    ((("r" "n"). ())(("ら" "ラ" "ﾗ") ("ん" "ン" "ﾝ")))
+    ((("r" "p"). ())(("ろ" "ロ" "ﾛ") ("う" "ウ" "ｳ")))
+    ((("r" "q"). ())(("ら" "ラ" "ﾗ") ("い" "イ" "ｲ")))
+    ((("r" "r"). ())(("ら" "ラ" "ﾗ") ("れ" "レ" "ﾚ")))
+    ((("r" "w"). ())(("れ" "レ" "ﾚ") ("い" "イ" "ｲ")))
+    ((("r" "y" "d"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("r" "y" "h"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("r" "y" "j"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("r" "y" "l"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("r" "y" "n"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("r" "y" "p"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("r" "y" "q"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("r" "y" "w"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("r" "y" "z"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("r" "z"). ())(("ら" "ラ" "ﾗ") ("ん" "ン" "ﾝ")))
+    ((("s" "d"). ())(("せ" "セ" "ｾ") ("ん" "ン" "ﾝ")))
+    ((("s" "f"). ())(("さ" "サ" "ｻ") ("い" "イ" "ｲ")))
+    ((("s" "h"). ())(("す" "ス" "ｽ") ("う" "ウ" "ｳ")))
+    ((("s" "j"). ())(("す" "ス" "ｽ") ("ん" "ン" "ﾝ")))
+    ((("s" "k"). ())(("し" "シ" "ｼ") ("ん" "ン" "ﾝ")))
+    ((("s" "l"). ())(("そ" "ソ" "ｿ") ("ん" "ン" "ﾝ")))
+    ((("s" "n"). ())(("さ" "サ" "ｻ") ("ん" "ン" "ﾝ")))
+    ((("s" "p"). ())(("そ" "ソ" "ｿ") ("う" "ウ" "ｳ")))
+    ((("s" "q"). ())(("さ" "サ" "ｻ") ("い" "イ" "ｲ")))
+    ((("s" "r"). ())(("す" "ス" "ｽ") ("る" "ル" "ﾙ")))
+    ((("s" "s"). ())(("せ" "セ" "ｾ") ("い" "イ" "ｲ")))
+    ((("s" "t"). ())(("し" "シ" "ｼ") ("た" "タ" "ﾀ")))
+    ((("s" "w"). ())(("せ" "セ" "ｾ") ("い" "イ" "ｲ")))
+    ((("s" "y" "d"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("s" "y" "h"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("s" "y" "j"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("s" "y" "l"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("s" "y" "n"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("s" "y" "p"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("s" "y" "q"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("s" "y" "w"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("s" "y" "z"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("s" "z"). ())(("さ" "サ" "ｻ") ("ん" "ン" "ﾝ")))
+    ((("t" "b"). ())(("た" "タ" "ﾀ") ("び" "ビ" "ﾋﾞ")))
+    ((("t" "c" "h"). ())("っ" "ッ" "ｯ"))
+    ((("t" "d"). ())(("て" "テ" "ﾃ") ("ん" "ン" "ﾝ")))
+    ((("t" "g" "i"). ())(("て" "テ" "ﾃ") ("ぃ" "ィ" "ｨ")))
+    ((("t" "g" "u"). ())(("と" "ト" "ﾄ") ("ぅ" "ゥ" "ｩ")))
+    ((("t" "h"). ())(("つ" "ツ" "ﾂ") ("う" "ウ" "ｳ")))
+    ((("t" "j"). ())(("つ" "ツ" "ﾂ") ("ん" "ン" "ﾝ")))
+    ((("t" "k"). ())(("ち" "チ" "ﾁ") ("ん" "ン" "ﾝ")))
+    ((("t" "l"). ())(("と" "ト" "ﾄ") ("ん" "ン" "ﾝ")))
+    ((("t" "m"). ())(("た" "タ" "ﾀ") ("め" "メ" "ﾒ")))
+    ((("t" "n"). ())(("た" "タ" "ﾀ") ("ん" "ン" "ﾝ")))
+    ((("t" "p"). ())(("と" "ト" "ﾄ") ("う" "ウ" "ｳ")))
+    ((("t" "q"). ())(("た" "タ" "ﾀ") ("い" "イ" "ｲ")))
+    ((("t" "r"). ())(("た" "タ" "ﾀ") ("ら" "ラ" "ﾗ")))
+    ((("t" "s" "a"). ())(("つ" "ツ" "ﾂ") ("ぁ" "ァ" "ｧ")))
+    ((("t" "s" "e"). ())(("つ" "ツ" "ﾂ") ("ぇ" "ェ" "ｪ")))
+    ((("t" "s" "i"). ())(("つ" "ツ" "ﾂ") ("ぃ" "ィ" "ｨ")))
+    ((("t" "s" "o"). ())(("つ" "ツ" "ﾂ") ("ぉ" "ォ" "ｫ")))
+    ((("t" "t"). ())(("た" "タ" "ﾀ") ("ち" "チ" "ﾁ")))
+    ((("t" "w"). ())(("て" "テ" "ﾃ") ("い" "イ" "ｲ")))
+    ((("t" "y" "d"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("t" "y" "h"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("t" "y" "j"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("t" "y" "l"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("t" "y" "n"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("t" "y" "p"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("t" "y" "q"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("t" "y" "w"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("t" "y" "z"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("t" "z"). ())(("た" "タ" "ﾀ") ("ん" "ン" "ﾝ")))
+    ((("w" "d"). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("w" "f"). ())(("わ" "ワ" "ﾜ") ("い" "イ" "ｲ")))
+    ((("w" "k"). ())(("う" "ウ" "ｳ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+    ((("w" "l"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ") ("ん" "ン" "ﾝ")))
+    ((("w" "n"). ())(("わ" "ワ" "ﾜ") ("ん" "ン" "ﾝ")))
+    ((("w" "p"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+    ((("w" "q"). ())(("わ" "ワ" "ﾜ") ("い" "イ" "ｲ")))
+    ((("w" "r"). ())(("わ" "ワ" "ﾜ") ("れ" "レ" "ﾚ")))
+    ((("w" "s" "o"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ")))
+    ((("w" "t"). ())(("わ" "ワ" "ﾜ") ("た" "タ" "ﾀ")))
+    ((("w" "u"). ())("う" "ウ" "ｳ"))
+    ((("w" "z"). ())(("わ" "ワ" "ﾜ") ("ん" "ン" "ﾝ")))
+    ((("x" "a"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ")))
+    ((("x" "d"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("x" "e"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ")))
+    ((("x" "h"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("x" "j"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("x" "l"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("x" "n"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("x" "o"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ")))
+    ((("x" "p"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("x" "q"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("x" "u"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ")))
+    ((("x" "x" "a"). ())("ぁ" "ァ" "ｧ"))
+    ((("x" "x" "i"). ())("ぃ" "ィ" "ｨ"))
+    ((("x" "x" "u"). ())("ぅ" "ゥ" "ｩ"))
+    ((("x" "x" "e"). ())("ぇ" "ェ" "ｪ"))
+    ((("x" "x" "o"). ())("ぉ" "ォ" "ｫ"))
+    ((("x" "x" "w" "a"). ())("ゎ" "ヮ" "ﾜ"))
+    ((("x" "x" "w" "i"). ())("ゐ" "ヰ" "ｨ"))
+    ((("x" "x" "w" "e"). ())("ゑ" "ヱ" "ｪ"))
+    ((("x" "x" "h"). ())("←" "←" ""))
+    ((("x" "x" "j"). ())("↓" "↓" ""))
+    ((("x" "x" "k"). ())("↑" "↑" ""))
+    ((("x" "x" "l"). ())("→" "→" ""))
+    ((("x" "w"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("x" "z"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("y" "e"). ())(("い" "イ" "ｲ") ("ぇ" "ェ" "ｪ")))
+    ((("y" "f"). ())("ゆ" "ユ" "ﾕ"))
+    ((("y" "h"). ())(("ゆ" "ユ" "ﾕ") ("う" "ウ" "ｳ")))
+    ((("y" "i"). ())("い" "イ" "ｲ"))
+    ((("y" "j"). ())(("ゆ" "ユ" "ﾕ") ("ん" "ン" "ﾝ")))
+    ((("y" "l"). ())(("よ" "ヨ" "ﾖ") ("ん" "ン" "ﾝ")))
+    ((("y" "n"). ())(("や" "ヤ" "ﾔ") ("ん" "ン" "ﾝ")))
+    ((("y" "p"). ())(("よ" "ヨ" "ﾖ") ("う" "ウ" "ｳ")))
+    ((("y" "q"). ())(("や" "ヤ" "ﾔ") ("い" "イ" "ｲ")))
+    ((("y" "r"). ())(("よ" "ヨ" "ﾖ") ("る" "ル" "ﾙ")))
+    ((("y" "w"). ())(("い" "イ" "ｲ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("y" "z"). ())(("や" "ヤ" "ﾔ") ("ん" "ン" "ﾝ")))
+    ((("z" "c"). ())("ざ" "ザ" "ｻﾞ"))
+    ((("z" "d"). ())(("ぜ" "ゼ" "ｾﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "f"). ())("ぜ" "ゼ" "ｾﾞ"))
+    ((("z" "g" "a"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("z" "g" "d"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("z" "g" "e"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("z" "g" "h"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("z" "g" "j"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("z" "g" "l"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("z" "g" "n"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("z" "g" "o"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ")))
+    ((("z" "g" "p"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("z" "g" "q"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("z" "g" "u"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("z" "g" "w"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("z" "g" "z"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("z" "h"). ())(("ず" "ズ" "ｽﾞ") ("う" "ウ" "ｳ")))
+    ((("z" "j"). ())(("ず" "ズ" "ｽﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "k"). ())(("じ" "ジ" "ｼﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "l"). ())(("ぞ" "ゾ" "ｿﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "n"). ())(("ざ" "ザ" "ｻﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "p"). ())(("ぞ" "ゾ" "ｿﾞ") ("う" "ウ" "ｳ")))
+    ((("z" "q"). ())(("ざ" "ザ" "ｻﾞ") ("い" "イ" "ｲ")))
+    ((("z" "r"). ())(("ざ" "ザ" "ｻﾞ") ("る" "ル" "ﾙ")))
+    ((("z" "v"). ())(("ざ" "ザ" "ｻﾞ") ("い" "イ" "ｲ")))
+    ((("z" "w"). ())(("ぜ" "ゼ" "ｾﾞ") ("い" "イ" "ｲ")))
+    ((("z" "x"). ())(("ぜ" "ゼ" "ｾﾞ") ("い" "イ" "ｲ")))
+    ((("z" "y" "d"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("z" "y" "h"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("z" "y" "j"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("z" "y" "l"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("z" "y" "n"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("z" "y" "p"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("z" "y" "q"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("z" "y" "w"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("z" "y" "z"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("z" "z"). ())(("ざ" "ザ" "ｻﾞ") ("ん" "ン" "ﾝ")))
+))
+
+(define ja-azik-rule (append ja-azik-rule-basic ja-rk-rule-basic))
+
+(define ja-azik-skk-okuri-char-alist '((";" . "t")))
+(define ja-azik-skk-downcase-alist (alist->icharlist '(("+" . ";"))))
+(define ja-azik-skk-set-henkan-point-key (map string->charcode '(";")))
diff --git a/scm/japanese-custom-utf8.scm b/scm/japanese-custom-utf8.scm
new file mode 100644
index 000000000..1eb55ed79
--- /dev/null
+++ b/scm/japanese-custom-utf8.scm
@@ -0,0 +1,524 @@
+;;;
+;;; Copyright (c) 2010-2013 uim Project https://github.com/uim/uim
+;;;
+;;; All rights reserved.
+;;;
+;;; Redistribution and use in source and binary forms, with or without
+;;; modification, are permitted provided that the following conditions
+;;; are met:
+;;; 1. Redistributions of source code must retain the above copyright
+;;;    notice, this list of conditions and the following disclaimer.
+;;; 2. Redistributions in binary form must reproduce the above copyright
+;;;    notice, this list of conditions and the following disclaimer in the
+;;;    documentation and/or other materials provided with the distribution.
+;;; 3. Neither the name of authors nor the names of its contributors
+;;;    may be used to endorse or promote products derived from this software
+;;;    without specific prior written permission.
+;;;
+;;; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND
+;;; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+;;; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+;;; ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE
+;;; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+;;; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+;;; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+;;; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+;;; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+;;; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+;;; SUCH DAMAGE.
+;;;;
+
+(require "util.scm")
+
+(define ja-rk-rule-basic
+  '(
+    ((("-"). ())("ー" "ー" "ｰ"))
+    (((","). ())("、" "、" "､"))
+    ((("."). ())("。" "。" "｡"))
+    ((("!"). ())("！" "！" "!"))
+    ((("\""). ())("”" "”" "\""))
+    ((("#"). ())("＃" "＃" "#"))
+    ((("$"). ())("＄" "＄" "$"))
+    ((("%"). ())("％" "％" "%"))
+    ((("&"). ())("＆" "＆" "&"))
+    ((("'"). ())("’" "’" "'"))
+    ((("("). ())("（" "（" "("))
+    (((")"). ())("）" "）" ")"))
+    ((("~"). ())("〜" "〜" "~"))
+    ((("="). ())("＝" "＝" "="))
+    ((("^"). ())("＾" "＾" "^"))
+    ((("\\"). ())("＼" "＼" "\\"))
+    ((("|"). ())("｜" "｜" "|"))
+    ((("`"). ())("‘" "‘" "`"))
+    ((("@"). ())("＠" "＠" "@"))
+    ((("{"). ())("｛" "｛" "{"))
+    ((("["). ())("「" "「" "｢"))
+    ((("+"). ())("＋" "＋" "+"))
+    (((";"). ())("；" "；" ";"))
+    ((("*"). ())("＊" "＊" "*"))
+    (((":"). ())("：" "：" ":"))
+    ((("}"). ())("｝" "｝" "}"))
+    ((("]"). ())("」" "」" "｣"))
+    ((("<"). ())("＜" "＜" "<"))
+    (((">"). ())("＞" "＞" ">"))
+    ((("?"). ())("？" "？" "?"))
+    ((("/"). ())("／" "／" "/"))
+    ((("_"). ())("＿" "＿" "_"))
+    ;; Since ordinary Japanese users press the "yen sign" key on
+    ;; Japanese keyboard in romaji-halfwidth-kana-mode "to input
+    ;; character code 134" rather than "to input yen sign symbol", I
+    ;; changed the fullwidth yen sign with backslash.
+    ;;   -- YamaKen 2007-09-17
+    ;; ((("yen"). ())("￥" "￥" "￥")) ;; XXX
+    ((("yen"). ())("￥" "￥" "\\"))
+
+    ((("1"). ())("1" "1" "1"))
+    ((("2"). ())("2" "2" "2"))
+    ((("3"). ())("3" "3" "3"))
+    ((("4"). ())("4" "4" "4"))
+    ((("5"). ())("5" "5" "5"))
+    ((("6"). ())("6" "6" "6"))
+    ((("7"). ())("7" "7" "7"))
+    ((("8"). ())("8" "8" "8"))
+    ((("9"). ())("9" "9" "9"))
+    ((("0"). ())("0" "0" "0"))
+
+    ((("a"). ())("あ" "ア" "ｱ"))
+    ((("i"). ())("い" "イ" "ｲ"))
+    ((("u"). ())("う" "ウ" "ｳ"))
+    ((("e"). ())("え" "エ" "ｴ"))
+    ((("o"). ())("お" "オ" "ｵ"))
+
+    ((("x" "a"). ())("ぁ" "ァ" "ｧ"))
+    ((("x" "i"). ())("ぃ" "ィ" "ｨ"))
+    ((("x" "y" "i"). ())("ぃ" "ィ" "ｨ"))
+    ((("x" "u"). ())("ぅ" "ゥ" "ｩ"))
+    ((("x" "e"). ())("ぇ" "ェ" "ｪ"))
+    ((("x" "y" "e"). ())("ぇ" "ェ" "ｪ"))
+    ((("x" "o"). ())("ぉ" "ォ" "ｫ"))
+
+    ((("l" "a"). ())("ぁ" "ァ" "ｧ"))
+    ((("l" "i"). ())("ぃ" "ィ" "ｨ"))
+    ((("l" "u"). ())("ぅ" "ゥ" "ｩ"))
+    ((("l" "e"). ())("ぇ" "ェ" "ｪ"))
+    ((("l" "o"). ())("ぉ" "ォ" "ｫ"))
+
+    ((("k" "k"). ("k"))("っ" "ッ" "ｯ"))
+
+    ((("k" "a"). ())("か" "カ" "ｶ"))
+    ((("k" "i"). ())("き" "キ" "ｷ"))
+    ((("k" "u"). ())("く" "ク" "ｸ"))
+    ((("k" "e"). ())("け" "ケ" "ｹ"))
+    ((("k" "o"). ())("こ" "コ" "ｺ"))
+    ((("k" "y" "a"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ")))
+    ((("k" "y" "i"). ())(("き" "キ" "ｷ") ("ぃ" "ィ" "ｨ")))
+    ((("k" "y" "u"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ")))
+    ((("k" "y" "e"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ")))
+    ((("k" "y" "o"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ")))
+
+    ((("g" "g"). ("g"))("っ" "ッ" "ｯ"))
+
+
+    ((("g" "a"). ())("が" "ガ" "ｶﾞ"))
+    ((("g" "i"). ())("ぎ" "ギ" "ｷﾞ"))
+    ((("g" "u"). ())("ぐ" "グ" "ｸﾞ"))
+    ((("g" "e"). ())("げ" "ゲ" "ｹﾞ"))
+    ((("g" "o"). ())("ご" "ゴ" "ｺﾞ"))
+
+    ((("g" "y" "a"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("g" "y" "i"). ())(("ぎ" "ギ" "ｷﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("g" "y" "u"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("g" "y" "e"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("g" "y" "o"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ")))
+
+    ((("q" "a"). ())(("く" "ク" "ｸ") ("ぁ" "ァ" "ｧ")))
+    ((("q" "i"). ())(("く" "ク" "ｸ") ("ぃ" "ィ" "ｨ")))
+    ((("q" "u"). ())("く" "ク" "ｸ"))
+    ((("q" "e"). ())(("く" "ク" "ｸ") ("ぇ" "ェ" "ｪ")))
+    ((("q" "o"). ())(("く" "ク" "ｸ") ("ぉ" "ォ" "ｫ")))
+
+    ((("s" "s"). ("s"))("っ" "ッ" "ｯ"))
+
+    ((("s" "a"). ())("さ" "サ" "ｻ"))
+    ((("s" "i"). ())("し" "シ" "ｼ"))
+    ((("s" "u"). ())("す" "ス" "ｽ"))
+    ((("s" "e"). ())("せ" "セ" "ｾ"))
+    ((("s" "o"). ())("そ" "ソ" "ｿ"))
+
+    ((("s" "y" "a"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ")))
+    ((("s" "y" "i"). ())(("し" "シ" "ｼ") ("ぃ" "ィ" "ｨ")))
+    ((("s" "y" "u"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ")))
+    ((("s" "y" "e"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ")))
+    ((("s" "y" "o"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ")))
+
+    ((("z" "z"). ("z"))("っ" "ッ" "ｯ"))
+
+    ((("z" "a"). ())("ざ" "ザ" "ｻﾞ"))
+    ((("z" "i"). ())("じ" "ジ" "ｼﾞ"))
+    ((("z" "u"). ())("ず" "ズ" "ｽﾞ"))
+    ((("z" "e"). ())("ぜ" "ゼ" "ｾﾞ"))
+    ((("z" "o"). ())("ぞ" "ゾ" "ｿﾞ"))
+    ((("z" "y" "a"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("z" "y" "i"). ())(("じ" "ジ" "ｼﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("z" "y" "u"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("z" "y" "e"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("z" "y" "o"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ")))
+
+    ((("j" "j"). ("j"))("っ" "ッ" "ｯ"))
+
+    ((("j" "a"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("j" "i"). ())("じ" "ジ" "ｼﾞ"))
+    ((("j" "u"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("j" "e"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("j" "o"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ")))
+
+    ((("j" "y" "a"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("j" "y" "i"). ())(("じ" "ジ" "ｼﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("j" "y" "u"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("j" "y" "e"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("j" "y" "o"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ")))
+
+    ((("t" "t"). ("t"))("っ" "ッ" "ｯ"))
+    ((("t" "c"). ("c"))("っ" "ッ" "ｯ"))
+
+    ((("t" "a"). ())("た" "タ" "ﾀ"))
+    ((("t" "i"). ())("ち" "チ" "ﾁ"))
+    ((("t" "u"). ())("つ" "ツ" "ﾂ"))
+    ((("t" "e"). ())("て" "テ" "ﾃ"))
+    ((("t" "o"). ())("と" "ト" "ﾄ"))
+
+    ((("t" "y" "a"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ")))
+    ((("t" "y" "i"). ())(("ち" "チ" "ﾁ") ("ぃ" "ィ" "ｨ")))
+    ((("t" "y" "u"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ")))
+    ((("t" "y" "e"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ")))
+    ((("t" "y" "o"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ")))
+
+    ((("t" "s" "a"). ())(("つ" "ツ" "ﾂ") ("ぁ" "ァ" "ｧ")))
+    ((("t" "s" "i"). ())(("つ" "ツ" "ﾂ") ("ぃ" "ィ" "ｨ")))
+    ((("t" "s" "u"). ())("つ" "ツ" "ﾂ"))
+    ((("t" "s" "e"). ())(("つ" "ツ" "ﾂ") ("ぇ" "ェ" "ｪ")))
+    ((("t" "s" "o"). ())(("つ" "ツ" "ﾂ") ("ぉ" "ォ" "ｫ")))
+
+    ((("c" "y" "a"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ")))
+    ((("c" "y" "i"). ())(("ち" "チ" "ﾁ") ("ぃ" "ィ" "ｨ")))
+    ((("c" "y" "u"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ")))
+    ((("c" "y" "e"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ")))
+    ((("c" "y" "o"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ")))
+
+    ((("x" "t" "u"). ())("っ" "ッ" "ｯ"))
+    ((("x" "t" "s" "u"). ())("っ" "ッ" "ｯ"))
+    ((("c" "c"). ("c"))("っ" "ッ" "ｯ"))
+
+    ((("d" "d"). ("d"))("っ" "ッ" "ｯ"))
+
+    ((("d" "a"). ())("だ" "ダ" "ﾀﾞ"))
+    ((("d" "i"). ())("ぢ" "ヂ" "ﾁﾞ"))
+    ((("d" "u"). ())("づ" "ヅ" "ﾂﾞ"))
+    ((("d" "e"). ())("で" "デ" "ﾃﾞ"))
+    ((("d" "o"). ())("ど" "ド" "ﾄﾞ"))
+
+    ((("d" "y" "a"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("d" "y" "i"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("d" "y" "u"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("d" "y" "e"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("d" "y" "o"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ょ" "ョ" "ｮ")))
+
+    ((("n" "n"). ())("ん" "ン" "ﾝ"))
+    ((("n" "'"). ())("ん" "ン" "ﾝ"))
+    ((("n"). ())("ん" "ン" "ﾝ"))
+
+    ((("n" "a"). ())("な" "ナ" "ﾅ"))
+    ((("n" "i"). ())("に" "ニ" "ﾆ"))
+    ((("n" "u"). ())("ぬ" "ヌ" "ﾇ"))
+    ((("n" "e"). ())("ね" "ネ" "ﾈ"))
+    ((("n" "o"). ())("の" "ノ" "ﾉ"))
+
+    ((("n" "y" "a"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ")))
+    ((("n" "y" "i"). ())(("に" "ニ" "ﾆ") ("ぃ" "ィ" "ｨ")))
+    ((("n" "y" "u"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ")))
+    ((("n" "y" "e"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ")))
+    ((("n" "y" "o"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ")))
+
+    ((("h" "h"). ("h"))("っ" "ッ" "ｯ"))
+
+    ((("h" "a"). ())("は" "ハ" "ﾊ"))
+    ((("h" "i"). ())("ひ" "ヒ" "ﾋ"))
+    ((("h" "u"). ())("ふ" "フ" "ﾌ"))
+    ((("h" "e"). ())("へ" "ヘ" "ﾍ"))
+    ((("h" "o"). ())("ほ" "ホ" "ﾎ"))
+
+    ((("h" "y" "a"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ")))
+    ((("h" "y" "i"). ())(("ひ" "ヒ" "ﾋ") ("ぃ" "ィ" "ｨ")))
+    ((("h" "y" "u"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ")))
+    ((("h" "y" "e"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ")))
+    ((("h" "y" "o"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ")))
+
+    ((("f" "f"). ("f"))("っ" "ッ" "ｯ"))
+
+    ((("f" "a"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ")))
+    ((("f" "i"). ())(("ふ" "フ" "ﾌ") ("ぃ" "ィ" "ｨ")))
+    ((("f" "u"). ())("ふ" "フ" "ﾌ"))
+    ((("f" "e"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ")))
+    ((("f" "o"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ")))
+
+    ((("f" "y" "a"). ())(("ふ" "フ" "ﾌ") ("ゃ" "ャ" "ｬ")))
+    ((("f" "y" "i"). ())(("ふ" "フ" "ﾌ") ("ぃ" "ィ" "ｨ")))
+    ((("f" "y" "u"). ())(("ふ" "フ" "ﾌ") ("ゅ" "ュ" "ｭ")))
+    ((("f" "y" "e"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ")))
+    ((("f" "y" "o"). ())(("ふ" "フ" "ﾌ") ("ょ" "ョ" "ｮ")))
+
+    ((("b" "b"). ("b"))("っ" "ッ" "ｯ"))
+
+    ((("b" "a"). ())("ば" "バ" "ﾊﾞ"))
+    ((("b" "i"). ())("び" "ビ" "ﾋﾞ"))
+    ((("b" "u"). ())("ぶ" "ブ" "ﾌﾞ"))
+    ((("b" "e"). ())("べ" "ベ" "ﾍﾞ"))
+    ((("b" "o"). ())("ぼ" "ボ" "ﾎﾞ"))
+
+    ((("b" "y" "a"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("b" "y" "i"). ())(("び" "ビ" "ﾋﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("b" "y" "u"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("b" "y" "e"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("b" "y" "o"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ")))
+
+    ((("p" "p"). ("p"))("っ" "ッ" "ｯ"))
+
+    ((("p" "a"). ())("ぱ" "パ" "ﾊﾟ"))
+    ((("p" "i"). ())("ぴ" "ピ" "ﾋﾟ"))
+    ((("p" "u"). ())("ぷ" "プ" "ﾌﾟ"))
+    ((("p" "e"). ())("ぺ" "ペ" "ﾍﾟ"))
+    ((("p" "o"). ())("ぽ" "ポ" "ﾎﾟ"))
+
+    ((("p" "y" "a"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ")))
+    ((("p" "y" "i"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぃ" "ィ" "ｨ")))
+    ((("p" "y" "u"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ")))
+    ((("p" "y" "e"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ")))
+    ((("p" "y" "o"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ")))
+
+    ((("m" "m"). ("m"))("っ" "ッ" "ｯ"))
+
+    ((("m" "b"). ("b"))("ん" "ン" "ﾝ"))
+    ((("m" "p"). ("p"))("ん" "ン" "ﾝ"))
+
+    ((("m" "a"). ())("ま" "マ" "ﾏ"))
+    ((("m" "i"). ())("み" "ミ" "ﾐ"))
+    ((("m" "u"). ())("む" "ム" "ﾑ"))
+    ((("m" "e"). ())("め" "メ" "ﾒ"))
+    ((("m" "o"). ())("も" "モ" "ﾓ"))
+
+    ((("m" "y" "a"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ")))
+    ((("m" "y" "i"). ())(("み" "ミ" "ﾐ") ("ぃ" "ィ" "ｨ")))
+    ((("m" "y" "u"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ")))
+    ((("m" "y" "e"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ")))
+    ((("m" "y" "o"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ")))
+
+    ((("y" "y"). ("y"))("っ" "ッ" "ｯ"))
+
+    ((("y" "a"). ())("や" "ヤ" "ﾔ"))
+    ((("y" "u"). ())("ゆ" "ユ" "ﾕ"))
+    ((("y" "e"). ())(("い" "イ" "ｲ") ("ぇ" "ェ" "ｪ")))
+    ((("y" "o"). ())("よ" "ヨ" "ﾖ"))
+
+    ((("x" "c" "a"). ())("ヵ" "ヵ" "ｶ"))
+    ((("x" "k" "a"). ())("ヵ" "ヵ" "ｶ"))
+    ((("x" "k" "e"). ())("ヶ" "ヶ" "ｹ"))
+
+    ((("x" "y" "a"). ())("ゃ" "ャ" "ｬ"))
+    ((("x" "y" "u"). ())("ゅ" "ュ" "ｭ"))
+    ((("x" "y" "o"). ())("ょ" "ョ" "ｮ"))
+
+    ((("r" "r"). ("r"))("っ" "ッ" "ｯ"))
+
+    ((("r" "a"). ())("ら" "ラ" "ﾗ"))
+    ((("r" "i"). ())("り" "リ" "ﾘ"))
+    ((("r" "u"). ())("る" "ル" "ﾙ"))
+    ((("r" "e"). ())("れ" "レ" "ﾚ"))
+    ((("r" "o"). ())("ろ" "ロ" "ﾛ"))
+
+    ((("l" "t" "u"). ())("っ" "ッ" "ｯ"))
+    ((("l" "t" "s" "u"). ())("っ" "ッ" "ｯ"))
+
+    ((("l" "y" "a"). ())("ゃ" "ャ" "ｬ"))
+    ((("l" "y" "i"). ())("ぃ" "ィ" "ｨ"))
+    ((("l" "y" "u"). ())("ゅ" "ュ" "ｭ"))
+    ((("l" "y" "e"). ())("ぇ" "ェ" "ｪ"))
+    ((("l" "y" "o"). ())("ょ" "ョ" "ｮ"))
+
+    ((("r" "y" "a"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ")))
+    ((("r" "y" "i"). ())(("り" "リ" "ﾘ") ("ぃ" "ィ" "ｨ")))
+    ((("r" "y" "u"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ")))
+    ((("r" "y" "e"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ")))
+    ((("r" "y" "o"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ")))
+
+    ((("w" "w"). ("w"))("っ" "ッ" "ｯ"))
+
+    ((("w" "a"). ())("わ" "ワ" "ﾜ"))
+    ((("w" "i"). ())(("う" "ウ" "ｳ") ("ぃ" "ィ" "ｨ")))
+    ((("w" "u"). ())("う" "ウ" "ｳ"))
+    ((("w" "e"). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ")))
+    ((("w" "o"). ())("を" "ヲ" "ｦ"))
+    ((("w" "h" "a"). ())(("う" "ウ" "ｳ") ("ぁ" "ァ" "ｧ")))
+    ((("w" "h" "i"). ())(("う" "ウ" "ｳ") ("ぃ" "ィ" "ｨ")))
+    ((("w" "h" "u"). ())("う" "ウ" "ｳ"))
+    ((("w" "h" "e"). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ")))
+    ((("w" "h" "o"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ")))
+
+    ((("v" "v"). ("v"))("っ" "ッ" "ｯ"))
+
+    ((("v" "a"). ())(("う゛" "ヴ" "ｳﾞ") ("ぁ" "ァ" "ｧ")))
+    ((("v" "i"). ())(("う゛" "ヴ" "ｳﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("v" "u"). ())("う゛" "ヴ" "ｳﾞ"))
+    ((("v" "e"). ())(("う゛" "ヴ" "ｳﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("v" "o"). ())(("う゛" "ヴ" "ｳﾞ") ("ぉ" "ォ" "ｫ")))
+
+    ((("v" "y" "a"). ())(("う゛" "ヴ" "ｳﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("v" "y" "u"). ())(("う゛" "ヴ" "ｳﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("v" "y" "o"). ())(("う゛" "ヴ" "ｳﾞ") ("ょ" "ョ" "ｮ")))
+
+    ((("z" "k"). ())("↑" "↑" ""))
+    ((("z" "j"). ())("↓" "↓" ""))
+    ((("z" "h"). ())("←" "←" ""))
+    ((("z" "l"). ())("→" "→" ""))
+    ((("z" "-"). ())("〜" "〜" ""))
+    ((("z" "["). ())("『" "『" ""))
+    ((("z" "]"). ())("』" "』" ""))
+    ((("z" ","). ())("‥" "‥" ""))
+    ((("z" "."). ())("…" "…" ""))
+    ((("z" "/"). ())("・" "・" "･"))
+    ))
+
+(define string-to-list
+  (lambda (s)
+    (with-char-codec "UTF-8"
+      (lambda ()
+	(map! (lambda (c)
+		(let ((str (list->string (list c))))
+		  (with-char-codec "ISO-8859-1"
+		    (lambda ()
+		      (%%string-reconstruct! str)))))
+	      (reverse! (string->list s)))))))
+
+(define ja-rk-rule-basic-uim ja-rk-rule-basic)
+
+(define ja-rk-rule-rule->table (lambda (rule)
+  (map
+    (lambda (item)
+      ; ((("k" "a")) ("か" "カ" "ｶ")) -> ("ka" "" "か")
+      ; ((("k" "k") "k") ("っ" "ッ" "ｯ")) -> ("kk" "k" "っ")
+      ; ((("k" "y" "a")) (("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ"))) -> ("kya" "" "きゃ")
+      (list
+        ; ((("k" "a")) ("か" "カ" "ｶ")) -> "ka"
+        (fold-right string-append ""
+          (caar item))
+        (let ((next-input (cdar item)))
+          (or
+            (and
+              ; ((("k" "a")) ("か" "カ" "ｶ")) -> ""
+              (null? next-input) "")
+            ; ((("k" "k") "k") ("っ" "ッ" "ｯ")) -> "k"
+            (car next-input)))
+        (let*
+          ((output (cadr item))
+            (single-output (car output))
+            (eucjp->utf8 (lambda (str)
+                           (iconv-convert "UTF-8" "EUC-JP" str))))
+          (or
+            (and
+              ; ((("k" "a")) ("か" "カ" "ｶ")) -> "か"
+              (string? single-output)
+              (eucjp->utf8 single-output))
+            ; ((("k" "y" "a")) (("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ"))) -> "きゃ"
+            (eucjp->utf8
+              (string-join
+                (map first output) "")))))) rule)))
+
+(define ja-rk-rule-table->rule (lambda (table)
+  (map
+    (lambda (item)
+      ; ("ka" "" "か") -> ((("k" "a")) ("か" "カ" "ｶ"))
+      ; ("kk" "k" "っ") -> ((("k" "k") "k") ("っ" "ッ" "ｯ"))
+      ; ("kya" "" "きゃ") -> ((("k" "y" "a")) (("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ")))
+      (list
+        (cons
+          (let ((input (car item)))
+            (or
+              (and
+                (string=? input "yen")
+                ; ("yen" "" "￥") -> ("yen")
+                '("yen"))
+              ; ("ka" "" "か") -> ("k" "a")
+              (map string
+                (string->list input))))
+          (let ((next-input (cadr item)))
+            (or
+              (and
+                ; ("ka" "" "か") -> none
+                (string=? next-input "") '())
+              ; ("kk" "k" "っ") -> "k"
+              (cons next-input '()))))
+        (let* ((output (caddr item))
+               (utf8->eucjp (lambda (str)
+                              (iconv-convert "EUC-JP" "UTF-8" str)))
+               (eucjp-output (utf8->eucjp output))
+               (eucjp-output-list (string-to-list eucjp-output)))
+          (or
+            (and
+              (=
+                (length eucjp-output-list) 1)
+              ; ("ka" "" "か") ->  ("か" "カ" "ｶ")
+              (ja-find-kana-list-from-rule ja-rk-rule eucjp-output))
+            ; ("kya" "" "きゃ") -> (("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ"))
+            (map
+              (lambda (char)
+                (ja-find-kana-list-from-rule ja-rk-rule char))
+                  (reverse eucjp-output-list)))))) table)))
+
+(define-custom-group 'ja-rk-rule
+                     (N_ "Japanese Romaji-Kana")
+                     (N_ "long description will be here."))
+
+(define-custom-group 'composing-rule
+                     (N_ "Composing rule")
+                     (N_ "long description will be here."))
+
+(define-custom 'ja-rk-rule-type 'uim
+               '(ja-rk-rule composing-rule)
+               (list 'choice
+	         (list 'uim (N_ "uim") (N_ "uim native"))
+	         (list 'custom (N_ "Custom") (N_ "Custom")))
+               (N_ "Composing rule type")
+               (N_ "long description will be here."))
+
+(define-custom 'ja-rk-rule-table-basic
+               (ja-rk-rule-rule->table ja-rk-rule-basic-uim)
+               '(ja-rk-rule composing-rule)
+               (list 'table
+                 (list 'input (N_ "Input") (N_ "Input"))
+		 (list 'next-input (N_ "Next input") (N_ "Next input"))
+                 (list 'output (N_ "Output") (N_ "Output")))
+               (N_ "Custom composing rule")
+               (N_ "long description will be here."))
+
+(define-custom 'ja-rk-rule-keep-consonant? #f
+               '(ja-rk-rule composing-rule)
+               '(boolean)
+               (N_ "Keep consonant Romaji not convertible to Kana")
+               (N_ "long description will be here."))
+
+(custom-add-hook 'ja-rk-rule-table-basic
+                 'custom-set-hooks
+                 (lambda ()
+                   (and
+                     (eq? ja-rk-rule-type 'uim)
+                       (set! ja-rk-rule-basic ja-rk-rule-basic-uim))
+                   (ja-rk-rule-update)))
+
+(custom-add-hook 'ja-rk-rule-table-basic
+                 'custom-activity-hooks
+                 (lambda ()
+                   (eq? ja-rk-rule-type 'custom)))
+
+(custom-add-hook 'ja-rk-rule-keep-consonant?
+                 'custom-set-hooks
+                 (lambda ()
+                   (ja-rk-rule-keep-consonant-update)))
diff --git a/scm/japanese-kana-utf8.scm b/scm/japanese-kana-utf8.scm
new file mode 100644
index 000000000..a92d50083
--- /dev/null
+++ b/scm/japanese-kana-utf8.scm
@@ -0,0 +1,935 @@
+;;;
+;;; Copyright (c) 2003-2013 uim Project https://github.com/uim/uim
+;;;
+;;; All rights reserved.
+;;;
+;;; Redistribution and use in source and binary forms, with or without
+;;; modification, are permitted provided that the following conditions
+;;; are met:
+;;; 1. Redistributions of source code must retain the above copyright
+;;;    notice, this list of conditions and the following disclaimer.
+;;; 2. Redistributions in binary form must reproduce the above copyright
+;;;    notice, this list of conditions and the following disclaimer in the
+;;;    documentation and/or other materials provided with the distribution.
+;;; 3. Neither the name of authors nor the names of its contributors
+;;;    may be used to endorse or promote products derived from this software
+;;;    without specific prior written permission.
+;;;
+;;; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND
+;;; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+;;; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+;;; ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE
+;;; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+;;; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+;;; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+;;; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+;;; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+;;; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+;;; SUCH DAMAGE.
+;;;;
+
+;; ja-kana-hiragana rule and ja-kana-katakana-rule should be merged.
+
+(define ja-kana-hiragana-rule
+  '(
+    ((("#"). ("ぁ"))())
+    ((("E"). ("ぃ"))())
+    ((("$"). ("ぅ"))())
+    ((("%"). ("ぇ"))())
+    ((("&"). ("ぉ"))())
+    ((("'"). ("ゃ"))())
+    ((("("). ("ゅ"))())
+    (((")"). ("ょ"))())
+    ((("~"). ("を"))())
+    ((("Z"). ("っ"))())
+    ((("y"). ("ん"))())
+    ((("3"). ("あ"))())
+    ((("e"). ("い"))())
+    ((("4"). ("う"))())
+    ((("5"). ("え"))())
+    ((("6"). ("お"))())
+    ((("t"). ("か"))())
+    ((("g"). ("き"))())
+    ((("h"). ("く"))())
+    (((":"). ("け"))())
+    ((("b"). ("こ"))())
+    ((("x"). ("さ"))())
+    ((("d"). ("し"))())
+    ((("r"). ("す"))())
+    ((("p"). ("せ"))())
+    ((("c"). ("そ"))())
+    ((("q"). ("た"))())
+    ((("a"). ("ち"))())
+    ((("z"). ("つ"))())
+    ((("w"). ("て"))())
+    ((("s"). ("と"))())
+    ((("u"). ("な"))())
+    ((("i"). ("に"))())
+    ((("1"). ("ぬ"))())
+    (((","). ("ね"))())
+    ((("k"). ("の"))())
+    ((("f"). ("は"))())
+    ((("v"). ("ひ"))())
+    ((("2"). ("ふ"))())
+    ((("^"). ("へ"))())
+    ((("-"). ("ほ"))())
+    ((("j"). ("ま"))())
+    ((("n"). ("み"))())
+    ((("]"). ("む"))())
+    ((("/"). ("め"))())
+    ((("m"). ("も"))())
+    ((("7"). ("や"))())
+    ((("8"). ("ゆ"))())
+    ((("9"). ("よ"))())
+    ((("o"). ("ら"))())
+    ((("l"). ("り"))())
+    ((("."). ("る"))())
+    (((";"). ("れ"))())
+    ((("0"). ("わ"))())
+    ((("|"). ("ー"))())
+    ((("T"). ("か"))())
+    ((("G"). ("き"))())
+    ((("H"). ("く"))())
+    ((("*"). ("け"))())
+    ((("B"). ("こ"))())
+    ((("X"). ("さ"))())
+    ((("D"). ("し"))())
+    ((("R"). ("す"))())
+    ((("P"). ("せ"))())
+    ((("C"). ("そ"))())
+    ((("Q"). ("た"))())
+    ((("A"). ("ち"))())
+    ((("W"). ("て"))())
+    ((("S"). ("と"))())
+    ((("U"). ("な"))())
+    ((("I"). ("に"))())
+    ((("!"). ("ぬ"))())
+    ((("K"). ("の"))())
+    ((("F"). ("は"))())
+    ((("V"). ("ひ"))())
+    ((("\""). ("ふ"))())
+    ((("="). ("ほ"))())
+    ((("J"). ("ま"))())
+    ((("N"). ("み"))())
+    ((("M"). ("も"))())
+    ((("O"). ("ら"))())
+    ((("L"). ("り"))())
+    ((("+"). ("れ"))())
+    ((("_"). ("ろ"))())
+    ((("Y"). ("ん"))())
+    ((("\\"). ("ろ"))())
+    ((("yen"). ("ー"))())
+
+    ((("kana-a"). ("ぁ"))())
+    ((("kana-i"). ("ぃ"))())
+    ((("kana-u"). ("ぅ"))())
+    ((("kana-e"). ("ぇ"))())
+    ((("kana-o"). ("ぉ"))())
+    ((("kana-ya"). ("ゃ"))())
+    ((("kana-yu"). ("ゅ"))())
+    ((("kana-yo"). ("ょ"))())
+    ((("kana-WO"). ("を"))())
+    ((("kana-tsu"). ("っ"))())
+    ((("kana-N"). ("ん"))())
+    ((("kana-A"). ("あ"))())
+    ((("kana-I"). ("い"))())
+    ((("kana-U"). ("う"))())
+    ((("kana-E"). ("え"))())
+    ((("kana-O"). ("お"))())
+    ((("kana-KA"). ("か"))())
+    ((("kana-KI"). ("き"))())
+    ((("kana-KU"). ("く"))())
+    ((("kana-KE"). ("け"))())
+    ((("kana-KO"). ("こ"))())
+    ((("kana-SA"). ("さ"))())
+    ((("kana-SHI"). ("し"))())
+    ((("kana-SU"). ("す"))())
+    ((("kana-SE"). ("せ"))())
+    ((("kana-SO"). ("そ"))())
+    ((("kana-TA"). ("た"))())
+    ((("kana-CHI"). ("ち"))())
+    ((("kana-TSU"). ("つ"))())
+    ((("kana-TE"). ("て"))())
+    ((("kana-TO"). ("と"))())
+    ((("kana-NA"). ("な"))())
+    ((("kana-NI"). ("に"))())
+    ((("kana-NU"). ("ぬ"))())
+    ((("kana-NE"). ("ね"))())
+    ((("kana-NO"). ("の"))())
+    ((("kana-HA"). ("は"))())
+    ((("kana-HI"). ("ひ"))())
+    ((("kana-FU"). ("ふ"))())
+    ((("kana-HE"). ("へ"))())
+    ((("kana-HO"). ("ほ"))())
+    ((("kana-MA"). ("ま"))())
+    ((("kana-MI"). ("み"))())
+    ((("kana-MU"). ("む"))())
+    ((("kana-ME"). ("め"))())
+    ((("kana-MO"). ("も"))())
+    ((("kana-YA"). ("や"))())
+    ((("kana-YU"). ("ゆ"))())
+    ((("kana-YO"). ("よ"))())
+    ((("kana-RA"). ("ら"))())
+    ((("kana-RI"). ("り"))())
+    ((("kana-RU"). ("る"))())
+    ((("kana-RE"). ("れ"))())
+    ((("kana-RO"). ("ろ"))())
+    ((("kana-WA"). ("わ"))())
+    ((("kana-prolonged-sound"). ("ー"))())
+
+    ((("か" "@"). ())("が" ""))
+    ((("き" "@"). ())("ぎ" ""))
+    ((("く" "@"). ())("ぐ" ""))
+    ((("け" "@"). ())("げ" ""))
+    ((("こ" "@"). ())("ご" ""))
+    ((("さ" "@"). ())("ざ" ""))
+    ((("し" "@"). ())("じ" ""))
+    ((("す" "@"). ())("ず" ""))
+    ((("せ" "@"). ())("ぜ" ""))
+    ((("そ" "@"). ())("ぞ" ""))
+    ((("た" "@"). ())("だ" ""))
+    ((("ち" "@"). ())("ぢ" ""))
+    ((("つ" "@"). ())("づ" ""))
+    ((("て" "@"). ())("で" ""))
+    ((("と" "@"). ())("ど" ""))
+    ((("は" "@"). ())("ば" ""))
+    ((("ひ" "@"). ())("び" ""))
+    ((("ふ" "@"). ())("ぶ" ""))
+    ((("へ" "@"). ())("べ" ""))
+    ((("ほ" "@"). ())("ぼ" ""))
+    ((("は" "["). ())("ぱ" ""))
+    ((("ひ" "["). ())("ぴ" ""))
+    ((("ふ" "["). ())("ぷ" ""))
+    ((("へ" "["). ())("ぺ" ""))
+    ((("ほ" "["). ())("ぽ" ""))
+    ((("か" "`"). ())("が" ""))
+    ((("き" "`"). ())("ぎ" ""))
+    ((("く" "`"). ())("ぐ" ""))
+    ((("け" "`"). ())("げ" ""))
+    ((("こ" "`"). ())("ご" ""))
+    ((("さ" "`"). ())("ざ" ""))
+    ((("し" "`"). ())("じ" ""))
+    ((("す" "`"). ())("ず" ""))
+    ((("せ" "`"). ())("ぜ" ""))
+    ((("そ" "`"). ())("ぞ" ""))
+    ((("た" "`"). ())("だ" ""))
+    ((("ち" "`"). ())("ぢ" ""))
+    ((("つ" "`"). ())("づ" ""))
+    ((("て" "`"). ())("で" ""))
+    ((("と" "`"). ())("ど" ""))
+    ((("は" "`"). ())("ば" ""))
+    ((("ひ" "`"). ())("び" ""))
+    ((("ふ" "`"). ())("ぶ" ""))
+    ((("へ" "`"). ())("べ" ""))
+    ((("ほ" "`"). ())("ぼ" ""))
+
+    ((("か" "kana-voiced-sound"). ())("が" ""))
+    ((("き" "kana-voiced-sound"). ())("ぎ" ""))
+    ((("く" "kana-voiced-sound"). ())("ぐ" ""))
+    ((("け" "kana-voiced-sound"). ())("げ" ""))
+    ((("こ" "kana-voiced-sound"). ())("ご" ""))
+    ((("さ" "kana-voiced-sound"). ())("ざ" ""))
+    ((("し" "kana-voiced-sound"). ())("じ" ""))
+    ((("す" "kana-voiced-sound"). ())("ず" ""))
+    ((("せ" "kana-voiced-sound"). ())("ぜ" ""))
+    ((("そ" "kana-voiced-sound"). ())("ぞ" ""))
+    ((("た" "kana-voiced-sound"). ())("だ" ""))
+    ((("ち" "kana-voiced-sound"). ())("ぢ" ""))
+    ((("つ" "kana-voiced-sound"). ())("づ" ""))
+    ((("て" "kana-voiced-sound"). ())("で" ""))
+    ((("と" "kana-voiced-sound"). ())("ど" ""))
+    ((("は" "kana-voiced-sound"). ())("ば" ""))
+    ((("ひ" "kana-voiced-sound"). ())("び" ""))
+    ((("ふ" "kana-voiced-sound"). ())("ぶ" ""))
+    ((("へ" "kana-voiced-sound"). ())("べ" ""))
+    ((("ほ" "kana-voiced-sound"). ())("ぼ" ""))
+    ((("は" "kana-semivoiced-sound"). ())("ぱ" ""))
+    ((("ひ" "kana-semivoiced-sound"). ())("ぴ" ""))
+    ((("ふ" "kana-semivoiced-sound"). ())("ぷ" ""))
+    ((("へ" "kana-semivoiced-sound"). ())("ぺ" ""))
+    ((("ほ" "kana-semivoiced-sound"). ())("ぽ" ""))
+
+    (((">"). ("。"))())
+    ((("<"). ("、"))())
+    ((("?"). ("・"))())
+    ((("@"). ("゛"))())
+    ((("["). ("゜"))())
+    ((("{"). ("「"))())
+    ((("}"). ("」"))())
+    ((("`"). ("゛"))())
+
+    ((("kana-fullstop"). ("。"))())
+    ((("kana-comma"). ("、"))())
+    ((("kana-conjunctive"). ("・"))())
+    ((("kana-voiced-sound"). ("゛"))())
+    ((("kana-semivoiced-sound"). ("゜"))())
+    ((("kana-opening-bracket"). ("「"))())
+    ((("kana-closing-bracket"). ("」"))())
+
+    ((("ぁ"). ())("ぁ"))
+    ((("ぃ"). ())("ぃ"))
+    ((("ぅ"). ())("ぅ"))
+    ((("ぇ"). ())("ぇ"))
+    ((("ぉ"). ())("ぉ"))
+    ((("ゃ"). ())("ゃ"))
+    ((("ゅ"). ())("ゅ"))
+    ((("ょ"). ())("ょ"))
+    ((("を"). ())("を"))
+    ((("っ"). ())("っ"))
+    ((("ん"). ())("ん"))
+    ((("あ"). ())("あ"))
+    ((("い"). ())("い"))
+    ((("う"). ())("う"))
+    ((("え"). ())("え"))
+    ((("お"). ())("お"))
+    ((("か"). ())("か"))
+    ((("き"). ())("き"))
+    ((("く"). ())("く"))
+    ((("け"). ())("け"))
+    ((("こ"). ())("こ"))
+    ((("さ"). ())("さ"))
+    ((("し"). ())("し"))
+    ((("す"). ())("す"))
+    ((("せ"). ())("せ"))
+    ((("そ"). ())("そ"))
+    ((("た"). ())("た"))
+    ((("ち"). ())("ち"))
+    ((("つ"). ())("つ"))
+    ((("て"). ())("て"))
+    ((("と"). ())("と"))
+    ((("な"). ())("な"))
+    ((("に"). ())("に"))
+    ((("ぬ"). ())("ぬ"))
+    ((("ね"). ())("ね"))
+    ((("の"). ())("の"))
+    ((("は"). ())("は"))
+    ((("ひ"). ())("ひ"))
+    ((("ふ"). ())("ふ"))
+    ((("へ"). ())("へ"))
+    ((("ほ"). ())("ほ"))
+    ((("ま"). ())("ま"))
+    ((("み"). ())("み"))
+    ((("む"). ())("む"))
+    ((("め"). ())("め"))
+    ((("も"). ())("も"))
+    ((("や"). ())("や"))
+    ((("ゆ"). ())("ゆ"))
+    ((("よ"). ())("よ"))
+    ((("ら"). ())("ら"))
+    ((("り"). ())("り"))
+    ((("る"). ())("る"))
+    ((("れ"). ())("れ"))
+    ((("わ"). ())("わ"))
+    ((("ー"). ())("ー"))
+    ((("ろ"). ())("ろ"))
+    ((("。"). ())("。"))
+    ((("、"). ())("、"))
+    ((("・"). ())("・"))
+    ((("゛"). ())("゛"))
+    ((("゜"). ())("゜"))
+    ((("「"). ())("「"))
+    ((("」"). ())("」"))
+
+    ))
+
+(define ja-kana-katakana-rule
+  '(
+    ((("#"). ("ァ"))())
+    ((("E"). ("ィ"))())
+    ((("$"). ("ゥ"))())
+    ((("%"). ("ェ"))())
+    ((("&"). ("ォ"))())
+    ((("'"). ("ャ"))())
+    ((("("). ("ュ"))())
+    (((")"). ("ョ"))())
+    ((("~"). ("ヲ"))())
+    ((("Z"). ("ッ"))())
+    ((("y"). ("ン"))())
+    ((("3"). ("ア"))())
+    ((("e"). ("イ"))())
+    ((("4"). ("ウ"))())
+    ((("5"). ("エ"))())
+    ((("6"). ("オ"))())
+    ((("t"). ("カ"))())
+    ((("g"). ("キ"))())
+    ((("h"). ("ク"))())
+    (((":"). ("ケ"))())
+    ((("b"). ("コ"))())
+    ((("x"). ("サ"))())
+    ((("d"). ("シ"))())
+    ((("r"). ("ス"))())
+    ((("p"). ("セ"))())
+    ((("c"). ("ソ"))())
+    ((("q"). ("タ"))())
+    ((("a"). ("チ"))())
+    ((("z"). ("ツ"))())
+    ((("w"). ("テ"))())
+    ((("s"). ("ト"))())
+    ((("u"). ("ナ"))())
+    ((("i"). ("ニ"))())
+    ((("1"). ("ヌ"))())
+    (((","). ("ネ"))())
+    ((("k"). ("ノ"))())
+    ((("f"). ("ハ"))())
+    ((("v"). ("ヒ"))())
+    ((("2"). ("フ"))())
+    ((("^"). ("ヘ"))())
+    ((("-"). ("ホ"))())
+    ((("j"). ("マ"))())
+    ((("n"). ("ミ"))())
+    ((("]"). ("ム"))())
+    ((("/"). ("メ"))())
+    ((("m"). ("モ"))())
+    ((("7"). ("ヤ"))())
+    ((("8"). ("ユ"))())
+    ((("9"). ("ヨ"))())
+    ((("o"). ("ラ"))())
+    ((("l"). ("リ"))())
+    ((("."). ("ル"))())
+    (((";"). ("レ"))())
+    ((("0"). ("ワ"))())
+    ((("|"). ("ー"))())
+    ((("T"). ("カ"))())
+    ((("G"). ("キ"))())
+    ((("H"). ("ク"))())
+    ((("*"). ("ケ"))())
+    ((("B"). ("コ"))())
+    ((("X"). ("サ"))())
+    ((("D"). ("シ"))())
+    ((("R"). ("ス"))())
+    ((("P"). ("セ"))())
+    ((("C"). ("ソ"))())
+    ((("Q"). ("タ"))())
+    ((("A"). ("チ"))())
+    ((("W"). ("テ"))())
+    ((("S"). ("ト"))())
+    ((("U"). ("ナ"))())
+    ((("I"). ("ニ"))())
+    ((("!"). ("ヌ"))())
+    ((("K"). ("ノ"))())
+    ((("F"). ("ハ"))())
+    ((("V"). ("ヒ"))())
+    ((("\""). ("フ"))())
+    ((("="). ("ホ"))())
+    ((("J"). ("マ"))())
+    ((("N"). ("ミ"))())
+    ((("M"). ("モ"))())
+    ((("O"). ("ラ"))())
+    ((("L"). ("リ"))())
+    ((("+"). ("レ"))())
+    ((("_"). ("ロ"))())
+    ((("Y"). ("ン"))())
+    ((("\\"). ("ロ"))())
+    ((("yen"). ("ー"))())
+
+    ((("kana-a"). ("ァ"))())
+    ((("kana-i"). ("ィ"))())
+    ((("kana-u"). ("ゥ"))())
+    ((("kana-e"). ("ェ"))())
+    ((("kana-o"). ("ォ"))())
+    ((("kana-ya"). ("ャ"))())
+    ((("kana-yu"). ("ュ"))())
+    ((("kana-yo"). ("ョ"))())
+    ((("kana-wo"). ("ヲ"))())
+    ((("kana-tsu"). ("ッ"))())
+    ((("kana-N"). ("ン"))())
+    ((("kana-A"). ("ア"))())
+    ((("kana-I"). ("イ"))())
+    ((("kana-U"). ("ウ"))())
+    ((("kana-E"). ("エ"))())
+    ((("kana-O"). ("オ"))())
+    ((("kana-KA"). ("カ"))())
+    ((("kana-KI"). ("キ"))())
+    ((("kana-KU"). ("ク"))())
+    ((("kana-KE"). ("ケ"))())
+    ((("kana-KO"). ("コ"))())
+    ((("kana-SA"). ("サ"))())
+    ((("kana-SHI"). ("シ"))())
+    ((("kana-SU"). ("ス"))())
+    ((("kana-SE"). ("セ"))())
+    ((("kana-SO"). ("ソ"))())
+    ((("kana-TA"). ("タ"))())
+    ((("kana-CHI"). ("チ"))())
+    ((("kana-TSU"). ("ツ"))())
+    ((("kana-TE"). ("テ"))())
+    ((("kana-TO"). ("ト"))())
+    ((("kana-NA"). ("ナ"))())
+    ((("kana-NI"). ("ニ"))())
+    ((("kana-NU"). ("ヌ"))())
+    ((("kana-NE"). ("ネ"))())
+    ((("kana-NO"). ("ノ"))())
+    ((("kana-HA"). ("ハ"))())
+    ((("kana-HI"). ("ヒ"))())
+    ((("kana-FU"). ("フ"))())
+    ((("kana-HE"). ("ヘ"))())
+    ((("kana-HO"). ("ホ"))())
+    ((("kana-MA"). ("マ"))())
+    ((("kana-MI"). ("ミ"))())
+    ((("kana-MU"). ("ム"))())
+    ((("kana-ME"). ("メ"))())
+    ((("kana-MO"). ("モ"))())
+    ((("kana-YA"). ("ヤ"))())
+    ((("kana-YU"). ("ユ"))())
+    ((("kana-YO"). ("ヨ"))())
+    ((("kana-RA"). ("ラ"))())
+    ((("kana-RI"). ("リ"))())
+    ((("kana-RU"). ("ル"))())
+    ((("kana-RE"). ("レ"))())
+    ((("kana-RO"). ("ロ"))())
+    ((("kana-WA"). ("ワ"))())
+    ((("kana-prolonged-sound"). ("ー"))())
+
+    ((("カ" "@"). ())("ガ"))
+    ((("キ" "@"). ())("ギ"))
+    ((("ク" "@"). ())("グ"))
+    ((("ケ" "@"). ())("ゲ"))
+    ((("コ" "@"). ())("ゴ"))
+    ((("サ" "@"). ())("ザ"))
+    ((("シ" "@"). ())("ジ"))
+    ((("ス" "@"). ())("ズ"))
+    ((("セ" "@"). ())("ゼ"))
+    ((("ソ" "@"). ())("ゾ"))
+    ((("タ" "@"). ())("ダ"))
+    ((("チ" "@"). ())("ヂ"))
+    ((("ツ" "@"). ())("ヅ"))
+    ((("テ" "@"). ())("デ"))
+    ((("ト" "@"). ())("ド"))
+    ((("ハ" "@"). ())("バ"))
+    ((("ヒ" "@"). ())("ビ"))
+    ((("フ" "@"). ())("ブ"))
+    ((("ヘ" "@"). ())("ベ"))
+    ((("ホ" "@"). ())("ボ"))
+    ((("ハ" "["). ())("パ"))
+    ((("ヒ" "["). ())("ピ"))
+    ((("フ" "["). ())("プ"))
+    ((("ヘ" "["). ())("ペ"))
+    ((("ホ" "["). ())("ポ"))
+    ((("カ" "`"). ())("ガ"))
+    ((("キ" "`"). ())("ギ"))
+    ((("ク" "`"). ())("グ"))
+    ((("ケ" "`"). ())("ゲ"))
+    ((("コ" "`"). ())("ゴ"))
+    ((("サ" "`"). ())("ザ"))
+    ((("シ" "`"). ())("ジ"))
+    ((("ス" "`"). ())("ズ"))
+    ((("セ" "`"). ())("ゼ"))
+    ((("ソ" "`"). ())("ゾ"))
+    ((("タ" "`"). ())("ダ"))
+    ((("チ" "`"). ())("ヂ"))
+    ((("ツ" "`"). ())("ヅ"))
+    ((("テ" "`"). ())("デ"))
+    ((("ト" "`"). ())("ド"))
+    ((("ハ" "`"). ())("バ"))
+    ((("ヒ" "`"). ())("ビ"))
+    ((("フ" "`"). ())("ブ"))
+    ((("ヘ" "`"). ())("ベ"))
+    ((("ホ" "`"). ())("ボ"))
+
+    ((("カ" "kana-voiced-sound"). ())("ガ"))
+    ((("キ" "kana-voiced-sound"). ())("ギ"))
+    ((("ク" "kana-voiced-sound"). ())("グ"))
+    ((("ケ" "kana-voiced-sound"). ())("ゲ"))
+    ((("コ" "kana-voiced-sound"). ())("ゴ"))
+    ((("サ" "kana-voiced-sound"). ())("ザ"))
+    ((("シ" "kana-voiced-sound"). ())("ジ"))
+    ((("ス" "kana-voiced-sound"). ())("ズ"))
+    ((("セ" "kana-voiced-sound"). ())("ゼ"))
+    ((("ソ" "kana-voiced-sound"). ())("ゾ"))
+    ((("タ" "kana-voiced-sound"). ())("ダ"))
+    ((("チ" "kana-voiced-sound"). ())("ヂ"))
+    ((("ツ" "kana-voiced-sound"). ())("ヅ"))
+    ((("テ" "kana-voiced-sound"). ())("デ"))
+    ((("ト" "kana-voiced-sound"). ())("ド"))
+    ((("ハ" "kana-voiced-sound"). ())("バ"))
+    ((("ヒ" "kana-voiced-sound"). ())("ビ"))
+    ((("フ" "kana-voiced-sound"). ())("ブ"))
+    ((("ヘ" "kana-voiced-sound"). ())("ベ"))
+    ((("ホ" "kana-voiced-sound"). ())("ボ"))
+    ((("ハ" "kana-semivoiced-sound"). ())("パ"))
+    ((("ヒ" "kana-semivoiced-sound"). ())("ピ"))
+    ((("フ" "kana-semivoiced-sound"). ())("プ"))
+    ((("ヘ" "kana-semivoiced-sound"). ())("ペ"))
+    ((("ホ" "kana-semivoiced-sound"). ())("ポ"))
+
+    (((">"). ("。"))())
+    ((("<"). ("、"))())
+    ((("?"). ("・"))())
+    ((("@"). ("゛"))())
+    ((("["). ("゜"))())
+    ((("{"). ("「"))())
+    ((("}"). ("」"))())
+    ((("`"). ("゛"))())
+
+    ((("kana-fullstop"). ("。"))())
+    ((("kana-comma"). ("、"))())
+    ((("kana-conjunctive"). ("・"))())
+    ((("kana-voiced-sound"). ("゛"))())
+    ((("kana-semivoiced-sound"). ("゜"))())
+    ((("kana-opening-bracket"). ("「"))())
+    ((("kana-closing-bracket"). ("」"))())
+
+    ((("ァ"). ())("ァ"))
+    ((("ィ"). ())("ィ"))
+    ((("ゥ"). ())("ゥ"))
+    ((("ェ"). ())("ェ"))
+    ((("ォ"). ())("ォ"))
+    ((("ャ"). ())("ヤ"))
+    ((("ュ"). ())("ュ"))
+    ((("ョ"). ())("ョ"))
+    ((("ヲ"). ())("ヲ"))
+    ((("ッ"). ())("ッ"))
+    ((("ン"). ())("ン"))
+    ((("ア"). ())("ア"))
+    ((("イ"). ())("イ"))
+    ((("ウ"). ())("ウ"))
+    ((("エ"). ())("エ"))
+    ((("オ"). ())("オ"))
+    ((("カ"). ())("カ"))
+    ((("キ"). ())("キ"))
+    ((("ク"). ())("ク"))
+    ((("ケ"). ())("ケ"))
+    ((("コ"). ())("コ"))
+    ((("サ"). ())("サ"))
+    ((("シ"). ())("シ"))
+    ((("ス"). ())("ス"))
+    ((("セ"). ())("セ"))
+    ((("ソ"). ())("ソ"))
+    ((("タ"). ())("タ"))
+    ((("チ"). ())("チ"))
+    ((("ツ"). ())("ツ"))
+    ((("テ"). ())("テ"))
+    ((("ト"). ())("ト"))
+    ((("ナ"). ())("ナ"))
+    ((("ニ"). ())("ニ"))
+    ((("ヌ"). ())("ヌ"))
+    ((("ネ"). ())("ネ"))
+    ((("ノ"). ())("ノ"))
+    ((("ハ"). ())("ハ"))
+    ((("ヒ"). ())("ヒ"))
+    ((("フ"). ())("フ"))
+    ((("ヘ"). ())("ヘ"))
+    ((("ホ"). ())("ホ"))
+    ((("マ"). ())("マ"))
+    ((("ミ"). ())("ミ"))
+    ((("ム"). ())("ム"))
+    ((("メ"). ())("メ"))
+    ((("モ"). ())("モ"))
+    ((("ヤ"). ())("ヤ"))
+    ((("ユ"). ())("ユ"))
+    ((("ヨ"). ())("ヨ"))
+    ((("ラ"). ())("ラ"))
+    ((("リ"). ())("リ"))
+    ((("ル"). ())("ル"))
+    ((("レ"). ())("レ"))
+    ((("ロ"). ())("ロ"))
+    ((("ワ"). ())("ワ"))
+    ((("ー"). ())("ー"))
+    ((("。"). ())("。"))
+    ((("、"). ())("、"))
+    ((("・"). ())("・"))
+    ((("゛"). ())("゛"))
+    ((("゜"). ())("゜"))
+    ((("「"). ())("「"))
+    ((("」"). ())("」"))
+    ))
+
+(define ja-kana-halfkana-rule
+  '(
+    ((("#"). ("ｧ"))())
+    ((("E"). ("ｨ"))())
+    ((("$"). ("ｩ"))())
+    ((("%"). ("ｪ"))())
+    ((("&"). ("ｫ"))())
+    ((("'"). ("ｬ"))())
+    ((("("). ("ｭ"))())
+    (((")"). ("ｮ"))())
+    ((("~"). ("ｦ"))())
+    ((("Z"). ("ｯ"))())
+    ((("y"). ("ﾝ"))())
+    ((("3"). ("ｱ"))())
+    ((("e"). ("ｲ"))())
+    ((("4"). ("ｳ"))())
+    ((("5"). ("ｴ"))())
+    ((("6"). ("ｵ"))())
+    ((("t"). ("ｶ"))())
+    ((("g"). ("ｷ"))())
+    ((("h"). ("ｸ"))())
+    (((":"). ("ｹ"))())
+    ((("b"). ("ｺ"))())
+    ((("x"). ("ｻ"))())
+    ((("d"). ("ｼ"))())
+    ((("r"). ("ｽ"))())
+    ((("p"). ("ｾ"))())
+    ((("c"). ("ｿ"))())
+    ((("q"). ("ﾀ"))())
+    ((("a"). ("ﾁ"))())
+    ((("z"). ("ﾂ"))())
+    ((("w"). ("ﾃ"))())
+    ((("s"). ("ﾄ"))())
+    ((("u"). ("ﾅ"))())
+    ((("i"). ("ﾆ"))())
+    ((("1"). ("ﾇ"))())
+    (((","). ("ﾈ"))())
+    ((("k"). ("ﾉ"))())
+    ((("f"). ("ﾊ"))())
+    ((("v"). ("ﾋ"))())
+    ((("2"). ("ﾌ"))())
+    ((("^"). ("ﾍ"))())
+    ((("-"). ("ﾎ"))())
+    ((("j"). ("ﾏ"))())
+    ((("n"). ("ﾐ"))())
+    ((("]"). ("ﾑ"))())
+    ((("/"). ("ﾒ"))())
+    ((("m"). ("ﾓ"))())
+    ((("7"). ("ﾔ"))())
+    ((("8"). ("ﾕ"))())
+    ((("9"). ("ﾖ"))())
+    ((("o"). ("ﾗ"))())
+    ((("l"). ("ﾘ"))())
+    ((("."). ("ﾙ"))())
+    (((";"). ("ﾚ"))())
+    ((("0"). ("ﾜ"))())
+    ((("|"). ("ｰ"))())
+    ((("T"). ("ｶ"))())
+    ((("G"). ("ｷ"))())
+    ((("H"). ("ｸ"))())
+    ((("*"). ("ｹ"))())
+    ((("B"). ("ｺ"))())
+    ((("X"). ("ｻ"))())
+    ((("D"). ("ｼ"))())
+    ((("R"). ("ｽ"))())
+    ((("P"). ("ｾ"))())
+    ((("C"). ("ｿ"))())
+    ((("Q"). ("ﾀ"))())
+    ((("A"). ("ﾁ"))())
+    ((("W"). ("ﾃ"))())
+    ((("S"). ("ﾄ"))())
+    ((("U"). ("ﾅ"))())
+    ((("I"). ("ﾆ"))())
+    ((("!"). ("ﾇ"))())
+    ((("K"). ("ﾉ"))())
+    ((("F"). ("ﾊ"))())
+    ((("V"). ("ﾋ"))())
+    ((("\""). ("ﾌ"))())
+    ((("="). ("ﾎ"))())
+    ((("J"). ("ﾏ"))())
+    ((("N"). ("ﾐ"))())
+    ((("M"). ("ﾓ"))())
+    ((("O"). ("ﾗ"))())
+    ((("L"). ("ﾘ"))())
+    ((("+"). ("ﾚ"))())
+    ((("_"). ("ﾛ"))())
+    ((("Y"). ("ﾝ"))())
+    ((("\\"). ("ﾛ"))())
+    ((("yen"). ("ｰ"))())
+
+    ((("kana-a"). ("ｧ"))())
+    ((("kana-i"). ("ｨ"))())
+    ((("kana-u"). ("ｩ"))())
+    ((("kana-e"). ("ｪ"))())
+    ((("kana-o"). ("ｫ"))())
+    ((("kana-ya"). ("ｬ"))())
+    ((("kana-yu"). ("ｭ"))())
+    ((("kana-yo"). ("ｮ"))())
+    ((("kana-WO"). ("ｦ"))())
+    ((("kana-tsu"). ("ｯ"))())
+    ((("kana-N"). ("ﾝ"))())
+    ((("kana-A"). ("ｱ"))())
+    ((("kana-I"). ("ｲ"))())
+    ((("kana-U"). ("ｳ"))())
+    ((("kana-E"). ("ｴ"))())
+    ((("kana-O"). ("ｵ"))())
+    ((("kana-KA"). ("ｶ"))())
+    ((("kana-KI"). ("ｷ"))())
+    ((("kana-KU"). ("ｸ"))())
+    ((("kana-KE"). ("ｹ"))())
+    ((("kana-KO"). ("ｺ"))())
+    ((("kana-SA"). ("ｻ"))())
+    ((("kana-SHI"). ("ｼ"))())
+    ((("kana-SU"). ("ｽ"))())
+    ((("kana-SE"). ("ｾ"))())
+    ((("kana-SO"). ("ｿ"))())
+    ((("kana-TA"). ("ﾀ"))())
+    ((("kana-CHI"). ("ﾁ"))())
+    ((("kana-TSU"). ("ﾂ"))())
+    ((("kana-TE"). ("ﾃ"))())
+    ((("kana-TO"). ("ﾄ"))())
+    ((("kana-NA"). ("ﾅ"))())
+    ((("kana-NI"). ("ﾆ"))())
+    ((("kana-NU"). ("ﾇ"))())
+    ((("kana-NE"). ("ﾈ"))())
+    ((("kana-NO"). ("ﾉ"))())
+    ((("kana-HA"). ("ﾊ"))())
+    ((("kana-HI"). ("ﾋ"))())
+    ((("kana-FU"). ("ﾌ"))())
+    ((("kana-HE"). ("ﾍ"))())
+    ((("kana-HO"). ("ﾎ"))())
+    ((("kana-MA"). ("ﾏ"))())
+    ((("kana-MI"). ("ﾐ"))())
+    ((("kana-MU"). ("ﾑ"))())
+    ((("kana-ME"). ("ﾒ"))())
+    ((("kana-MO"). ("ﾓ"))())
+    ((("kana-YA"). ("ﾔ"))())
+    ((("kana-YU"). ("ﾕ"))())
+    ((("kana-YO"). ("ﾖ"))())
+    ((("kana-RA"). ("ﾗ"))())
+    ((("kana-RI"). ("ﾘ"))())
+    ((("kana-RU"). ("ﾙ"))())
+    ((("kana-RE"). ("ﾚ"))())
+    ((("kana-RO"). ("ﾛ"))())
+    ((("kana-WA"). ("ﾜ"))())
+    ((("kana-prolonged-sound"). ("ｰ"))())
+
+    ((("ｶ" "@"). ())("ｶﾞ"))
+    ((("ｷ" "@"). ())("ｷﾞ"))
+    ((("ｸ" "@"). ())("ｸﾞ"))
+    ((("ｹ" "@"). ())("ｹﾞ"))
+    ((("ｺ" "@"). ())("ｺﾞ"))
+    ((("ｻ" "@"). ())("ｻﾞ"))
+    ((("ｼ" "@"). ())("ｼﾞ"))
+    ((("ｽ" "@"). ())("ｽﾞ"))
+    ((("ｾ" "@"). ())("ｾﾞ"))
+    ((("ｿ" "@"). ())("ｿﾞ"))
+    ((("ﾀ" "@"). ())("ﾀﾞ"))
+    ((("ﾁ" "@"). ())("ﾁﾞ"))
+    ((("ﾂ" "@"). ())("ﾂﾞ"))
+    ((("ﾃ" "@"). ())("ﾃﾞ"))
+    ((("ﾄ" "@"). ())("ﾄﾞ"))
+    ((("ﾊ" "@"). ())("ﾊﾞ"))
+    ((("ﾋ" "@"). ())("ﾋﾞ"))
+    ((("ﾌ" "@"). ())("ﾌﾞ"))
+    ((("ﾍ" "@"). ())("ﾍﾞ"))
+    ((("ﾎ" "@"). ())("ﾎﾞ"))
+    ((("ﾊ" "["). ())("ﾊﾟ"))
+    ((("ﾋ" "["). ())("ﾋﾟ"))
+    ((("ﾌ" "["). ())("ﾌﾟ"))
+    ((("ﾍ" "["). ())("ﾍﾟ"))
+    ((("ﾎ" "["). ())("ﾎﾟ"))
+    ((("ｶ" "`"). ())("ｶﾞ"))
+    ((("ｷ" "`"). ())("ｷﾞ"))
+    ((("ｸ" "`"). ())("ｸﾞ"))
+    ((("ｹ" "`"). ())("ｹﾞ"))
+    ((("ｺ" "`"). ())("ｺﾞ"))
+    ((("ｻ" "`"). ())("ｻﾞ"))
+    ((("ｼ" "`"). ())("ｼﾞ"))
+    ((("ｽ" "`"). ())("ｽﾞ"))
+    ((("ｾ" "`"). ())("ｾﾞ"))
+    ((("ｿ" "`"). ())("ｿﾞ"))
+    ((("ﾀ" "`"). ())("ﾀﾞ"))
+    ((("ﾁ" "`"). ())("ﾁﾞ"))
+    ((("ﾂ" "`"). ())("ﾂﾞ"))
+    ((("ﾃ" "`"). ())("ﾃﾞ"))
+    ((("ﾄ" "`"). ())("ﾄﾞ"))
+    ((("ﾊ" "`"). ())("ﾊﾞ"))
+    ((("ﾋ" "`"). ())("ﾋﾞ"))
+    ((("ﾌ" "`"). ())("ﾌﾞ"))
+    ((("ﾍ" "`"). ())("ﾍﾞ"))
+    ((("ﾎ" "`"). ())("ﾎﾞ"))
+
+    ((("ｶ" "kana-voiced-sound"). ())("ｶﾞ"))
+    ((("ｷ" "kana-voiced-sound"). ())("ｷﾞ"))
+    ((("ｸ" "kana-voiced-sound"). ())("ｸﾞ"))
+    ((("ｹ" "kana-voiced-sound"). ())("ｹﾞ"))
+    ((("ｺ" "kana-voiced-sound"). ())("ｺﾞ"))
+    ((("ｻ" "kana-voiced-sound"). ())("ｻﾞ"))
+    ((("ｼ" "kana-voiced-sound"). ())("ｼﾞ"))
+    ((("ｽ" "kana-voiced-sound"). ())("ｽﾞ"))
+    ((("ｾ" "kana-voiced-sound"). ())("ｾﾞ"))
+    ((("ｿ" "kana-voiced-sound"). ())("ｿﾞ"))
+    ((("ﾀ" "kana-voiced-sound"). ())("ﾀﾞ"))
+    ((("ﾁ" "kana-voiced-sound"). ())("ﾁﾞ"))
+    ((("ﾂ" "kana-voiced-sound"). ())("ﾂﾞ"))
+    ((("ﾃ" "kana-voiced-sound"). ())("ﾃﾞ"))
+    ((("ﾄ" "kana-voiced-sound"). ())("ﾄﾞ"))
+    ((("ﾊ" "kana-voiced-sound"). ())("ﾊﾞ"))
+    ((("ﾋ" "kana-voiced-sound"). ())("ﾋﾞ"))
+    ((("ﾌ" "kana-voiced-sound"). ())("ﾌﾞ"))
+    ((("ﾍ" "kana-voiced-sound"). ())("ﾍﾞ"))
+    ((("ﾎ" "kana-voiced-sound"). ())("ﾎﾞ"))
+    ((("ﾊ" "kana-semivoiced-sound"). ())("ﾊﾟ"))
+    ((("ﾋ" "kana-semivoiced-sound"). ())("ﾋﾟ"))
+    ((("ﾌ" "kana-semivoiced-sound"). ())("ﾌﾟ"))
+    ((("ﾍ" "kana-semivoiced-sound"). ())("ﾍﾟ"))
+    ((("ﾎ" "kana-semivoiced-sound"). ())("ﾎﾟ"))
+ 
+    (((">"). ("｡"))())
+    ((("<"). ("､"))())
+    ((("?"). ("･"))())
+    ((("@"). ("ﾞ"))())
+    ((("["). ("ﾟ"))())
+    ((("{"). ("｢"))())
+    ((("}"). ("｣"))())
+    ((("`"). ("ﾞ"))())
+
+    ((("kana-fullstop"). ("｡"))())
+    ((("kana-comma"). ("､"))())
+    ((("kana-conjunctive"). ("･"))())
+    ((("kana-voiced-sound"). ("ﾞ"))())
+    ((("kana-semivoiced-sound"). ("ﾟ"))())
+    ((("kana-opening-bracket"). ("｢"))())
+    ((("kana-closing-bracket"). ("｣"))())
+ 
+    ((("ｧ"). ())("ｧ"))
+    ((("ｨ"). ())("ｨ"))
+    ((("ｩ"). ())("ｩ"))
+    ((("ｪ"). ())("ｪ"))
+    ((("ｫ"). ())("ｫ"))
+    ((("ｬ"). ())("ﾔ"))
+    ((("ｭ"). ())("ｭ"))
+    ((("ｮ"). ())("ｮ"))
+    ((("ｦ"). ())("ｦ"))
+    ((("ｯ"). ())("ｯ"))
+    ((("ﾝ"). ())("ﾝ"))
+    ((("ｱ"). ())("ｱ"))
+    ((("ｲ"). ())("ｲ"))
+    ((("ｳ"). ())("ｳ"))
+    ((("ｴ"). ())("ｴ"))
+    ((("ｵ"). ())("ｵ"))
+    ((("ｶ"). ())("ｶ"))
+    ((("ｷ"). ())("ｷ"))
+    ((("ｸ"). ())("ｸ"))
+    ((("ｹ"). ())("ｹ"))
+    ((("ｺ"). ())("ｺ"))
+    ((("ｻ"). ())("ｻ"))
+    ((("ｼ"). ())("ｼ"))
+    ((("ｽ"). ())("ｽ"))
+    ((("ｾ"). ())("ｾ"))
+    ((("ｿ"). ())("ｿ"))
+    ((("ﾀ"). ())("ﾀ"))
+    ((("ﾁ"). ())("ﾁ"))
+    ((("ﾂ"). ())("ﾂ"))
+    ((("ﾃ"). ())("ﾃ"))
+    ((("ﾄ"). ())("ﾄ"))
+    ((("ﾅ"). ())("ﾅ"))
+    ((("ﾆ"). ())("ﾆ"))
+    ((("ﾇ"). ())("ﾇ"))
+    ((("ﾈ"). ())("ﾈ"))
+    ((("ﾉ"). ())("ﾉ"))
+    ((("ﾊ"). ())("ﾊ"))
+    ((("ﾋ"). ())("ﾋ"))
+    ((("ﾌ"). ())("ﾌ"))
+    ((("ﾍ"). ())("ﾍ"))
+    ((("ﾎ"). ())("ﾎ"))
+    ((("ﾏ"). ())("ﾏ"))
+    ((("ﾐ"). ())("ﾐ"))
+    ((("ﾑ"). ())("ﾑ"))
+    ((("ﾒ"). ())("ﾒ"))
+    ((("ﾓ"). ())("ﾓ"))
+    ((("ﾔ"). ())("ﾔ"))
+    ((("ﾕ"). ())("ﾕ"))
+    ((("ﾖ"). ())("ﾖ"))
+    ((("ﾗ"). ())("ﾗ"))
+    ((("ﾘ"). ())("ﾘ"))
+    ((("ﾙ"). ())("ﾙ"))
+    ((("ﾚ"). ())("ﾚ"))
+    ((("ﾛ"). ())("ﾛ"))
+    ((("ﾜ"). ())("ﾜ"))
+    ((("ｰ"). ())("ｰ"))
+    ((("｡"). ())("｡"))
+    ((("､"). ())("､"))
+    ((("･"). ())("･"))
+    ((("ﾞ"). ())("ﾞ"))
+    ((("ﾟ"). ())("ﾟ"))
+    ((("｢"). ())("｢"))
+    ((("｣"). ())("｣"))
+    ))
diff --git a/scm/japanese-kzik-utf8.scm b/scm/japanese-kzik-utf8.scm
new file mode 100644
index 000000000..c288d17c0
--- /dev/null
+++ b/scm/japanese-kzik-utf8.scm
@@ -0,0 +1,618 @@
+;;;
+;;; Copyright (c) 2010-2013 uim Project https://github.com/uim/uim
+;;;
+;;; All rights reserved.
+;;;
+;;; Redistribution and use in source and binary forms, with or without
+;;; modification, are permitted provided that the following conditions
+;;; are met:
+;;; 1. Redistributions of source code must retain the above copyright
+;;;    notice, this list of conditions and the following disclaimer.
+;;; 2. Redistributions in binary form must reproduce the above copyright
+;;;    notice, this list of conditions and the following disclaimer in the
+;;;    documentation and/or other materials provided with the distribution.
+;;; 3. Neither the name of authors nor the names of its contributors
+;;;    may be used to endorse or promote products derived from this software
+;;;    without specific prior written permission.
+;;;
+;;; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND
+;;; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+;;; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+;;; ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE
+;;; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+;;; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+;;; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+;;; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+;;; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+;;; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+;;; SUCH DAMAGE.
+;;;;
+
+(define ja-kzik-rule-basic
+  '(
+
+    (((":"). ())("ー" "ー" "ｰ"))
+    (((";"). ())("っ" "ッ" "ｯ"))
+    ((("b" "d"). ())(("べ" "ベ" "ﾍﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "a"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("b" "g" "d"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "e"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("b" "g" "h"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("b" "g" "j"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "l"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "n"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("b" "g" "o"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ")))
+    ((("b" "g" "p"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("b" "g" "q"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("b" "g" "u"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("b" "g" "w"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("b" "g" "z"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("b" "h"). ())(("ぶ" "ブ" "ﾌﾞ") ("う" "ウ" "ｳ")))
+    ((("b" "j"). ())(("ぶ" "ブ" "ﾌﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "k"). ())(("び" "ビ" "ﾋﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "l"). ())(("ぼ" "ボ" "ﾎﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "n"). ())(("ば" "バ" "ﾊﾞ") ("ん" "ン" "ﾝ")))
+    ((("b" "p"). ())(("ぼ" "ボ" "ﾎﾞ") ("う" "ウ" "ｳ")))
+    ((("b" "q"). ())(("ば" "バ" "ﾊﾞ") ("い" "イ" "ｲ")))
+    ((("b" "t"). ())(("び" "ビ" "ﾋﾞ") ("と" "ト" "ﾄ")))
+    ((("b" "w"). ())(("べ" "ベ" "ﾍﾞ") ("い" "イ" "ｲ")))
+    ((("b" "y" "d"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("b" "y" "h"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("b" "y" "j"). ())(("び" "ビ" "ﾋﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("b" "y" "l"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("b" "y" "n"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("b" "y" "p"). ())(("び" "ビ" "ﾋﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("b" "y" "q"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("b" "y" "w"). ())(("び" "ビ" "ﾋﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("b" "y" "z"). ())(("び" "ビ" "ﾋﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("b" "z"). ())(("ば" "バ" "ﾊﾞ") ("ん" "ン" "ﾝ")))
+    ((("c" "a"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ")))
+    ((("c" "d"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("c" "e"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ")))
+    ((("c" "h"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("c" "j"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("c" "l"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("c" "n"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("c" "o"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ")))
+    ((("c" "p"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("c" "q"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("c" "u"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ")))
+    ((("c" "w"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("c" "y" "a"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ")))
+    ((("c" "y" "e"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ")))
+    ((("c" "y" "i"). ())(("ち" "チ" "ﾁ") ("ぃ" "ィ" "ｨ")))
+    ((("c" "y" "o"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ")))
+    ((("c" "y" "u"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ")))
+    ((("c" "z"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("d" "c" "i"). ())(("で" "デ" "ﾃﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("d" "c" "u"). ())(("ど" "ド" "ﾄﾞ") ("ぅ" "ゥ" "ｩ")))
+    ((("d" "d"). ())(("で" "デ" "ﾃﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "f"). ())("で" "デ" "ﾃﾞ"))
+    ((("d" "h"). ())(("づ" "ヅ" "ﾂﾞ") ("う" "ウ" "ｳ")))
+    ((("d" "j"). ())(("づ" "ヅ" "ﾂﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "k"). ())(("ぢ" "ヂ" "ﾁﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "l"). ())(("ど" "ド" "ﾄﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "m"). ())(("で" "デ" "ﾃﾞ") ("も" "モ" "ﾓ")))
+    ((("d" "n"). ())(("だ" "ダ" "ﾀﾞ") ("ん" "ン" "ﾝ")))
+    ((("d" "p"). ())(("ど" "ド" "ﾄﾞ") ("う" "ウ" "ｳ")))
+    ((("d" "q"). ())(("だ" "ダ" "ﾀﾞ") ("い" "イ" "ｲ")))
+    ((("d" "s"). ())(("で" "デ" "ﾃﾞ") ("す" "ス" "ｽ")))
+    ((("d" "t"). ())(("だ" "ダ" "ﾀﾞ") ("ち" "チ" "ﾁ")))
+    ((("d" "w"). ())(("で" "デ" "ﾃﾞ") ("い" "イ" "ｲ")))
+    ((("d" "z"). ())(("だ" "ダ" "ﾀﾞ") ("ん" "ン" "ﾝ")))
+    ((("f" "d"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("f" "h"). ())(("ふ" "フ" "ﾌ") ("う" "ウ" "ｳ")))
+    ((("f" "j"). ())(("ふ" "フ" "ﾌ") ("ん" "ン" "ﾝ")))
+    ((("f" "k"). ())(("ふ" "フ" "ﾌ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+    ((("f" "l"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ") ("ん" "ン" "ﾝ")))
+    ((("f" "n"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ") ("ん" "ン" "ﾝ")))
+    ((("f" "p"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+    ((("f" "q"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ") ("い" "イ" "ｲ")))
+    ((("f" "w"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("f" "z"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ") ("ん" "ン" "ﾝ")))
+    ((("g" "d"). ())(("げ" "ゲ" "ｹﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "a"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("g" "g" "u"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("g" "g" "e"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("g" "g" "o"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ")))
+    ((("g" "g" "z"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "n"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "j"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "d"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "l"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("g" "g" "q"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("g" "g" "h"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("g" "g" "w"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("g" "g" "p"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("g" "h"). ())(("ぐ" "グ" "ｸﾞ") ("う" "ウ" "ｳ")))
+    ((("g" "j"). ())(("ぐ" "グ" "ｸﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "k"). ())(("ぎ" "ギ" "ｷﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "l"). ())(("ご" "ゴ" "ｺﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "n"). ())(("が" "ガ" "ｶﾞ") ("ん" "ン" "ﾝ")))
+    ((("g" "p"). ())(("ご" "ゴ" "ｺﾞ") ("う" "ウ" "ｳ")))
+    ((("g" "q"). ())(("が" "ガ" "ｶﾞ") ("い" "イ" "ｲ")))
+    ((("g" "r"). ())(("が" "ガ" "ｶﾞ") ("ら" "ラ" "ﾗ")))
+    ((("g" "t"). ())(("ご" "ゴ" "ｺﾞ") ("と" "ト" "ﾄ")))
+    ((("g" "w"). ())(("げ" "ゲ" "ｹﾞ") ("い" "イ" "ｲ")))
+    ((("g" "w" "a"). ())(("ぐ" "グ" "ｸﾞ") ("ぁ" "ァ" "ｧ")))
+    ((("g" "w" "e"). ())(("ぐ" "グ" "ｸﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("g" "w" "i"). ())(("ぐ" "グ" "ｸﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("g" "w" "o"). ())(("ぐ" "グ" "ｸﾞ") ("ぉ" "ォ" "ｫ")))
+    ((("g" "w" "u"). ())(("ぐ" "グ" "ｸﾞ") ("ぅ" "ゥ" "ｩ")))
+    ((("g" "y" "d"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("g" "y" "h"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("g" "y" "j"). ())(("ぎ" "ギ" "ｷﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("g" "y" "l"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("g" "y" "n"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("g" "y" "p"). ())(("ぎ" "ギ" "ｷﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("g" "y" "q"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("g" "y" "w"). ())(("ぎ" "ギ" "ｷﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("g" "y" "z"). ())(("ぎ" "ギ" "ｷﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("g" "z"). ())(("が" "ガ" "ｶﾞ") ("ん" "ン" "ﾝ")))
+    ((("h" "d"). ())(("へ" "ヘ" "ﾍ") ("ん" "ン" "ﾝ")))
+    ((("h" "g" "a"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ")))
+    ((("h" "g" "d"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("h" "g" "e"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ")))
+    ((("h" "g" "h"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("h" "g" "j"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("h" "g" "l"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("h" "g" "n"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("h" "g" "o"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ")))
+    ((("h" "g" "p"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("h" "g" "q"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("h" "g" "u"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ")))
+    ((("h" "g" "w"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("h" "g" "z"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("h" "h"). ())(("ふ" "フ" "ﾌ") ("う" "ウ" "ｳ")))
+    ((("h" "j"). ())(("ふ" "フ" "ﾌ") ("ん" "ン" "ﾝ")))
+    ((("h" "k"). ())(("ひ" "ヒ" "ﾋ") ("ん" "ン" "ﾝ")))
+    ((("h" "l"). ())(("ほ" "ホ" "ﾎ") ("ん" "ン" "ﾝ")))
+    ((("h" "n"). ())(("は" "ハ" "ﾊ") ("ん" "ン" "ﾝ")))
+    ((("h" "p"). ())(("ほ" "ホ" "ﾎ") ("う" "ウ" "ｳ")))
+    ((("h" "q"). ())(("は" "ハ" "ﾊ") ("い" "イ" "ｲ")))
+    ((("h" "t"). ())(("ひ" "ヒ" "ﾋ") ("と" "ト" "ﾄ")))
+    ((("h" "w"). ())(("へ" "ヘ" "ﾍ") ("い" "イ" "ｲ")))
+    ((("h" "y" "d"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("h" "y" "h"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("h" "y" "j"). ())(("ひ" "ヒ" "ﾋ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("h" "y" "l"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("h" "y" "n"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("h" "y" "p"). ())(("ひ" "ヒ" "ﾋ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("h" "y" "q"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("h" "y" "w"). ())(("ひ" "ヒ" "ﾋ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("h" "y" "z"). ())(("ひ" "ヒ" "ﾋ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("h" "z"). ())(("は" "ハ" "ﾊ") ("ん" "ン" "ﾝ")))
+    ((("j" "d"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("j" "f"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("j" "h"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("j" "j"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("j" "k"). ())(("じ" "ジ" "ｼﾞ") ("ん" "ン" "ﾝ")))
+    ((("j" "l"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("j" "n"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("j" "p"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("j" "q"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("j" "w"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("j" "y" "a"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("j" "y" "e"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("j" "y" "i"). ())(("じ" "ジ" "ｼﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("j" "y" "o"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ")))
+    ((("j" "y" "u"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("j" "z"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "d"). ())(("け" "ケ" "ｹ") ("ん" "ン" "ﾝ")))
+    ((("k" "f"). ())("き" "キ" "ｷ"))
+    ((("k" "g" "a"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ")))
+    ((("k" "g" "d"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("k" "g" "e"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ")))
+    ((("k" "g" "h"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("k" "g" "j"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("k" "g" "l"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("k" "g" "n"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "g" "o"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ")))
+    ((("k" "g" "p"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("k" "g" "q"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("k" "g" "u"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ")))
+    ((("k" "g" "w"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("k" "g" "z"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "h"). ())(("く" "ク" "ｸ") ("う" "ウ" "ｳ")))
+    ((("k" "j"). ())(("く" "ク" "ｸ") ("ん" "ン" "ﾝ")))
+    ((("k" "k"). ())(("き" "キ" "ｷ") ("ん" "ン" "ﾝ")))
+    ((("k" "l"). ())(("こ" "コ" "ｺ") ("ん" "ン" "ﾝ")))
+    ((("k" "m"). ())(("か" "カ" "ｶ") ("も" "モ" "ﾓ")))
+    ((("k" "n"). ())(("か" "カ" "ｶ") ("ん" "ン" "ﾝ")))
+    ((("k" "p"). ())(("こ" "コ" "ｺ") ("う" "ウ" "ｳ")))
+    ((("k" "q"). ())(("か" "カ" "ｶ") ("い" "イ" "ｲ")))
+    ((("k" "r"). ())(("か" "カ" "ｶ") ("ら" "ラ" "ﾗ")))
+    ((("k" "t"). ())(("こ" "コ" "ｺ") ("と" "ト" "ﾄ")))
+    ((("k" "w"). ())(("け" "ケ" "ｹ") ("い" "イ" "ｲ")))
+    ((("k" "y" "d"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("k" "y" "h"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("k" "y" "j"). ())(("き" "キ" "ｷ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("k" "y" "l"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("k" "y" "n"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "y" "p"). ())(("き" "キ" "ｷ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("k" "y" "q"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("k" "y" "w"). ())(("き" "キ" "ｷ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("k" "y" "z"). ())(("き" "キ" "ｷ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("k" "z"). ())(("か" "カ" "ｶ") ("ん" "ン" "ﾝ")))
+    ((("l" "a"). ())("ぁ" "ァ" "ｧ"))
+    ((("l" "e"). ())("ぇ" "ェ" "ｪ"))
+    ((("l" "i"). ())("ぃ" "ィ" "ｨ"))
+    ((("l" "o"). ())("ぉ" "ォ" "ｫ"))
+    ((("l" "u"). ())("ぅ" "ゥ" "ｩ"))
+    ((("l" "y" "a"). ())("ゃ" "ャ" "ｬ"))
+    ((("l" "y" "e"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ")))
+    ((("l" "y" "i"). ())(("り" "リ" "ﾘ") ("ぃ" "ィ" "ｨ")))
+    ((("l" "y" "o"). ())("ょ" "ョ" "ｮ"))
+    ((("l" "y" "u"). ())("ゅ" "ュ" "ｭ"))
+    ((("m" "d"). ())(("め" "メ" "ﾒ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "a"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ")))
+    ((("m" "g" "d"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "e"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ")))
+    ((("m" "g" "h"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("m" "g" "j"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "l"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "n"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("m" "g" "o"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ")))
+    ((("m" "g" "p"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("m" "g" "q"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("m" "g" "u"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ")))
+    ((("m" "g" "w"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("m" "g" "z"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("m" "f"). ())("む" "ム" "ﾑ"))
+    ((("m" "h"). ())(("む" "ム" "ﾑ") ("う" "ウ" "ｳ")))
+    ((("m" "j"). ())(("む" "ム" "ﾑ") ("ん" "ン" "ﾝ")))
+    ((("m" "k"). ())(("み" "ミ" "ﾐ") ("ん" "ン" "ﾝ")))
+    ((("m" "l"). ())(("も" "モ" "ﾓ") ("ん" "ン" "ﾝ")))
+    ((("m" "n"). ())(("も" "モ" "ﾓ") ("の" "ノ" "ﾉ")))
+    ((("m" "p"). ())(("も" "モ" "ﾓ") ("う" "ウ" "ｳ")))
+    ((("m" "q"). ())(("ま" "マ" "ﾏ") ("い" "イ" "ｲ")))
+    ((("m" "s"). ())(("ま" "マ" "ﾏ") ("す" "ス" "ｽ")))
+    ((("m" "t"). ())(("ま" "マ" "ﾏ") ("た" "タ" "ﾀ")))
+    ((("m" "w"). ())(("め" "メ" "ﾒ") ("い" "イ" "ｲ")))
+    ((("m" "y" "d"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("m" "y" "h"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("m" "y" "j"). ())(("み" "ミ" "ﾐ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("m" "y" "l"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("m" "y" "n"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("m" "y" "p"). ())(("み" "ミ" "ﾐ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("m" "y" "q"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("m" "y" "w"). ())(("み" "ミ" "ﾐ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("m" "y" "z"). ())(("み" "ミ" "ﾐ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("m" "z"). ())(("ま" "マ" "ﾏ") ("ん" "ン" "ﾝ")))
+    ((("n"). ())("ん" "ン" "ﾝ"))
+    ((("n" "b"). ())(("ね" "ネ" "ﾈ") ("ば" "バ" "ﾊﾞ")))
+    ((("n" "d"). ())(("ね" "ネ" "ﾈ") ("ん" "ン" "ﾝ")))
+    ((("n" "f"). ())("ぬ" "ヌ" "ﾇ"))
+    ((("n" "g" "a"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ")))
+    ((("n" "g" "d"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("n" "g" "e"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ")))
+    ((("n" "g" "h"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("n" "g" "j"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("n" "g" "l"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("n" "g" "n"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("n" "g" "o"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ")))
+    ((("n" "g" "p"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("n" "g" "q"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("n" "g" "u"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ")))
+    ((("n" "g" "w"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("n" "g" "z"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("n" "h"). ())(("ぬ" "ヌ" "ﾇ") ("う" "ウ" "ｳ")))
+    ((("n" "j"). ())(("ぬ" "ヌ" "ﾇ") ("ん" "ン" "ﾝ")))
+    ((("n" "k"). ())(("に" "ニ" "ﾆ") ("ん" "ン" "ﾝ")))
+    ((("n" "l"). ())(("の" "ノ" "ﾉ") ("ん" "ン" "ﾝ")))
+    ((("n" "p"). ())(("の" "ノ" "ﾉ") ("う" "ウ" "ｳ")))
+    ((("n" "q"). ())(("な" "ナ" "ﾅ") ("い" "イ" "ｲ")))
+    ((("n" "r"). ())(("な" "ナ" "ﾅ") ("る" "ル" "ﾙ")))
+    ((("n" "t"). ())(("に" "ニ" "ﾆ") ("ち" "チ" "ﾁ")))
+    ((("n" "w"). ())(("ね" "ネ" "ﾈ") ("い" "イ" "ｲ")))
+    ((("n" "y" "d"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("n" "y" "h"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("n" "y" "j"). ())(("に" "ニ" "ﾆ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("n" "y" "l"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("n" "y" "n"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("n" "y" "p"). ())(("に" "ニ" "ﾆ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("n" "y" "q"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("n" "y" "w"). ())(("に" "ニ" "ﾆ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("n" "y" "z"). ())(("に" "ニ" "ﾆ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("n" "z"). ())(("な" "ナ" "ﾅ") ("ん" "ン" "ﾝ")))
+    ((("p" "d"). ())(("ぺ" "ペ" "ﾍﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "a"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ")))
+    ((("p" "g" "d"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "e"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ")))
+    ((("p" "g" "h"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("p" "g" "j"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "l"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "n"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("p" "g" "o"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ")))
+    ((("p" "g" "p"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("p" "g" "q"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("p" "g" "u"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ")))
+    ((("p" "g" "w"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("p" "g" "z"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("p" "h"). ())(("ぷ" "プ" "ﾌﾟ") ("う" "ウ" "ｳ")))
+    ((("p" "j"). ())(("ぷ" "プ" "ﾌﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "k"). ())(("ぴ" "ピ" "ﾋﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "l"). ())(("ぽ" "ポ" "ﾎﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "n"). ())(("ぱ" "パ" "ﾊﾟ") ("ん" "ン" "ﾝ")))
+    ((("p" "p"). ())(("ぽ" "ポ" "ﾎﾟ") ("う" "ウ" "ｳ")))
+    ((("p" "q"). ())(("ぱ" "パ" "ﾊﾟ") ("い" "イ" "ｲ")))
+    ((("p" "w"). ())(("ぺ" "ペ" "ﾍﾟ") ("い" "イ" "ｲ")))
+    ((("p" "y" "d"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("p" "y" "h"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("p" "y" "j"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("p" "y" "l"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("p" "y" "n"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("p" "y" "p"). ())(("ぴ" "ピ" "ﾋﾟ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("p" "y" "q"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("p" "y" "w"). ())(("ぴ" "ピ" "ﾋﾟ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("p" "y" "z"). ())(("ぴ" "ピ" "ﾋﾟ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("p" "z"). ())(("ぱ" "パ" "ﾊﾟ") ("ん" "ン" "ﾝ")))
+    ((("q"). ())("ん" "ン" "ﾝ"))
+    ((("r" "d"). ())(("れ" "レ" "ﾚ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "a"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ")))
+    ((("r" "g" "d"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "e"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ")))
+    ((("r" "g" "h"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("r" "g" "j"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "l"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "n"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("r" "g" "o"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ")))
+    ((("r" "g" "p"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("r" "g" "q"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("r" "g" "u"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ")))
+    ((("r" "g" "w"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("r" "g" "z"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("r" "h"). ())(("る" "ル" "ﾙ") ("う" "ウ" "ｳ")))
+    ((("r" "j"). ())(("る" "ル" "ﾙ") ("ん" "ン" "ﾝ")))
+    ((("r" "k"). ())(("り" "リ" "ﾘ") ("ん" "ン" "ﾝ")))
+    ((("r" "l"). ())(("ろ" "ロ" "ﾛ") ("ん" "ン" "ﾝ")))
+    ((("r" "n"). ())(("ら" "ラ" "ﾗ") ("ん" "ン" "ﾝ")))
+    ((("r" "p"). ())(("ろ" "ロ" "ﾛ") ("う" "ウ" "ｳ")))
+    ((("r" "q"). ())(("ら" "ラ" "ﾗ") ("い" "イ" "ｲ")))
+    ((("r" "r"). ())(("ら" "ラ" "ﾗ") ("れ" "レ" "ﾚ")))
+    ((("r" "w"). ())(("れ" "レ" "ﾚ") ("い" "イ" "ｲ")))
+    ((("r" "y" "d"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("r" "y" "h"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("r" "y" "j"). ())(("り" "リ" "ﾘ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("r" "y" "l"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("r" "y" "n"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("r" "y" "p"). ())(("り" "リ" "ﾘ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("r" "y" "q"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("r" "y" "w"). ())(("り" "リ" "ﾘ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("r" "y" "z"). ())(("り" "リ" "ﾘ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("r" "z"). ())(("ら" "ラ" "ﾗ") ("ん" "ン" "ﾝ")))
+    ((("s" "d"). ())(("せ" "セ" "ｾ") ("ん" "ン" "ﾝ")))
+    ((("s" "f"). ())(("さ" "サ" "ｻ") ("い" "イ" "ｲ")))
+    ((("s" "h"). ())(("す" "ス" "ｽ") ("う" "ウ" "ｳ")))
+    ((("s" "j"). ())(("す" "ス" "ｽ") ("ん" "ン" "ﾝ")))
+    ((("s" "k"). ())(("し" "シ" "ｼ") ("ん" "ン" "ﾝ")))
+    ((("s" "l"). ())(("そ" "ソ" "ｿ") ("ん" "ン" "ﾝ")))
+    ((("s" "n"). ())(("さ" "サ" "ｻ") ("ん" "ン" "ﾝ")))
+    ((("s" "p"). ())(("そ" "ソ" "ｿ") ("う" "ウ" "ｳ")))
+    ((("s" "q"). ())(("さ" "サ" "ｻ") ("い" "イ" "ｲ")))
+    ((("s" "r"). ())(("す" "ス" "ｽ") ("る" "ル" "ﾙ")))
+    ((("s" "s"). ())(("せ" "セ" "ｾ") ("い" "イ" "ｲ")))
+    ((("s" "t"). ())(("し" "シ" "ｼ") ("た" "タ" "ﾀ")))
+    ((("s" "w"). ())(("せ" "セ" "ｾ") ("い" "イ" "ｲ")))
+    ((("s" "y" "d"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("s" "y" "h"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("s" "y" "j"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("s" "y" "l"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("s" "y" "n"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("s" "y" "p"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("s" "y" "q"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("s" "y" "w"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("s" "y" "z"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("s" "z"). ())(("さ" "サ" "ｻ") ("ん" "ン" "ﾝ")))
+    ((("t" "b"). ())(("た" "タ" "ﾀ") ("び" "ビ" "ﾋﾞ")))
+    ((("t" "c" "h"). ())("っ" "ッ" "ｯ"))
+    ((("t" "d"). ())(("て" "テ" "ﾃ") ("ん" "ン" "ﾝ")))
+    ((("t" "g" "i"). ())(("て" "テ" "ﾃ") ("ぃ" "ィ" "ｨ")))
+    ((("t" "g" "u"). ())(("と" "ト" "ﾄ") ("ぅ" "ゥ" "ｩ")))
+    ((("t" "h"). ())(("つ" "ツ" "ﾂ") ("う" "ウ" "ｳ")))
+    ((("t" "j"). ())(("つ" "ツ" "ﾂ") ("ん" "ン" "ﾝ")))
+    ((("t" "k"). ())(("ち" "チ" "ﾁ") ("ん" "ン" "ﾝ")))
+    ((("t" "l"). ())(("と" "ト" "ﾄ") ("ん" "ン" "ﾝ")))
+    ((("t" "m"). ())(("た" "タ" "ﾀ") ("め" "メ" "ﾒ")))
+    ((("t" "n"). ())(("た" "タ" "ﾀ") ("ん" "ン" "ﾝ")))
+    ((("t" "p"). ())(("と" "ト" "ﾄ") ("う" "ウ" "ｳ")))
+    ((("t" "q"). ())(("た" "タ" "ﾀ") ("い" "イ" "ｲ")))
+    ((("t" "r"). ())(("た" "タ" "ﾀ") ("ら" "ラ" "ﾗ")))
+    ((("t" "s" "a"). ())(("つ" "ツ" "ﾂ") ("ぁ" "ァ" "ｧ")))
+    ((("t" "s" "e"). ())(("つ" "ツ" "ﾂ") ("ぇ" "ェ" "ｪ")))
+    ((("t" "s" "i"). ())(("つ" "ツ" "ﾂ") ("ぃ" "ィ" "ｨ")))
+    ((("t" "s" "o"). ())(("つ" "ツ" "ﾂ") ("ぉ" "ォ" "ｫ")))
+    ((("t" "w"). ())(("て" "テ" "ﾃ") ("い" "イ" "ｲ")))
+    ((("t" "y" "d"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("t" "y" "h"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("t" "y" "j"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("t" "y" "l"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("t" "y" "n"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("t" "y" "p"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("t" "y" "q"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("t" "y" "w"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("t" "y" "z"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("t" "z"). ())(("た" "タ" "ﾀ") ("ん" "ン" "ﾝ")))
+    ((("w" "d"). ())(("う" "ウ" "ｳ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("w" "k"). ())(("う" "ウ" "ｳ") ("ぃ" "ィ" "ｨ") ("ん" "ン" "ﾝ")))
+    ((("w" "l"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ") ("ん" "ン" "ﾝ")))
+    ((("w" "n"). ())(("わ" "ワ" "ﾜ") ("ん" "ン" "ﾝ")))
+    ((("w" "p"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ") ("ー" "ー" "ｰ")))
+    ((("w" "q"). ())(("わ" "ワ" "ﾜ") ("い" "イ" "ｲ")))
+    ((("w" "r"). ())(("わ" "ワ" "ﾜ") ("れ" "レ" "ﾚ")))
+    ((("w" "s" "o"). ())(("う" "ウ" "ｳ") ("ぉ" "ォ" "ｫ")))
+    ((("w" "t"). ())(("わ" "ワ" "ﾜ") ("た" "タ" "ﾀ")))
+    ((("w" "u"). ())("う" "ウ" "ｳ"))
+    ((("w" "z"). ())(("わ" "ワ" "ﾜ") ("ん" "ン" "ﾝ")))
+    ((("x" "a"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ")))
+    ((("x" "d"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("x" "e"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ")))
+    ((("x" "h"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("x" "j"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("x" "l"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("x" "n"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("x" "o"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ")))
+    ((("x" "p"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("x" "q"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("x" "u"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ")))
+    ((("x" "x" "a"). ())("ぁ" "ァ" "ｧ"))
+    ((("x" "x" "i"). ())("ぃ" "ィ" "ｨ"))
+    ((("x" "x" "u"). ())("ぅ" "ゥ" "ｩ"))
+    ((("x" "x" "e"). ())("ぇ" "ェ" "ｪ"))
+    ((("x" "x" "o"). ())("ぉ" "ォ" "ｫ"))
+    ((("x" "x" "w" "a"). ())("ゎ" "ヮ" "ﾜ"))
+    ((("x" "x" "w" "i"). ())("ゐ" "ヰ" "ｨ"))
+    ((("x" "x" "w" "e"). ())("ゑ" "ヱ" "ｪ"))
+    ((("x" "x" "h"). ())("←" "←" ""))
+    ((("x" "x" "j"). ())("↓" "↓" ""))
+    ((("x" "x" "k"). ())("↑" "↑" ""))
+    ((("x" "x" "l"). ())("→" "→" ""))
+    ((("x" "-"). ())("-" "-" ""))
+    ((("x" ";"). ())(";" ";" ""))
+    ((("x" ":"). ())(":" ":" ""))
+    ((("x" "_"). ())("　" "　" ""))
+    ((("x" ","). ())("," "," ""))
+    ((("x" "."). ())("." "." ""))
+    ((("x" "["). ())("[" "[" ""))
+    ((("x" "]"). ())("]" "]" ""))
+    ((("x" "~"). ())("~" "~" ""))
+    ((("x" "w"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("x" "z"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("y" "e"). ())(("い" "イ" "ｲ") ("ぇ" "ェ" "ｪ")))
+    ((("y" "f"). ())("ゆ" "ユ" "ﾕ"))
+    ((("y" "h"). ())(("ゆ" "ユ" "ﾕ") ("う" "ウ" "ｳ")))
+    ((("y" "i"). ())("い" "イ" "ｲ"))
+    ((("y" "j"). ())(("ゆ" "ユ" "ﾕ") ("ん" "ン" "ﾝ")))
+    ((("y" "l"). ())(("よ" "ヨ" "ﾖ") ("ん" "ン" "ﾝ")))
+    ((("y" "n"). ())(("や" "ヤ" "ﾔ") ("ん" "ン" "ﾝ")))
+    ((("y" "p"). ())(("よ" "ヨ" "ﾖ") ("う" "ウ" "ｳ")))
+    ((("y" "q"). ())(("や" "ヤ" "ﾔ") ("い" "イ" "ｲ")))
+    ((("y" "r"). ())(("よ" "ヨ" "ﾖ") ("る" "ル" "ﾙ")))
+    ((("y" "w"). ())(("い" "イ" "ｲ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("y" "z"). ())(("や" "ヤ" "ﾔ") ("ん" "ン" "ﾝ")))
+    ((("z" "c"). ())("ざ" "ザ" "ｻﾞ"))
+    ((("z" "d"). ())(("ぜ" "ゼ" "ｾﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "f"). ())("ぜ" "ゼ" "ｾﾞ"))
+    ((("z" "g" "a"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("z" "g" "d"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("z" "g" "e"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("z" "g" "h"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("z" "g" "j"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("z" "g" "l"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("z" "g" "n"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("z" "g" "o"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ")))
+    ((("z" "g" "p"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("z" "g" "q"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("z" "g" "u"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("z" "g" "w"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("z" "g" "z"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("z" "h"). ())(("ず" "ズ" "ｽﾞ") ("う" "ウ" "ｳ")))
+    ((("z" "j"). ())(("ず" "ズ" "ｽﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "k"). ())(("じ" "ジ" "ｼﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "l"). ())(("ぞ" "ゾ" "ｿﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "n"). ())(("ざ" "ザ" "ｻﾞ") ("ん" "ン" "ﾝ")))
+    ((("z" "p"). ())(("ぞ" "ゾ" "ｿﾞ") ("う" "ウ" "ｳ")))
+    ((("z" "q"). ())(("ざ" "ザ" "ｻﾞ") ("い" "イ" "ｲ")))
+    ((("z" "r"). ())(("ざ" "ザ" "ｻﾞ") ("る" "ル" "ﾙ")))
+    ((("z" "v"). ())(("ざ" "ザ" "ｻﾞ") ("い" "イ" "ｲ")))
+    ((("z" "w"). ())(("ぜ" "ゼ" "ｾﾞ") ("い" "イ" "ｲ")))
+    ((("z" "x"). ())(("ぜ" "ゼ" "ｾﾞ") ("い" "イ" "ｲ")))
+    ((("z" "y" "d"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("ん" "ン" "ﾝ")))
+    ((("z" "y" "h"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("う" "ウ" "ｳ")))
+    ((("z" "y" "j"). ())(("じ" "ジ" "ｼﾞ") ("ゅ" "ュ" "ｭ") ("ん" "ン" "ﾝ")))
+    ((("z" "y" "l"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("ん" "ン" "ﾝ")))
+    ((("z" "y" "n"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("z" "y" "p"). ())(("じ" "ジ" "ｼﾞ") ("ょ" "ョ" "ｮ") ("う" "ウ" "ｳ")))
+    ((("z" "y" "q"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("い" "イ" "ｲ")))
+    ((("z" "y" "w"). ())(("じ" "ジ" "ｼﾞ") ("ぇ" "ェ" "ｪ") ("い" "イ" "ｲ")))
+    ((("z" "y" "z"). ())(("じ" "ジ" "ｼﾞ") ("ゃ" "ャ" "ｬ") ("ん" "ン" "ﾝ")))
+    ((("z" "z"). ())(("ざ" "ザ" "ｻﾞ") ("ん" "ン" "ﾝ")))
+    ((("s" "g"). ())("思" "思" ""))
+    ((("s" "x"). ())("着" "着" ""))
+    ((("s" "c"). ())("送" "送" ""))
+    ((("s" "v"). ())("空" "空" ""))
+    ((("s" "b"). ())("分" "分" ""))
+    ((("s" "m"). ())("見" "見" ""))
+    ((("d" "r"). ())("対" "対" ""))
+    ((("d" "g"). ())("大" "大" ""))
+    ((("d" "x"). ())("代" "代" ""))
+    ((("d" "v"). ())("遅" "遅" ""))
+    ((("d" "b"). ())("書" "書" ""))
+    ((("f" "r"). ())("件" "件" ""))
+    ((("f" "t"). ())("仕" "仕" ""))
+    ((("f" "s"). ())("会" "会" ""))
+    ((("f" "g"). ())("以" "以" ""))
+    ((("f" "x"). ())("点" "点" ""))
+    ((("f" "c"). ())("押" "押" ""))
+    ((("f" "v"). ())("換" "換" ""))
+    ((("f" "b"). ())("付" "付" ""))
+    ((("g" "s"). ())("行" "行" ""))
+    ((("g" "f"). ())("試" "試" ""))
+    ((("g" "x"). ())("欠" "欠" ""))
+    ((("g" "c"). ())("要" "要" ""))
+    ((("g" "v"). ())("用" "用" ""))
+    ((("g" "b"). ())("様" "様" ""))
+    ((("h" "r"). ())("合" "合" ""))
+    ((("h" "s"). ())("方" "方" ""))
+    ((("h" "f"). ())("法" "法" ""))
+    ((("h" "x"). ())("機" "機" ""))
+    ((("h" "c"). ())("移" "移" ""))
+    ((("h" "v"). ())("信" "信" ""))
+    ((("h" "b"). ())("買" "買" ""))
+    ((("j" "r"). ())("重" "重" ""))
+    ((("j" "t"). ())("使" "使" ""))
+    ((("j" "s"). ())("★" "★" ""))
+    ((("j" "g"). ())("聞" "聞" ""))
+    ((("j" "x"). ())("生" "生" ""))
+    ((("j" "c"). ())("身" "身" ""))
+    ((("j" "v"). ())("地" "地" ""))
+    ((("j" "b"). ())("自" "自" ""))
+    ((("k" "s"). ())("★" "★" ""))
+    ((("k" "x"). ())("変" "変" ""))
+    ((("k" "c"). ())("開" "開" ""))
+    ((("k" "v"). ())("気" "気" ""))
+    ((("k" "b"). ())("効" "効" ""))
+    ((("r" "t"). ())("力" "力" ""))
+    ((("t" "f"). ())("強" "強" ""))
+    ((("v" "f"). ())("返" "返" ""))
+    ((("v" "z"). ())("帰" "帰" ""))
+))
+
+(define ja-rk-rule-basic-kzik-changeset
+  '(
+    ((("!"). ())("!" "!" "!"))
+    ((("\""). ())("\"" "\"" "\""))
+    ((("#"). ())("#" "#" "#"))
+    ((("$"). ())("$" "$" "$"))
+    ((("%"). ())("%" "%" "%"))
+    ((("&"). ())("&" "&" "&"))
+    ((("'"). ())("'" "'" "'"))
+    ((("("). ())("(" "(" "("))
+    (((")"). ())(")" ")" ")"))
+    ((("="). ())("=" "=" "="))
+    ((("^"). ())("^" "^" "^"))
+    ((("\\"). ())("\\" "\\" "\\"))
+    ((("|"). ())("|" "|" "|"))
+    ((("`"). ())("`" "`" "`"))
+    ((("@"). ())("@" "@" "@"))
+    ((("{"). ())("{" "{" "{"))
+    ((("+"). ())("+" "+" "+"))
+    (((";"). ())(";" ";" ";"))
+    ((("*"). ())("*" "*" "*"))
+    (((":"). ())(":" ":" ":"))
+    ((("}"). ())("}" "}" "}"))
+    ((("<"). ())("<" "<" "<"))
+    (((">"). ())(">" ">" ">"))
+    ((("?"). ())("?" "?" "?"))
+    ((("/"). ())("/" "/" "/"))
+    ((("_"). ())("_" "_" "_"))))
+
+(define (ja-rk-kzik-apply-changeset rule-basic)
+  (map (lambda (l)
+         (let ((c (assoc (car l) ja-rk-rule-basic-kzik-changeset)))
+           (if c
+               c
+               l)))
+       rule-basic))
+
+(define ja-kzik-rule (append ja-kzik-rule-basic (ja-rk-kzik-apply-changeset ja-rk-rule-basic)))
diff --git a/scm/japanese-utf8.scm b/scm/japanese-utf8.scm
new file mode 100644
index 000000000..37f28c6e6
--- /dev/null
+++ b/scm/japanese-utf8.scm
@@ -0,0 +1,675 @@
+;;;
+;;; Copyright (c) 2003-2013 uim Project https://github.com/uim/uim
+;;;
+;;; All rights reserved.
+;;;
+;;; Redistribution and use in source and binary forms, with or without
+;;; modification, are permitted provided that the following conditions
+;;; are met:
+;;; 1. Redistributions of source code must retain the above copyright
+;;;    notice, this list of conditions and the following disclaimer.
+;;; 2. Redistributions in binary form must reproduce the above copyright
+;;;    notice, this list of conditions and the following disclaimer in the
+;;;    documentation and/or other materials provided with the distribution.
+;;; 3. Neither the name of authors nor the names of its contributors
+;;;    may be used to endorse or promote products derived from this software
+;;;    without specific prior written permission.
+;;;
+;;; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND
+;;; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+;;; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+;;; ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE
+;;; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+;;; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+;;; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+;;; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+;;; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+;;; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+;;; SUCH DAMAGE.
+;;;;
+
+;; UTF-8
+
+(require-extension (srfi 1 2))
+(require-custom "japanese-custom-utf8.scm")
+(require "util.scm")
+
+(define ja-rk-rule-additional
+  '(
+    ((("d" "s" "u"). ())("づ" "ヅ" "ﾂﾞ"))
+
+    ((("d" "h" "a"). ())(("で" "デ" "ﾃﾞ") ("ゃ" "ャ" "ｬ")))
+    ((("d" "h" "i"). ())(("で" "デ" "ﾃﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("d" "h" "u"). ())(("で" "デ" "ﾃﾞ") ("ゅ" "ュ" "ｭ")))
+    ((("d" "h" "e"). ())(("で" "デ" "ﾃﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("d" "h" "o"). ())(("で" "デ" "ﾃﾞ") ("ょ" "ョ" "ｮ")))
+
+    ((("d" "w" "a"). ())(("ど" "ド" "ﾄﾞ") ("ぁ" "ァ" "ｧ")))
+    ((("d" "w" "i"). ())(("ど" "ド" "ﾄﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("d" "w" "u"). ())(("ど" "ド" "ﾄﾞ") ("ぅ" "ゥ" "ｩ")))
+    ((("d" "w" "e"). ())(("ど" "ド" "ﾄﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("d" "w" "o"). ())(("ど" "ド" "ﾄﾞ") ("ぉ" "ォ" "ｫ")))
+
+    ((("k" "w" "a"). ())(("く" "ク" "ｸ") ("ぁ" "ァ" "ｧ")))
+    ((("k" "w" "i"). ())(("く" "ク" "ｸ") ("ぃ" "ィ" "ｨ")))
+    ((("k" "w" "u"). ())(("く" "ク" "ｸ") ("ぅ" "ゥ" "ｩ")))
+    ((("k" "w" "e"). ())(("く" "ク" "ｸ") ("ぇ" "ェ" "ｪ")))
+    ((("k" "w" "o"). ())(("く" "ク" "ｸ") ("ぉ" "ォ" "ｫ")))
+
+    ((("s" "h" "a"). ())(("し" "シ" "ｼ") ("ゃ" "ャ" "ｬ")))
+    ((("s" "h" "i"). ())("し" "シ" "ｼ"))
+    ((("s" "h" "u"). ())(("し" "シ" "ｼ") ("ゅ" "ュ" "ｭ")))
+    ((("s" "h" "e"). ())(("し" "シ" "ｼ") ("ぇ" "ェ" "ｪ")))
+    ((("s" "h" "o"). ())(("し" "シ" "ｼ") ("ょ" "ョ" "ｮ")))
+
+    ((("s" "w" "a"). ())(("す" "ス" "ｽ") ("ぁ" "ァ" "ｧ")))
+    ((("s" "w" "i"). ())(("す" "ス" "ｽ") ("ぃ" "ィ" "ｨ")))
+    ((("s" "w" "u"). ())(("す" "ス" "ｽ") ("ぅ" "ゥ" "ｩ")))
+    ((("s" "w" "e"). ())(("す" "ス" "ｽ") ("ぇ" "ェ" "ｪ")))
+    ((("s" "w" "o"). ())(("す" "ス" "ｽ") ("ぉ" "ォ" "ｫ")))
+
+    ((("t" "w" "a"). ())(("と" "ト" "ﾄ") ("ぁ" "ァ" "ｧ")))
+    ((("t" "w" "i"). ())(("と" "ト" "ﾄ") ("ぃ" "ィ" "ｨ")))
+    ((("t" "w" "u"). ())(("と" "ト" "ﾄ") ("ぅ" "ゥ" "ｩ")))
+    ((("t" "w" "e"). ())(("と" "ト" "ﾄ") ("ぇ" "ェ" "ｪ")))
+    ((("t" "w" "o"). ())(("と" "ト" "ﾄ") ("ぉ" "ォ" "ｫ")))
+
+    ((("t" "h" "a"). ())(("て" "テ" "ﾃ") ("ゃ" "ャ" "ｬ")))
+    ((("t" "h" "i"). ())(("て" "テ" "ﾃ") ("ぃ" "ィ" "ｨ")))
+    ((("t" "h" "u"). ())(("て" "テ" "ﾃ") ("ゅ" "ュ" "ｭ")))
+    ((("t" "h" "e"). ())(("て" "テ" "ﾃ") ("ぇ" "ェ" "ｪ")))
+    ((("t" "h" "o"). ())(("て" "テ" "ﾃ") ("ょ" "ョ" "ｮ")))
+
+    ((("h" "w" "a"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ")))
+    ((("h" "w" "i"). ())(("ふ" "フ" "ﾌ") ("ぃ" "ィ" "ｨ")))
+    ((("h" "w" "e"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ")))
+    ((("h" "w" "o"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ")))
+
+    ((("f" "w" "a"). ())(("ふ" "フ" "ﾌ") ("ぁ" "ァ" "ｧ")))
+    ((("f" "w" "i"). ())(("ふ" "フ" "ﾌ") ("ぃ" "ィ" "ｨ")))
+    ((("f" "w" "u"). ())(("ふ" "フ" "ﾌ") ("ぅ" "ゥ" "ｩ")))
+    ((("f" "w" "e"). ())(("ふ" "フ" "ﾌ") ("ぇ" "ェ" "ｪ")))
+    ((("f" "w" "o"). ())(("ふ" "フ" "ﾌ") ("ぉ" "ォ" "ｫ")))
+
+    ((("x" "w" "a"). ())("ゎ" "ヮ" "ﾜ"))
+    ((("x" "w" "i"). ())("ゐ" "ヰ" "ｨ"))
+    ((("x" "w" "e"). ())("ゑ" "ヱ" "ｪ"))
+
+    ((("w" "y" "i"). ())("ゐ" "ヰ" "ｨ"))
+    ((("w" "y" "e"). ())("ゑ" "ヱ" "ｪ"))
+
+    ((("c" "h" "a"). ())(("ち" "チ" "ﾁ") ("ゃ" "ャ" "ｬ")))
+    ((("c" "h" "i"). ())("ち" "チ" "ﾁ"))
+    ((("c" "h" "u"). ())(("ち" "チ" "ﾁ") ("ゅ" "ュ" "ｭ")))
+    ((("c" "h" "e"). ())(("ち" "チ" "ﾁ") ("ぇ" "ェ" "ｪ")))
+    ((("c" "h" "o"). ())(("ち" "チ" "ﾁ") ("ょ" "ョ" "ｮ")))
+
+    ((("q" "w" "a"). ())(("く" "ク" "ｸ") ("ぁ" "ァ" "ｧ")))
+    ((("q" "w" "i"). ())(("く" "ク" "ｸ") ("ぃ" "ィ" "ｨ")))
+    ((("q" "w" "u"). ())(("く" "ク" "ｸ") ("ぅ" "ゥ" "ｩ")))
+    ((("q" "w" "e"). ())(("く" "ク" "ｸ") ("ぇ" "ェ" "ｪ")))
+    ((("q" "w" "o"). ())(("く" "ク" "ｸ") ("ぉ" "ォ" "ｫ")))
+
+    ((("q" "y" "a"). ())(("く" "ク" "ｸ") ("ゃ" "ャ" "ｬ")))
+    ((("q" "y" "i"). ())(("く" "ク" "ｸ") ("ぃ" "ィ" "ｨ")))
+    ((("q" "y" "u"). ())(("く" "ク" "ｸ") ("ゅ" "ュ" "ｭ")))
+    ((("q" "y" "e"). ())(("く" "ク" "ｸ") ("ぇ" "ェ" "ｪ")))
+    ((("q" "y" "o"). ())(("く" "ク" "ｸ") ("ょ" "ョ" "ｮ")))
+
+    ((("g" "w" "a"). ())(("ぐ" "グ" "ｸﾞ") ("ぁ" "ァ" "ｧ")))
+    ((("g" "w" "i"). ())(("ぐ" "グ" "ｸﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("g" "w" "u"). ())(("ぐ" "グ" "ｸﾞ") ("ぅ" "ゥ" "ｩ")))
+    ((("g" "w" "e"). ())(("ぐ" "グ" "ｸﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("g" "w" "o"). ())(("ぐ" "グ" "ｸﾞ") ("ぉ" "ォ" "ｫ")))
+
+    ((("z" "w" "a"). ())(("ず" "ズ" "ｽﾞ") ("ぁ" "ァ" "ｧ")))
+    ((("z" "w" "i"). ())(("ず" "ズ" "ｽﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("z" "w" "u"). ())(("ず" "ズ" "ｽﾞ") ("ぅ" "ゥ" "ｩ")))
+    ((("z" "w" "e"). ())(("ず" "ズ" "ｽﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("z" "w" "o"). ())(("ず" "ズ" "ｽﾞ") ("ぉ" "ォ" "ｫ")))
+
+    ;((("n" "w" "a"). ())(("ぬ" "ヌ" "ﾇ") ("ぁ" "ァ" "ｧ")))
+    ;((("n" "w" "i"). ())(("ぬ" "ヌ" "ﾇ") ("ぃ" "ィ" "ｨ")))
+    ;((("n" "w" "u"). ())(("ぬ" "ヌ" "ﾇ") ("ぅ" "ゥ" "ｩ")))
+    ;((("n" "w" "e"). ())(("ぬ" "ヌ" "ﾇ") ("ぇ" "ェ" "ｪ")))
+    ;((("n" "w" "o"). ())(("ぬ" "ヌ" "ﾇ") ("ぉ" "ォ" "ｫ")))
+
+    ((("b" "w" "a"). ())(("ぶ" "ブ" "ﾌﾞ") ("ぁ" "ァ" "ｧ")))
+    ((("b" "w" "i"). ())(("ぶ" "ブ" "ﾌﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("b" "w" "u"). ())(("ぶ" "ブ" "ﾌﾞ") ("ぅ" "ゥ" "ｩ")))
+    ((("b" "w" "e"). ())(("ぶ" "ブ" "ﾌﾞ") ("ぇ" "ェ" "ｪ")))
+    ((("b" "w" "o"). ())(("ぶ" "ブ" "ﾌﾞ") ("ぉ" "ォ" "ｫ")))
+
+    ((("p" "w" "a"). ())(("ぷ" "プ" "ﾌﾟ") ("ぁ" "ァ" "ｧ")))
+    ((("p" "w" "i"). ())(("ぷ" "プ" "ﾌﾟ") ("ぃ" "ィ" "ｨ")))
+    ((("p" "w" "u"). ())(("ぷ" "プ" "ﾌﾟ") ("ぅ" "ゥ" "ｩ")))
+    ((("p" "w" "e"). ())(("ぷ" "プ" "ﾌﾟ") ("ぇ" "ェ" "ｪ")))
+    ((("p" "w" "o"). ())(("ぷ" "プ" "ﾌﾟ") ("ぉ" "ォ" "ｫ")))
+
+    ((("m" "w" "a"). ())(("む" "ム" "ﾑ") ("ぁ" "ァ" "ｧ")))
+    ((("m" "w" "i"). ())(("む" "ム" "ﾑ") ("ぃ" "ィ" "ｨ")))
+    ((("m" "w" "u"). ())(("む" "ム" "ﾑ") ("ぅ" "ゥ" "ｩ")))
+    ((("m" "w" "e"). ())(("む" "ム" "ﾑ") ("ぇ" "ェ" "ｪ")))
+    ((("m" "w" "o"). ())(("む" "ム" "ﾑ") ("ぉ" "ォ" "ｫ")))
+
+    ((("y" "w" "a"). ())(("ゆ" "ユ" "ﾕ") ("ぁ" "ァ" "ｧ")))
+    ((("y" "w" "i"). ())(("ゆ" "ユ" "ﾕ") ("ぃ" "ィ" "ｨ")))
+    ((("y" "w" "u"). ())(("ゆ" "ユ" "ﾕ") ("ぅ" "ゥ" "ｩ")))
+    ((("y" "w" "e"). ())(("ゆ" "ユ" "ﾕ") ("ぇ" "ェ" "ｪ")))
+    ((("y" "w" "o"). ())(("ゆ" "ユ" "ﾕ") ("ぉ" "ォ" "ｫ")))
+
+    ((("r" "w" "a"). ())(("る" "ル" "ﾙ") ("ぁ" "ァ" "ｧ")))
+    ((("r" "w" "i"). ())(("る" "ル" "ﾙ") ("ぃ" "ィ" "ｨ")))
+    ((("r" "w" "u"). ())(("る" "ル" "ﾙ") ("ぅ" "ゥ" "ｩ")))
+    ((("r" "w" "e"). ())(("る" "ル" "ﾙ") ("ぇ" "ェ" "ｪ")))
+    ((("r" "w" "o"). ())(("る" "ル" "ﾙ") ("ぉ" "ォ" "ｫ")))
+
+    ((("d" "'" "i"). ())(("で" "デ" "ﾃﾞ") ("ぃ" "ィ" "ｨ")))
+    ((("d" "'" "y" "u"). ())(("で" "デ" "ﾃﾞ") ("ゅ" "ュ" "ｭ")))
+
+    ((("d" "'" "u"). ())(("ど" "ド" "ﾄﾞ") ("ぅ" "ゥ" "ｩ")))
+
+    ((("t" "'" "i"). ())(("て" "テ" "ﾃ") ("ぃ" "ィ" "ｨ")))
+    ((("t" "'" "y" "u"). ())(("て" "テ" "ﾃ") ("ゅ" "ュ" "ｭ")))
+
+    ((("t" "'" "u"). ())(("と" "ト" "ﾄ") ("ぅ" "ゥ" "ｩ")))
+
+    ))
+
+(define ja-rk-rule (append ja-rk-rule-basic ja-rk-rule-additional))
+
+(define ja-wide-rule
+  '(("a" "ａ")
+    ("b" "ｂ")
+    ("c" "ｃ")
+    ("d" "ｄ")
+    ("e" "ｅ")
+    ("f" "ｆ")
+    ("g" "ｇ")
+    ("h" "ｈ")
+    ("i" "ｉ")
+    ("j" "ｊ")
+    ("k" "ｋ")
+    ("l" "ｌ")
+    ("m" "ｍ")
+    ("n" "ｎ")
+    ("o" "ｏ")
+    ("p" "ｐ")
+    ("q" "ｑ")
+    ("r" "ｒ")
+    ("s" "ｓ")
+    ("t" "ｔ")
+    ("u" "ｕ")
+    ("v" "ｖ")
+    ("w" "ｗ")
+    ("x" "ｘ")
+    ("y" "ｙ")
+    ("z" "ｚ")
+    ("A" "Ａ")
+    ("B" "Ｂ")
+    ("C" "Ｃ")
+    ("D" "Ｄ")
+    ("E" "Ｅ")
+    ("F" "Ｆ")
+    ("G" "Ｇ")
+    ("H" "Ｈ")
+    ("I" "Ｉ")
+    ("J" "Ｊ")
+    ("K" "Ｋ")
+    ("L" "Ｌ")
+    ("M" "Ｍ")
+    ("N" "Ｎ")
+    ("O" "Ｏ")
+    ("P" "Ｐ")
+    ("Q" "Ｑ")
+    ("R" "Ｒ")
+    ("S" "Ｓ")
+    ("T" "Ｔ")
+    ("U" "Ｕ")
+    ("V" "Ｖ")
+    ("W" "Ｗ")
+    ("X" "Ｘ")
+    ("Y" "Ｙ")
+    ("Z" "Ｚ")
+
+    ("1" "１")
+    ("2" "２")
+    ("3" "３")
+    ("4" "４")
+    ("5" "５")
+    ("6" "６")
+    ("7" "７")
+    ("8" "８")
+    ("9" "９")
+    ("0" "０")
+
+    ("-" "−")
+    ("," "，")
+    ("." "．")
+    ("!" "！")
+    ("\"" "”")
+    ("#" "＃")
+    ("$" "＄")
+    ("%" "％")
+    ("&" "＆")
+    ("'" "’")
+    ("(" "（")
+    (")" "）")
+    ("~" "〜")
+    ("=" "＝")
+    ("^" "＾")
+    ("\\" "＼")
+    ("yen" "￥")
+    ("|" "｜")
+    ("`" "‘")
+    ("@" "＠")
+    ("{" "｛")
+    ("[" "［")
+    ("+" "＋")
+    (";" "；")
+    ("*" "＊")
+    (":" "：")
+    ("}" "｝")
+    ("]" "］")
+    ("<" "＜")
+    (">" "＞")
+    ("?" "？")
+    ("/" "／")
+    ("_"  "＿")
+    (" " "　")
+    ))
+
+;;
+;; 2004-08-30 Takuro Ashie <ashie@homa.ne.jp>
+;;
+;;   It's a ad-hoc way to detect vowel and consonant in roma string.
+;;   FIXME!
+;;
+(define ja-vowel-table
+ '(("a" "a")
+   ("i" "i")
+   ("u" "u")
+   ("e" "e")
+   ("o" "o")
+    ))
+
+(define ja-consonant-syllable-table
+ '(("b" "")
+   ("c" "")
+   ("d" "")
+   ("f" "fa")
+   ("g" "")
+   ("h" "")
+   ("j" "ji")
+   ("k" "")
+   ("l" "")
+   ("m" "")
+   ("n" "nn")
+   ("p" "")
+   ("q" "")
+   ("r" "")
+   ("s" "")
+   ("t" "")
+   ("v" "vu")
+   ("w" "wu")
+   ("x" "")
+   ("y" "")
+   ("z" "")
+   ("ky" "ki")
+   ("gy" "gi")
+   ("sy" "si")
+   ("zy" "zi")
+   ("jy" "ji")
+   ("ty" "ti")
+   ("ts" "tu")
+   ("cy" "ti")
+   ("dy" "di")
+   ("ny" "ni")
+   ("hy" "hi")
+   ("fy" "fu")
+   ("by" "bi")
+   ("py" "pi")
+   ("my" "mi")
+   ("ly" "li")
+   ("ry" "ri")
+   ("wh" "wu")
+   ("ds" "du")
+   ("dh" "de")
+   ("dw" "do")
+   ("kw" "ku")
+   ("sh" "si")
+   ("sw" "su")
+   ("tw" "to")
+   ("th" "te")
+   ("hw" "hu")
+   ("fw" "fu")
+   ("xw" "wa")
+   ("wy" "wi")
+   ("ch" "ti")
+   ("qw" "ku")
+   ("qy" "ku")
+   ("gw" "gu")
+   ("zw" "zu")
+   ("bw" "bu")
+   ("pw" "pu")
+   ("mw" "mu")
+   ("yw" "yu")
+   ("rw" "ru")
+   ))
+
+(define ja-default-small-tsu-roma "ltu")
+
+;; "ja-direct-rule" seems to be used to commit a character immediately
+;; even when japanese-context (i.e. preedit mode) is on.  I don't think the
+;; rule is needed normally.  So I leave it null by default.  -- ekato
+(define ja-direct-rule
+  '(
+    ))
+
+;; space on (hiragana katakana halfkana) input mode
+(define ja-space
+  '("　" "　" " "))
+
+;; space on (halfwidth-alnum fullwidth-alnum) input mode
+(define ja-alnum-space
+  '(" " "　"))
+
+;;
+(define ja-find-rec
+  (lambda (c rule)
+    (if (null? rule)
+	#f
+	(let ((r (car rule)))
+	  (if (string=? c (car r))
+	      (cadr r)
+	      (ja-find-rec c (cdr rule)))))))
+
+(define ja-wide
+  (lambda (c)
+    (or (ja-find-rec c ja-wide-rule)
+        c)))
+
+(define ja-direct
+  (lambda (c)
+    (ja-find-rec c ja-direct-rule)))
+
+(define ja-vowel
+  (lambda (c)
+    (ja-find-rec c ja-vowel-table)))
+
+(define ja-consonant-to-syllable
+  (lambda (c)
+    (ja-find-rec c ja-consonant-syllable-table)))
+
+;;
+;; 2004-08-30 Takuro Ashie <ashie@homa.ne.jp>
+;;
+;; ja-string-list-to-wide-alphabet
+;;
+;;   Convert alphabets in string list to wide alphabets.
+;;   This procedure is ad-hoc. Maybe more generalize is needed.
+;;
+(define ja-string-list-to-wide-alphabet
+  (lambda (char-list)
+    (if (not (null? char-list))
+        (string-append (ja-string-list-to-wide-alphabet (cdr char-list))
+                       (ja-wide (car char-list)))
+        "")))
+
+
+;; Convert a invalid roma consonant at the end of string-list to a valid roma
+;; consonant or valid roma string.
+;;
+;; "Invalid roma string-list" will be generated while editing a preedit string:
+;;
+;;     Convert a "n" which is followed by a vowel to "nn":
+;;       1. at first, type a following string:
+;;          ("ka" "n" "ki")
+;;       2: press backspace (or move the cursor):
+;;          ("ka" "n")
+;;       3. type a vowel:
+;;          ("ka" "n" "i")
+;;       4. On this case, this procedure converts the list to:
+;;          ("ka" "nn" "i")
+;;
+;;     Fix a broken "っ":
+;;       1.  at fisrt, type a following string:
+;;             ("a" "t" "ti")
+;;       2.  press backspace (or move the cursor):
+;;             ("a" "t")
+;;       3.  type remaining strings:
+;;             ("a" "t" "ka" "nn" "be" "-")
+;;      (3'. On this case, this procedure converts the list to:
+;;             ("a" "t") -> ("a" "ltu"))
+;;       4.  On this case, this procedure converts the list to:
+;;             ("a" "k" "ka" "nn" "be" "-")
+(define ja-fix-deleted-raw-str-to-valid-roma!
+  (lambda (raw-str)
+    (if (not (null? (car raw-str)))
+	(let ((lst (car raw-str)))
+	  (if (ja-consonant-to-syllable (car lst))
+	      (if (= (string-length (ja-consonant-to-syllable (car lst))) 2)
+		  (set-car! lst (ja-consonant-to-syllable (car lst)))
+		  (set-car! lst ja-default-small-tsu-roma)))))))
+
+;; not sure this is the good place and the procedure is well written...
+(define (list-seq-contained? large small)
+  (define (list-seq-partial-equal-internal ll sl n)
+    (let ((len (length sl)))
+      (if (> len (length ll))
+	  #f
+	  (if (= len (length (filter-map equal? ll sl)))
+	      n
+	      (list-seq-partial-equal-internal (cdr ll) sl (+ n 1))))))
+  (if (null? small)
+      #f
+      (list-seq-partial-equal-internal large small 0)))
+
+;; revise string list contains "う゛"
+;; (("゛") ("う")) -> ("う゛")
+(define ja-join-vu
+  (lambda (lst)
+    (let ((sub (member "゛" lst)))
+      (if (and
+	   sub
+	   (not (null? (cdr sub)))
+	   (string=? (car (cdr sub)) "う"))
+	  (append
+	   (list-head lst (- (length lst) (length sub)))
+	   '("う゛")
+	   (ja-join-vu (list-tail lst (+ (- (length lst) (length sub)) 2))))
+	  (if (and
+	       sub
+	       (member "゛" (cdr sub)))
+	      (append
+	       (list-head lst (+ (- (length lst) (length sub)) 1))
+	       (ja-join-vu (cdr sub)))
+	      lst)))))
+
+;; get ("あ" "ア" "ｱ") from "あ"
+(define ja-find-kana-list-from-rule
+  (lambda (rule str)
+    (if (not (null? rule))
+	(if (pair? (member str (car (cdr (car rule)))))
+	    (car (cdr (car rule)))
+	    (ja-find-kana-list-from-rule (cdr rule) str))
+        (if (string=?  str "゛")
+	    (list "゛" "゛" "ﾞ")
+	    (list str str str)))))
+
+;; (("じ" "ジ" "ｼﾞ") ("ん" "ン" "ﾝ") ("か" "カ" "ｶ")) from ("じ" "ん" "か")
+(define ja-make-kana-str-list
+  (lambda (sl)
+    (if (not (null? sl))
+	(append (list (ja-find-kana-list-from-rule ja-rk-rule-basic (car sl)))
+		(ja-make-kana-str-list (cdr sl)))
+	'())))
+
+(define ja-type-direct	       -1)
+(define ja-type-hiragana	0)
+(define ja-type-katakana	1)
+(define ja-type-halfkana	2)
+(define ja-type-halfwidth-alnum	3)
+(define ja-type-fullwidth-alnum	4)
+
+(define ja-opposite-kana
+  (lambda (kana)
+    (cond
+     ((= kana ja-type-hiragana)
+      ja-type-katakana)
+     ((= kana ja-type-katakana)
+      ja-type-hiragana)
+     ((= kana ja-type-halfkana)
+      ja-type-hiragana))))
+
+;; getting required type of kana string from above kana-str-list
+;; (ja-make-kana-str
+;;  (("じ" "ジ" "ｼﾞ") ("ん" "ン" "ﾝ") ("か" "カ" "ｶ"))
+;;  ja-type-katakana)
+;;  -> "カンジ"
+(define ja-make-kana-str
+  (lambda (sl type)
+    (let ((get-str-by-type
+	   (lambda (l)
+	     (cond
+	      ((= type ja-type-hiragana)
+	       (caar l))
+	      ((= type ja-type-katakana)
+	       (car (cdar l)))
+	      ((= type ja-type-halfkana)
+	       (cadr (cdar l)))))))
+      (if (not (null? sl))
+	  (string-append (ja-make-kana-str (cdr sl) type)
+			 (get-str-by-type sl))
+	  ""))))
+
+(define japanese-roma-set-yen-representation
+  (lambda ()
+    ;; Since ordinary Japanese users press the "yen sign" key on
+    ;; Japanese keyboard in alphanumeric-mode "to input character code
+    ;; 134" rather than "to input yen sign symbol", I changed the
+    ;; fullwidth yen sign with backslash.  -- YamaKen 2007-09-17
+    ;;(set-symbol-value! 'yen "￥")  ;; XXX
+    (set-symbol-value! 'yen "\\")
+    ))
+
+;; TODO: Support new custom type string-list.
+(define japanese-auto-start-henkan-keyword-list '("、" "。" "．" "，" "？" "」" "！" "；" "：" ")" ";" ":" "）" "”" "】" "』" "》" "〉" "｝" "］" "〕" "}" "]" "?" "." "," "!"))
+
+(define ja-rk-rule-consonant-to-keep
+  (map (lambda (c)
+         (if (= (string-length c) 1)
+           (list (cons (list c) '()) (list c c c))
+           (let ((lst (reverse (string-to-list c))))
+             (list (cons lst '()) (list (list (car lst) (car lst) (car lst))
+                                        (list (cadr lst) (cadr lst) (cadr lst)))))))
+       (filter (lambda (x) (not (string=? "n" x)))
+               (map car ja-consonant-syllable-table))))
+
+(define ja-rk-rule-keep-consonant-update
+  (lambda ()
+    (if ja-rk-rule-keep-consonant?
+      (set! ja-rk-rule (append ja-rk-rule-consonant-to-keep
+                               ja-rk-rule-basic
+                               ja-rk-rule-additional))
+      (set! ja-rk-rule (append ja-rk-rule-basic
+                               ja-rk-rule-additional)))))
+
+;; In ja-rk-rule-update,
+;; don't set ja-rk-rule-basic to ja-rk-rule-basic-uim
+;;
+;; If you do so, when the following conditions are met
+;;   1) users call ja-rk-rule-update in ~/.uim
+;;   2) ja-rk-rule-type is 'uim (default value)
+;; ja-rk-rule-basic is always overridden
+;; with ja-rk-rule-basic-uim.
+;; This is an unwanted behavior for users.
+(define ja-rk-rule-update
+  (lambda ()
+    (and
+      (eq? ja-rk-rule-type 'custom)
+      (set! ja-rk-rule-basic
+        (ja-rk-rule-table->rule ja-rk-rule-table-basic)))
+    (ja-rk-rule-keep-consonant-update)))
+
+;;; Convert EUC-JP code to EUC-JP string (cf. ucs->utf8-string in ichar.scm)
+(define (ja-euc-jp-code->euc-jp-string code)
+  (with-char-codec "EUC-JP"
+    (lambda ()
+      (let ((str (list->string (list (integer->char code)))))
+        (with-char-codec "ISO-8859-1"
+          (lambda ()
+            (%%string-reconstruct! str)))))))
+
+;;; Convert JIS code(ISO-2022-JP) to EUC-JP string
+(define (ja-jis-code->euc-jp-string state jis1 jis2)
+  (let
+    ((ej0 (if (eq? state 'jisx0213-plane2) #x8f 0))
+     (ej1 (+ jis1 #x80))
+     (ej2 (+ jis2 #x80)))
+    (and
+      ;; sigscheme/src/encoding.c:eucjp_int2str()
+      (<= #xa1 ej1 #xfe) ; IN_GR94()
+      (if (= ej0 #x8f) ; SS3?
+        (<= #xa1 ej2 #xfe) ; IN_GR94()
+        (<= #xa0 ej2 #xff)) ; IN_GR96()
+      (iconv-code-conv (iconv-open "UTF-8" "EUC-JP")
+		       (ja-euc-jp-code->euc-jp-string
+			(+ (* ej0 #x10000) (* ej1 #x100) ej2))))))
+
+;;; Convert reverse string list of JIS code to one EUC-JP kanji string
+;;; ("d" "2" "0" "5") -> "亅"
+(define (ja-kanji-code-input-jis str-list)
+  (and-let*
+    ((length=4? (= (length str-list) 4))
+     (str1 (string-list-concat (take-right str-list 2)))
+     (str2 (string-list-concat (take str-list 2)))
+     (jis1 (string->number str1 16))
+     (jis2 (string->number str2 16)))
+    (ja-jis-code->euc-jp-string 'jisx0213-plane1 jis1 jis2)))
+
+;;; Convert reverse string list of Kuten code to one EUC-JP kanji string
+;;; ("3" "1" "-" "8" "4" "-" "1") -> "亅"
+(define (ja-kanji-code-input-kuten str-list)
+  (let*
+    ((numlist (string-split (string-list-concat str-list) "-"))
+     (men-exists? (>= (length numlist) 3))
+     (men (if men-exists? (string->number (list-ref numlist 0)) 1))
+     (ku (string->number (list-ref numlist (if men-exists? 1 0))))
+     (ten (string->number (list-ref numlist (if men-exists? 2 1)))))
+    (and men ku ten (<= 1 men 2)
+      (ja-jis-code->euc-jp-string
+        (if (= men 2) 'jisx0213-plane2 'jisx0213-plane1)
+        (+ ku #x20) (+ ten #x20)))))
+
+;;; Convert reverse string list of UCS to one EUC-JP kanji string
+;;; ("5" "8" "E" "4" "+" "U") -> "亅"
+(define (ja-kanji-code-input-ucs str-list)
+  (and-let*
+    ((str-list-1 (drop-right str-list 1)) ; drop last "U"
+     (not-only-u? (not (null? str-list-1)))
+     (ucs-str (if (string=? (last str-list-1) "+")
+                (drop-right str-list-1 1)
+                str-list-1))
+     (ucs (string->number (string-list-concat ucs-str) 16))
+     ;; range check to avoid error
+     (valid? ; sigscheme/src/sigschemeinternal.h:ICHAR_VALID_UNICODEP()
+      (or
+        (<= 0 ucs #xd7ff)
+        (<= #xe000 ucs #x10ffff))))
+     (ucs->utf8-string ucs)))
+
+;;; Convert reverse string list to one EUC-JP kanji string
+(define (ja-kanji-code-input str-list)
+  (cond
+    ((string-ci=? (last str-list) "u")
+      (ja-kanji-code-input-ucs str-list))
+    ((member "-" str-list)
+      (ja-kanji-code-input-kuten str-list))
+    (else
+      (ja-kanji-code-input-jis str-list))))
+
+;;
+(require "rk.scm")
+
+(ja-rk-rule-update)
diff --git a/scm/skk-custom-eucjp.scm b/scm/skk-custom-eucjp.scm
new file mode 100644
index 000000000..df0ba969a
--- /dev/null
+++ b/scm/skk-custom-eucjp.scm
@@ -0,0 +1,557 @@
+;;; skk-custom.scm: Customization variables for skk.scm
+;;;
+;;; Copyright (c) 2003-2013 uim Project https://github.com/uim/uim
+;;;
+;;; All rights reserved.
+;;;
+;;; Redistribution and use in source and binary forms, with or without
+;;; modification, are permitted provided that the following conditions
+;;; are met:
+;;; 1. Redistributions of source code must retain the above copyright
+;;;    notice, this list of conditions and the following disclaimer.
+;;; 2. Redistributions in binary form must reproduce the above copyright
+;;;    notice, this list of conditions and the following disclaimer in the
+;;;    documentation and/or other materials provided with the distribution.
+;;; 3. Neither the name of authors nor the names of its contributors
+;;;    may be used to endorse or promote products derived from this software
+;;;    without specific prior written permission.
+;;;
+;;; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND
+;;; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+;;; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+;;; ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE
+;;; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+;;; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+;;; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+;;; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+;;; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+;;; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+;;; SUCH DAMAGE.
+;;;;
+
+(require "i18n.scm")
+
+
+(define skk-im-name-label (N_ "SKK"))
+(define skk-im-short-desc (N_ "uim version of SKK input method"))
+
+(define-custom-group 'skk
+                     skk-im-name-label
+                     skk-im-short-desc)
+
+(define-custom-group 'skk-dict
+                     (N_ "SKK dictionaries")
+                     (N_ "Dictionary settings for SKK"))
+
+(define-custom-group 'skk-advanced
+                     (N_ "SKK (advanced)")
+                     (N_ "Advanced settings for SKK"))
+
+;; subgroup
+(define-custom-group 'skkserv
+		     (N_ "SKK server")
+		     (N_ "long description will be here."))
+
+;; subgroup
+(define-custom-group 'dict-files
+		     (N_ "Dictionary files")
+		     (N_ "long description will be here."))
+
+
+;;
+;; candidate window
+;;
+
+(define-custom 'skk-use-candidate-window? #t
+  '(skk candwin)
+  '(boolean)
+  (N_ "Use candidate window")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-commit-candidate-by-label-key? #t
+  '(skk candwin)
+  '(boolean)
+  (N_ "Commit candidate by heading label keys")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-candidate-selection-style 'ddskk-like
+  '(skk candwin)
+  (list 'choice
+	(list 'uim (N_ "uim") (N_ "uim native"))
+	(list 'ddskk-like (N_ "ddskk-like") (N_ "Similar to ddskk")))
+  (N_ "Candidate selection style")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-use-manual-candwin-setting? #f
+  '(skk candwin)
+  '(boolean)
+  (N_ "Set candidate window behavior manually")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-candidate-op-count 5
+  '(skk candwin)
+  '(integer 0 99)
+  (N_ "Conversion key press count to show candidate window")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-nr-candidate-max 7
+  '(skk candwin)
+  '(integer 1 20)
+  (N_ "Number of candidates in candidate window at a time")
+  (N_ "long description will be here."))
+
+;; activity dependency
+(custom-add-hook 'skk-commit-candidate-by-label-key?
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-candidate-window?))
+
+(custom-add-hook 'skk-candidate-selection-style
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-candidate-window?))
+
+(custom-add-hook 'skk-use-manual-candwin-setting?
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-candidate-window?))
+
+(custom-add-hook 'skk-candidate-op-count
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-candidate-window?))
+
+(custom-add-hook 'skk-nr-candidate-max
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-candidate-window?))
+
+(custom-add-hook 'skk-use-candidate-window?
+		 'custom-get-hooks
+		 (lambda ()
+		   (if (not skk-use-candidate-window?)
+		       (begin
+		         (set! skk-candidate-selection-style 'uim)
+			 (set! skk-use-manual-candwin-setting? #f)))))
+
+(custom-add-hook 'skk-candidate-op-count
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-manual-candwin-setting?))
+
+(custom-add-hook 'skk-nr-candidate-max
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-manual-candwin-setting?))
+
+(custom-add-hook 'skk-candidate-selection-style
+		 'custom-set-hooks
+		 (lambda ()
+		   (if (not skk-use-manual-candwin-setting?)
+		       (cond
+			((eq? skk-candidate-selection-style 'ddskk-like)
+			    (custom-set-value! 'skk-candidate-op-count 5)
+			    (custom-set-value! 'skk-nr-candidate-max 7))
+		        ((eq? skk-candidate-selection-style 'uim)
+			    (custom-set-value! 'skk-candidate-op-count 2)
+			    (custom-set-value! 'skk-nr-candidate-max 10))))))
+
+(custom-add-hook 'skk-use-manual-candwin-setting?
+		 'custom-set-hooks
+		 (lambda ()
+		   (if (not skk-use-manual-candwin-setting?)
+		       (custom-set-value!
+		        'skk-candidate-selection-style
+		        skk-candidate-selection-style))))
+
+;;
+;; toolbar
+;;
+
+;; Can't be unified with action definitions in skk.scm until uim
+;; 0.4.6.
+(define skk-input-mode-indication-alist
+  (list
+   (list 'action_skk_latin
+	 'ja_halfwidth_alnum
+	 "a"
+	 (N_ "Direct input")
+	 (N_ "Direct input mode"))
+   (list 'action_skk_hiragana
+	 'ja_hiragana
+	 ""
+	 (N_ "Hiragana")
+	 (N_ "Hiragana input mode"))
+   (list 'action_skk_katakana
+	 'ja_katakana
+	 ""
+	 (N_ "Katakana")
+	 (N_ "Katakana input mode"))
+   (list 'action_skk_hankana
+	 'ja_halfkana
+	 ""
+	 (N_ "Halfwidth Katakana")
+	 (N_ "Halfwidth Katakana input mode"))
+   (list 'action_skk_wide_latin
+	 'ja_fullwidth_alnum
+	 ""
+	 (N_ "Fullwidth Alphanumeric")
+	 (N_ "Fullwidth Alphanumeric input mode"))))
+
+(define skk-kana-input-method-indication-alist
+  (list
+   (list 'action_skk_roma
+	 'ja_romaji
+	 ""
+	 (N_ "Romaji")
+	 (N_ "Romaji input mode"))
+
+   (list 'action_skk_azik
+	 'ja_azik
+	 ""
+	 (N_ "AZIK")
+	 (N_ "AZIK extended romaji input mode"))
+
+   (list 'action_skk_act
+	 'ja_act
+	 ""
+	 (N_ "ACT")
+	 (N_ "ACT extended romaji input mode"))
+
+   (list 'action_skk_kzik
+	 'ja_kzik
+	 ""
+	 (N_ "KZIK")
+	 (N_ "KZIK extended romaji input mode"))))
+    
+;;; Buttons
+
+(define-custom 'skk-widgets '(widget_skk_input_mode
+			      widget_skk_kana_input_method)
+  '(skk toolbar-widget)
+  (list 'ordered-list
+	(list 'widget_skk_input_mode
+	      (N_ "Input mode")
+	      (N_ "Input mode"))
+	(list 'widget_skk_kana_input_method
+	      (N_ "Kana input method")
+	      (N_ "Kana input method")))
+  (N_ "Enabled toolbar buttons")
+  (N_ "long description will be here."))
+
+;; dynamic reconfiguration
+;; skk-configure-widgets is not defined at this point. So wrapping
+;; into lambda.
+(custom-add-hook 'skk-widgets
+		 'custom-set-hooks
+		 (lambda ()
+		   (skk-configure-widgets)))
+
+
+;;; Input mode
+
+(define-custom 'default-widget_skk_input_mode 'action_skk_latin
+  '(skk toolbar-widget)
+  (cons 'choice
+	(map indication-alist-entry-extract-choice
+	     skk-input-mode-indication-alist))
+  (N_ "Default input mode")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-input-mode-actions
+               (map car skk-input-mode-indication-alist)
+  '(skk toolbar-widget)
+  (cons 'ordered-list
+	(map indication-alist-entry-extract-choice
+	     skk-input-mode-indication-alist))
+  (N_ "Input mode menu items")
+  (N_ "long description will be here."))
+
+;; value dependency
+(if custom-full-featured?
+    (custom-add-hook 'skk-input-mode-actions
+		     'custom-set-hooks
+		     (lambda ()
+		       (custom-choice-range-reflect-olist-val
+			'default-widget_skk_input_mode
+			'skk-input-mode-actions
+			skk-input-mode-indication-alist))))
+
+;; dynamic reconfiguration
+(custom-add-hook 'default-widget_skk_input_mode
+		 'custom-set-hooks
+		 (lambda ()
+		   (skk-configure-widgets)))
+
+(custom-add-hook 'skk-input-mode-actions
+		 'custom-set-hooks
+		 (lambda ()
+		   (skk-configure-widgets)))
+
+;;; Kana input method
+
+(define-custom 'default-widget_skk_kana_input_method 'action_skk_roma
+  '(skk toolbar-widget)
+  (cons 'choice
+	(map indication-alist-entry-extract-choice
+	     skk-kana-input-method-indication-alist))
+  (N_ "Default kana input method")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-kana-input-method-actions
+               (map car skk-kana-input-method-indication-alist)
+  '(skk toolbar-widget)
+  (cons 'ordered-list
+	(map indication-alist-entry-extract-choice
+	     skk-kana-input-method-indication-alist))
+  (N_ "Kana input method menu items")
+  (N_ "long description will be here."))
+
+;; value dependency
+(if custom-full-featured?
+    (custom-add-hook 'skk-kana-input-method-actions
+		     'custom-set-hooks
+		     (lambda ()
+		       (custom-choice-range-reflect-olist-val
+			'default-widget_skk_kana_input_method
+			'skk-kana-input-method-actions
+			skk-kana-input-method-indication-alist))))
+
+;; activity dependency
+(custom-add-hook 'default-widget_skk_kana_input_method
+		 'custom-activity-hooks
+		 (lambda ()
+		   (memq 'widget_skk_kana_input_method skk-widgets)))
+
+(custom-add-hook 'skk-kana-input-method-actions
+		 'custom-activity-hooks
+		 (lambda ()
+		   (memq 'widget_skk_kana_input_method skk-widgets)))
+
+;; dynamic reconfiguration
+(custom-add-hook 'default-widget_skk_kana_input_method
+		 'custom-set-hooks
+		 (lambda ()
+		   (skk-configure-widgets)))
+
+(custom-add-hook 'skk-kana-input-method-actions
+		 'custom-set-hooks
+		 (lambda ()
+		   (skk-configure-widgets)))
+
+
+;;
+;; dictionary
+;;
+
+(define-custom 'skk-use-skkserv? #f
+  '(skk-dict skkserv)
+  '(boolean)
+  (N_ "Use skkserv instead of SKK-JISYO")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-skkserv-enable-completion? #f
+  '(skk-dict skkserv)
+  '(boolean)
+  (N_ "Enable skkserv completion")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-skkserv-enable-completion?
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-skkserv?))
+
+(define-custom 'skk-skkserv-completion-timeout 2000
+  '(skk-dict skkserv)
+  '(integer -1 65535)
+  (N_ "Timeout for skkserv completion (msec)")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-skkserv-completion-timeout
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-skkserv-enable-completion?))
+
+(define-custom 'skk-skkserv-use-env? #t
+  '(skk-dict skkserv)
+  '(boolean)
+  (N_ "Use value of environment variable SKKSERVER")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-skkserv-use-env?
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-skkserv?))
+
+(define-custom 'skk-skkserv-hostname "localhost"
+  '(skk-dict skkserv)
+  '(string ".*")
+  (N_ "Hostname of skkserv")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-skkserv-hostname
+		 'custom-activity-hooks
+		 (lambda ()
+		   (not skk-skkserv-use-env?)))
+
+(define-custom 'skk-skkserv-portnum 1178
+  '(skk-dict skkserv)
+  '(integer 0 65535)
+  (N_ "Port number of skkserv")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-skkserv-portnum
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-skkserv?))
+
+(define-custom 'skk-skkserv-address-family 'unspecified
+  '(skk-dict skkserv)
+  (list 'choice
+	(list 'unspecified (N_ "Auto") (N_ "Auto"))
+	(list 'inet  (N_ "IPv4")
+	      (N_ "Forces skkserv to use IPv4 addresses only"))
+	(list 'inet6 (N_ "IPv6")
+	      (N_ "Forces skkserv to use IPv6 addresses only")))
+  (N_ "Address family of skkserv")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-skkserv-address-family
+	 'custom-activity-hooks
+	 (lambda ()
+	   skk-use-skkserv?))
+
+(define-custom 'skk-dic-file-name (string-append (sys-datadir)
+						 "/skk/SKK-JISYO.L")
+  '(skk-dict dict-files)
+  '(pathname regular-file)
+  (N_ "System dictionary file")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-personal-dic-filename
+  (string-append (or (home-directory (user-name)) "") "/.skk-jisyo")
+  '(skk-dict dict-files)
+  '(pathname regular-file)
+  (N_ "Personal dictionary file")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-uim-personal-dic-filename
+  (string-append (or (home-directory (user-name)) "") "/.skk-uim-jisyo")
+  '(skk-dict dict-files)
+  '(pathname regular-file)
+  (N_ "Personal dictionary file (dedicated to uim)")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-dic-file-name
+		 'custom-activity-hooks
+		 (lambda ()
+		   (not skk-use-skkserv?)))
+
+;;
+;; advanced
+;;
+
+(define-custom 'skk-style 'skk-style-ddskk-like
+  '(skk-advanced)
+  (list 'choice
+	(list 'skk-style-ddskk-like (N_ "ddskk") (N_ "Similar to ddskk"))
+	(list 'skk-style-uim (N_ "uim") (N_ "uim native")))
+  (N_ "Visual style")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-use-recursive-learning? #t
+  '(skk-advanced)
+  '(boolean)
+  (N_ "Use recursive learning")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-use-numeric-conversion? #t
+  '(skk-advanced)
+  '(boolean)
+  (N_ "Use numeric conversion")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-auto-start-henkan? #t
+  '(skk-advanced)
+  '(boolean)
+  (N_ "Enable auto conversion with punctuation marks")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-dcomp-activate? #f
+  '(skk-advanced)
+  '(boolean)
+  (N_ "Enable dynamic completion")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-use-look? #f
+  '(skk-advanced)
+  '(boolean)
+  (N_ "Use UNIX look command for completion")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-use-look?
+                 'custom-set-hooks
+                 (lambda ()
+                   (if skk-use-look?
+                     (skk-lib-look-open skk-look-dict))))
+
+(define-custom 'skk-look-dict "/usr/share/dict/words"
+  '(skk-advanced)
+  '(pathname regular-file)
+  (N_ "Use UNIX look dictionary file")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-look-dict
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-use-look?))
+
+;;
+;; annotation
+;;
+
+(define-custom 'skk-show-annotation? #t
+  '(skk-advanced annotation)
+  '(boolean)
+  (N_ "Show annotation of candidate word")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-show-annotation-in-preedit? #f
+  '(skk-advanced annotation)
+  '(boolean)
+  (N_ "Show annotation also in preedit area")
+  (N_ "long description will be here."))
+
+(custom-add-hook 'skk-show-annotation-in-preedit?
+		 'custom-activity-hooks
+		 (lambda ()
+		   skk-show-annotation?))
+
+(custom-add-hook 'skk-show-annotation?
+		 'custom-get-hooks
+		 (lambda ()
+		   (if (not skk-show-annotation?)
+		       (set! skk-show-annotation-in-preedit? #f))))
+
+;;
+;; special operations
+;;
+
+(define-custom 'skk-use-with-vi? #f
+  '(skk-advanced special-op)
+  '(boolean)
+  (N_ "Enable vi-cooperative mode")
+  (N_ "long description will be here."))
+
+(define-custom 'skk-egg-like-newline? #f
+  '(skk-advanced special-op)
+  '(boolean)
+  (N_ "Use Enter key as just committing (egg-like operation)")
+  (N_ "long description will be here."))
+
+;; should be removed if there is no usage
+(define-custom 'skk-commit-newline-explicitly? #f
+  '(skk-advanced special-op)
+  '(boolean)
+  (N_ "Commit newline as ASCII string instead of native key-event")
+  (N_ "long description will be here."))
diff --git a/scm/skk-custom.scm b/scm/skk-custom.scm
index df0ba969a..d3e52cadc 100644
--- a/scm/skk-custom.scm
+++ b/scm/skk-custom.scm
@@ -179,22 +179,22 @@
 	 (N_ "Direct input mode"))
    (list 'action_skk_hiragana
 	 'ja_hiragana
-	 ""
+	 "あ"
 	 (N_ "Hiragana")
 	 (N_ "Hiragana input mode"))
    (list 'action_skk_katakana
 	 'ja_katakana
-	 ""
+	 "ア"
 	 (N_ "Katakana")
 	 (N_ "Katakana input mode"))
    (list 'action_skk_hankana
 	 'ja_halfkana
-	 ""
+	 "ｱ"
 	 (N_ "Halfwidth Katakana")
 	 (N_ "Halfwidth Katakana input mode"))
    (list 'action_skk_wide_latin
 	 'ja_fullwidth_alnum
-	 ""
+	 "Ａ"
 	 (N_ "Fullwidth Alphanumeric")
 	 (N_ "Fullwidth Alphanumeric input mode"))))
 
@@ -202,25 +202,25 @@
   (list
    (list 'action_skk_roma
 	 'ja_romaji
-	 ""
+	 "Ｒ"
 	 (N_ "Romaji")
 	 (N_ "Romaji input mode"))
 
    (list 'action_skk_azik
 	 'ja_azik
-	 ""
+	 "Ｚ"
 	 (N_ "AZIK")
 	 (N_ "AZIK extended romaji input mode"))
 
    (list 'action_skk_act
 	 'ja_act
-	 ""
+	 "Ｃ"
 	 (N_ "ACT")
 	 (N_ "ACT extended romaji input mode"))
 
    (list 'action_skk_kzik
 	 'ja_kzik
-	 ""
+	 "Ｋ"
 	 (N_ "KZIK")
 	 (N_ "KZIK extended romaji input mode"))))
     
diff --git a/scm/skk-eucjp.scm b/scm/skk-eucjp.scm
new file mode 100644
index 000000000..5e56582f8
--- /dev/null
+++ b/scm/skk-eucjp.scm
@@ -0,0 +1,2348 @@
+;;;
+;;; Copyright (c) 2003-2013 uim Project https://github.com/uim/uim
+;;;
+;;; All rights reserved.
+;;;
+;;; Redistribution and use in source and binary forms, with or without
+;;; modification, are permitted provided that the following conditions
+;;; are met:
+;;; 1. Redistributions of source code must retain the above copyright
+;;;    notice, this list of conditions and the following disclaimer.
+;;; 2. Redistributions in binary form must reproduce the above copyright
+;;;    notice, this list of conditions and the following disclaimer in the
+;;;    documentation and/or other materials provided with the distribution.
+;;; 3. Neither the name of authors nor the names of its contributors
+;;;    may be used to endorse or promote products derived from this software
+;;;    without specific prior written permission.
+;;;
+;;; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND
+;;; ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+;;; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+;;; ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE
+;;; FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+;;; DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+;;; OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+;;; HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+;;; LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+;;; OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+;;; SUCH DAMAGE.
+;;;;
+
+;; SKK is a Japanese input method
+;;
+;; EUC-JP
+;;
+;; SKKϤϲξ֤ǹ
+;; Following is list of SKK input state
+;;  ľ direct
+;;   kanji
+;;  Ф䴰 completion
+;;  Ѵ converting
+;;  ꤬ okuri
+;;  ѿ latin
+;;  ѱѿ wide-latin
+;;   kcode
+;;
+;;
+(require "japanese.scm")
+(require-custom "generic-key-custom.scm")
+(require-custom "skk-custom.scm")
+(require-custom "skk-key-custom.scm")
+
+
+;;; user config
+
+;; TODO: Support new custom type string-list. It involves character
+;; encoding conversion problem.  -- YamaKen 2005-02-02
+(define skk-auto-start-henkan-keyword-list '("" "" "" "" "" "" "" "" "" "" ")" ";" ":" "" "" "" "" "" "" "" "" "" "}" "]" "?" "." "," "!"))
+
+(define skk-ddskk-like-heading-label-char-list '("a" "s" "d" "f" "j" "k" "l"))
+(define skk-uim-heading-label-char-list '("1" "2" "3" "4" "5" "6" "7" "8" "9" "0"))
+
+(define skk-ja-rk-rule (append ja-rk-rule-basic ja-rk-rule-additional))
+(define skk-okuri-char-alist '())
+(define skk-downcase-alist '())
+(define skk-set-henkan-point-key '())
+
+(define skk-ichar-downcase
+  (lambda (x)
+    (or (cdr (or (assoc x skk-downcase-alist)
+                 '(#f . #f)))
+        (ichar-downcase x))))
+
+(define skk-ichar-upper-case?
+  (lambda (x)
+    (or (if (assoc x skk-downcase-alist) #t #f) (ichar-upper-case? x))))
+
+(define skk-context-set-okuri-head-using-alist!
+  (lambda (sc s)
+    (skk-context-set-okuri-head!
+      sc
+      (or (cdr (or (assoc s skk-okuri-char-alist)
+                   '(#f . #f)))
+          s))))
+
+;; style specification
+(define skk-style-spec
+  '(;; (style-element-name . validator)
+    (skk-preedit-attr-mode-mark		   . preedit-attr?)
+    (skk-preedit-attr-head		   . preedit-attr?)
+    (skk-preedit-attr-okuri		   . preedit-attr?)
+    (skk-preedit-attr-pending-rk	   . preedit-attr?)
+    (skk-preedit-attr-conv-body		   . preedit-attr?)
+    (skk-preedit-attr-conv-okuri	   . preedit-attr?)
+    (skk-preedit-attr-conv-appendix	   . preedit-attr?)
+    (skk-preedit-attr-direct-pending-rk    . preedit-attr?)
+    (skk-preedit-attr-child-beginning-mark . preedit-attr?)
+    (skk-preedit-attr-child-end-mark       . preedit-attr?)
+    (skk-preedit-attr-child-committed      . preedit-attr?)
+    (skk-preedit-attr-child-dialog	   . preedit-attr?)
+    (skk-preedit-attr-dcomp		   . preedit-attr?)
+    (skk-child-context-beginning-mark      . string?)
+    (skk-child-context-end-mark		   . string?)
+    (skk-show-cursor-on-preedit?	   . boolean?)
+    (skk-show-candidates-with-okuri?       . boolean?)))
+;; predefined styles
+(define skk-style-uim
+  '((skk-preedit-attr-mode-mark		   . preedit-reverse)
+    (skk-preedit-attr-head		   . preedit-reverse)
+    (skk-preedit-attr-okuri		   . preedit-reverse)
+    (skk-preedit-attr-pending-rk	   . preedit-reverse)
+    (skk-preedit-attr-conv-body		   . preedit-reverse)
+    (skk-preedit-attr-conv-okuri	   . preedit-reverse)
+    (skk-preedit-attr-conv-appendix	   . preedit-reverse)
+    (skk-preedit-attr-direct-pending-rk    . preedit-underline)
+    (skk-preedit-attr-child-beginning-mark . preedit-reverse)
+    (skk-preedit-attr-child-end-mark       . preedit-reverse)
+    (skk-preedit-attr-child-committed      . preedit-reverse)
+    (skk-preedit-attr-child-dialog	   . preedit-none)
+    (skk-preedit-attr-dcomp		   . preedit-none)
+    (skk-child-context-beginning-mark      . "[")
+    (skk-child-context-end-mark		   . "]")
+    (skk-show-cursor-on-preedit?	   . #f)
+    (skk-show-candidates-with-okuri?       . #t)))
+(define skk-style-ddskk-like
+  '((skk-preedit-attr-mode-mark		   . preedit-underline)
+    (skk-preedit-attr-head		   . preedit-underline)
+    (skk-preedit-attr-okuri		   . preedit-underline)
+    (skk-preedit-attr-pending-rk	   . preedit-underline)
+    (skk-preedit-attr-conv-body		   . preedit-reverse)
+    (skk-preedit-attr-conv-okuri	   . preedit-underline)
+    (skk-preedit-attr-conv-appendix	   . preedit-underline)
+    (skk-preedit-attr-direct-pending-rk    . preedit-underline)
+    (skk-preedit-attr-child-beginning-mark . preedit-underline)
+    (skk-preedit-attr-child-end-mark       . preedit-underline)
+    (skk-preedit-attr-child-committed      . preedit-underline)
+    (skk-preedit-attr-child-dialog	   . preedit-none)
+    (skk-preedit-attr-dcomp		   . preedit-underline)
+    (skk-child-context-beginning-mark      . "")
+    (skk-child-context-end-mark		   . "")
+    (skk-show-cursor-on-preedit?	   . #t)
+    (skk-show-candidates-with-okuri?       . #f)))
+
+;;; implementations
+
+(define skk-type-hiragana 0)
+(define skk-type-katakana 1)
+(define skk-type-hankana 2)
+
+(define skk-input-rule-roma 0)
+(define skk-input-rule-azik 1)
+(define skk-input-rule-act 2)
+(define skk-input-rule-kzik 3)
+
+(define skk-child-type-editor 0)
+(define skk-child-type-dialog 1)
+
+;; style elements
+(define skk-preedit-attr-mode-mark #f)
+(define skk-preedit-attr-head #f)
+(define skk-preedit-attr-okuri #f)
+(define skk-preedit-attr-pending-rk #f)
+(define skk-preedit-attr-conv-body #f)
+(define skk-preedit-attr-conv-okuri #f)
+(define skk-preedit-attr-conv-appendix #f)
+(define skk-preedit-attr-direct-pending-rk #f)
+(define skk-preedit-attr-child-beginning-mark #f)
+(define skk-preedit-attr-child-end-mark #f)
+(define skk-preedit-attr-child-committed #f)
+(define skk-preedit-attr-child-dialog #f)
+(define skk-preedit-attr-dcomp #f)
+(define skk-child-context-beginning-mark #f)
+(define skk-child-context-end-mark #f)
+(define skk-show-cursor-on-preedit? #f)
+(define skk-show-candidates-with-okuri? #f)
+
+(define skk-dic #f)
+(define skk-context-list '())
+
+(define skk-prepare-activation
+  (lambda (sc)
+    (skk-flush sc)
+    (skk-update-preedit sc)))
+
+(register-action 'action_skk_hiragana
+		 (lambda (sc)
+		   '(ja_hiragana
+		     ""
+		     "Ҥ餬"
+		     "Ҥ餬ϥ⡼"))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (and (not (skk-latin-state? dsc))
+			  (= (skk-context-kana-mode dsc)
+			     skk-type-hiragana))))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (skk-prepare-activation dsc)
+		     (skk-context-set-state! dsc 'skk-state-direct)
+		     (skk-context-set-kana-mode! dsc skk-type-hiragana))))
+
+(register-action 'action_skk_katakana
+		 (lambda (sc)
+		   '(ja_katakana
+		     ""
+		     ""
+		     "ϥ⡼"))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (and (not (skk-latin-state? dsc))
+			  (= (skk-context-kana-mode dsc)
+			     skk-type-katakana))))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (skk-prepare-activation dsc)
+		     (skk-context-set-state! dsc 'skk-state-direct)
+		     (skk-context-set-kana-mode! dsc skk-type-katakana))))
+
+(register-action 'action_skk_hankana
+		 (lambda (sc)
+		   '(ja_halfkana
+		     ""
+		     "Ⱦѥ"
+		     "Ⱦѥϥ⡼"))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (and (not (skk-latin-state? dsc))
+			  (= (skk-context-kana-mode dsc)
+			     skk-type-hankana))))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (skk-prepare-activation dsc)
+		     (skk-context-set-state! dsc 'skk-state-direct)
+		     (skk-context-set-kana-mode! dsc skk-type-hankana))))
+
+(register-action 'action_skk_latin
+		 (lambda (sc)
+		   '(ja_halfwidth_alnum
+		     "a"
+		     "ľ"
+		     "ľ(̵Ѵ)ϥ⡼"))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (eq? (skk-context-state dsc)
+			'skk-state-latin)))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (skk-prepare-activation dsc)
+		     (skk-context-set-state! dsc 'skk-state-latin))))
+
+(register-action 'action_skk_wide_latin
+		 (lambda (sc)
+		   '(ja_fullwidth_alnum
+		     ""
+		     "ѱѿ"
+		     "ѱѿϥ⡼"))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (eq? (skk-context-state dsc)
+			'skk-state-wide-latin)))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (skk-prepare-activation dsc)
+		     (skk-context-set-state! dsc 'skk-state-wide-latin))))
+
+(register-action 'action_skk_roma
+		 (lambda (sc)
+		   '(ja_romaji
+		     ""
+		     "޻"
+		     "޻ϥ⡼"))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (= (skk-context-input-rule dsc)
+			skk-input-rule-roma)))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (skk-prepare-activation dsc)
+		     (skk-set-rule! dsc skk-input-rule-roma))))
+
+(register-action 'action_skk_azik
+		 (lambda (sc)
+		   '(ja_azik
+		     ""
+		     "AZIK"
+		     "AZIKĥ޻ϥ⡼"))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (= (skk-context-input-rule dsc)
+			skk-input-rule-azik)))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (skk-prepare-activation dsc)
+		     (skk-set-rule! dsc skk-input-rule-azik))))
+
+(register-action 'action_skk_act
+		 (lambda (sc)
+		   '(ja_act
+		     ""
+		     "ACT"
+		     "ACTĥ޻ϥ⡼"))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (= (skk-context-input-rule dsc)
+			skk-input-rule-act)))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (skk-prepare-activation dsc)
+		     (skk-set-rule! dsc skk-input-rule-act))))
+
+
+(register-action 'action_skk_kzik
+		 (lambda (sc)
+		   '(ja_kzik
+		     ""
+		     "KZIK"
+		     "KZIKĥ޻ϥ⡼"))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (= (skk-context-input-rule dsc)
+			skk-input-rule-kzik)))
+		 (lambda (sc)
+		   (let ((dsc (skk-find-descendant-context sc)))
+		     (skk-prepare-activation dsc)
+		     (skk-set-rule! dsc skk-input-rule-kzik))))
+
+;; Update widget definitions based on action configurations. The
+;; procedure is needed for on-the-fly reconfiguration involving the
+;; custom API
+(define skk-configure-widgets
+  (lambda ()
+    (register-widget 'widget_skk_input_mode
+		     (activity-indicator-new skk-input-mode-actions)
+		     (actions-new skk-input-mode-actions))
+
+    (register-widget 'widget_skk_kana_input_method
+		     (activity-indicator-new skk-kana-input-method-actions)
+		     (actions-new skk-kana-input-method-actions))
+    (context-list-replace-widgets! 'skk skk-widgets)))
+
+(define skk-context-rec-spec
+  (append
+   context-rec-spec
+   (list
+    (list 'state	      'skk-state-latin)
+    (list 'kana-mode	      skk-type-hiragana)
+    (list 'input-rule	      skk-input-rule-roma)
+    (list 'head		      '())
+    (list 'okuri-head	      "")
+    (list 'okuri	      '())
+    (list 'appendix	      '())
+    (list 'dcomp-word	      "")
+    ;(list 'candidates	      '())
+    (list 'nth		      0)
+    (list 'nr-candidates      0)
+    (list 'rk-context	      '())
+    (list 'candidate-op-count 0)
+    (list 'candidate-window   #f)
+    (list 'child-context      '())
+    (list 'child-type	      '())
+    (list 'parent-context     '())
+    (list 'editor	      '())
+    (list 'dialog	      '())
+    (list 'latin-conv	      #f)
+    (list 'commit-raw	      #f)
+    (list 'completion-nth     0))))
+(define-record 'skk-context skk-context-rec-spec)
+(define skk-context-new-internal skk-context-new)
+
+(define skk-set-rule!
+  (lambda (sc input-rule)
+    (let ((rkc (skk-context-rk-context sc))
+	  (rule (cond
+		 ((= input-rule skk-input-rule-roma)
+                  (set! skk-okuri-char-alist '())
+                  (set! skk-downcase-alist '()) 
+                  (set! skk-set-henkan-point-key '())
+		  skk-ja-rk-rule)
+		 ((= input-rule skk-input-rule-azik)
+		  (require "japanese-azik.scm")
+                  (set! skk-okuri-char-alist ja-azik-skk-okuri-char-alist)
+                  (set! skk-downcase-alist ja-azik-skk-downcase-alist) 
+                  (set! skk-set-henkan-point-key ja-azik-skk-set-henkan-point-key)
+		  ja-azik-rule)
+		 ((= input-rule skk-input-rule-act)
+		  (require "japanese-act.scm")
+                  (set! skk-okuri-char-alist ja-act-skk-okuri-char-alist)
+                  (set! skk-downcase-alist ja-act-skk-downcase-alist)
+                  (set! skk-set-henkan-point-key ja-act-skk-set-henkan-point-key)
+		  ja-act-rule)
+		 ((= input-rule skk-input-rule-kzik)
+		  (require "japanese-kzik.scm")
+                  (set! skk-okuri-char-alist '())
+                  (set! skk-downcase-alist '())
+                  (set! skk-set-henkan-point-key '())
+		  ja-kzik-rule))))
+      (skk-context-set-input-rule! sc input-rule)
+      (rk-context-set-rule! rkc rule))))
+
+(define skk-find-root-context
+  (lambda (sc)
+    (let ((pc (skk-context-parent-context sc)))
+      (if (not (null? pc))
+	  (skk-find-root-context pc)
+	  sc))))
+
+(define skk-find-descendant-context
+  (lambda (sc)
+    (let ((csc (skk-context-child-context sc)))
+      (if (not (null? csc))
+	  (skk-find-descendant-context csc)
+	  sc))))
+
+(define skk-read-personal-dictionary
+  (lambda ()
+    (if (not (setugid?))
+        (or (skk-lib-read-personal-dictionary skk-dic
+                                              skk-uim-personal-dic-filename)
+            (skk-lib-read-personal-dictionary skk-dic
+                                              skk-personal-dic-filename)))))
+
+(define skk-save-personal-dictionary
+  (lambda ()
+    (if (not (setugid?))
+        (skk-lib-save-personal-dictionary skk-dic
+                                          skk-uim-personal-dic-filename))))
+
+(define skk-flush
+  (lambda (sc)
+    (let ((csc (skk-context-child-context sc)))
+      (rk-flush (skk-context-rk-context sc))
+      (if skk-use-recursive-learning?
+	  (skk-editor-flush (skk-context-editor sc)))
+      (skk-dialog-flush (skk-context-dialog sc))
+      (if (not (skk-latin-state? sc))
+	  (skk-context-set-state! sc 'skk-state-direct))
+      (skk-context-set-head! sc '())
+      (skk-context-set-okuri-head! sc "")
+      (skk-context-set-okuri! sc '())
+      (skk-context-set-appendix! sc '())
+      (skk-reset-dcomp-word sc)
+      (skk-reset-candidate-window sc)
+      (skk-context-set-nr-candidates! sc 0)
+      (skk-context-set-latin-conv! sc #f)
+      (skk-context-set-child-context! sc '())
+      (skk-context-set-child-type! sc '())
+      (if (not (null? csc))
+	  (skk-flush csc)))))
+
+(define skk-context-new
+  (lambda (id im)
+    (if (not skk-dic)
+	(let ((hostname (if skk-skkserv-use-env?
+			    (or (getenv "SKKSERVER") "localhost")
+			    skk-skkserv-hostname)))
+	  (if skk-use-recursive-learning?
+	      (require "skk-editor.scm"))
+	  (require "skk-dialog.scm")
+          (set! skk-dic (skk-lib-dic-open skk-dic-file-name
+                                          skk-use-skkserv?
+                                          hostname
+                                          skk-skkserv-portnum
+                                          skk-skkserv-address-family))
+          (if skk-use-look?
+              (skk-lib-look-open skk-look-dict))
+	  (skk-read-personal-dictionary)))
+    (let ((sc (skk-context-new-internal id im))
+	  (rkc (rk-context-new skk-ja-rk-rule #t #f)))
+      (skk-context-set-widgets! sc skk-widgets)
+      (skk-context-set-head! sc '())
+      (skk-context-set-rk-context! sc rkc)
+      (skk-context-set-child-context! sc '())
+      (skk-context-set-parent-context! sc '())
+      (if skk-use-recursive-learning?
+	  (skk-context-set-editor! sc (skk-editor-new sc)))
+      (skk-context-set-dialog! sc (skk-dialog-new sc))
+      (skk-flush sc)
+      (skk-context-set-state! sc 'skk-state-latin)
+      sc)))
+
+(define skk-latin-state?
+  (lambda (sc)
+    (case (skk-context-state sc)
+      ((skk-state-latin skk-state-wide-latin) #t)
+      (else #f))))
+
+(define skk-make-string
+  (lambda (sl kana)
+    (let ((get-str-by-type 
+	   (lambda (l)
+	     (cond
+	      ((= kana skk-type-hiragana)
+	       (caar l))
+	      ((= kana skk-type-katakana)
+	       (car (cdar l)))
+	      ((= kana skk-type-hankana)
+	       (cadr (cdar l)))))))
+    (if (not (null? sl))
+	(string-append (skk-make-string (cdr sl) kana)
+		       (get-str-by-type sl))
+	""))))
+
+(define skk-conv-wide-latin
+  (lambda (sl)
+    (let ((get-wide-latin-str
+	   (lambda (l)
+	     (ja-wide (caar l)))))
+    (if (not (null? sl))
+	(string-append (skk-conv-wide-latin (cdr sl))
+		       (get-wide-latin-str sl))
+	""))))
+
+(define skk-conv-opposite-case
+  (lambda (sl)
+    (let ((get-opposite-case-str
+	   (lambda (l)
+	     (let ((c (string->charcode (caar l))))
+	       (cond
+		((ichar-upper-case? c)
+		 (charcode->string (+ c 32)))
+		((ichar-lower-case? c)
+		 (charcode->string (- c 32)))
+		(else
+		 (caar l)))))))
+      (if (not (null? sl))
+	  (string-append (skk-conv-opposite-case (cdr sl))
+			 (get-opposite-case-str sl))
+	  ""))))
+
+(define skk-opposite-kana
+  (lambda (kana)
+    (cond
+     ((= kana skk-type-hiragana)
+      skk-type-katakana)
+     ((= kana skk-type-katakana)
+      skk-type-hiragana)
+     ((= kana skk-type-hankana)
+      skk-type-hiragana))))  ; different to ddskk's behavior
+
+(define skk-context-kana-toggle
+  (lambda (sc)
+    (let* ((kana (skk-context-kana-mode sc))
+	   (opposite-kana (skk-opposite-kana kana)))
+      (skk-context-set-kana-mode! sc opposite-kana))))
+
+(define skk-get-string-mode-part
+  (lambda (sc res type)
+    (let ((get-str-by-type 
+	   (lambda (l)
+	     (cond
+	      ((= type skk-type-hiragana)
+	       (car l))
+	      ((= type skk-type-katakana)
+	       (car (cdr l)))
+	      ((= type skk-type-hankana)
+	       (cadr (cdr l)))))))
+      (get-str-by-type res))))
+
+(define skk-do-get-string
+  (lambda (sc str kana)
+    (if (not (null? str))
+	(if (string? (car str))
+	    (skk-get-string-mode-part sc str kana)
+	    (string-append
+	     (skk-do-get-string sc (car str) kana)
+	     (skk-do-get-string sc (cdr str) kana)))
+	"")))
+
+(define skk-get-string
+  (lambda (sc str kana)
+    (let ((res (skk-do-get-string sc str kana)))
+      (if (and res (> (string-length res) 0))
+	  res
+	  #f))))
+
+;;; no longer used 
+(define skk-get-string-by-mode
+  (lambda (sc str)
+    (let ((kana (skk-context-kana-mode sc)))
+      (skk-get-string sc str kana))))
+
+(define skk-get-nth-candidate
+  (lambda (sc n)
+    (let* ((head (skk-context-head sc))
+    	   (cand (skk-lib-get-nth-candidate
+                  skk-dic
+                  n
+                  (cons (skk-make-string head skk-type-hiragana)
+                        (skk-context-okuri-head sc))
+                  (skk-make-string (skk-context-okuri sc) skk-type-hiragana)
+                  skk-use-numeric-conversion?)))
+      (if skk-show-annotation?
+	  cand
+	  (skk-lib-remove-annotation cand)))))
+
+(define skk-get-current-candidate
+  (lambda (sc)
+    (skk-get-nth-candidate
+     sc
+     (skk-context-nth sc))))
+
+(define skk-get-nth-completion
+  (lambda (sc n)
+    (skk-lib-get-nth-completion
+     skk-dic
+     n
+     (skk-make-string (skk-context-head sc) skk-type-hiragana)
+     skk-use-numeric-conversion?
+     skk-use-look?)))
+
+(define skk-get-current-completion
+  (lambda (sc)
+    (skk-get-nth-completion
+     sc
+     (skk-context-completion-nth sc))))
+
+(define skk-commit-raw
+  (lambda (sc key key-state)
+    (let ((psc (skk-context-parent-context sc)))
+      (if (not (null? psc))
+	  (begin
+	    (if (= (skk-context-child-type psc)
+		   skk-child-type-editor)
+		(skk-editor-commit-raw (skk-context-editor psc) key key-state)
+		(skk-dialog-commit-raw (skk-context-dialog psc) key key-state)))
+	  (begin
+	    (skk-context-set-commit-raw! sc #t)
+	    (im-commit-raw sc))))))
+
+(define skk-commit-raw-with-preedit-update
+  (lambda (sc key key-state)
+    (let ((psc (skk-context-parent-context sc)))
+      (if (not (null? psc))
+	  (begin
+	    (if (= (skk-context-child-type psc)
+	    	   skk-child-type-editor)
+		(skk-editor-commit-raw (skk-context-editor psc) key key-state)
+		(skk-dialog-commit-raw (skk-context-dialog psc) key key-state)))
+	  (begin
+	    (skk-context-set-commit-raw! sc #f)
+	    (im-commit-raw sc))))))
+
+;; commit string
+(define skk-commit
+  (lambda (sc str)
+    (let ((psc (skk-context-parent-context sc)))
+      (if (not (null? psc))
+	  (begin
+	    (if (= (skk-context-child-type psc)
+	    	   skk-child-type-editor)
+		(skk-editor-commit (skk-context-editor psc) str)
+		(skk-dialog-commit (skk-context-dialog psc) str)))
+	  (im-commit sc str)))))
+
+(define skk-prepare-commit-string
+  (lambda (sc)
+    (let* ((cand (skk-lib-eval-candidate (skk-lib-remove-annotation (skk-get-current-candidate sc))))
+	   (okuri (skk-make-string (skk-context-okuri sc)
+				   (skk-context-kana-mode sc)))
+	   (appendix (skk-make-string (skk-context-appendix sc)
+				   (skk-context-kana-mode sc)))
+	   (res (string-append cand okuri appendix))
+	   (head (skk-context-head sc)))
+      (skk-lib-commit-candidate
+       skk-dic
+       (cons (skk-make-string head skk-type-hiragana)
+             (skk-context-okuri-head sc))
+       (skk-make-string (skk-context-okuri sc) skk-type-hiragana)
+       (skk-context-nth sc)
+       skk-use-numeric-conversion?)
+      (if (> (skk-context-nth sc) 0)
+	  (skk-save-personal-dictionary))
+      (skk-reset-candidate-window sc)
+      (skk-flush sc)
+      res)))
+
+(define skk-purge-candidate
+  (lambda (sc)
+    (let ((res (skk-lib-purge-candidate
+                skk-dic
+                (cons
+                 (skk-make-string (skk-context-head sc) skk-type-hiragana)
+                 (skk-context-okuri-head sc))
+                (skk-make-string (skk-context-okuri sc) skk-type-hiragana)
+                (skk-context-nth sc)
+                skk-use-numeric-conversion?)))
+      (if res
+	  (skk-save-personal-dictionary))
+      (skk-reset-candidate-window sc)
+      (skk-flush sc)
+      res)))
+
+(define skk-reset-dcomp-word
+  (lambda (sc)
+    (if skk-dcomp-activate?
+	(skk-context-set-dcomp-word! sc ""))))
+
+(define skk-append-string
+  (lambda (sc str)
+    (and
+     (not (null? str))
+     (if (not (string? (car str)))
+	 (begin
+	   (skk-append-string sc (car str))
+	   (skk-append-string sc (cdr str)))
+	 #t)
+     (skk-context-set-head! sc (cons str (skk-context-head sc)))
+     ;;; dcomp
+     (if skk-dcomp-activate?
+	 (skk-context-set-dcomp-word!
+	  sc
+	  (skk-lib-get-dcomp-word
+           skk-dic
+           (skk-make-string
+            (skk-context-head sc) (skk-context-kana-mode sc))
+           skk-use-numeric-conversion?
+           skk-use-look?))))))
+
+(define skk-append-okuri-string
+  (lambda (sc str)
+    (and
+     (not (null? str))
+     (if (not (string? (car str)))
+	 (begin
+	   (skk-append-okuri-string sc (car str))
+	   (skk-append-okuri-string sc (cdr str))
+	   )
+	 #t)
+     (skk-context-set-okuri!
+      sc
+      (cons str (skk-context-okuri sc))))))
+
+(define skk-append-residual-kana
+  (lambda (sc)
+    (let* ((rkc (skk-context-rk-context sc))
+	   (residual-kana (rk-push-key-last! rkc)))
+      (if residual-kana
+	  (skk-append-string sc residual-kana)))))
+
+(define skk-begin-conversion
+  (lambda (sc)
+    (let ((res (skk-lib-get-entry
+                skk-dic
+                (skk-make-string (skk-context-head sc) skk-type-hiragana)
+                (skk-context-okuri-head sc)
+                (skk-make-string (skk-context-okuri sc)
+                                 skk-type-hiragana)
+                skk-use-numeric-conversion?)))
+      (if res
+	  (begin
+	    (skk-context-set-nth! sc 0)
+	    (skk-context-set-nr-candidates! sc 0)
+	    (skk-check-candidate-window-begin sc)
+	    (if (skk-context-candidate-window sc)
+		(im-select-candidate sc 0))
+	    (skk-context-set-state! sc 'skk-state-converting))
+	  (if skk-use-recursive-learning?
+	      (skk-setup-child-context sc skk-child-type-editor)
+	      (skk-flush sc))))))
+
+(define skk-begin-completion
+  (lambda (sc)
+    ;; get residual 'n'
+    (if (eq? (skk-context-state sc) 'skk-state-kanji)
+	(skk-append-residual-kana sc))
+    (skk-lib-get-completion
+     skk-dic
+     (skk-make-string (skk-context-head sc) (skk-context-kana-mode sc))
+     skk-use-numeric-conversion?
+     skk-use-look?)
+    (skk-context-set-completion-nth! sc 0)
+    (skk-context-set-state! sc 'skk-state-completion)))
+
+(define skk-dcomp-word-tail
+  (lambda (sc)
+   (let ((h (skk-make-string (skk-context-head sc) skk-type-hiragana))
+	 (w (skk-context-dcomp-word sc)))
+     (skk-lib-substring w (string-length h) (string-length w)))))
+
+
+(define skk-do-update-preedit
+  (lambda (sc)
+    (let ((rkc (skk-context-rk-context sc))
+	  (stat (skk-context-state sc))
+	  (csc (skk-context-child-context sc))
+	  (with-dcomp-word? #f))
+      ;; mark
+      (if (and
+	   (null? csc)
+	   (or
+	    (eq? stat 'skk-state-kanji)
+	    (eq? stat 'skk-state-completion)
+	    (eq? stat 'skk-state-okuri)))
+	  (im-pushback-preedit sc skk-preedit-attr-mode-mark ""))
+      (if (and
+	   (null? csc)
+	   (eq? stat 'skk-state-kcode))
+	  (im-pushback-preedit sc skk-preedit-attr-mode-mark "JIS "))
+      (if (or
+	   (not (null? csc))
+	   (eq? stat 'skk-state-converting))
+	  (im-pushback-preedit sc skk-preedit-attr-mode-mark ""))
+      ;; head without child context
+      (if (and
+	   (null? csc)
+	   (or
+	    (eq? stat 'skk-state-kanji)
+	    (eq? stat 'skk-state-okuri)
+	    (eq? stat 'skk-state-kcode)))
+	  (let ((h (skk-make-string 
+		    (skk-context-head sc)
+		    (skk-context-kana-mode sc))))
+	    (if (string? h)
+		(im-pushback-preedit
+		 sc skk-preedit-attr-head
+		 h))))
+      ;; dcomp
+      (if (and
+	   skk-dcomp-activate?
+	   (null? csc)
+	   (eq? stat 'skk-state-kanji)
+	   (not (skk-rk-pending? sc))
+	   (not (string=? (skk-context-dcomp-word sc) "")))
+	  (begin
+	    (if skk-show-cursor-on-preedit?
+	        (im-pushback-preedit sc preedit-cursor ""))
+	    (im-pushback-preedit
+	     sc skk-preedit-attr-dcomp
+	     (skk-dcomp-word-tail sc))
+	    (set! with-dcomp-word? #t)
+	     ))
+      ;; conv-body + okuri
+      (if (and
+	   (eq? stat 'skk-state-converting)
+	   (or
+	    (null? csc)
+	    (and
+	     (not (null? csc))
+	     (= (skk-context-child-type sc) skk-child-type-dialog))))
+	  (begin
+	    (if (or
+		 (eq? skk-candidate-selection-style 'uim)
+		 (and
+		  (eq? skk-candidate-selection-style 'ddskk-like)
+		  (not (skk-context-candidate-window sc))))
+		(im-pushback-preedit
+		 sc
+		 (bitwise-ior skk-preedit-attr-conv-body
+			      (if skk-show-cursor-on-preedit?
+				  preedit-cursor
+				  preedit-none))
+		 (if skk-show-annotation-in-preedit?
+		     (skk-lib-eval-candidate (skk-get-current-candidate sc))
+		     (skk-lib-eval-candidate
+		      (skk-lib-remove-annotation
+		       (skk-get-current-candidate sc)))))
+		(im-pushback-preedit
+		 sc
+		 (bitwise-ior skk-preedit-attr-conv-body
+			      (if skk-show-cursor-on-preedit?
+				  preedit-cursor
+				  preedit-none))
+		 ""))
+	    (im-pushback-preedit
+	     sc skk-preedit-attr-conv-okuri
+	     (skk-make-string (skk-context-okuri sc)
+			      (skk-context-kana-mode sc)))
+	    (im-pushback-preedit
+	     sc skk-preedit-attr-conv-appendix
+	     (skk-make-string (skk-context-appendix sc)
+			      (skk-context-kana-mode sc)))))
+      ;; head with child context
+      (if (and
+	   (not (null? csc))
+	   (or
+	     (eq? stat 'skk-state-kanji)
+	     (eq? stat 'skk-state-okuri)
+	     (and
+	      (eq? stat 'skk-state-converting)
+	      (eq? (skk-context-child-type sc) skk-child-type-editor))))
+	  (let ((h '()))
+	    (if skk-use-numeric-conversion?
+	      ;; replace numeric string with #
+	      (set! h (skk-lib-replace-numeric
+			(skk-make-string 
+			 (skk-context-head sc)
+			 (skk-context-kana-mode sc))))
+	      (set! h (skk-make-string 
+			(skk-context-head sc)
+			(skk-context-kana-mode sc))))
+	    (if (string? h)
+		(im-pushback-preedit
+		 sc skk-preedit-attr-head
+		 h))))
+      ;; completion
+      (if (and
+	   (eq? stat 'skk-state-completion)
+	   (null? csc))
+	  (let ((comp (skk-get-current-completion sc)))
+	    (im-pushback-preedit
+	     sc skk-preedit-attr-head
+	     (if (not (string=? comp ""))
+		 comp
+		 (skk-make-string 
+		  (skk-context-head sc)
+		  (skk-context-kana-mode sc))))))
+      ;; okuri mark
+      (if (or
+	   (eq? stat 'skk-state-okuri)
+	   (and
+	    (not (null? csc))
+	    (eq? stat 'skk-state-converting)
+	    (not (null? (skk-context-okuri sc)))
+	    (= (skk-context-child-type sc) skk-child-type-editor)))
+	  (begin
+	    (im-pushback-preedit 
+	     sc skk-preedit-attr-okuri
+	     (string-append
+	      "*" (skk-make-string (skk-context-okuri sc)
+				   (skk-context-kana-mode sc))))))
+      ;; pending rk
+      (if (or
+	   (eq? stat 'skk-state-direct)
+	   (eq? stat 'skk-state-latin)
+	   (eq? stat 'skk-state-wide-latin))
+	  (begin
+	    (im-pushback-preedit sc skk-preedit-attr-direct-pending-rk
+				 (rk-pending rkc))
+	    (if skk-show-cursor-on-preedit?
+	        (im-pushback-preedit sc preedit-cursor "")))
+	  (begin
+	    (im-pushback-preedit sc skk-preedit-attr-pending-rk
+				 (rk-pending rkc))
+	    (if (and
+		 (or
+		  (eq? stat 'skk-state-kanji)
+		  (eq? stat 'skk-state-completion)
+		  (eq? stat 'skk-state-okuri)
+		  (eq? stat 'skk-state-kcode))
+		 skk-show-cursor-on-preedit?
+		 (not with-dcomp-word?))
+		(im-pushback-preedit sc preedit-cursor ""))))
+      ;; child context's preedit
+      (if (not (null? csc))
+	  (let ((editor (skk-context-editor sc))
+		(dialog (skk-context-dialog sc)))
+	    (if (= (skk-context-child-type sc) skk-child-type-editor)
+		(begin
+		  (im-pushback-preedit sc
+		  		       skk-preedit-attr-child-beginning-mark
+				       skk-child-context-beginning-mark)
+		  (im-pushback-preedit sc
+				       skk-preedit-attr-child-committed
+				       (skk-editor-get-left-string editor)))
+		(begin
+		  (im-pushback-preedit sc
+				       skk-preedit-attr-child-dialog
+				       skk-child-context-beginning-mark)
+		  (im-pushback-preedit sc
+		  		       skk-preedit-attr-child-dialog
+				       (skk-dialog-get-left-string dialog))))
+	    (skk-do-update-preedit csc)
+	    (if (= (skk-context-child-type sc) skk-child-type-editor)
+	    	(begin
+		  (im-pushback-preedit sc
+				     skk-preedit-attr-child-committed
+				     (skk-editor-get-right-string editor))
+		  (im-pushback-preedit sc
+		  		       skk-preedit-attr-child-end-mark
+				       skk-child-context-end-mark))
+		(begin
+		  (im-pushback-preedit sc
+				       skk-preedit-attr-child-dialog
+				       (skk-dialog-get-right-string dialog))
+		  (im-pushback-preedit sc
+		  		       skk-preedit-attr-child-dialog
+				       skk-child-context-end-mark)))))
+	    )))
+
+(define skk-update-preedit
+  (lambda (sc)
+    (if (not (skk-context-commit-raw sc))
+	(begin
+	  (im-clear-preedit sc)
+	  (skk-do-update-preedit (skk-find-root-context sc))
+	  (im-update-preedit sc))
+	(skk-context-set-commit-raw! sc #f))))
+
+
+;; called from skk-editor
+(define skk-commit-editor-context
+  (lambda (sc str)
+    (let* ((psc (skk-context-parent-context sc))
+	   (okuri (skk-make-string (skk-context-okuri sc)
+				   (skk-context-kana-mode sc)))
+	   (appendix (skk-make-string (skk-context-appendix sc)
+				   (skk-context-kana-mode sc)))
+	   (str (if (not (null? psc))
+		    str
+		    (string-append str okuri appendix))))
+      (skk-flush sc)
+      (skk-context-set-child-context! sc '())
+      (skk-context-set-child-type! sc '())
+      (skk-commit sc str))))
+
+(define skk-commit-dialog-context
+  (lambda (sc str)
+    (let* ((psc (skk-context-parent-context sc))
+	   (okuri (skk-make-string (skk-context-okuri sc)
+				   (skk-context-kana-mode sc)))
+	   (appendix (skk-make-string (skk-context-appendix sc)
+				   (skk-context-kana-mode sc)))
+	   (str (if (not (null? psc))
+		    str
+		    (string-append str okuri appendix))))
+      (skk-flush sc)
+      (skk-context-set-child-context! sc '())
+      (skk-context-set-child-type! sc '())
+      (skk-commit sc str))))
+
+;; experimental coding style. discussions are welcome -- YamaKen
+(define skk-proc-state-direct-no-preedit
+  (lambda (key key-state sc rkc)
+    (if skk-use-with-vi?
+	(if (skk-vi-escape-key? key key-state)
+	    (begin
+	      (skk-context-set-state! sc 'skk-state-latin)
+	      (rk-flush rkc))))
+    (cond
+     ((or (skk-cancel-key? key key-state)
+	  (skk-backspace-key? key key-state)
+	  (skk-return-key? key key-state))
+      (skk-commit-raw sc key key-state)
+      #f)
+     ((skk-wide-latin-key? key key-state)
+      (skk-context-set-state! sc 'skk-state-wide-latin)
+      (rk-flush rkc)
+      #f)
+     ((skk-latin-key? key key-state)
+      (skk-context-set-state! sc 'skk-state-latin)
+      (rk-flush rkc)
+      #f)
+     ((skk-kcode-input-key? key key-state)
+      (skk-context-set-state! sc 'skk-state-kcode)
+      (rk-flush rkc)
+      #f)
+     ((skk-latin-conv-key? key key-state)
+      (skk-context-set-state! sc 'skk-state-kanji)
+      (skk-context-set-latin-conv! sc #t)
+      #f)
+     ((skk-sticky-key? key key-state)
+      (skk-context-set-state! sc 'skk-state-kanji)
+      (skk-context-set-latin-conv! sc #f)
+      #f)
+     ((skk-kanji-mode-key? key key-state)
+      (skk-context-set-state! sc 'skk-state-kanji)
+      (skk-context-set-latin-conv! sc #f)
+      #f)
+     ((skk-hankaku-kana-key? key key-state)
+      (let* ((kana (skk-context-kana-mode sc))
+	     (new-kana (if (= kana skk-type-hankana)
+			   skk-type-hiragana
+			   skk-type-hankana)))
+	(skk-context-set-kana-mode! sc new-kana))
+      #f)
+     ((skk-kana-toggle-key? key key-state)
+      (skk-context-kana-toggle sc)
+      #f)
+     ;; bad strategy. see bug #528
+     ((symbol? key)
+      (skk-commit-raw sc key key-state)
+      #f)
+     ;; bad strategy. see bug #528
+     ((or
+       (and
+	(shift-key-mask key-state)
+	(not (ichar-graphic? key)))
+       (control-key-mask key-state)
+       (alt-key-mask key-state)
+       (meta-key-mask key-state)
+       (super-key-mask key-state)
+       (hyper-key-mask key-state))
+      (if (not (skk-state-direct-no-preedit-nop-key? key key-state))
+	  (skk-commit-raw sc key key-state))
+      #f)
+     (else
+      #t))))
+
+(define skk-rk-pending?
+  (lambda (sc)
+    (if (null? (rk-context-seq (skk-context-rk-context sc)))
+	#f
+	#t)))
+
+(define skk-proc-state-direct
+  (lambda (c key key-state)
+    (let* ((sc (skk-find-descendant-context c))
+	   (key-str (charcode->string (skk-ichar-downcase key)))
+	   (rkc (skk-context-rk-context sc))
+	   (res #f)
+	   (kana (skk-context-kana-mode sc)))
+      (and
+       ;; at first, no preedit mode
+       (if (not (skk-rk-pending? sc))
+	   (skk-proc-state-direct-no-preedit key key-state sc rkc)
+	   #t)
+       (if (skk-cancel-key? key key-state)
+	   (begin
+	     (skk-flush sc)
+	     #f)
+	   #t)
+       (if (skk-backspace-key? key key-state)
+	   (begin
+	     (rk-backspace rkc)
+	     #f)
+	   #t)
+       ;; commits "n" as kana according to kana-mode. This is
+       ;; ddskk-compatible behavior.
+       (if (skk-commit-key? key key-state)
+	   (begin
+	     (set! res (rk-push-key-last! rkc))
+	     #f)
+	   #t)
+       ;; commits "n" as kana according to kana-mode, and send
+       ;; native return
+       (if (skk-return-key? key key-state)
+	   (begin
+	     (set! res (rk-push-key-last! rkc))
+	     (skk-commit-raw-with-preedit-update sc key key-state)
+	     #f)
+	   #t)
+       ;; Handles "n{L,l,/,\,Q,C-q,C-Q,q}" key sequence as below. This is
+       ;; ddskk-compatible behavior.
+       ;; 1. commits "n" as kana according to kana-mode
+       ;; 2. switch mode by "{L,l,/,\,Q,C-q,C-Q,q}"
+       (if (and (skk-wide-latin-key? key key-state)
+		(not (rk-expect-key? rkc key-str)))
+	   (begin
+	     (set! res (rk-push-key-last! rkc))
+	     (skk-context-set-state! sc 'skk-state-wide-latin)
+	     #f)
+	   #t)
+       (if (and (skk-latin-key? key key-state)
+		(not (rk-expect-key? rkc key-str)))
+	   (begin
+	     (set! res (rk-push-key-last! rkc))
+	     (skk-context-set-state! sc 'skk-state-latin)
+	     #f)
+	   #t)
+       (if (and (skk-kcode-input-key? key key-state)
+		(not (rk-expect-key? rkc key-str)))
+	   (begin
+	     (set! res (rk-push-key-last! rkc))
+	     (skk-context-set-state! sc 'skk-state-kcode)
+	     #f)
+	   #t)
+       (if (and (skk-latin-conv-key? key key-state)
+		(not (rk-expect-key? rkc key-str)))
+	   (let* ((residual-kana (rk-push-key-last! rkc)))
+	     (if residual-kana
+		 (skk-commit sc (skk-get-string sc residual-kana kana)))
+	     (skk-context-set-state! sc 'skk-state-kanji)
+	     (skk-context-set-latin-conv! sc #t)
+	     #f)
+	   #t)
+       (if (and (skk-sticky-key? key key-state)
+		(not (rk-expect-key? rkc key-str)))
+	   (let* ((residual-kana (rk-push-key-last! rkc)))
+	     (if residual-kana
+		 (skk-commit sc (skk-get-string sc residual-kana kana)))
+	     (skk-context-set-state! sc 'skk-state-kanji)
+	     (skk-context-set-latin-conv! sc #f)
+	     #f)
+	   #t)
+       (if (and (skk-kanji-mode-key? key key-state)
+		(not (rk-expect-key? rkc key-str)))
+	   (let* ((residual-kana (rk-push-key-last! rkc)))
+	     (if residual-kana
+		 (skk-commit sc (skk-get-string sc residual-kana kana)))
+	     (skk-context-set-state! sc 'skk-state-kanji)
+	     (skk-context-set-latin-conv! sc #f)
+	     #f)
+	   #t)
+       (if (and (skk-hankaku-kana-key? key key-state)
+		(not (rk-expect-key? rkc key-str)))
+	   (let* ((kana (skk-context-kana-mode sc))
+		  (new-kana (if (= kana skk-type-hankana)
+		    		  skk-type-hiragana
+				  skk-type-hankana)))
+	     (set! res (rk-push-key-last! rkc))
+	     (skk-context-set-kana-mode! sc new-kana)
+	     #f)
+	   #t)
+       (if (and (skk-kana-toggle-key? key key-state)
+		(not (rk-expect-key? rkc key-str)))
+	   (begin
+	     (set! res (rk-push-key-last! rkc))
+	     (skk-context-kana-toggle sc)
+	     #f)
+	   #t)
+       ;; Handles "n " key sequence as below. This is ddskk-compatible
+       ;; behavior.
+       ;; 1. commits "n" as kana according to kana-mode
+       ;; 2. commits " " as native space (such as Qt::Key_Space)
+       ;;    unless expected rkc list includes " "
+       (if (and (skk-plain-space-key? key key-state)
+		(not (rk-expect-key? rkc key-str)))
+	   (begin
+	     (set! res (rk-push-key-last! rkc))
+	     (skk-commit-raw-with-preedit-update sc key key-state)
+	     #f)
+	   #t)
+       ;; bad strategy. see bug #528
+       ;; "<Control>a", "<Alt> ", "<Meta>b" and so on
+       (if (or
+	    (and
+	     (shift-key-mask key-state)
+	     (not (ichar-graphic? key)))
+	    (control-key-mask key-state)
+	    (alt-key-mask key-state)
+	    (meta-key-mask key-state)
+	    (super-key-mask key-state)
+	    (hyper-key-mask key-state))
+	   (begin
+	     (skk-flush sc)
+	     (skk-commit-raw-with-preedit-update sc key key-state)
+	     #f)
+	   #t)
+       (if (skk-ichar-upper-case? key)
+	   (if (and 
+		(skk-rk-pending? sc)
+		(not (rk-current-seq rkc)))
+	       ;; ddskk compatible behavior but not in SKK speciation
+	       (let ((str (rk-push-key! rkc (charcode->string
+					      (skk-ichar-downcase key)))))
+		 (skk-context-set-state! sc 'skk-state-kanji)
+		 (if str
+		   (skk-append-string sc str))
+		 #f)
+	       (let* ((residual-kana (rk-push-key-last! rkc)))
+		 ;; handle preceding "n"
+		 (if residual-kana
+		     (skk-commit sc (skk-get-string sc residual-kana kana)))
+		 (skk-context-set-state! sc 'skk-state-kanji)
+		 (set! key (skk-ichar-downcase key))
+		 #t))
+	   #t)
+       ;; bad strategy. see bug #528
+       (if (symbol? key)
+	   (begin
+	     (skk-flush sc)
+	     (skk-commit-raw-with-preedit-update sc key key-state)
+	     #f)
+	   #t)
+       (begin
+	 (set! res
+	       (rk-push-key!
+		rkc
+		key-str))
+	 #t));;and
+      ;; update state
+      (if (eq? (skk-context-state sc) 'skk-state-kanji)
+	  (begin
+	    (if res
+		(skk-append-string sc res))))
+      (if (or
+	   (eq? (skk-context-state sc) 'skk-state-direct)
+	   (eq? (skk-context-state sc) 'skk-state-latin)
+	   (eq? (skk-context-state sc) 'skk-state-wide-latin)
+	   (eq? (skk-context-state sc) 'skk-state-kcode))
+	  (if (and res
+		   (or
+		    (list? (car res))
+		    (not (string=? (car res) ""))))
+	      (skk-get-string sc res kana)
+	      #f)
+	  #f))))
+
+(define skk-sokuon-shiin-char?
+  (lambda (c)
+    (and (ichar-alphabetic? c)
+	 (and
+	  (not (= c 97))	;; a
+	  (not (= c 105))	;; i
+	  (not (= c 117))	;; u
+	  (not (= c 101))	;; e
+	  (not (= c 111))	;; o
+	  (not (= c 110))))))	;; n
+
+(define skk-rk-push-key-match-without-new-seq
+  (lambda (rkc key)
+    (let* ((s (rk-context-seq rkc))
+	   (s (cons key s))
+	   (rule (rk-context-rule rkc))
+	   (seq (rk-lib-find-seq (reverse s) rule)))
+	 (if (and
+	      seq
+	      (null? (cdar seq)))
+	     (cadr seq)
+	     #f))))
+
+; see [Anthy-dev: 2646, 2654]
+(define skk-commit-with-conv-completion
+  (lambda (sc)
+    (cond
+     ((and skk-dcomp-activate?
+	   (not (skk-rk-pending? sc))
+	   (not (string=? (skk-context-dcomp-word sc) "")))
+      (if (skk-lib-get-entry
+           skk-dic
+           (skk-context-dcomp-word sc) "" "" skk-use-numeric-conversion?)
+	  (begin
+	    (skk-string-list-to-context-head
+	     sc
+	     (string-to-list (skk-context-dcomp-word sc)))
+	    (skk-context-set-nth! sc 0)
+	    (skk-commit sc (skk-prepare-commit-string sc)))
+	  (begin
+	    (skk-commit sc (skk-context-dcomp-word sc))
+	    (skk-flush sc))))
+     ((and skk-dcomp-activate?
+	   (skk-rk-pending? sc)
+	   (not (string=? (skk-context-dcomp-word sc) "")))
+      (skk-append-residual-kana sc)
+      (if (not (null? (skk-context-head sc)))
+	  (let ((dcomp (skk-lib-get-dcomp-word
+                        skk-dic
+                        (skk-make-string
+                         (skk-context-head sc)
+                         (skk-context-kana-mode sc))
+                        skk-use-numeric-conversion?
+                        skk-use-look?)))
+	    (if (not (string=? dcomp ""))
+		(begin
+		  (skk-string-list-to-context-head
+		   sc
+		   (string-to-list dcomp))
+		  (if (skk-lib-get-entry
+                       skk-dic
+                       (skk-make-string
+                        (skk-context-head sc) skk-type-hiragana)
+                       ""
+                       ""
+                       skk-use-numeric-conversion?)
+		      (begin
+			(skk-context-set-nth! sc 0)
+			(skk-commit sc (skk-prepare-commit-string sc)))
+		      (begin
+			(skk-commit sc dcomp)
+			(skk-flush sc))))
+		(begin
+		  (if (skk-lib-get-entry
+                       skk-dic
+                       (skk-make-string
+                        (skk-context-head sc) skk-type-hiragana)
+                       ""
+                       ""
+                       skk-use-numeric-conversion?)
+		      (begin
+			(skk-context-set-nth! sc 0)
+			(skk-commit sc (skk-prepare-commit-string sc)))
+		      (begin
+			(skk-commit sc (skk-make-string
+					(skk-context-head sc)
+					(skk-context-kana-mode sc)))
+			(skk-flush sc))))))))
+     (else
+      (skk-append-residual-kana sc)
+      (if (not (null? (skk-context-head sc)))
+	  (begin
+	    (if (skk-lib-get-entry
+                 skk-dic
+                 (skk-make-string
+                  (skk-context-head sc) skk-type-hiragana)
+                 ""
+                 ""
+                 skk-use-numeric-conversion?)
+		(begin
+		  (skk-context-set-nth! sc 0)
+		  (skk-commit sc (skk-prepare-commit-string sc)))
+		(begin
+		  (skk-commit sc (skk-make-string
+				  (skk-context-head sc)
+				  (skk-context-kana-mode sc)))
+		  (skk-flush sc))))
+	  (skk-flush sc))))))
+
+(define skk-proc-state-kanji
+  (lambda (c key key-state)
+    (let* ((sc (skk-find-descendant-context c))
+	   (rkc (skk-context-rk-context sc))
+	   (stat (skk-context-state sc))
+	   (res #f))
+      (and
+       ;; First, check begin-conv, completion, cancel, backspace,
+       ;; commit, and return keys
+       (if (skk-begin-conv-key? key key-state)
+	   (begin
+	     (skk-append-residual-kana sc)
+	     (if (not (null? (skk-context-head sc)))
+		 (skk-begin-conversion sc)
+		 (skk-flush sc))
+	     #f)
+	   #t)
+       (if (skk-begin-completion-key? key key-state)
+	   (begin
+	     (skk-begin-completion sc)
+	     #f)
+	   #t)
+       (if (skk-cancel-key? key key-state)
+	   (begin
+	     (skk-flush sc)
+	     #f)
+	   #t)
+       (if (skk-backspace-key? key key-state)
+	   (begin
+	     (if (not (rk-backspace rkc))
+		 (if (> (length (skk-context-head sc)) 0)
+		     (skk-context-set-head! sc (cdr (skk-context-head sc)))
+		     (skk-flush sc)))
+	     ;;; dcomp
+	     (if (and
+		  skk-dcomp-activate?
+		  (eq? (skk-context-state sc) 'skk-state-kanji))
+		 (skk-context-set-dcomp-word!
+		  sc
+		  (if (not (skk-rk-pending? sc))
+		      (skk-lib-get-dcomp-word
+                       skk-dic
+                       (skk-make-string
+                        (skk-context-head sc)
+                        (skk-context-kana-mode sc))
+                       skk-use-numeric-conversion?
+                       skk-use-look?)
+                      "")))
+	     #f)
+	   #t)
+       (if (or
+	    (skk-commit-key? key key-state)
+	    (skk-return-key? key key-state))
+	   (begin
+	     (skk-append-residual-kana sc)
+	     (skk-commit sc (skk-make-string
+			     (skk-context-head sc)
+			     (skk-context-kana-mode sc)))
+	     (skk-flush sc)
+	     (if (not skk-egg-like-newline?)
+		 (if (skk-return-key? key key-state)
+		     (if skk-commit-newline-explicitly?
+			 (skk-commit sc "\n")
+			 (begin
+			   (skk-update-preedit sc)
+			   (skk-proc-state-direct c key key-state)))))
+ 	     #f)
+	   #t)
+       (if (skk-begin-conv-with-completion-key? key key-state)
+	   ; do uim's own way --ekato. see [Anthy-dev: 2646, 2654]
+	   (begin
+	     (cond
+	      ((and skk-dcomp-activate?
+		    (not (skk-rk-pending? sc))
+		    (not (string=? (skk-context-dcomp-word sc) "")))
+	       (let ((sl (string-to-list (skk-context-dcomp-word sc))))
+		 (skk-string-list-to-context-head sc sl)
+		 (skk-begin-conversion sc)))
+	      ((and skk-dcomp-activate?
+		    (skk-rk-pending? sc)
+		    (not (string=? (skk-context-dcomp-word sc) "")))
+	       (skk-append-residual-kana sc)
+	       (let ((sl (string-to-list
+			  (skk-lib-get-dcomp-word
+                           skk-dic
+                           (skk-make-string
+                            (skk-context-head sc)
+                            (skk-context-kana-mode sc))
+                           skk-use-numeric-conversion?
+                           skk-use-look?))))
+		 (if (not (null? sl))
+		     (begin
+		       (skk-string-list-to-context-head sc sl)
+		       (skk-begin-conversion sc))
+		     (begin
+		       (if (not (null? (skk-context-head sc)))
+			   (skk-begin-conversion sc)
+			   (skk-flush sc))))))
+	      (else
+	       (skk-append-residual-kana sc)
+	       (if (not (null? (skk-context-head sc)))
+		   (skk-begin-conversion sc)
+		   (skk-flush sc))))
+	     #f)
+	   #t)
+       (if (skk-commit-with-conv-completion-key? key key-state)
+	   (begin
+	     (skk-commit-with-conv-completion sc)
+	     #f)
+	   #t)
+       ;; Then check latin-conv status before key handling of hiragana/katakana
+       (if (skk-context-latin-conv sc)
+	   (begin
+	     (cond
+	      ((skk-conv-wide-latin-key? key key-state) 
+	       ;; wide latin conversion
+	       (if (not (null? (skk-context-head sc)))
+		   (begin
+		     (skk-commit sc (skk-conv-wide-latin
+				     (skk-context-head sc)))
+		     (skk-flush sc))))
+	      ((skk-conv-opposite-case-key? key key-state) 
+	       ;; alternative case conversion
+	       (if (not (null? (skk-context-head sc)))
+		   (begin
+		     (skk-commit sc (skk-conv-opposite-case
+				     (skk-context-head sc)))
+		     (skk-flush sc))))
+	      (else
+	       ;; append latin string
+	       (begin
+		 (if (ichar-graphic? key)
+		     (let* ((s (charcode->string key))
+			    (p (cons s (cons s (cons s s)))))
+		       (skk-append-string sc p))))))
+	     #f)
+	   #t)
+       (if (skk-kanji-mode-key? key key-state)
+	   (begin
+	     (skk-append-residual-kana sc)
+	     (if (not (null? (skk-context-head sc)))
+		 (begin
+		   (skk-commit sc (skk-make-string
+				   (skk-context-head sc)
+				   (skk-context-kana-mode sc)))
+		   (skk-flush sc)
+		   (skk-context-set-state! sc 'skk-state-kanji)
+		   (skk-context-set-latin-conv! sc #f)))
+	     #f)
+	   #t)
+       ;; handle Settou-ji
+       (if (skk-special-midashi-key? key key-state)
+	   (begin
+	     (skk-append-residual-kana sc)
+	     (skk-append-string sc '(">" ">" ">"))
+	     (skk-begin-conversion sc)
+	     #f)
+	   #t)
+       (if (skk-sticky-key? key key-state)
+	   (if (null? (skk-context-head sc))
+	     (begin
+	       (skk-commit sc (charcode->string key))
+	       (skk-flush sc)
+	       #f)
+	     (begin
+	       (skk-context-set-state! sc 'skk-state-okuri)
+	       #f))
+	   #t)
+       (if (and (skk-ichar-upper-case? key)
+		(not (null? (skk-context-head sc))))
+	   (let ((key-str (charcode->string (skk-ichar-downcase key))))
+	     (set! res (skk-rk-push-key-match-without-new-seq rkc key-str))
+	     (if (and
+		  (skk-rk-pending? sc)
+		  (not (rk-current-seq rkc))
+		  res)
+		 ;; ddskk compatible behavior but not in SKK speciation
+		 (begin
+		   (skk-context-set-state! sc 'skk-state-okuri)
+		   (skk-context-set-okuri-head-using-alist!
+		    sc
+		    (car (reverse (rk-context-seq rkc))))
+		   (rk-context-set-seq! rkc '())
+		   (skk-append-okuri-string sc res)
+		   (skk-begin-conversion sc)
+		   #f)
+		 (begin
+		   (skk-context-set-state! sc 'skk-state-okuri)
+		   (set! key (skk-ichar-downcase key))
+		   (skk-context-set-okuri-head-using-alist! sc key-str)
+		   (if (and (not (member key skk-set-henkan-point-key)) (skk-sokuon-shiin-char? key))
+		       (begin
+			 (set! res (rk-push-key! rkc key-str))
+			 (if res
+			     (skk-context-set-head! sc
+						    (cons
+						     res
+						     (skk-context-head sc))))))
+		   (skk-append-residual-kana sc)
+		   #t)))
+	   #t)
+       (if (skk-kana-toggle-key? key key-state)
+	   (begin
+	     (skk-append-residual-kana sc)
+	     (if (not (null? (skk-context-head sc)))
+		 (begin
+		   (skk-commit sc (skk-make-string
+				   (skk-context-head sc)
+				   (skk-opposite-kana
+				    (skk-context-kana-mode sc))))
+	     	   (skk-flush sc)))
+	     #f)
+	   #t)
+       (if (skk-hankaku-kana-key? key key-state)
+	   (begin
+	     (skk-append-residual-kana sc)
+	     (if (not (null? (skk-context-head sc)))
+		 (begin
+		   (skk-commit sc (skk-make-string (skk-context-head sc)
+						   skk-type-hankana))
+		   (skk-flush sc)))
+	     #f)
+	   #t)
+       (begin
+	 (set! key (skk-ichar-downcase key))  
+	 (set! stat (skk-context-state sc))
+	 (set! res
+	       (rk-push-key!
+		rkc
+		(charcode->string key)))
+	 (and
+	  (if (and
+	       res
+	       skk-auto-start-henkan?
+	       (string-find skk-auto-start-henkan-keyword-list (car res))
+	       (not (null? (skk-context-head sc))))
+	      (begin
+		(skk-context-set-appendix! sc (list res))
+		(skk-begin-conversion sc)
+		#f)
+	      #t)
+	  (if (and res
+		   (eq? stat 'skk-state-kanji)
+		   (or
+		    (list? (car res))
+		    (not (string=? (car res) ""))))
+	      (begin
+		(skk-append-string sc res)
+		#t)
+	      #t)
+	   (if (and res
+	 	    (eq? stat 'skk-state-okuri)
+		    (or
+		     (list? (car res))
+		     (not (string=? (car res) ""))))
+	       (begin
+		 (skk-append-okuri-string sc res)
+		 (skk-begin-conversion sc))))))
+      #f)))
+
+(define skk-setup-child-context
+  (lambda (sc type)
+    (let ((csc (skk-context-new (skk-context-uc sc)
+				(skk-context-im sc)))
+	  (input-rule (skk-context-input-rule sc)))
+      (skk-context-set-child-context! sc csc)
+      (skk-context-set-child-type! sc type)
+      (skk-context-set-parent-context! csc sc)
+      (if (= type skk-child-type-editor)
+	  (skk-context-set-state! csc 'skk-state-direct)
+	  (skk-context-set-state! csc 'skk-state-latin))
+      (skk-set-rule! csc input-rule))))
+
+(define skk-check-candidate-window-begin
+  (lambda (sc)
+    (if (and
+	 (not (skk-context-candidate-window sc))
+	 skk-use-candidate-window?
+	 (> (skk-context-nth sc) (- skk-candidate-op-count 2)))
+	(begin
+	  (skk-context-set-candidate-window! sc #t)
+	  (skk-context-set-nr-candidates!
+	   sc
+	   (skk-lib-get-nr-candidates
+            skk-dic
+            (skk-make-string (skk-context-head sc) skk-type-hiragana)
+            (skk-context-okuri-head sc)
+            (skk-make-string (skk-context-okuri sc) skk-type-hiragana)
+            skk-use-numeric-conversion?))
+	  (im-activate-candidate-selector
+	   sc
+	   (cond
+	    ((eq? skk-candidate-selection-style 'uim)
+		  (skk-context-nr-candidates sc))
+	    ((eq? skk-candidate-selection-style 'ddskk-like)
+		  (- (skk-context-nr-candidates sc)
+		     (- skk-candidate-op-count 1))))
+	   skk-nr-candidate-max)))))
+
+(define skk-commit-by-label-key
+  (lambda (sc key)
+    (let ((nr (skk-context-nr-candidates sc))
+	  (cur-page (if (= skk-nr-candidate-max 0)
+			0
+			(cond
+			 ((eq? skk-candidate-selection-style 'uim)
+			    (quotient (skk-context-nth sc)
+				      skk-nr-candidate-max))
+			 ((eq? skk-candidate-selection-style 'ddskk-like)
+			    (quotient (- (skk-context-nth sc)
+					 (- skk-candidate-op-count 1))
+				      skk-nr-candidate-max)))))
+	  (idx -1)
+	  (res #f))
+      (cond
+       ((eq? skk-candidate-selection-style 'uim)
+	(let ((num (- (length skk-uim-heading-label-char-list)
+		      (length
+		       (member (charcode->string key)
+			       skk-uim-heading-label-char-list)))))
+	  (if (or (< num skk-nr-candidate-max)
+		  (= skk-nr-candidate-max 0))
+	      (set! idx (+ (* cur-page skk-nr-candidate-max) num)))))
+       ((eq? skk-candidate-selection-style 'ddskk-like)
+	(let ((num (- (length skk-ddskk-like-heading-label-char-list)
+		      (length
+		       (member (charcode->string key)
+			       skk-ddskk-like-heading-label-char-list)))))
+	  (if (or (< num skk-nr-candidate-max)
+		  (= skk-nr-candidate-max 0))
+	      (set! idx (+ (* cur-page skk-nr-candidate-max)
+			   num (- skk-candidate-op-count 1)))))))
+      (if (and (>= idx 0)
+	       (< idx nr))
+	  (begin
+	    (skk-context-set-nth! sc idx)
+	    (set! res (skk-prepare-commit-string sc))))
+      res)))
+      
+(define skk-incr-candidate-index
+  (lambda (sc)
+    (cond
+     ((eq? skk-candidate-selection-style 'uim)
+      (skk-context-set-nth! sc (+ 1 (skk-context-nth sc))))
+     ((eq? skk-candidate-selection-style 'ddskk-like)
+      (if (> (+ (skk-context-nth sc) 1) (- skk-candidate-op-count 1))
+	  (if (> (+ (skk-context-nth sc) skk-nr-candidate-max)
+		 (- (skk-context-nr-candidates sc) 1))
+	      ;; go into recursive learning state
+	      (skk-context-set-nth! sc (skk-context-nr-candidates sc))
+	      ;; just shift to next page
+	      (im-shift-page-candidate sc #t))
+	  ;; just increment index unless candidate window exist
+	  (skk-context-set-nth! sc (+ 1 (skk-context-nth sc))))))
+    (skk-context-set-candidate-op-count!
+     sc
+     (+ 1 (skk-context-candidate-op-count sc)))
+    #t))
+
+(define skk-decr-candidate-index
+  (lambda (sc)
+    (cond
+     ((eq? skk-candidate-selection-style 'uim)
+      (if (> (skk-context-nth sc) 0)
+	  (begin
+	    (skk-context-set-nth! sc (- (skk-context-nth sc) 1))
+	    #t)
+	  (begin
+	    (if (= (skk-context-nr-candidates sc) 0)
+		(begin
+		  (skk-back-to-kanji-state sc)
+		  #f)
+		(begin
+		  (skk-context-set-nth!
+		   sc
+		   (- (skk-context-nr-candidates sc) 1))
+		  #t)))))
+     ((eq? skk-candidate-selection-style 'ddskk-like)
+      (if (> (skk-context-nth sc)
+	     (+ skk-nr-candidate-max (- skk-candidate-op-count 2)))
+	  (begin
+	    (im-shift-page-candidate sc #f)
+	    #t)
+	  (if (= (skk-context-nth sc) 0)
+	      (begin
+		(skk-back-to-kanji-state sc)
+		#f)
+	      (begin
+		(if (> (skk-context-nth sc) (- skk-candidate-op-count 2))
+		    (begin
+		      (skk-reset-candidate-window sc)
+		      (skk-context-set-nth! sc
+					    (- skk-candidate-op-count 1))))
+		(skk-context-set-nth! sc (- (skk-context-nth sc) 1))
+		#t)))))))
+
+(define skk-change-candidate-index
+  (lambda (sc incr)
+    (let ((head (skk-context-head sc)))
+      (and
+       (if incr
+	   (skk-incr-candidate-index sc)
+	   (skk-decr-candidate-index sc))
+       (if (null? (skk-get-current-candidate sc))
+	   (begin
+	     (skk-context-set-nth! sc 0)
+	     (if skk-use-recursive-learning?
+		 (begin
+		   (skk-reset-candidate-window sc)
+		   (skk-setup-child-context sc skk-child-type-editor)))
+	     #t)
+	   #t)
+       (if (null? (skk-context-child-context sc))
+	   (begin
+	     ;; Windowɽ򳫻Ϥ뤫
+	     (skk-check-candidate-window-begin sc)
+	     ;;
+	     (if (skk-context-candidate-window sc)
+		 (cond
+		  ((eq? skk-candidate-selection-style 'uim)
+		   (im-select-candidate sc (skk-context-nth sc)))
+		  ((eq? skk-candidate-selection-style 'ddskk-like)
+		   (im-select-candidate
+		    sc
+		    (- (skk-context-nth sc) (- skk-candidate-op-count 1))))))
+	     #t)
+	   #t))
+      #f)))
+
+(define skk-reset-candidate-window
+  (lambda (sc)
+    (if (skk-context-candidate-window sc)
+	(begin
+	  (im-deactivate-candidate-selector sc)
+	  (skk-context-set-candidate-window! sc #f)))
+    (skk-context-set-candidate-op-count! sc 0)))
+
+(define skk-back-to-kanji-state
+  (lambda (sc)
+    (skk-reset-candidate-window sc)
+    (skk-context-set-state! sc 'skk-state-kanji)
+    (skk-context-set-okuri-head! sc "")
+    (if (not (null? (skk-context-okuri sc)))
+	(begin
+	  (skk-context-set-head! sc
+				 (append (skk-context-okuri sc)
+					 (skk-context-head sc)))
+	  (skk-reset-dcomp-word sc)))
+    (if (not (null? (skk-context-appendix sc)))
+	(begin
+	  (skk-context-set-head! sc
+				 (append (skk-context-appendix sc)
+					 (skk-context-head sc)))
+	  (skk-reset-dcomp-word sc)))
+    (skk-context-set-okuri! sc '())
+    (skk-context-set-appendix! sc '())
+    ;; don't clear dcomp (not compatible with ddskk's behavior)
+    ;;(skk-reset-dcomp-word sc )
+    (skk-context-set-nr-candidates! sc 0)))
+
+(define skk-back-to-converting-state
+  (lambda (sc)
+    (skk-context-set-nth! sc (- (skk-context-nr-candidates sc) 1))
+    (skk-check-candidate-window-begin sc)
+    (if (skk-context-candidate-window sc)
+	(cond
+	 ((eq? skk-candidate-selection-style 'uim)
+	  (im-select-candidate sc (skk-context-nth sc)))
+	 ((eq? skk-candidate-selection-style 'ddskk-like)
+	  (im-select-candidate
+	   sc
+	   (- (skk-context-nth sc) (- skk-candidate-op-count 1))))))
+    (skk-context-set-state! sc 'skk-state-converting)))
+
+(define skk-change-completion-index
+  (lambda (sc incr)
+    (if incr
+	(begin
+	  (if (> (- (skk-lib-get-nr-completions
+                     skk-dic
+                     (skk-make-string (skk-context-head sc) skk-type-hiragana)
+                     skk-use-numeric-conversion?
+                     skk-use-look?)
+		    1)
+		 (skk-context-completion-nth sc))
+	      (skk-context-set-completion-nth!
+	       sc
+	       (+ 1 (skk-context-completion-nth sc)))))
+	(begin
+	  (if (> (skk-context-completion-nth sc) 0)
+	      (skk-context-set-completion-nth!
+	       sc
+	       (- (skk-context-completion-nth sc) 1)))))
+    #f))
+
+(define find-kana-list-from-rule
+  (lambda (rule str)
+    (if (not (null? rule))
+	(if (pair? (member str (car (cdr (car rule)))))
+	    (car (cdr (car rule)))
+	    (find-kana-list-from-rule (cdr rule) str))
+	(list str str str))))
+
+(define skk-string-list-to-context-head
+  (lambda (sc sl)
+    (skk-context-set-head! sc '())
+    (skk-append-string-list-to-context-head sc sl)))
+
+(define skk-append-string-list-to-context-head
+  (lambda (sc sl)
+    (let ((append-list-to-context-head
+    	    (lambda (sc sl)
+	      (skk-context-set-head! sc (append (skk-context-head sc)
+	      (list sl))))))
+      (if (not (null? sl))
+	  (begin
+	    (append-list-to-context-head
+	      sc
+	      (if (or
+		   (skk-context-latin-conv sc)
+		   ;; handle Setsubi-ji and Settou-ji
+		   (string=? ">" (car sl))
+		   (and
+		    skk-use-numeric-conversion?
+		    (string=? "#" (car sl))))
+	       (list (car sl) (car sl) (car sl))
+	       (find-kana-list-from-rule ja-rk-rule-basic (car sl))))
+	  (skk-append-string-list-to-context-head sc (cdr sl)))
+	#f))))
+
+(define skk-proc-state-completion
+  (lambda (c key key-state)
+    (let ((sc (skk-find-descendant-context c)))
+      (and
+       (if (skk-next-completion-key? key key-state)
+	   (skk-change-completion-index sc #t)
+	   #t)
+       (if (skk-prev-completion-key? key key-state)
+	   (skk-change-completion-index sc #f)
+	   #t)
+       (if (skk-new-completion-from-current-comp-key? key key-state)
+	   (let* ((comp (skk-get-current-completion sc))
+		  (sl (string-to-list comp)))
+	     (if (not (null? sl))
+		 (begin (skk-lib-get-completion
+                         skk-dic
+                         (skk-get-current-completion sc)
+                         skk-use-numeric-conversion?
+                         skk-use-look?)))
+	     (skk-lib-clear-completions
+	      (skk-make-string
+	       (skk-context-head sc)
+	       skk-type-hiragana)
+	      skk-use-numeric-conversion?)
+	     (if (not (null? sl))
+		 (skk-string-list-to-context-head sc sl))
+	     (skk-context-set-completion-nth! sc 0)
+	     (if skk-dcomp-activate?
+		 (skk-context-set-dcomp-word!
+		  sc
+		  (skk-get-current-completion sc)))
+	     #f)
+	   #t)
+       (if (skk-cancel-key? key key-state)
+	   (begin
+	     (skk-lib-clear-completions
+	       (skk-make-string (skk-context-head sc) skk-type-hiragana)
+	       skk-use-numeric-conversion?)
+	     (skk-context-set-state! sc 'skk-state-kanji)
+	     ;; don't clear dcomp (not compatible with ddskk's behavior)
+	     ;;(skk-reset-dcomp-word sc)
+	     #f)
+	   #t)
+       (let ((sl (string-to-list (skk-get-current-completion sc))))
+	 (skk-lib-clear-completions
+	  (skk-make-string (skk-context-head sc) (skk-context-kana-mode sc))
+	  skk-use-numeric-conversion?)
+	 (if (not (null? sl))
+	     (skk-string-list-to-context-head sc sl))
+	 (skk-reset-dcomp-word sc)
+	 (skk-context-set-state! sc 'skk-state-kanji)
+	 (skk-proc-state-kanji c key key-state)))
+      #f)))
+
+(define skk-heading-label-char?
+  (lambda (key)
+    (cond
+     ((eq? skk-candidate-selection-style 'uim)
+      (if (member (charcode->string key)
+      		  skk-uim-heading-label-char-list)
+	  #t
+	  #f))
+     ((eq? skk-candidate-selection-style 'ddskk-like)
+      (if (member (charcode->string key)
+		  skk-ddskk-like-heading-label-char-list)
+	  #t
+	  #f)))))
+
+(define skk-proc-state-converting
+  (lambda (c key key-state)
+    (let ((sc (skk-find-descendant-context c))
+	  (res #f))
+      (and
+       (if (skk-next-candidate-key? key key-state)
+	   (skk-change-candidate-index sc #t)
+	   #t)
+       (if (skk-prev-candidate-key? key key-state)
+	   (skk-change-candidate-index sc #f)
+	   #t)
+       (if (skk-cancel-key? key key-state)
+	   (begin
+	     ;; back to kanji state
+	     (skk-back-to-kanji-state sc)
+	     #f)
+	   #t)
+       (if (skk-next-page-key? key key-state)
+	   (begin
+	     (if (skk-context-candidate-window sc)
+		 (im-shift-page-candidate sc #t))
+	     #f)
+	   #t)
+       (if (skk-prev-page-key? key key-state)
+	   (begin
+	     (if (skk-context-candidate-window sc)
+		 (im-shift-page-candidate sc #f))
+	     #f)
+	   #t)
+       (if (or
+	    (skk-commit-key? key key-state)
+	    (skk-return-key? key key-state))
+	   (begin
+	     (set! res (skk-prepare-commit-string sc))
+	     (if (skk-return-key? key key-state)
+		 (begin
+		   (skk-commit sc res)
+		   (set! res #f)
+		   (if (not skk-egg-like-newline?)
+		       (if skk-commit-newline-explicitly?
+			   (skk-commit sc "\n")
+			   (begin
+			     (skk-update-preedit sc)
+			     (skk-proc-state-direct c key key-state))))))
+	     #f)
+	   #t)
+       (if (and skk-commit-candidate-by-label-key?
+       		(skk-heading-label-char? key)
+		(skk-context-candidate-window sc))
+	   (begin
+	     (set! res (skk-commit-by-label-key sc key))
+	     (if res
+		 #f
+		 #t))
+	   #t)
+       (if (skk-purge-candidate-key? key key-state)
+	   (if (not
+		(and (eq? skk-candidate-selection-style 'ddskk-like)
+		     (skk-context-candidate-window sc)))
+	       (begin
+		 (skk-reset-candidate-window sc)
+		 (skk-setup-child-context sc skk-child-type-dialog)
+		 #f))
+	   #t)
+       (begin
+	 (skk-context-set-state! sc 'skk-state-direct)
+	 (set! res (skk-prepare-commit-string sc))
+	 (skk-commit sc res)
+	 (skk-update-preedit sc)
+	 ;; handle Setsubi-ji
+	 (if (skk-special-midashi-key? key key-state)
+	     (begin
+	       (skk-context-set-state! sc 'skk-state-kanji)
+	       (skk-append-string sc '(">" ">" ">"))
+	       (set! res #f))
+	     (set! res (skk-proc-state-direct c key key-state)))))
+      res)))
+
+(define skk-proc-state-okuri
+  (lambda (c key key-state)
+    (let* ((sc (skk-find-descendant-context c))
+	   (rkc (skk-context-rk-context sc))
+	   (res #f))
+      (and
+       (if (skk-cancel-key? key key-state)
+	   (begin
+	     (rk-flush rkc)
+	     (skk-back-to-kanji-state sc)
+	     #f)
+	   #t)
+       (if (skk-backspace-key? key key-state)
+	   (begin
+	     (rk-backspace rkc)
+	     (skk-back-to-kanji-state sc)
+	     #f)
+	   #t)
+       ;; committing incomplete head: conformed the behavior to ddskk
+       (if (or
+	    (skk-commit-key? key key-state)
+	    (skk-return-key? key key-state))
+	   (begin
+	     (skk-commit sc (skk-make-string
+			     (skk-context-head sc)
+			     (skk-context-kana-mode sc)))
+	     (skk-flush sc)
+	     (if (skk-return-key? key key-state)
+		 (begin
+		   (skk-update-preedit sc)
+		   (skk-proc-state-direct c key key-state)))
+	     #f)
+	   #t)
+       (begin
+	 (if (string=? (skk-context-okuri-head sc) "")
+             (if (skk-rk-pending? sc)
+               (skk-context-set-okuri-head-using-alist!
+                 sc
+                 (car (reverse (rk-context-seq rkc))))
+               (skk-context-set-okuri-head-using-alist!
+                 sc
+                 (charcode->string (skk-ichar-downcase key)))))
+	 (set! res
+	       (rk-push-key!
+		rkc
+		(charcode->string (skk-ichar-downcase key))))
+	 (if (and res
+	 	  (or
+		   (list? (car res))
+		   (not (string=? (car res) ""))))
+	     (begin
+	       (skk-append-okuri-string sc res)
+	       (if (not (skk-rk-pending? sc))
+		   (skk-begin-conversion sc)))
+	     (begin
+	       (if (= (length (rk-context-seq rkc)) 1)
+		   (skk-context-set-okuri-head-using-alist! sc (charcode->string key)))))))
+      #f)))
+
+(define skk-proc-state-latin
+  (lambda (c key key-state)
+    (let ((sc (skk-find-descendant-context c)))
+      (if
+       (skk-on-key? key key-state)
+       (begin
+	 (skk-context-set-state! sc 'skk-state-direct)
+	 (skk-context-set-kana-mode! sc skk-type-hiragana))
+       (skk-commit-raw sc key key-state))
+      #f)))
+
+(define skk-proc-state-wide-latin
+  (lambda (c key key-state)
+    (let* ((char (charcode->string key))
+	   (w (if (symbol? key) #f (ja-wide char)))
+	   (sc (skk-find-descendant-context c)))
+      (if skk-use-with-vi?
+	  (if (skk-vi-escape-key? key key-state)
+	      (skk-context-set-state! sc 'skk-state-latin)))
+      (cond
+       ((skk-on-key? key key-state)
+	(skk-flush sc)
+	(skk-context-set-state! sc 'skk-state-direct)
+	(skk-context-set-kana-mode! sc skk-type-hiragana))
+       ((and (modifier-key-mask key-state)
+	     (not (shift-key-mask key-state)))
+	(skk-commit-raw sc key key-state))
+       (w
+	(skk-commit sc w))
+       (else
+	(skk-commit-raw sc key key-state)))
+      #f)))
+
+(define skk-proc-state-kcode
+  (lambda (c key key-state)
+    (let ((sc (skk-find-descendant-context c)))
+      (and
+       (if (skk-cancel-key? key key-state)
+	   (begin
+	     (skk-flush sc)
+	     #f)
+	   #t)
+       (if (skk-backspace-key? key key-state)
+	   (begin
+	     (if (> (length (skk-context-head sc)) 0)
+		 (skk-context-set-head! sc (cdr (skk-context-head sc)))
+		 (skk-flush sc))
+	     #f)
+	   #t)
+       (if (or
+	    (skk-commit-key? key key-state)
+	    (skk-return-key? key key-state))
+	   (begin
+	     (if (> (length (skk-context-head sc)) 0)
+	       (let* ((str-list (string-to-list
+				  (skk-make-string
+				     (skk-context-head sc)
+				     (skk-context-kana-mode sc))))
+		      (kanji (ja-kanji-code-input str-list)))
+		 (if (and kanji (> (string-length kanji) 0))
+		   (begin
+		     (skk-commit sc kanji)
+		     (skk-flush sc))))
+	       (skk-flush sc))
+	     #f)
+	   #t)
+       ;; append latin string
+       (if (ichar-graphic? key)
+	   (let* ((s (charcode->string key))
+		  (p (cons s (cons s (cons s s)))))
+	     (skk-append-string sc p)
+	     #f)
+	   #t))
+      #f)))
+
+(define skk-push-key
+  (lambda (c key key-state)
+    (let* ((sc (skk-find-descendant-context c))
+	   (state (skk-context-state sc))
+	   (fun (cond
+		 ((eq? state 'skk-state-direct)
+		  skk-proc-state-direct)
+		 ((eq? state 'skk-state-kanji)
+		  skk-proc-state-kanji)
+		 ((eq? state 'skk-state-completion)
+		  skk-proc-state-completion)
+		 ((eq? state 'skk-state-converting)
+		  skk-proc-state-converting)
+		 ((eq? state 'skk-state-okuri)
+		  skk-proc-state-okuri)
+		 ((eq? state 'skk-state-latin)
+		  skk-proc-state-latin)
+		 ((eq? state 'skk-state-wide-latin)
+		  skk-proc-state-wide-latin)
+		 ((eq? state 'skk-state-kcode)
+		  skk-proc-state-kcode)))
+	   (res (fun c key key-state)))
+      (if res
+	  (skk-commit sc res))
+      (skk-update-preedit sc))))
+
+(define skk-init-handler
+  (lambda (id im arg)
+    (let ((sc (skk-context-new id im)))
+      (update-style skk-style-spec (symbol-value skk-style))
+      (set! skk-context-list (cons sc skk-context-list))
+      sc)))
+
+(define skk-release-handler
+  (lambda (sc)
+    (skk-save-personal-dictionary)
+    (set! skk-context-list (delete! sc skk-context-list))
+    (if (null? skk-context-list)
+      (begin
+        (skk-lib-look-close)
+        (skk-lib-free-dic skk-dic)
+        (set! skk-dic #f)))))
+
+(define skk-press-key-handler
+  (lambda (sc key state)
+    (if (ichar-control? key)
+	(im-commit-raw sc)
+	(skk-push-key sc key state))))
+
+(define skk-release-key-handler
+  (lambda (c key state)
+    (let* ((sc (skk-find-descendant-context c))
+	   (state (skk-context-state sc)))
+      (if (eq? state 'skk-state-latin)
+	  ;; don't discard key release event for apps
+	  (begin
+	    (skk-context-set-commit-raw! sc #f)
+	    (im-commit-raw sc))))))
+
+(define skk-reset-handler
+  (lambda (sc)
+    (skk-flush sc)))
+
+(define skk-get-candidate-with-okuri
+  (lambda (cand okuri)
+    (let ((pos (string-contains cand ";" 0)))
+      (if pos
+	  (string-append
+	   (substring cand 0 pos)
+	   (skk-make-string okuri skk-type-hiragana)
+	   (substring cand pos (string-length cand)))
+	  (string-append
+	   cand
+	   (skk-make-string okuri skk-type-hiragana))))))
+
+(define skk-get-candidate-handler
+  (lambda (sc idx accel-enum-hint)
+    (let* ((dcsc (skk-find-descendant-context sc))
+	   (cand (skk-lib-eval-candidate
+		  (skk-get-nth-candidate
+		   dcsc
+		   (cond
+		    ((eq? skk-candidate-selection-style 'uim)
+		       idx)
+		    ((eq? skk-candidate-selection-style 'ddskk-like)
+		       (+ idx (- skk-candidate-op-count 1)))))))
+	   (okuri (skk-context-okuri dcsc)))
+      (list
+       (if (and
+	    (not (null? okuri))
+	    skk-show-candidates-with-okuri?)
+	   (skk-get-candidate-with-okuri cand okuri)
+	   cand)
+       (cond
+	((eq? skk-candidate-selection-style 'uim)
+	 (if (= skk-nr-candidate-max 0)
+	     (digit->string (+ idx 1))
+	     (begin
+	       (set! idx (remainder idx skk-nr-candidate-max))
+	       (if (< idx (length skk-uim-heading-label-char-list))
+		   (charcode->string
+		    (ichar-upcase
+		     (string->charcode
+		      (nth idx skk-uim-heading-label-char-list))))
+		   ""))))
+	((eq? skk-candidate-selection-style 'ddskk-like)
+	 (if (> skk-nr-candidate-max 0)
+	     (set! idx (remainder idx skk-nr-candidate-max)))
+	 (if (< idx (length skk-ddskk-like-heading-label-char-list))
+	     (charcode->string
+	      (ichar-upcase
+	       (string->charcode
+		(nth idx skk-ddskk-like-heading-label-char-list))))
+	     "")))
+       ""))))
+
+(define skk-set-candidate-index-handler
+  (lambda (c idx)
+    (let ((sc (skk-find-descendant-context c)))
+      (if (skk-context-candidate-window sc)
+	  (begin
+	    (cond
+	     ((eq? skk-candidate-selection-style 'uim)
+	      (skk-context-set-nth! sc idx))
+	     ((eq? skk-candidate-selection-style 'ddskk-like)
+	      (skk-context-set-nth! sc (+ idx (- skk-candidate-op-count 1)))))
+	    (skk-update-preedit sc))))))
+
+(skk-configure-widgets)
+
+(register-im
+ 'skk
+ "ja"
+ "EUC-JP"
+ skk-im-name-label
+ skk-im-short-desc
+ #f
+ skk-init-handler
+ skk-release-handler
+ context-mode-handler
+ skk-press-key-handler
+ skk-release-key-handler
+ skk-reset-handler
+ skk-get-candidate-handler
+ skk-set-candidate-index-handler
+ context-prop-activate-handler
+ #f
+ #f
+ #f
+ #f
+ #f
+ )
diff --git a/scm/skk.scm b/scm/skk.scm
index 5e56582f8..e5987b0c8 100644
--- a/scm/skk.scm
+++ b/scm/skk.scm
@@ -30,21 +30,21 @@
 
 ;; SKK is a Japanese input method
 ;;
-;; EUC-JP
+;; UTF-8
 ;;
-;; SKKϤϲξ֤ǹ
+;; SKKの入力は下記の状態で構成される
 ;; Following is list of SKK input state
-;;  ľ direct
-;;   kanji
-;;  Ф䴰 completion
-;;  Ѵ converting
-;;  ꤬ okuri
-;;  ѿ latin
-;;  ѱѿ wide-latin
-;;   kcode
+;;  直接入力 direct
+;;  漢字入力 kanji
+;;  見出し語補完 completion
+;;  変換中 converting
+;;  送りがな okuri
+;;  英数 latin
+;;  全角英数 wide-latin
+;;  漢字コード入力 kcode
 ;;
 ;;
-(require "japanese.scm")
+(require "japanese-utf8.scm")
 (require-custom "generic-key-custom.scm")
 (require-custom "skk-custom.scm")
 (require-custom "skk-key-custom.scm")
@@ -54,7 +54,7 @@
 
 ;; TODO: Support new custom type string-list. It involves character
 ;; encoding conversion problem.  -- YamaKen 2005-02-02
-(define skk-auto-start-henkan-keyword-list '("" "" "" "" "" "" "" "" "" "" ")" ";" ":" "" "" "" "" "" "" "" "" "" "}" "]" "?" "." "," "!"))
+(define skk-auto-start-henkan-keyword-list '("を" "、" "。" "．" "，" "？" "」" "！" "；" "：" ")" ";" ":" "）" "”" "】" "』" "》" "〉" "｝" "］" "〕" "}" "]" "?" "." "," "!"))
 
 (define skk-ddskk-like-heading-label-char-list '("a" "s" "d" "f" "j" "k" "l"))
 (define skk-uim-heading-label-char-list '("1" "2" "3" "4" "5" "6" "7" "8" "9" "0"))
@@ -135,8 +135,8 @@
     (skk-preedit-attr-child-committed      . preedit-underline)
     (skk-preedit-attr-child-dialog	   . preedit-none)
     (skk-preedit-attr-dcomp		   . preedit-underline)
-    (skk-child-context-beginning-mark      . "")
-    (skk-child-context-end-mark		   . "")
+    (skk-child-context-beginning-mark      . "【")
+    (skk-child-context-end-mark		   . "】")
     (skk-show-cursor-on-preedit?	   . #t)
     (skk-show-candidates-with-okuri?       . #f)))
 
@@ -184,9 +184,9 @@
 (register-action 'action_skk_hiragana
 		 (lambda (sc)
 		   '(ja_hiragana
-		     ""
-		     "Ҥ餬"
-		     "Ҥ餬ϥ⡼"))
+		     "あ"
+		     "ひらがな"
+		     "ひらがな入力モード"))
 		 (lambda (sc)
 		   (let ((dsc (skk-find-descendant-context sc)))
 		     (and (not (skk-latin-state? dsc))
@@ -201,9 +201,9 @@
 (register-action 'action_skk_katakana
 		 (lambda (sc)
 		   '(ja_katakana
-		     ""
-		     ""
-		     "ϥ⡼"))
+		     "ア"
+		     "カタカナ"
+		     "カタカナ入力モード"))
 		 (lambda (sc)
 		   (let ((dsc (skk-find-descendant-context sc)))
 		     (and (not (skk-latin-state? dsc))
@@ -218,9 +218,9 @@
 (register-action 'action_skk_hankana
 		 (lambda (sc)
 		   '(ja_halfkana
-		     ""
-		     "Ⱦѥ"
-		     "Ⱦѥϥ⡼"))
+		     "ｱ"
+		     "半角カタカナ"
+		     "半角カタカナ入力モード"))
 		 (lambda (sc)
 		   (let ((dsc (skk-find-descendant-context sc)))
 		     (and (not (skk-latin-state? dsc))
@@ -236,8 +236,8 @@
 		 (lambda (sc)
 		   '(ja_halfwidth_alnum
 		     "a"
-		     "ľ"
-		     "ľ(̵Ѵ)ϥ⡼"))
+		     "直接入力"
+		     "直接(無変換)入力モード"))
 		 (lambda (sc)
 		   (let ((dsc (skk-find-descendant-context sc)))
 		     (eq? (skk-context-state dsc)
@@ -250,9 +250,9 @@
 (register-action 'action_skk_wide_latin
 		 (lambda (sc)
 		   '(ja_fullwidth_alnum
-		     ""
-		     "ѱѿ"
-		     "ѱѿϥ⡼"))
+		     "Ａ"
+		     "全角英数"
+		     "全角英数入力モード"))
 		 (lambda (sc)
 		   (let ((dsc (skk-find-descendant-context sc)))
 		     (eq? (skk-context-state dsc)
@@ -265,9 +265,9 @@
 (register-action 'action_skk_roma
 		 (lambda (sc)
 		   '(ja_romaji
-		     ""
-		     "޻"
-		     "޻ϥ⡼"))
+		     "Ｒ"
+		     "ローマ字"
+		     "ローマ字入力モード"))
 		 (lambda (sc)
 		   (let ((dsc (skk-find-descendant-context sc)))
 		     (= (skk-context-input-rule dsc)
@@ -280,9 +280,9 @@
 (register-action 'action_skk_azik
 		 (lambda (sc)
 		   '(ja_azik
-		     ""
+		     "Ｚ"
 		     "AZIK"
-		     "AZIKĥ޻ϥ⡼"))
+		     "AZIK拡張ローマ字入力モード"))
 		 (lambda (sc)
 		   (let ((dsc (skk-find-descendant-context sc)))
 		     (= (skk-context-input-rule dsc)
@@ -295,9 +295,9 @@
 (register-action 'action_skk_act
 		 (lambda (sc)
 		   '(ja_act
-		     ""
+		     "Ｃ"
 		     "ACT"
-		     "ACTĥ޻ϥ⡼"))
+		     "ACT拡張ローマ字入力モード"))
 		 (lambda (sc)
 		   (let ((dsc (skk-find-descendant-context sc)))
 		     (= (skk-context-input-rule dsc)
@@ -311,9 +311,9 @@
 (register-action 'action_skk_kzik
 		 (lambda (sc)
 		   '(ja_kzik
-		     ""
+		     "Ｋ"
 		     "KZIK"
-		     "KZIKĥ޻ϥ⡼"))
+		     "KZIK拡張ローマ字入力モード"))
 		 (lambda (sc)
 		   (let ((dsc (skk-find-descendant-context sc)))
 		     (= (skk-context-input-rule dsc)
@@ -376,19 +376,19 @@
                   (set! skk-set-henkan-point-key '())
 		  skk-ja-rk-rule)
 		 ((= input-rule skk-input-rule-azik)
-		  (require "japanese-azik.scm")
+		  (require "japanese-azik-utf8.scm")
                   (set! skk-okuri-char-alist ja-azik-skk-okuri-char-alist)
                   (set! skk-downcase-alist ja-azik-skk-downcase-alist) 
                   (set! skk-set-henkan-point-key ja-azik-skk-set-henkan-point-key)
 		  ja-azik-rule)
 		 ((= input-rule skk-input-rule-act)
-		  (require "japanese-act.scm")
+		  (require "japanese-act-utf8.scm")
                   (set! skk-okuri-char-alist ja-act-skk-okuri-char-alist)
                   (set! skk-downcase-alist ja-act-skk-downcase-alist)
                   (set! skk-set-henkan-point-key ja-act-skk-set-henkan-point-key)
 		  ja-act-rule)
 		 ((= input-rule skk-input-rule-kzik)
-		  (require "japanese-kzik.scm")
+		  (require "japanese-kzik-utf8.scm")
                   (set! skk-okuri-char-alist '())
                   (set! skk-downcase-alist '())
                   (set! skk-set-henkan-point-key '())
@@ -790,7 +790,7 @@
 	    (eq? stat 'skk-state-kanji)
 	    (eq? stat 'skk-state-completion)
 	    (eq? stat 'skk-state-okuri)))
-	  (im-pushback-preedit sc skk-preedit-attr-mode-mark ""))
+	  (im-pushback-preedit sc skk-preedit-attr-mode-mark "▽"))
       (if (and
 	   (null? csc)
 	   (eq? stat 'skk-state-kcode))
@@ -798,7 +798,7 @@
       (if (or
 	   (not (null? csc))
 	   (eq? stat 'skk-state-converting))
-	  (im-pushback-preedit sc skk-preedit-attr-mode-mark ""))
+	  (im-pushback-preedit sc skk-preedit-attr-mode-mark "▼"))
       ;; head without child context
       (if (and
 	   (null? csc)
@@ -1798,7 +1798,7 @@
 	   #t)
        (if (null? (skk-context-child-context sc))
 	   (begin
-	     ;; Windowɽ򳫻Ϥ뤫
+	     ;; 候補Windowの表示を開始するか
 	     (skk-check-candidate-window-begin sc)
 	     ;;
 	     (if (skk-context-candidate-window sc)
@@ -2327,7 +2327,7 @@
 (register-im
  'skk
  "ja"
- "EUC-JP"
+ "UTF-8"
  skk-im-name-label
  skk-im-short-desc
  #f
diff --git a/uim/skk.c b/uim/skk.c
index 656332a40..1440c9ea3 100644
--- a/uim/skk.c
+++ b/uim/skk.c
@@ -1272,17 +1272,17 @@ skk_store_replaced_numeric_str(uim_lisp head_)
 }
 
 static char *wide_num_list[] =
-  {"", "", "", "", "", "", "", "", "", ""};
+  {"０", "１", "２", "３", "４", "５", "６", "７", "８", "９"};
 static char *kanji_num_list[] =
-  {"", "", "", "", "", "", "ϻ", "", "Ȭ", ""};
+  {"〇", "一", "二", "三", "四", "五", "六", "七", "八", "九"};
 static char *kanji_num_position_list[] =
-  {NULL, "", "ɴ", "", "", NULL, NULL, NULL, "", NULL,
-   NULL, NULL, "", NULL, NULL, NULL, "", NULL, NULL, NULL};
+  {NULL, "十", "百", "千", "万", NULL, NULL, NULL, "億", NULL,
+   NULL, NULL, "兆", NULL, NULL, NULL, "京", NULL, NULL, NULL};
 static char *kanji_check_num_list[] =
-  {"", "", "б", "", "", "", "ϻ", "", "Ȭ", ""};
+  {"〇", "壱", "弍", "参", "四", "伍", "六", "七", "八", "九"};
 static char *kanji_check_num_position_list[] =
-  {NULL, "", "ɴ", "", "", NULL, NULL, NULL, "", NULL,
-   NULL, NULL, "", NULL, NULL, NULL, "", NULL, NULL, NULL};
+  {NULL, "拾", "百", "阡", "萬", NULL, NULL, NULL, "億", NULL,
+   NULL, NULL, "兆", NULL, NULL, NULL, "京", NULL, NULL, NULL};
 
 static char *
 numeric_wide_or_kanji_conv(const char *numstr, int method)
@@ -1291,15 +1291,15 @@ numeric_wide_or_kanji_conv(const char *numstr, int method)
   int i, len;
 
   len = strlen(numstr);
-  mbstr = uim_malloc(len * 2 + 1);
+  mbstr = uim_malloc(len * 3 + 1);
 
   for (i = 0; i < len; i++) {
     if (method == 1)
-      strcpy(&mbstr[i * 2], wide_num_list[numstr[i] - '0']);
+      strcpy(&mbstr[i * 3], wide_num_list[numstr[i] - '0']);
     else
-      strcpy(&mbstr[i * 2], kanji_num_list[numstr[i] - '0']);
+      strcpy(&mbstr[i * 3], kanji_num_list[numstr[i] - '0']);
   }
-  mbstr[len * 2] = '\0';
+  mbstr[len * 3] = '\0';
 
   return mbstr;
 }
@@ -1316,19 +1316,19 @@ numeric_kanji_with_position_conv(const char *numstr)
   if (len > 20) /* too big number */
     return uim_strdup(numstr);
 
-  mbstr = uim_malloc(len * 2 + 1);
-  mblen = len * 2;
+  mbstr = uim_malloc(len * 3 + 1);
+  mblen = len * 3;
 
   for (i = 0, j = 0; j < len; i++, j++) {
     position = len - j - 1;
     if (numstr[j] == '0') {
       i--;
-      mblen -= 2;
+      mblen -= 3;
       /* check zero at the head */
       if (j == 0) {
 	head_is_zero = 1;
       } else {
-	/* add , , ,  for zero */
+	/* add 万, 億, 兆, 京 for zero */
 	if ((position >= 4) && ((position % 4) == 0) && !head_is_zero) {
 	  int use_position = 0;
 	  if (j >= 3) {
@@ -1344,10 +1344,10 @@ numeric_kanji_with_position_conv(const char *numstr)
 	  }
 	  if (use_position) {
 	    i++;
-	    mblen += 2;
-	    if (mblen > len * 2)
-	      mbstr = uim_realloc(mbstr, mblen + 2);
-	    strcpy(&mbstr[i * 2], kanji_num_position_list[position]);
+	    mblen += 3;
+	    if (mblen > len * 3)
+	      mbstr = uim_realloc(mbstr, mblen + 3);
+	    strcpy(&mbstr[i * 3], kanji_num_position_list[position]);
 	  }
 	}
       }
@@ -1358,8 +1358,8 @@ numeric_kanji_with_position_conv(const char *numstr)
       /* replace numstr[j] with kanji number */
       if (numstr[j] == '1') {
 	/*
-	 * use "" only for the one at the place of , , , ,
-	 *  or 
+	 * use "一" only for the one at the place of 一, 万, 億, 兆,
+	 * 京 or 一千万
 	 */
 	if (((position % 4) == 0) ||
 	    ((position >= 7) &&
@@ -1367,33 +1367,33 @@ numeric_kanji_with_position_conv(const char *numstr)
 	     (numstr[j + 1] == '0') &&
 	     (numstr[j + 2] == '0') &&
 	     (numstr[j + 3] == '0'))) {
-	  strcpy(&mbstr[i * 2], kanji_num_list[1]);
+	  strcpy(&mbstr[i * 3], kanji_num_list[1]);
 	} else {
 	  i--;
-	  mblen -= 2;
+	  mblen -= 3;
 	}
       } else {
-	strcpy(&mbstr[i * 2], kanji_num_list[numstr[j] - '0']);
+	strcpy(&mbstr[i * 3], kanji_num_list[numstr[j] - '0']);
       }
 
-      /* add , ɴ,  for number whose place is exceeded  */
+      /* add 十, 百, 千 for number whose place is exceeded 万 */
       if (position > 4) {
 	if ((position % 4) != 0) {
 	  i++;
-	  mblen += 2;
-	  if (mblen > len * 2)
-	    mbstr = uim_realloc(mbstr, mblen + 2);
-	  strcpy(&mbstr[i * 2], kanji_num_position_list[position % 4]);
+	  mblen += 3;
+	  if (mblen > len * 3)
+	    mbstr = uim_realloc(mbstr, mblen + 3);
+	  strcpy(&mbstr[i * 3], kanji_num_position_list[position % 4]);
 	}
       }
 
       /* add position */
       if (kanji_num_position_list[position]) {
 	i++;
-	mblen += 2;
-	if (mblen > len * 2)
-	  mbstr = uim_realloc(mbstr, mblen + 2);
-	strcpy(&mbstr[i * 2], kanji_num_position_list[position]);
+	mblen += 3;
+	if (mblen > len * 3)
+	  mbstr = uim_realloc(mbstr, mblen + 3);
+	strcpy(&mbstr[i * 3], kanji_num_position_list[position]);
       }
     }
   }
@@ -1401,7 +1401,7 @@ numeric_kanji_with_position_conv(const char *numstr)
   /* in case of zero */
   if (head_is_zero) {
     strcpy(&mbstr[0], kanji_num_list[0]);
-    mblen = 2;
+    mblen = 3;
   }
 
   mbstr[mblen] = '\0';
@@ -1420,19 +1420,19 @@ numeric_kanji_for_check_conv(const char *numstr)
   if (len > 20) /* too big number */
     return uim_strdup(numstr);
 
-  mbstr = uim_malloc(len * 2 + 1);
-  mblen = len * 2;
+  mbstr = uim_malloc(len * 3 + 1);
+  mblen = len * 3;
 
   for (i = 0, j = 0; j < len; i++, j++) {
     position = len - j - 1;
     if (numstr[j] == '0') {
       i--;
-      mblen -= 2;
+      mblen -= 3;
       /* check zero at the head */
       if (j == 0) {
 	head_is_zero = 1;
       } else {
-	/* add , , ,  for zero */
+	/* add 萬, 億, 兆, 京 for zero */
 	if ((position >= 4) && ((position % 4) == 0) && !head_is_zero) {
 	  int use_position = 0;
 	  if (j >= 3) {
@@ -1448,10 +1448,10 @@ numeric_kanji_for_check_conv(const char *numstr)
 	  }
 	  if (use_position) {
 	    i++;
-	    mblen += 2;
-	    if (mblen > len * 2)
-	      mbstr = uim_realloc(mbstr, mblen + 2);
-	    strcpy(&mbstr[i * 2], kanji_check_num_position_list[position]);
+	    mblen += 3;
+	    if (mblen > len * 3)
+	      mbstr = uim_realloc(mbstr, mblen + 3);
+	    strcpy(&mbstr[i * 3], kanji_check_num_position_list[position]);
 	  }
 	}
       }
@@ -1460,26 +1460,26 @@ numeric_kanji_for_check_conv(const char *numstr)
 	head_is_zero = 0;
 
       /* replace numstr[j] with kanji number */
-      strcpy(&mbstr[i * 2], kanji_check_num_list[numstr[j] - '0']);
+      strcpy(&mbstr[i * 3], kanji_check_num_list[numstr[j] - '0']);
 
-      /* add , ɴ,  for number whose place is exceeded  */
+      /* add 拾, 百, 阡 for number whose place is exceeded 萬 */
       if (position > 4) {
 	if ((position % 4) != 0) {
 	  i++;
-	  mblen += 2;
-	  if (mblen > len * 2)
-	    mbstr = uim_realloc(mbstr, mblen + 2);
-	  strcpy(&mbstr[i * 2], kanji_check_num_position_list[position % 4]);
+	  mblen += 3;
+	  if (mblen > len * 3)
+	    mbstr = uim_realloc(mbstr, mblen + 3);
+	  strcpy(&mbstr[i * 3], kanji_check_num_position_list[position % 4]);
 	}
       }
 
       /* add position */
       if (kanji_check_num_position_list[position]) {
 	i++;
-	mblen += 2;
-	if (mblen > len * 2)
-	  mbstr = uim_realloc(mbstr, mblen + 2);
-	strcpy(&mbstr[i * 2], kanji_check_num_position_list[position]);
+	mblen += 3;
+	if (mblen > len * 3)
+	  mbstr = uim_realloc(mbstr, mblen + 3);
+	strcpy(&mbstr[i * 3], kanji_check_num_position_list[position]);
       }
     }
   }
@@ -1487,7 +1487,7 @@ numeric_kanji_for_check_conv(const char *numstr)
   /* in case of zero */
   if (head_is_zero) {
     strcpy(&mbstr[0], kanji_check_num_list[0]);
-    mblen = 2;
+    mblen = 3;
   }
 
   mbstr[mblen] = '\0';
@@ -1504,10 +1504,10 @@ numeric_shogi_conv(const char *numstr)
   if (len != 2) /* allow two digit number only */
     return uim_strdup(numstr);
 
-  mbstr = uim_malloc(5);
+  mbstr = uim_malloc(7);
   strcpy(&mbstr[0], wide_num_list[numstr[0] - '0']);
-  strcpy(&mbstr[2], kanji_num_list[numstr[1] - '0']);
-  mbstr[4] = '\0';
+  strcpy(&mbstr[3], kanji_num_list[numstr[1] - '0']);
+  mbstr[6] = '\0';
 
   return mbstr;
 }
@@ -1525,17 +1525,17 @@ numeric_convert(const char *numstr, int method)
   case 0:
     ret = uim_strdup(numstr);
     break;
-  case 1: /* ѿ */
-  case 2: /*  ̵̼ */
+  case 1: /* 全角数字 */
+  case 2: /* 漢数字 位取り無し */
     ret = numeric_wide_or_kanji_conv(numstr, method);
     break;
-  case 3: /*  ̼ͭ */
+  case 3: /* 漢数字 位取り有り */
     ret = numeric_kanji_with_position_conv(numstr);
     break;
-  case 5: /* ڼɽ */
+  case 5: /* 小切手表記 */
     ret = numeric_kanji_for_check_conv(numstr);
     break;
-  case 9: /* ɽ */
+  case 9: /* 将棋表記 */
     ret = numeric_shogi_conv(numstr);
     break;
   default:
diff --git a/uim/skk.c.eucjp b/uim/skk.c.eucjp
new file mode 100644
index 000000000..656332a40
--- /dev/null
+++ b/uim/skk.c.eucjp
@@ -0,0 +1,3880 @@
+/* 
+  Copyright (c) 2003-2013 uim Project https://github.com/uim/uim
+
+  All rights reserved.
+
+  Redistribution and use in source and binary forms, with or without
+  modification, are permitted provided that the following conditions
+  are met:
+
+  1. Redistributions of source code must retain the above copyright
+     notice, this list of conditions and the following disclaimer.
+  2. Redistributions in binary form must reproduce the above copyright
+     notice, this list of conditions and the following disclaimer in the
+     documentation and/or other materials provided with the distribution.
+  3. Neither the name of authors nor the names of its contributors
+     may be used to endorse or promote products derived from this software
+     without specific prior written permission.
+
+  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND
+  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+  ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE
+  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+  DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+  OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+  HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+  SUCH DAMAGE.
+
+*/
+
+/*
+ * SKK is a simple Japanese input method
+ *
+ * Many many things are to be implemented!
+ */
+#include <config.h>
+
+#include <sys/types.h>
+#include <sys/mman.h>
+#include <sys/stat.h>
+#include <fcntl.h>
+#include <unistd.h>
+#include <string.h>
+#include <stdlib.h>
+#include <stdio.h>
+#include <ctype.h>
+#include <signal.h>
+#include <errno.h>
+#include <sys/socket.h>
+#include <netdb.h>
+#include <sys/param.h>
+#ifdef HAVE_STRINGS_H
+#include <strings.h>
+#endif
+#ifdef HAVE_POLL_H
+#include <poll.h>
+#elif defined(HAVE_SYS_POLL_H)
+#include <sys/poll.h>
+#else
+#include "bsd-poll.h"
+#endif
+
+#include "uim.h"
+#include "uim-scm.h"
+#include "uim-scm-abbrev.h"
+#include "uim-helper.h"
+#include "dynlib.h"
+#include "uim-notify.h"
+#include "gettext.h"
+
+#include "bsdlook.h"
+
+#define skk_isalpha(ch)	(skk_islower(ch) || skk_isupper(ch))
+#define skk_islower(ch)	((((unsigned char)ch) >= 'a') && (((unsigned char)ch) <= 'z'))
+#define skk_isupper(ch)	((((unsigned char)ch) >= 'A') && (((unsigned char)ch) <= 'Z'))
+#define skk_isascii(ch)	((((unsigned char)ch) & ~0x7f) == 0)
+
+#define IGNORING_WORD_MAX	63
+#define USE_SKK_JISYO_S_BUF	1	/* use SKK-JISYO.S as a cache for
+					   word completion */
+#define SKK_JISYO_S	DATADIR "/skk/SKK-JISYO.S"
+
+/*
+ * cand : candidate
+ */
+
+
+/* candidate array for each okurigana
+ *
+ * |C0|C1| .. |Cnr_real_cands| ..	       |Cnr_cands|
+ * <-------should be saved --><-- cache of master dict -->
+ */
+struct skk_cand_array {
+  /* okurigana string */
+  char *okuri;
+
+  int nr_cands; /* length of cands array allocated */
+  int nr_real_cands; /* length of read from file part */
+  /* candidate string */
+  char **cands;
+
+  /* this array was used and merged with okuri-nasi entry array */
+  int is_used;
+  /* link to its parent line */
+  struct skk_line *line;
+};
+
+/* skk_line state */
+#define SKK_LINE_NEED_SAVE	(1<<0)
+#define SKK_LINE_USE_FOR_COMPLETION	(1<<1)
+
+/* skk dictionary line */
+struct skk_line {
+  /* line index. head part */
+  char *head;
+  /* line index. okurigana part. value will be 0 if it is okuri-nasi
+     entry */
+  char okuri_head;
+  /* array of candidate array for different okuri-gana */
+  int nr_cand_array;
+  struct skk_cand_array *cands;
+  /* state of line */
+  int state;
+  /* link to next entry in the list */
+  struct skk_line *next;
+};
+
+/* skk dictionary file */
+typedef struct dic_info_ {
+  /* address of mmap'ed dictionary file */
+  void *addr;
+  /* byte offset of first valid entry in mmap'ed region */
+  int first;
+  /* byte offset of first okuri-nasi entry */
+  int border;
+  /* size of dictionary file */
+  int size;
+  /* head of cached skk dictionary line list. LRU ordered */
+  struct skk_line head;
+  /* timestamp of personal dictionary */
+  time_t personal_dic_timestamp;
+  /* whether cached lines are modified or not */
+  int cache_modified;
+  /* length of cached lines */
+  int cache_len;
+  /* skkserv related state */
+  int skkserv_state;
+  /* skkserv hostname */
+  char *skkserv_hostname;
+  /* skkserv port number */
+  int skkserv_portnum;
+  /* skkserv address family. AF_UNSPEC or AF_INET or AF_INET6 */
+  int skkserv_family;
+  /* timeout (milisec) for skkserv completion */
+  int skkserv_completion_timeout;
+} dic_info;
+
+/* completion */
+struct skk_comp_array {
+  /* index of completion */
+  char *head;
+  /* array of completion string */
+  int nr_comps;
+  char **comps;
+  /**/
+  int refcount;
+  /**/
+  struct skk_comp_array *next;
+} *skk_comp;
+
+/* XXX should create skk.h */
+static uim_lisp skk_replace_numeric(uim_lisp head_);
+
+static uim_lisp restore_numeric(const char *s, uim_lisp numlst_);
+static char *replace_numeric(const char *str);
+static char *sanitize_word(const char *str, const char *prefix);
+static int is_purged_cand(const char *str);
+static void merge_purged_cands(dic_info *skk_dic,
+		struct skk_cand_array *src_ca,
+		struct skk_cand_array *dst_ca, int src_nth, int dst_nth);
+static void merge_purged_cand_to_dst_array(dic_info *skk_dic,
+		struct skk_cand_array *src_ca,
+		struct skk_cand_array *dst_ca, char *purged_cand);
+static void update_personal_dictionary_cache_with_file(dic_info *skk_dic,
+		const char *fn, int is_personal);
+static void look_get_comp(struct skk_comp_array *ca, const char *str);
+static uim_lisp look_get_top_word(const char *str);
+static char *quote_word(const char *word, const char *prefix);
+
+/* skkserv connection */
+#define SKK_SERV_BUFSIZ	1024
+#define SKK_SERV_USE	(1<<0)
+#define SKK_SERV_CONNECTED	(1<<1)
+#define SKK_SERV_TRY_COMPLETION	(1<<2)
+
+static int skkservsock = -1;
+static FILE *rserv, *wserv;
+/* prototype */
+static int open_skkserv(const char *hostname, int portnum, int family);
+static void close_skkserv(void);
+static void skkserv_disconnected(dic_info *di);
+
+static int use_look = 0;
+static uim_look_ctx *skk_look_ctx = NULL;
+
+static uim_bool is_setugid;
+
+static int
+calc_line_len(const char *s)
+{
+  int i;
+  for (i = 0; s[i] != '\n'; i++);
+  return i;
+}
+
+static int
+is_okuri(const char *line_str)
+{
+  const char *b;
+  /* find first white space */
+  b = strchr(line_str, ' ');
+  if (!b || b == line_str)
+    return 0;
+  /* check previous character */
+  b--;
+  if (skk_isalpha(*b) && (!skk_isascii(line_str[0]) || line_str[0] == '>'))
+    return 1;
+  return 0;
+}
+
+static int
+find_first_line(dic_info *di)
+{
+  char *s = di->addr;
+  int off = 0;
+
+  while (off < di->size && s[off] == ';') {
+    int l = calc_line_len(&s[off]);
+    off += l + 1;
+  }
+  return off;
+}
+
+static int
+find_border(dic_info *di)
+{
+  char *s = di->addr;
+  int off = 0;
+  while (off < di->size) {
+    int l = calc_line_len(&s[off]);
+    if (s[off] == ';') {
+      off += l + 1;
+      continue;
+    }
+    if (!is_okuri(&s[off]))
+      return off;
+    off += l + 1;
+  }
+  /* every entry is okuri-ari, it may not happen. */
+  return di->size - 1;
+}
+
+static dic_info *
+open_dic(const char *fn, uim_bool use_skkserv, const char *skkserv_hostname,
+	 int skkserv_portnum, int skkserv_family)
+{
+  dic_info *di;
+  struct stat st;
+  int fd;
+  void *addr = NULL;
+  int mmap_done = 0;
+
+  di = (dic_info *)uim_malloc(sizeof(dic_info));
+
+  di->skkserv_hostname = NULL;
+  if (use_skkserv) {
+    di->skkserv_hostname = uim_strdup(skkserv_hostname);
+    di->skkserv_portnum = skkserv_portnum;
+    di->skkserv_family = skkserv_family;
+    di->skkserv_state = SKK_SERV_USE | open_skkserv(skkserv_hostname,
+						    skkserv_portnum,
+						    skkserv_family);
+    di->skkserv_completion_timeout = uim_scm_symbol_value_int("skk-skkserv-completion-timeout");
+  } else {
+    di->skkserv_state = 0;
+    fd = open(fn, O_RDONLY);
+    if (fd != -1) {
+      if (fstat(fd, &st) != -1) {
+	addr = mmap(0, st.st_size, PROT_READ, MAP_SHARED, fd, 0);
+	if (addr != MAP_FAILED) {
+	  mmap_done = 1;
+	}
+      }
+      close(fd);
+    }
+  }
+
+  di->addr = mmap_done ? addr : NULL;
+  di->size = mmap_done ? st.st_size : 0;
+  di->first = mmap_done ? find_first_line(di) : 0;
+  di->border = mmap_done ? find_border(di) : 0;
+
+  di->head.next = NULL;
+  di->personal_dic_timestamp = 0;
+  di->cache_modified = 0;
+  di->cache_len = 0;
+
+  return di;
+}
+
+static const char *
+find_line(dic_info *di, int off)
+{
+  char *ptr = di->addr;
+  while (off > 0 && (ptr[off] != '\n' || ptr[off + 1] == ';'))
+    off--;
+
+  if (off)
+    off++;
+
+  return &ptr[off];
+}
+
+static char *
+extract_line_index(dic_info *di, int off, char *buf, int len)
+{
+  const char *p = find_line(di, off);
+  int i;
+  if (p[0] == ';')
+    return NULL;
+
+  for (i = 0; i < len && p[i] != ' '; i++)
+    buf[i] = p[i];
+  buf[i] = '\0';
+
+  return buf;
+}
+
+static int
+do_search_line(dic_info *di, const char *s, int min,
+	       int max, int d)
+{
+  char buf[256];
+  char *r;
+  int idx = ((unsigned int)min + (unsigned int)max) >> 1;
+  int c = 0;
+
+  if (abs(max - min) < 4)
+    return -1;
+
+  r = extract_line_index(di, idx, buf, 256);
+  if (r)
+    c = strcmp(s, r);
+  else
+    return -1;
+
+  if (!c)
+    return idx;
+
+  if (c * d > 0)
+    return do_search_line(di, s, idx, max, d);
+  else
+    return do_search_line(di, s, min, idx, d);
+
+  return -1;
+}
+
+/* This function name is temporary. I want a better name. */
+static char *
+first_space(char *str)
+{
+  while (*str && (*str != ' '))
+    str++;
+
+  return str;
+}
+
+/* This function returns a pointer with '/' or '\0' */
+static char *
+next_cand_slash(char *str)
+{
+  int i = 0;
+  int open_bracket = 0;
+
+  while (*str && (*str != '/' || open_bracket == 1)) {
+    if (*str == '[' && i == 0)
+      open_bracket = 1;
+
+    if (open_bracket == 1 && *str == ']' && *(str + 1) == '/')
+      open_bracket = 0;
+    str++;
+    i++;
+  }
+  return str;
+}
+
+static char *
+next_slash_in_bracket(char *str)
+{
+  while (*str && *str != '/')
+    str++;
+
+  return str;
+}
+
+static char *
+okuri_in_bracket(char *str)
+{
+  char *p, *term;
+
+  if (!str)
+    return NULL;
+
+  p = uim_strdup(str);
+  term = next_slash_in_bracket(p);
+
+  if (*term == '\0') {
+    /* this is not the bracket used for skk-henkan-strict-okuri-precedence */
+    free(p);
+    return NULL;
+  }
+  
+  *term = '\0';
+  return p;
+}
+
+static char *
+nth_candidate(char *str, int nth)
+{
+  char *p, *term;
+  int i;
+
+  str = first_space(str);
+  for (i = 0; i <= nth; i++) {
+    str = next_cand_slash(str);
+    if (*str == '/')
+      str++;
+  }
+
+  if (*str == '\0')
+    return NULL;
+
+  p = uim_strdup(str);
+  term = next_cand_slash(p);
+  *term = '\0';
+  return p;
+}
+
+static void
+free_skk_line(struct skk_line *sl)
+{
+  int i, j;
+
+  if (!sl)
+    return ;
+
+  for (i = 0; i < sl->nr_cand_array; i++) {
+    struct skk_cand_array *ca = &sl->cands[i];
+    for (j = 0; j < ca->nr_cands; j++)
+      free(ca->cands[j]);
+    free(ca->okuri);
+    free(ca->cands);
+  }
+  free(sl->head);
+  free(sl->cands);
+  free(sl);
+}
+
+static void
+free_skk_dic(dic_info *skk_dic)
+{
+  if (skk_dic) {
+    struct skk_line *sl, *tmp;
+
+    if (skk_dic->addr)
+      munmap(skk_dic->addr, skk_dic->size);
+
+    sl = skk_dic->head.next;
+    while (sl) {
+      tmp = sl;
+      sl = sl->next;
+      free_skk_line(tmp);
+    }
+
+    if (skk_dic->skkserv_state & SKK_SERV_CONNECTED)
+      close_skkserv();
+    free(skk_dic->skkserv_hostname);
+
+    free(skk_dic);
+  }
+}
+
+/* init */
+static uim_lisp
+skk_dic_open(uim_lisp fn_, uim_lisp use_skkserv_, uim_lisp skkserv_hostname_,
+	     uim_lisp skkserv_portnum_, uim_lisp skkserv_family_)
+{
+  const char *fn, *skkserv_hostname, *skkserv_family_str;
+  uim_bool use_skkserv;
+  int skkserv_portnum, skkserv_family;
+  dic_info *skk_dic;
+
+  fn = REFER_C_STR(fn_);
+  use_skkserv = C_BOOL(use_skkserv_);
+  skkserv_hostname = REFER_C_STR(skkserv_hostname_);
+  skkserv_portnum = C_INT(skkserv_portnum_);
+  skkserv_family_str = REFER_C_STR(skkserv_family_);
+
+  is_setugid = uim_helper_is_setugid();
+  signal(SIGPIPE, SIG_IGN);
+
+  skkserv_family = AF_UNSPEC;
+  if (skkserv_family_str) {
+    if (!strcmp(skkserv_family_str, "inet"))
+      skkserv_family = AF_INET;
+    else if (!strcmp(skkserv_family_str, "inet6"))
+      skkserv_family = AF_INET6;
+  }
+
+  skk_dic = open_dic(fn, use_skkserv, skkserv_hostname, skkserv_portnum,
+		     skkserv_family);
+
+  return MAKE_PTR(skk_dic);
+}
+
+static uim_lisp
+skk_free_dic(uim_lisp skk_dic_)
+{
+  dic_info *skk_dic = NULL;
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  free_skk_dic(skk_dic);
+
+  return uim_scm_f();
+}
+
+static struct skk_cand_array *
+find_candidate_array_from_line(struct skk_line *sl, const char *okuri,
+			       int create_if_notfound)
+{
+  int i;
+  struct skk_cand_array *ca;
+
+  if (!okuri || !strlen(okuri))
+    return &sl->cands[0];
+
+  for (i = 1; i < sl->nr_cand_array; i++) {
+    if (okuri && !strcmp(okuri, sl->cands[i].okuri))
+      return &sl->cands[i];
+  }
+
+  if (!create_if_notfound)
+    return &sl->cands[0];
+
+  /* allocate now */
+  sl->nr_cand_array++;
+  sl->cands = uim_realloc(sl->cands,
+		      sizeof(struct skk_cand_array) * sl->nr_cand_array);
+  ca = &sl->cands[sl->nr_cand_array - 1];
+  ca->is_used = 0;
+  ca->cands = NULL;
+  ca->nr_cands = 0;
+  ca->nr_real_cands = 0;
+  ca->okuri = uim_strdup(okuri);
+  ca->line = sl;
+  return ca;
+}
+
+static void
+push_back_candidate_to_array(struct skk_cand_array *ca, const char *cand)
+{
+  ca->nr_cands++;
+  if (ca->cands)
+    ca->cands = uim_realloc(ca->cands, sizeof(char *) * ca->nr_cands);
+  else
+    ca->cands = uim_malloc(sizeof(char *));
+  ca->cands[ca->nr_cands - 1] = uim_strdup(cand);
+}
+
+static void
+merge_base_candidates_to_array(dic_info *skk_dic,
+		               struct skk_line *sl,
+			       struct skk_cand_array *dst_ca)
+{
+  int i, j;
+  struct skk_cand_array *src_ca;
+
+  if (!sl)
+    return ;
+
+  src_ca = &sl->cands[0];
+  if (src_ca == dst_ca)
+    return ;
+
+  for (i = 0; i < src_ca->nr_cands; i++) {
+    int dup = 0;
+    int src_purged_cand_index = -1;
+    int dst_purged_cand_index = -1;
+
+    if (i < src_ca->nr_real_cands && is_purged_cand(src_ca->cands[i]))
+      src_purged_cand_index = i;
+
+    for (j = 0; j < dst_ca->nr_cands; j++) {
+      if (dst_purged_cand_index == -1 && is_purged_cand(dst_ca->cands[j]))
+	dst_purged_cand_index = j;
+      if (!strcmp(src_ca->cands[i], dst_ca->cands[j])) {
+	dup = 1;
+      }
+    }
+    if (!dup) {
+      if (src_purged_cand_index != -1 && dst_purged_cand_index != -1)
+	merge_purged_cands(skk_dic, src_ca, dst_ca, src_purged_cand_index,
+			dst_purged_cand_index);
+      else if (src_purged_cand_index != -1 && dst_purged_cand_index == -1)
+	merge_purged_cand_to_dst_array(skk_dic, src_ca, dst_ca,
+			src_ca->cands[src_purged_cand_index]);
+#if 0
+      /*
+       * Just adding words subsequent to real_cands
+       * (push_back_candidate_to_array) is enough.
+       */
+      else if (src_purged_cand_index == -1 && dst_purged_cand_index != -1)
+	merge_word_to_dst_cand_array_with_purged_words(dst_ca,
+			src_ca, src_ca->cands[i]);
+#endif
+      else
+	push_back_candidate_to_array(dst_ca, src_ca->cands[i]);
+    }
+  }
+}
+
+static void
+compose_line_parts(dic_info *di, struct skk_line *sl,
+		   char *okuri, char *line)
+{
+  int nth;
+  char *tmp;
+  struct skk_cand_array *ca = find_candidate_array_from_line(sl, okuri, 1);
+
+  nth = 0;
+  do {
+    tmp = nth_candidate(line, nth);
+    if (tmp) {
+      if (tmp[0] == '[') {
+	char *str = okuri_in_bracket(&tmp[1]);
+	if (!str) {
+	  /*
+	   * this is not the bracket used for
+	   * skk-henkan-strict-okuri-precedence
+	   */
+	  char *quoted = quote_word(tmp, "(concat \"");
+	  push_back_candidate_to_array(ca, quoted);
+	  free(quoted);
+	} else {
+	  tmp[0] = ' '; /* create first_space */
+	  compose_line_parts(di, sl, str, &tmp[0]);
+	  free(str);
+	}
+      } else if (tmp[0] != ']') {
+	push_back_candidate_to_array(ca, tmp);
+      }
+      nth++;
+      free(tmp);
+    } else {
+      break;
+    }
+  } while (1);
+}
+
+static struct skk_line *
+alloc_skk_line(const char *word, char okuri_head)
+{
+  struct skk_line *sl;
+  sl = uim_malloc(sizeof(struct skk_line));
+  sl->state = 0;
+  sl->head = uim_strdup(word);
+  sl->okuri_head = okuri_head;
+  sl->nr_cand_array = 1;
+  sl->cands = uim_malloc(sizeof(struct skk_cand_array));
+  sl->cands[0].okuri = NULL;
+  sl->cands[0].cands = NULL;
+  sl->cands[0].nr_cands = 0;
+  sl->cands[0].nr_real_cands = 0;
+  sl->cands[0].is_used = 0;
+  sl->cands[0].line = sl;
+  return sl;
+}
+
+static struct skk_line *
+copy_skk_line(struct skk_line *p)
+{
+  int i, j;
+  struct skk_line *sl;
+
+  if (!p)
+    return NULL;
+
+  sl = uim_malloc(sizeof(struct skk_line));
+  sl->state = p->state;
+  sl->head = uim_strdup(p->head);
+  sl->okuri_head = p->okuri_head;
+  sl->nr_cand_array = p->nr_cand_array;
+  sl->cands = uim_malloc(sizeof(struct skk_cand_array) * sl->nr_cand_array);
+  for (i = 0; i < sl->nr_cand_array; i++) {
+    struct skk_cand_array *ca = &sl->cands[i];
+    struct skk_cand_array *q = &p->cands[i];
+
+    ca->okuri = q->okuri ? uim_strdup(q->okuri) : NULL;
+    ca->nr_cands = q->nr_cands;
+    ca->nr_real_cands = q->nr_real_cands;
+    ca->cands = uim_malloc(sizeof(char *) * ca->nr_cands);
+    for (j = 0; j < ca->nr_cands; j++)
+      ca->cands[j] = uim_strdup(q->cands[j]);
+    ca->is_used = q->is_used;
+    ca->line = sl;
+  }
+  sl->next = NULL;
+  return sl;
+}
+
+/*
+ * Compose skk line
+ */
+static struct skk_line *
+compose_line(dic_info *di, const char *word, char okuri_head, char *entry)
+{
+  struct skk_line *sl;
+
+  sl = alloc_skk_line(word, okuri_head);
+  /* parse */
+  compose_line_parts(di, sl, NULL, entry);
+
+  return sl;
+}
+
+static void
+add_line_to_cache_head(dic_info *di, struct skk_line *sl)
+{
+  sl->next = di->head.next;
+  di->head.next = sl;
+
+  di->cache_len++;
+  di->cache_modified = 1;
+}
+
+static void
+move_line_to_cache_head(dic_info *di, struct skk_line *sl)
+{
+  struct skk_line *prev;
+
+  if (di->head.next == sl)
+    return;
+
+  prev = di->head.next;
+  while (prev->next != sl) {
+    prev = prev->next;
+  }
+  prev->next = sl->next;
+  sl->next = di->head.next;
+  di->head.next = sl;
+
+  di->cache_modified = 1;
+}
+
+#if 0
+static void
+add_line_to_cache_last(dic_info *di, struct skk_line *sl)
+{
+  struct skk_line *prev;
+
+  if (di->head.next == NULL)
+    di->head.next = sl;
+  else {
+    prev = di->head.next;
+    while (prev->next) {
+      prev = prev->next;
+    }
+    prev->next = sl;
+  }
+  sl->next = NULL;
+
+  di->cache_len++;
+  di->cache_modified = 1;
+}
+#endif
+
+static struct skk_line *
+search_line_from_server(dic_info *di, const char *s, char okuri_head)
+{
+  char r;
+  struct skk_line *sl;
+  int n = 0, ret, len;
+  char buf[SKK_SERV_BUFSIZ];
+  char *line, *idx;
+  ssize_t nr;
+
+  if (!(di->skkserv_state & SKK_SERV_CONNECTED)) {
+    if (!((di->skkserv_state |= open_skkserv(di->skkserv_hostname,
+					     di->skkserv_portnum,
+					     di->skkserv_family)) &
+	  SKK_SERV_CONNECTED))
+      return NULL;
+  }
+
+  uim_asprintf(&idx, "%s%c", s, okuri_head);
+
+  fprintf(wserv, "1%s \n", idx);
+  ret = fflush(wserv);
+  if (ret != 0 && errno == EPIPE) {
+    free(idx);
+    skkserv_disconnected(di);
+    return NULL;
+  }
+
+  uim_asprintf(&line, "%s ", idx);
+  free(idx);
+
+  if ((nr = read(skkservsock, &r, 1)) == -1 || nr == 0) {
+    skkserv_disconnected(di);
+    free(line);
+    return NULL;
+  }
+
+  if (r == '1') {  /* succeeded */
+    while (1) {
+      if ((nr = read(skkservsock, &r, 1)) == -1 || nr == 0) {
+	skkserv_disconnected(di);
+	free(line);
+	return NULL;
+      }
+
+      if (r == '\n') {
+	len = strlen(line) + n;
+	line = uim_realloc(line, len + 1);
+	strlcat(line, buf, len + 1);
+	break;
+      }
+
+      buf[n] = r;
+      buf[n + 1] = '\0';
+      if (n == SKK_SERV_BUFSIZ - 2) {
+	len = strlen(line) + n + 1;
+	line = uim_realloc(line, len + 1);
+	strlcat(line, buf, len + 1);
+	n = 0;
+      } else {
+	n++;
+      }
+    }
+    sl = compose_line(di, s, okuri_head, line);
+    free(line);
+    return sl;
+  } else {
+    while ((nr = read(skkservsock, &r, 1)) != -1 && nr != 0 && r != '\n')
+      ;
+    free(line);
+    return NULL;
+  }
+}
+
+static struct skk_line *
+search_line_from_file(dic_info *di, const char *s, char okuri_head)
+{
+  int n;
+  const char *p;
+  int len;
+  char *line, *idx;
+  struct skk_line *sl;
+
+  if (!di->addr)
+    return NULL;
+
+  uim_asprintf(&idx, "%s%c", s, okuri_head);
+
+  if (okuri_head)
+    n = do_search_line(di, idx, di->first, di->border - 1, -1);
+  else
+    n = do_search_line(di, idx, di->border, di->size - 1, 1);
+
+  free(idx);
+
+  if (n == -1)
+    return NULL;
+
+  p = find_line(di, n);
+  len = calc_line_len(p);
+  line = uim_malloc(len + 1);
+  /* strncat is used intentionally because *p is too long string */
+  line[0] = '\0';
+  strncat(line, p, len);
+  sl = compose_line(di, s, okuri_head, line);
+  free(line);
+  return sl;
+}
+
+static struct skk_line *
+search_line_from_cache(dic_info *di, const char *s, char okuri_head)
+{
+  struct skk_line *sl;
+
+  if (!di)
+    return NULL;
+
+  /* search from cache */
+  for (sl = di->head.next; sl; sl = sl->next) {
+    if (!strcmp(sl->head, s) && sl->okuri_head == okuri_head)
+      return sl;
+  }
+  return NULL;
+}
+
+
+static struct skk_cand_array *
+find_cand_array(dic_info *di, const char *s,
+		char okuri_head, const char *okuri,
+		int create_if_not_found)
+{
+  struct skk_line *sl, *sl_file;
+  struct skk_cand_array *ca;
+  int from_file = 0;
+
+  if (!di)
+    return NULL;
+
+  sl = search_line_from_cache(di, s, okuri_head);
+  if (!sl) {
+    if (di->skkserv_state & SKK_SERV_USE)
+      sl = search_line_from_server(di, s, okuri_head);
+    else
+      sl = search_line_from_file(di, s, okuri_head);
+    if (!sl) {
+      if (!create_if_not_found)
+	return NULL;
+      sl = alloc_skk_line(s, okuri_head);
+    }
+    from_file = 1;
+    add_line_to_cache_head(di, sl);
+  }
+
+  ca = find_candidate_array_from_line(sl, okuri, create_if_not_found);
+
+  if (!ca->is_used) {
+    merge_base_candidates_to_array(di, sl, ca);
+    ca->is_used = 1;
+    if (!from_file) {
+      if (di->skkserv_state & SKK_SERV_USE) {
+	sl_file = search_line_from_server(di, s, okuri_head);
+	if (!(di->skkserv_state & SKK_SERV_CONNECTED))
+	  ca->is_used = 0;
+      } else
+	sl_file = search_line_from_file(di, s, okuri_head);
+      merge_base_candidates_to_array(di, sl_file, ca);
+      free_skk_line(sl_file);
+    }
+  }
+
+  return ca;
+}
+
+static struct skk_cand_array *
+find_cand_array_lisp(dic_info *skk_dic, uim_lisp head_, uim_lisp okuri_head_,
+		     uim_lisp okuri_, int create_if_not_found,
+		     uim_lisp numeric_conv_)
+{
+  char o;
+  const char *hs;
+  const char *okuri = NULL;
+  struct skk_cand_array *ca;
+  char *rs = NULL;
+
+  hs = REFER_C_STR(head_);
+
+  if (TRUEP(numeric_conv_))
+    rs = replace_numeric(hs);
+
+  if (okuri_ != uim_scm_null())
+    okuri = REFER_C_STR(okuri_);
+
+  if (okuri_head_ == uim_scm_null()) {
+    o = '\0';
+  } else {
+    const char *os = REFER_C_STR(okuri_head_);
+    o = os[0];
+  }
+
+  if (!rs)
+    ca = find_cand_array(skk_dic, hs, o, okuri, create_if_not_found);
+  else {
+    ca = find_cand_array(skk_dic, rs, o, okuri, create_if_not_found);
+    free(rs);
+  }
+
+  return ca;
+}
+
+/*
+ * purged_cand: /(skk-ignore-dic-word "foo" "bar" ...)/
+ * purged_words: {"foo", "bar", ..., NULL}
+ */
+static int
+is_purged_cand(const char *str)
+{
+  char *p;
+
+  p = strstr(str, "(skk-ignore-dic-word ");
+  if (p == str)
+    return 1;
+
+  return 0;
+}
+
+static char *
+expand_str(const char *p)
+{
+  char buf[BUFSIZ];
+  int i = 0;
+  int c, n, ndigits;
+
+  while (*p != '\0') {
+    c = *p;
+    if (c == '\\') {
+      p++;
+      c = *p;
+      if (c == '\0')
+	break;
+      switch (c) {
+      case '\\':
+	c = '\\';
+	break;
+      case 'n':
+	c = '\n';
+	break;
+      case 'r':
+	c = '\r';
+	break;
+      case '0':
+      case '1':
+      case '2':
+      case '3':
+      case '4':
+      case '5':
+      case '6':
+      case '7':
+    	n = c - '0';
+    	ndigits = 1;
+    	while (ndigits < 3) {
+    	  p++;
+    	  c = *p;
+    	  if (*p == '\0') {
+	    uim_notify_fatal(N_("uim-skk: error in expand_str"));
+	    return NULL;
+	  }
+	  if (c >= '0' && c <= '7') {
+	    n = n * 8 + c - '0';
+	    ndigits++;
+	  } else {
+	    p--;
+	    break;
+	  }
+	}
+	c = n;
+      }
+    }
+    if ((i + 1) >= BUFSIZ) {
+      uim_notify_fatal(N_("uim-skk: too long word"));
+      return NULL;
+    }
+    buf[i] = c;
+    i++;
+    p++;
+  }
+  buf[i] = '\0';
+  return uim_strdup(buf);
+}
+
+static char **
+get_purged_words(const char *str)
+{
+  char *p;
+  char **words = NULL;
+  char *word = NULL;
+  int nr = 0;
+  int open = 0;
+  int len = 0;
+
+  p = strstr(str, "(skk-ignore-dic-word");
+  if (!p)
+    return NULL;
+
+  p = first_space(p);
+  if (*p == '\0')
+    return NULL;
+  p++;
+
+  while (*p != '\0') {
+    if (*p == '"' && p[-1] != '\\') {
+      open = open ? 0 : 1;
+      if (open) {
+	p++;
+	word = p;
+	len = 0;
+      } else {
+	char *orig = uim_malloc(len + 1);
+	char *expanded_word;
+
+	nr++;
+	if (words)
+	  words = uim_realloc(words, sizeof(char *) * nr);
+	else
+	  words = uim_malloc(sizeof(char *));
+	strlcpy(orig, word, len + 1);
+
+	expanded_word = expand_str(orig);
+	if (expanded_word)
+	  words[nr - 1] = expanded_word;
+	else
+	  words[nr - 1] = uim_strdup(orig);
+	free(orig);
+      }
+    }
+    p++;
+    len++;
+  }
+  if (words) {
+    words = uim_realloc(words, sizeof(char *) * (nr + 1));
+    words[nr] = NULL;
+  }
+  return words;
+}
+
+static int
+nr_purged_words(char **p)
+{
+  int i = 0;
+
+  while (p && p[i])
+    i++;
+  return i;
+}
+
+static void
+free_allocated_purged_words(char **p)
+{
+  int i = 0;
+
+  if (!p)
+    return;
+
+  while (p[i]) {
+    free(p[i]);
+    i++;
+  }
+  free(p);
+}
+
+static int
+is_purged_only(struct skk_cand_array *ca)
+{
+  int i, j;
+  char **purged_words;
+
+  if (ca->nr_real_cands > 1)
+    return 0;
+
+  if ((purged_words = get_purged_words(ca->cands[0])) != NULL) {
+    int nr_purged = nr_purged_words(purged_words);
+    /* going to compare words beyond nr_real_cands */
+    for (i = ca->nr_real_cands; i < ca->nr_cands; i++) {
+      for (j = 0; j < nr_purged; j++) {
+	/* return false if there is any different candidate */
+	if (strcmp(ca->cands[i], purged_words[j])) {
+	  free_allocated_purged_words(purged_words);
+	  return 0;
+	}
+      }
+    }
+    free_allocated_purged_words(purged_words);
+    return 1;
+  }
+  return 0;
+}
+
+static int
+match_to_discarding_index(int indices[], int n)
+{
+  int i = 0;
+  while (indices[i] != -1) {
+    if (indices[i] == n)
+      return 1;
+    i++;
+  }
+  return 0;
+}
+
+static uim_lisp
+skk_get_entry(uim_lisp skk_dic_, uim_lisp head_, uim_lisp okuri_head_,
+	      uim_lisp okuri_, uim_lisp numeric_conv_)
+{
+  struct skk_cand_array *ca;
+  dic_info *skk_dic = NULL;
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 0, numeric_conv_);
+
+  if (ca && ca->nr_cands > 0 && !is_purged_only(ca))
+      return uim_scm_t();
+
+  if (TRUEP(numeric_conv_))
+    return skk_get_entry(skk_dic_, head_, okuri_head_, okuri_, uim_scm_f());
+
+  return uim_scm_f();
+}
+
+static uim_lisp
+skk_store_replaced_numeric_str(uim_lisp head_)
+{
+  const char *str;
+  int len;
+
+  int prev_is_num = 0;
+  int i, numlen = 0, start = 0;
+  char *numstr = NULL;
+  uim_lisp lst = uim_scm_null();
+
+  str = REFER_C_STR(head_);
+  len = strlen(str);
+
+  for (i = 0; i < len; i++) {
+    if (isdigit((unsigned char)str[i])) {
+      if (prev_is_num == 0) {
+	start = i;
+	numlen = 1;
+      } else {
+	numlen++;
+      }
+      prev_is_num = 1;
+    } else {
+      if (prev_is_num) {
+	/* add number into list */
+	if (!numstr)
+	  numstr = uim_malloc(numlen + 1);
+	else
+	  numstr = uim_realloc(numstr, numlen + 1);
+	strlcpy(numstr, &str[start], numlen + 1);
+	lst = CONS(MAKE_STR(numstr), lst);
+      }
+      prev_is_num = 0;
+    }
+  }
+
+  /*
+   * Add last number into list if string is ended with numeric
+   * character.
+   */
+  if (prev_is_num) {
+    if (!numstr)
+      numstr = uim_malloc(numlen + 1);
+    else
+      numstr = uim_realloc(numstr, numlen + 1);
+    strlcpy(numstr, &str[start], numlen + 1);
+    lst = CONS(MAKE_STR(numstr), lst);
+  }
+  free(numstr);
+
+  return uim_scm_callf("reverse", "o", lst);
+}
+
+static char *wide_num_list[] =
+  {"", "", "", "", "", "", "", "", "", ""};
+static char *kanji_num_list[] =
+  {"", "", "", "", "", "", "ϻ", "", "Ȭ", ""};
+static char *kanji_num_position_list[] =
+  {NULL, "", "ɴ", "", "", NULL, NULL, NULL, "", NULL,
+   NULL, NULL, "", NULL, NULL, NULL, "", NULL, NULL, NULL};
+static char *kanji_check_num_list[] =
+  {"", "", "б", "", "", "", "ϻ", "", "Ȭ", ""};
+static char *kanji_check_num_position_list[] =
+  {NULL, "", "ɴ", "", "", NULL, NULL, NULL, "", NULL,
+   NULL, NULL, "", NULL, NULL, NULL, "", NULL, NULL, NULL};
+
+static char *
+numeric_wide_or_kanji_conv(const char *numstr, int method)
+{
+  char *mbstr;
+  int i, len;
+
+  len = strlen(numstr);
+  mbstr = uim_malloc(len * 2 + 1);
+
+  for (i = 0; i < len; i++) {
+    if (method == 1)
+      strcpy(&mbstr[i * 2], wide_num_list[numstr[i] - '0']);
+    else
+      strcpy(&mbstr[i * 2], kanji_num_list[numstr[i] - '0']);
+  }
+  mbstr[len * 2] = '\0';
+
+  return mbstr;
+}
+
+static char *
+numeric_kanji_with_position_conv(const char *numstr)
+{
+  char *mbstr;
+  int i, j, len, mblen;
+  int position;
+  int head_is_zero = 0;
+
+  len = strlen(numstr);
+  if (len > 20) /* too big number */
+    return uim_strdup(numstr);
+
+  mbstr = uim_malloc(len * 2 + 1);
+  mblen = len * 2;
+
+  for (i = 0, j = 0; j < len; i++, j++) {
+    position = len - j - 1;
+    if (numstr[j] == '0') {
+      i--;
+      mblen -= 2;
+      /* check zero at the head */
+      if (j == 0) {
+	head_is_zero = 1;
+      } else {
+	/* add , , ,  for zero */
+	if ((position >= 4) && ((position % 4) == 0) && !head_is_zero) {
+	  int use_position = 0;
+	  if (j >= 3) {
+	    if (!((numstr[j - 1] == '0') && (numstr[j - 2] == '0') &&
+				    (numstr[j - 3] == '0')))
+	      use_position = 1;
+	  } else if (j == 2) {
+	    if (!((numstr[j - 1] == '0') && (numstr[j - 2] == '0')))
+	      use_position = 1;
+	  } else if (j == 1) {
+	    if (!(numstr[j - 1] == '0'))
+	      use_position = 1;
+	  }
+	  if (use_position) {
+	    i++;
+	    mblen += 2;
+	    if (mblen > len * 2)
+	      mbstr = uim_realloc(mbstr, mblen + 2);
+	    strcpy(&mbstr[i * 2], kanji_num_position_list[position]);
+	  }
+	}
+      }
+    } else {
+      if (head_is_zero == 1)
+	head_is_zero = 0;
+
+      /* replace numstr[j] with kanji number */
+      if (numstr[j] == '1') {
+	/*
+	 * use "" only for the one at the place of , , , ,
+	 *  or 
+	 */
+	if (((position % 4) == 0) ||
+	    ((position >= 7) &&
+	     ((position % 4) == 3) &&
+	     (numstr[j + 1] == '0') &&
+	     (numstr[j + 2] == '0') &&
+	     (numstr[j + 3] == '0'))) {
+	  strcpy(&mbstr[i * 2], kanji_num_list[1]);
+	} else {
+	  i--;
+	  mblen -= 2;
+	}
+      } else {
+	strcpy(&mbstr[i * 2], kanji_num_list[numstr[j] - '0']);
+      }
+
+      /* add , ɴ,  for number whose place is exceeded  */
+      if (position > 4) {
+	if ((position % 4) != 0) {
+	  i++;
+	  mblen += 2;
+	  if (mblen > len * 2)
+	    mbstr = uim_realloc(mbstr, mblen + 2);
+	  strcpy(&mbstr[i * 2], kanji_num_position_list[position % 4]);
+	}
+      }
+
+      /* add position */
+      if (kanji_num_position_list[position]) {
+	i++;
+	mblen += 2;
+	if (mblen > len * 2)
+	  mbstr = uim_realloc(mbstr, mblen + 2);
+	strcpy(&mbstr[i * 2], kanji_num_position_list[position]);
+      }
+    }
+  }
+
+  /* in case of zero */
+  if (head_is_zero) {
+    strcpy(&mbstr[0], kanji_num_list[0]);
+    mblen = 2;
+  }
+
+  mbstr[mblen] = '\0';
+  return mbstr;
+}
+
+static char *
+numeric_kanji_for_check_conv(const char *numstr)
+{
+  char *mbstr;
+  int i, j, len, mblen;
+  int position;
+  int head_is_zero = 0;
+
+  len = strlen(numstr);
+  if (len > 20) /* too big number */
+    return uim_strdup(numstr);
+
+  mbstr = uim_malloc(len * 2 + 1);
+  mblen = len * 2;
+
+  for (i = 0, j = 0; j < len; i++, j++) {
+    position = len - j - 1;
+    if (numstr[j] == '0') {
+      i--;
+      mblen -= 2;
+      /* check zero at the head */
+      if (j == 0) {
+	head_is_zero = 1;
+      } else {
+	/* add , , ,  for zero */
+	if ((position >= 4) && ((position % 4) == 0) && !head_is_zero) {
+	  int use_position = 0;
+	  if (j >= 3) {
+	    if (!((numstr[j - 1] == '0') && (numstr[j - 2] == '0') &&
+				    (numstr[j - 3] == '0')))
+	      use_position = 1;
+	  } else if (j == 2) {
+	    if (!((numstr[j - 1] == '0') && (numstr[j - 2] == '0')))
+	      use_position = 1;
+	  } else if (j == 1) {
+	    if (!((numstr[j - 1] == '0')))
+	      use_position = 1;
+	  }
+	  if (use_position) {
+	    i++;
+	    mblen += 2;
+	    if (mblen > len * 2)
+	      mbstr = uim_realloc(mbstr, mblen + 2);
+	    strcpy(&mbstr[i * 2], kanji_check_num_position_list[position]);
+	  }
+	}
+      }
+    } else {
+      if (head_is_zero == 1)
+	head_is_zero = 0;
+
+      /* replace numstr[j] with kanji number */
+      strcpy(&mbstr[i * 2], kanji_check_num_list[numstr[j] - '0']);
+
+      /* add , ɴ,  for number whose place is exceeded  */
+      if (position > 4) {
+	if ((position % 4) != 0) {
+	  i++;
+	  mblen += 2;
+	  if (mblen > len * 2)
+	    mbstr = uim_realloc(mbstr, mblen + 2);
+	  strcpy(&mbstr[i * 2], kanji_check_num_position_list[position % 4]);
+	}
+      }
+
+      /* add position */
+      if (kanji_check_num_position_list[position]) {
+	i++;
+	mblen += 2;
+	if (mblen > len * 2)
+	  mbstr = uim_realloc(mbstr, mblen + 2);
+	strcpy(&mbstr[i * 2], kanji_check_num_position_list[position]);
+      }
+    }
+  }
+
+  /* in case of zero */
+  if (head_is_zero) {
+    strcpy(&mbstr[0], kanji_check_num_list[0]);
+    mblen = 2;
+  }
+
+  mbstr[mblen] = '\0';
+  return mbstr;
+}
+
+static char *
+numeric_shogi_conv(const char *numstr)
+{
+  char *mbstr;
+  int len;
+
+  len = strlen(numstr);
+  if (len != 2) /* allow two digit number only */
+    return uim_strdup(numstr);
+
+  mbstr = uim_malloc(5);
+  strcpy(&mbstr[0], wide_num_list[numstr[0] - '0']);
+  strcpy(&mbstr[2], kanji_num_list[numstr[1] - '0']);
+  mbstr[4] = '\0';
+
+  return mbstr;
+}
+
+/* returns string with malloc() */
+static char *
+numeric_convert(const char *numstr, int method)
+{
+  char *ret;
+
+  /*
+   *  method #4 is already handled in skk_get_nth_candidate()
+   */
+  switch (method) {
+  case 0:
+    ret = uim_strdup(numstr);
+    break;
+  case 1: /* ѿ */
+  case 2: /*  ̵̼ */
+    ret = numeric_wide_or_kanji_conv(numstr, method);
+    break;
+  case 3: /*  ̼ͭ */
+    ret = numeric_kanji_with_position_conv(numstr);
+    break;
+  case 5: /* ڼɽ */
+    ret = numeric_kanji_for_check_conv(numstr);
+    break;
+  case 9: /* ɽ */
+    ret = numeric_shogi_conv(numstr);
+    break;
+  default:
+    ret = uim_strdup(numstr);
+    break;
+  }
+  return ret;
+}
+
+static uim_lisp
+skk_merge_replaced_numeric_str(uim_lisp str_, uim_lisp numlst_)
+{
+  char *str;
+  int i, j, len, newlen;
+  int method;
+  int convlen;
+  const char *numstr;
+  char *convstr;
+
+  if (str_ == uim_scm_null())
+    return uim_scm_null();
+
+  str = C_STR(str_);
+  len = strlen(str);
+  newlen = len;
+
+  for (i = 0, j = 0; j < len; i++, j++) {
+    if (str[i] == '#') {
+      method = str[i + 1] - '0';
+      if (NULLP(numlst_))
+	 break;
+
+      numstr = REFER_C_STR(CAR(numlst_));
+
+      convstr = numeric_convert(numstr, method);
+      convlen = strlen(convstr);
+
+      newlen = newlen - 2 + convlen;
+      str = uim_realloc(str, newlen + 1);
+      memmove(&str[i + convlen], &str[i + 2], newlen - i - convlen + 1);
+      memcpy(&str[i], convstr, convlen);
+      i = i - 2 + convlen;
+
+      numlst_ = CDR(numlst_);
+    }
+  }
+  str[newlen] = '\0';
+
+  return MAKE_STR_DIRECTLY(str);
+}
+
+static char *
+replace_numeric(const char *str)
+{
+  char *newstr;
+  int prev_is_num = 0;
+  int i, j, len, newlen;
+
+  newstr = uim_strdup(str);
+  len = newlen = strlen(newstr);
+
+  for (i = 0, j = 0; j < len; i++, j++) {
+    if (isdigit((unsigned char)newstr[i])) {
+      if (prev_is_num == 0) {
+	newstr[i] = '#';
+      } else {
+	memmove(&newstr[i], &newstr[i + 1], newlen - i);
+	newlen--;
+	i--;
+      }
+      prev_is_num = 1;
+    } else {
+      prev_is_num = 0;
+    }
+  }
+  return newstr;
+}
+
+static uim_lisp
+skk_replace_numeric(uim_lisp head_)
+{
+  char *str;
+  
+  str = replace_numeric(REFER_C_STR(head_));
+
+  return MAKE_STR_DIRECTLY(str);
+}
+
+static char *
+find_numeric_conv_method4_mark(const char *cand, int *nth)
+{
+  int i, len;
+  char *p;
+
+  len = strlen(cand);
+
+  p = strstr(cand, "#4");
+  if (p) {
+    for (i = 0; i < len; i++) {
+      if (cand[i] == '#' && isdigit((unsigned char)cand[i + 1])) {
+	(*nth)++;
+	if (cand[i + 1] == '4')
+	  break;
+      }
+    }
+  }
+  return p;
+}
+
+static int
+has_numeric_in_head(uim_lisp head_)
+{
+  const char *str;
+  int i = 0;
+
+  str = REFER_C_STR(head_);
+
+  while (str[i] != '\0') {
+    if (isdigit((unsigned char)str[i]))
+      return 1;
+    i++;
+  }
+
+  return 0;
+}
+
+static uim_lisp
+get_nth(int nth, uim_lisp lst_)
+{
+  int i;
+  /* nth start from 1 */
+  for (i = 1; i < nth; i++) {
+    if (NULLP(lst_)) {
+      return uim_scm_null();
+    }
+    lst_ = CDR(lst_);
+  }
+  return CAR(lst_);
+}
+
+static int
+get_purged_cand_index(struct skk_cand_array *ca)
+{
+  int i, n = -1;
+
+  if (!ca)
+    return -1;
+
+  for (i = 0; i < ca->nr_real_cands; i++) {
+    if (is_purged_cand(ca->cands[i])) {
+      n = i;
+      break;
+    }
+  }
+  return n;
+}
+
+static int
+get_ignoring_indices(struct skk_cand_array *ca, int indices[])
+{
+  int i, j, k = 0;
+  int purged_cand_index;
+
+  purged_cand_index= get_purged_cand_index(ca);
+
+  if (purged_cand_index != -1) {
+    char **purged_words = get_purged_words(ca->cands[purged_cand_index]);
+    int nr_purged = nr_purged_words(purged_words);
+
+    indices[k] = purged_cand_index;
+    k++;
+
+    for (i = ca->nr_real_cands; i < ca->nr_cands; i++) {
+      if (k >= IGNORING_WORD_MAX)
+	break;
+      for (j = 0; j < nr_purged; j++) {
+	if (!strcmp(ca->cands[i], purged_words[j])) {
+	  indices[k] = i;
+	  k++;
+	}
+      }
+    }
+    indices[k] = -1;
+    free_allocated_purged_words(purged_words);
+  } else {
+    indices[0] = -1;
+  }
+  return k;
+}
+
+static uim_lisp
+skk_get_nth_candidate(uim_lisp skk_dic_, uim_lisp nth_,
+		      uim_lisp head_and_okuri_head_,
+		      uim_lisp okuri_,
+		      uim_lisp numeric_conv_)
+{
+  int n;
+  struct skk_cand_array *ca, *subca;
+  int i, j, k = 0;
+  const char *cands = NULL;
+  char *p;
+  const char *numstr;
+  int method_place = 0;
+  int sublen, newlen;
+  int mark;
+  uim_lisp str_ = uim_scm_null();
+  uim_lisp numlst_ = uim_scm_null();
+  int ignoring_indices[IGNORING_WORD_MAX + 1];
+  dic_info *skk_dic = NULL;
+  uim_lisp head_ = CAR(head_and_okuri_head_);
+  uim_lisp okuri_head_ = CDR(head_and_okuri_head_);
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  if (TRUEP(numeric_conv_))
+    numlst_ = skk_store_replaced_numeric_str(head_);
+
+  n = C_INT(nth_);
+
+  if (!NULLP(numlst_))
+    ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 0, numeric_conv_);
+  else
+    ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 0, uim_scm_f());
+
+  get_ignoring_indices(ca, ignoring_indices);
+
+  if (ca) {
+    /* handle #4 method of numeric conversion */
+    if (!NULLP(numlst_)) {
+      for (i = 0; i < ca->nr_cands; i++) {
+	if (match_to_discarding_index(ignoring_indices, i))
+	  continue;
+
+	if ((p = find_numeric_conv_method4_mark(ca->cands[i], &method_place))) {
+	  numstr = REFER_C_STR(get_nth(method_place, numlst_));
+	  subca = find_cand_array(skk_dic, numstr, 0, NULL, 0);
+	  if (subca) {
+	    for (j = 0; j < subca->nr_cands; j++) {
+	      if (k == n) {
+		char *str;
+		str = uim_strdup(ca->cands[i]);
+		sublen = strlen(subca->cands[j]);
+		newlen = strlen(ca->cands[i]) - 2 + sublen;
+		mark = p - ca->cands[i];
+
+		str = uim_realloc(str, newlen + 1);
+		memmove(&str[mark + sublen],
+			&str[mark + 2],
+			newlen - mark - sublen + 1);
+		memcpy(&str[mark], subca->cands[j], sublen);
+
+		str_ = MAKE_STR_DIRECTLY(str);
+		return skk_merge_replaced_numeric_str(str_, numlst_);
+	      }
+	      k++;
+	    }
+	  }
+	} else {
+	   if (k == n) {
+	     cands = ca->cands[i];
+	     break;
+	   }
+	   k++;
+	}
+      }
+    } else {
+      for (i = 0; i < ca->nr_cands; i++) {
+	if (match_to_discarding_index(ignoring_indices, i))
+	  continue;
+	if (k == n) {
+	  cands = ca->cands[i];
+	  break;
+	}
+	k++;
+      }
+    }
+  }
+
+  /* check non-numeric conversion */
+  if (!cands && n >= k && !NULLP(numlst_))
+    return skk_get_nth_candidate(skk_dic_, MAKE_INT(n - k),
+		    head_and_okuri_head_, okuri_, uim_scm_f());
+
+  if (cands)
+    str_ = MAKE_STR(cands);
+
+  if (!NULLP(numlst_))
+    return skk_merge_replaced_numeric_str(str_, numlst_);
+  else
+    return str_;
+}
+
+static uim_lisp
+skk_get_nr_candidates(uim_lisp skk_dic_, uim_lisp head_, uim_lisp okuri_head_, uim_lisp okuri_, uim_lisp numeric_conv_)
+{
+  struct skk_cand_array *ca, *subca;
+  int n = 0;
+  int i, nr_cands = 0;
+  const char *numstr;
+  int method_place = 0;
+  uim_lisp numlst_ = uim_scm_null();
+  int ignoring_indices[IGNORING_WORD_MAX + 1];
+  dic_info *skk_dic = NULL;
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  if (TRUEP(numeric_conv_))
+    numlst_ = skk_store_replaced_numeric_str(head_);
+
+  if (!NULLP(numlst_))
+    ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 0, numeric_conv_);
+  else
+    ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 0, uim_scm_f());
+
+  if (ca)
+    n = ca->nr_cands;
+  nr_cands = n;
+  nr_cands -= get_ignoring_indices(ca, ignoring_indices);
+
+  /* handle #4 method of numeric conversion */
+  if (!NULLP(numlst_)) {
+    for (i = 0; i < n; i++) {
+      if (match_to_discarding_index(ignoring_indices, i))
+	continue;
+
+      if (find_numeric_conv_method4_mark(ca->cands[i], &method_place)) {
+	numstr = REFER_C_STR(get_nth(method_place, numlst_));
+	nr_cands--;
+	subca = find_cand_array(skk_dic, numstr, 0, NULL, 0);
+	if (subca)
+	  nr_cands += subca->nr_cands;
+	break;
+      }
+    }
+  }
+
+  /* add non-numeric conversion */
+  if (!NULLP(numlst_))
+    return MAKE_INT(nr_cands +
+		    C_INT(skk_get_nr_candidates(skk_dic_, head_, okuri_head_,
+				    okuri_, uim_scm_f())));
+
+  return MAKE_INT(nr_cands);
+}
+
+static struct skk_comp_array *
+make_comp_array_from_cache(dic_info *di, const char *s, uim_lisp use_look_)
+{
+  struct skk_line *sl;
+  struct skk_comp_array *ca;
+
+  if (!di)
+    return NULL;
+
+  ca = uim_malloc(sizeof(struct skk_comp_array));
+  ca->nr_comps = 0;
+  ca->refcount = 0;
+  ca->comps = NULL;
+  ca->head = NULL;
+  ca->next = NULL;
+
+  /* search from cache */
+  for (sl = di->head.next; sl; sl = sl->next) {
+    if (/* string 's' is part of sl->head */
+	!strncmp(sl->head, s, strlen(s)) && strcmp(sl->head, s) &&
+	/* and sl is okuri-nasi line */
+	sl->okuri_head == '\0' &&
+	/* exclude some entries */
+	sl->state & SKK_LINE_USE_FOR_COMPLETION) {
+      ca->nr_comps++;
+      ca->comps = uim_realloc(ca->comps, sizeof(char *) * ca->nr_comps);
+      ca->comps[ca->nr_comps - 1] = uim_strdup(sl->head);
+    }
+  }
+
+  if (TRUEP(use_look_))
+    look_get_comp(ca, s);
+
+  if (ca->nr_comps == 0) {
+    free(ca);
+    ca = NULL;
+  } else {
+    ca->head = uim_strdup(s);
+    ca->next = skk_comp;
+    skk_comp = ca;
+  }
+  return ca;
+}
+
+static struct skk_comp_array *
+append_comp_array_from_server(struct skk_comp_array *ca, dic_info *di, const char *s, uim_lisp use_look_)
+{
+  char r;
+  struct skk_line *sl;
+  int n = 0, ret, len;
+  int i;
+  char buf[SKK_SERV_BUFSIZ];
+  char *line;
+  ssize_t nr;
+  struct pollfd pfd[1];
+
+  if (!di) {
+    return ca;
+  }
+  if (!(di->skkserv_state & SKK_SERV_CONNECTED)) {
+    if (!((di->skkserv_state |= open_skkserv(di->skkserv_hostname,
+					     di->skkserv_portnum,
+					     di->skkserv_family)) &
+	  SKK_SERV_CONNECTED))
+      return ca;
+  }
+
+  fprintf(wserv, "4%s \n", s);
+  ret = fflush(wserv);
+  if (ret != 0 && errno == EPIPE) {
+    skkserv_disconnected(di);
+    return ca;
+  }
+
+  /* check server response to see the capability of completion */
+  pfd[0].fd = skkservsock;
+  pfd[0].events = POLLIN;
+  ret = poll(pfd, 1, di->skkserv_completion_timeout);
+  if (ret == -1) {
+    skkserv_disconnected(di);
+    return ca;
+  } else if (ret == 0) {
+    uim_notify_info(N_("SKK server without completion capability\n"));
+    /* don't try server completion further any more */
+    di->skkserv_state &= ~SKK_SERV_TRY_COMPLETION;
+    return ca;
+  }
+
+  if ((nr = read(skkservsock, &r, 1)) == -1 || nr == 0) {
+    skkserv_disconnected(di);
+    return ca;
+  }
+
+  if (r == '1') {
+    char sep = '\0';
+    uim_asprintf(&line, "%s ", s);
+    while (1) {
+      if ((nr = read(skkservsock, &r, 1)) == -1 || nr == 0) {
+        skkserv_disconnected(di);
+        free(line);
+        return ca;
+      }
+
+      if (r == '\n') {
+        len = strlen(line) + n;
+        line = uim_realloc(line, len + 1);
+        strlcat(line, buf, len + 1);
+        break;
+      }
+
+      /* FIXME: should handle word with '/' properly */
+      if (n == 0 && sep == '\0') {
+	sep = r;
+      } else {
+	if (sep == ' ' && r == ' ') {
+	  r = '/';
+	}
+      }
+
+      buf[n] = r;
+      buf[n + 1] = '\0';
+      if (n == SKK_SERV_BUFSIZ - 2) {
+        len = strlen(line) + n + 1;
+        line = uim_realloc(line, len + 1);
+        strlcat(line, buf, len + 1);
+        n = 0;
+      } else {
+        n++;
+      }
+    }
+    sl = compose_line(di, s, '\0', line);
+    free(line);
+
+    if (!ca) {
+      ca = uim_malloc(sizeof(struct skk_comp_array));
+      ca->nr_comps = 0;
+      ca->refcount = 0;
+      ca->comps = NULL;
+      ca->head = NULL;
+      ca->next = NULL;
+    }
+    for (i = 0; i < sl->cands[0].nr_cands; i++) {
+      if (strcmp(s, sl->cands[0].cands[i]) != 0) {
+        ca->nr_comps++;
+        ca->comps = uim_realloc(ca->comps, sizeof(char *) * ca->nr_comps);
+        ca->comps[ca->nr_comps - 1] = uim_strdup(sl->cands[0].cands[i]);
+      }
+    }
+    free_skk_line(sl);
+    if (ca->nr_comps == 0) {
+      free(ca);
+      ca = NULL;
+    } else if (ca->head == NULL) {
+      ca->head = uim_strdup(s);
+      ca->next = skk_comp;
+      skk_comp = ca;
+    }
+  } else {
+    while ((nr = read(skkservsock, &r, 1)) != -1 && nr != 0 && r != '\n');
+  }
+
+  return ca;
+}
+
+static struct skk_comp_array *
+find_comp_array(dic_info *di, const char *s, uim_lisp use_look_)
+{
+  struct skk_comp_array *ca;
+
+  if (strlen(s) == 0)
+    return NULL;
+
+  for (ca = skk_comp; ca; ca = ca->next) {
+    if (!strcmp(ca->head, s))
+      break;
+  }
+  if (ca == NULL) {
+    ca = make_comp_array_from_cache(di, s, use_look_);
+    if (di->skkserv_state & SKK_SERV_TRY_COMPLETION)
+      ca = append_comp_array_from_server(ca, di, s, use_look_);
+  }
+
+  return ca;
+}
+
+static struct skk_comp_array *
+find_comp_array_lisp(dic_info *skk_dic, uim_lisp head_, uim_lisp numeric_conv_, uim_lisp use_look_)
+{
+  const char *hs;
+  struct skk_comp_array *ca;
+  char *rs = NULL;
+
+  hs = REFER_C_STR(head_);
+
+  if (TRUEP(numeric_conv_))
+    rs = replace_numeric(hs);
+
+  if (!rs)
+    ca = find_comp_array(skk_dic, hs, use_look_);
+  else {
+    ca = find_comp_array(skk_dic, rs, use_look_);
+    free(rs);
+  }
+  return ca;
+}
+
+static uim_lisp
+skk_get_completion(uim_lisp skk_dic_, uim_lisp head_, uim_lisp numeric_conv_, uim_lisp use_look_)
+{
+  struct skk_comp_array *ca;
+  dic_info *skk_dic = NULL;
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  ca = find_comp_array_lisp(skk_dic, head_, numeric_conv_, use_look_);
+  if (ca) {
+    ca->refcount++;
+    return uim_scm_t();
+  }
+
+  if (TRUEP(numeric_conv_) && has_numeric_in_head(head_))
+    return skk_get_completion(skk_dic_, head_, uim_scm_f(), use_look_);
+
+  return uim_scm_f();
+}
+
+static uim_lisp
+skk_get_nth_completion(uim_lisp skk_dic_, uim_lisp nth_, uim_lisp head_,
+		uim_lisp numeric_conv_, uim_lisp use_look_)
+{
+  int n;
+  struct skk_comp_array *ca;
+  char *str;
+  uim_lisp numlst_ = uim_scm_null();
+  dic_info *skk_dic = NULL;
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  if (TRUEP(numeric_conv_))
+    numlst_ = skk_store_replaced_numeric_str(head_);
+
+  if (!NULLP(numlst_))
+    ca = find_comp_array_lisp(skk_dic, head_, numeric_conv_, use_look_);
+  else
+    ca = find_comp_array_lisp(skk_dic, head_, uim_scm_f(), use_look_);
+
+  if (!ca) {
+    if (!NULLP(numlst_))
+      return skk_get_nth_completion(skk_dic_, nth_, head_, uim_scm_f(), use_look_);
+    else
+      return MAKE_STR("");
+  }
+
+  n = C_INT(nth_);
+  if (ca->nr_comps > n) {
+    str = ca->comps[n];
+    if (!NULLP(numlst_))
+      return restore_numeric(str, numlst_);
+    else
+      return MAKE_STR(str);
+  }
+
+  if (!NULLP(numlst_) && n >= ca->nr_comps)
+    return skk_get_nth_completion(skk_dic_, MAKE_INT(n - ca->nr_comps),
+		    head_, uim_scm_f(), use_look_);
+
+  return MAKE_STR("");
+}
+
+static uim_lisp
+skk_get_nr_completions(uim_lisp skk_dic_, uim_lisp head_, uim_lisp numeric_conv_, uim_lisp use_look_)
+{
+  int n = 0;
+  struct skk_comp_array *ca;
+  dic_info *skk_dic = NULL;
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  ca = find_comp_array_lisp(skk_dic, head_, numeric_conv_, use_look_);
+  if (ca)
+    n = ca->nr_comps;
+
+  if (TRUEP(numeric_conv_) && has_numeric_in_head(head_))
+    return MAKE_INT(n +
+		    C_INT(skk_get_nr_completions(skk_dic_, head_, uim_scm_f(), use_look_))); 
+
+  return MAKE_INT(n);
+}
+
+static uim_lisp
+skk_clear_completions(uim_lisp head_, uim_lisp numeric_conv_)
+{
+  int i;
+  struct skk_comp_array *ca, *ca_prev;
+  const char *hs;
+  char *rs = NULL;
+
+  hs = REFER_C_STR(head_);
+
+  if (TRUEP(numeric_conv_))
+    rs = replace_numeric(hs);
+
+  if (!rs)
+    for (ca = skk_comp; ca; ca = ca->next) {
+      if (!strcmp(ca->head, hs)) {
+	ca->refcount--;
+	break;
+      }
+    }
+  else {
+    for (ca = skk_comp; ca; ca = ca->next) {
+      if (!strcmp(ca->head, rs)) {
+	ca->refcount--;
+	break;
+      }
+    }
+    free(rs);
+  }
+
+  if (ca && ca->refcount == 0) {
+    for (i = 0; i < ca->nr_comps; i++) {
+      free(ca->comps[i]);
+    }
+    free(ca->comps);
+    free(ca->head);
+
+    if (ca == skk_comp) {
+      skk_comp = ca->next;
+      free(ca);
+    } else {
+      ca_prev = skk_comp;
+      while (ca_prev->next != ca) {
+	ca_prev = ca_prev->next;
+      }
+      ca_prev->next = ca->next;
+      free(ca);
+    }
+  }
+
+  if (TRUEP(numeric_conv_) && has_numeric_in_head(head_))
+    skk_clear_completions(head_, uim_scm_f());
+
+  return uim_scm_t();
+}
+
+static uim_lisp
+restore_numeric(const char *s, uim_lisp numlst_)
+{
+  int i, j, len, newlen, numstrlen;
+  const char *numstr;
+  char *str;
+
+  str = uim_strdup(s);
+  newlen = len = strlen(str);
+
+  for (i = 0, j = 0; j < len; i++, j++) {
+    if (str[i] == '#') {
+      if (NULLP(numlst_))
+	break;
+
+      numstr  = REFER_C_STR(CAR(numlst_));
+      numstrlen = strlen(numstr);
+      newlen = newlen - 1 + numstrlen;
+      str = uim_realloc(str, newlen + 1);
+      memmove(&str[i + numstrlen], &str[i + 1], newlen - i - numstrlen + 1);
+      memcpy(&str[i], numstr, numstrlen);
+      i = i  - 1 + numstrlen;
+
+      numlst_ = CDR(numlst_);
+    }
+  }
+  return MAKE_STR_DIRECTLY(str);
+}
+
+static uim_lisp
+skk_get_dcomp_word(uim_lisp skk_dic_, uim_lisp head_, uim_lisp numeric_conv_, uim_lisp use_look_)
+{
+  const char *hs;
+  struct skk_line *sl;
+  int len;
+  uim_lisp numlst_, look_;
+  char *rs = NULL;
+  dic_info *skk_dic = NULL;
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  numlst_ = uim_scm_null();
+  hs = REFER_C_STR(head_);
+
+  if (TRUEP(numeric_conv_))
+    numlst_ = skk_store_replaced_numeric_str(head_);
+
+  if (!NULLP(numlst_)) {
+    rs = replace_numeric(hs);
+    len = strlen(rs);
+  } else
+    len = strlen(hs);
+
+  if (len != 0) {
+    /* Search from cache using same way as in make_comp_array_from_cache(). */
+    if (!rs) {
+      for (sl = skk_dic->head.next; sl; sl = sl->next) {
+	if (!strncmp(sl->head, hs, len) && strcmp(sl->head, hs) &&
+			sl->okuri_head == '\0' &&
+			sl->state & SKK_LINE_USE_FOR_COMPLETION)
+	  return MAKE_STR(sl->head);
+      }
+      if (TRUEP(use_look_)) {
+	look_ = look_get_top_word(hs);
+	if (TRUEP(look_))
+	  return look_;
+      }
+    } else {
+      for (sl = skk_dic->head.next; sl; sl = sl->next) {
+	if (!strncmp(sl->head, rs, len) && strcmp(sl->head, rs) &&
+			sl->okuri_head == '\0' &&
+			sl->state & SKK_LINE_USE_FOR_COMPLETION) {
+	  free(rs);
+	  return restore_numeric(sl->head, numlst_);
+	}
+      }
+      if (TRUEP(use_look_)) {
+	look_ = look_get_top_word(rs);
+	free(rs);
+	if (TRUEP(look_))
+	  return look_;
+      } else {
+	free(rs);
+      }
+      return skk_get_dcomp_word(skk_dic_, head_, uim_scm_f(), use_look_);
+    }
+  }
+  return MAKE_STR("");
+}
+
+static void
+reorder_candidate(dic_info *skk_dic, struct skk_cand_array *ca, const char *str)
+{
+  int i;
+  int nth = 0;
+  char *tmp;
+  /* find index of the candidate */
+  for (i = 0; i < ca->nr_cands; i++) {
+    if (!strcmp(str, ca->cands[i])) {
+      nth = i;
+      break;
+    }
+  }
+
+  /* shift array */
+  tmp = ca->cands[nth];
+  if (nth) {
+    for (i = nth; i > 0; i--)
+      ca->cands[i] = ca->cands[i - 1];
+    ca->cands[0] = tmp;
+    skk_dic->cache_modified = 1;
+  }
+  /* */
+  if (nth >= ca->nr_real_cands)
+    ca->nr_real_cands++;
+}
+
+static void push_purged_word(dic_info *skk_dic, struct skk_cand_array *ca, int nth, int append, char *word)
+{
+  char *cand = ca->cands[nth];
+  int len, oldlen = strlen(cand);
+  char *p = sanitize_word(word, NULL);
+
+  if (!p)
+    return;
+
+  if (append) {
+    /* check whether the word is already registerd */
+    char **purged_words = get_purged_words(cand);
+    int nr_purged = nr_purged_words(purged_words);
+    int j;
+    for (j = 0; j < nr_purged; j++) {
+      if (!strcmp(purged_words[j], word)) {
+	free_allocated_purged_words(purged_words);
+	return;
+      }
+    }
+    free_allocated_purged_words(purged_words);
+
+    len = oldlen + strlen(p) + 3;
+    cand = uim_realloc(cand, len + 1);
+    if (cand) {
+      cand[oldlen - 1] = '\0';
+      strcat(cand, " \"");
+      strcat(cand, p);
+      strcat(cand, "\")");
+      ca->cands[nth] = cand;
+      skk_dic->cache_modified = 1;
+    }
+  } else {
+    len = strlen("(skk-ignore-dic-word \"\")") + strlen(p) + 1;
+    cand = uim_realloc(cand, len);
+    if (cand) {
+      snprintf(cand, len, "(skk-ignore-dic-word \"%s\")", p);
+      ca->cands[nth] = cand;
+      skk_dic->cache_modified = 1;
+    }
+  }
+}
+
+static void remove_candidate_from_array(dic_info *skk_dic, struct skk_cand_array *ca, int nth)
+{
+  int i;
+
+  free(ca->cands[nth]);
+  for (i = nth; i < ca->nr_cands - 1; i++)
+    ca->cands[i] = ca->cands[i + 1];
+  if (nth < ca->nr_real_cands)
+    ca->nr_real_cands--;
+  ca->nr_cands--;
+  skk_dic->cache_modified = 1;
+}
+
+static void
+merge_word_to_real_cand_array(struct skk_cand_array *ca, const char *word)
+{
+  int i, nth = -1;
+  char *tmp;
+
+  push_back_candidate_to_array(ca, word);
+  nth = ca->nr_cands - 1;
+
+  /* move word at the end of real cand array */
+  tmp = ca->cands[nth];
+  if (nth >= ca->nr_real_cands) {
+    for (i = nth; i > ca->nr_real_cands; i--)
+      ca->cands[i] = ca->cands[i - 1];
+    ca->cands[ca->nr_real_cands] = tmp;
+    ca->nr_real_cands++;
+  }
+}
+
+static int exist_in_purged_cand(struct skk_cand_array *ca,
+		const char *word)
+{
+  int i, purged_cand_index;
+  char **purged_words;
+  int nr_purged;
+
+  purged_cand_index = get_purged_cand_index(ca);
+  if (purged_cand_index == -1)
+    return 0;
+
+  purged_words = get_purged_words(ca->cands[purged_cand_index]);
+  nr_purged = nr_purged_words(purged_words);
+
+  for (i = 0; i < nr_purged; i++) {
+    if (!strcmp(purged_words[i], word)) {
+      free_allocated_purged_words(purged_words);
+      return 1;
+    }
+  }
+  free_allocated_purged_words(purged_words);
+  return 0;
+}
+
+static int index_in_real_cands(struct skk_cand_array *ca, const char *str)
+{
+  int i;
+  for (i = 0; i < ca->nr_real_cands; i++) {
+    if (!strcmp(ca->cands[i], str))
+      return i;
+  }
+  return -1;
+}
+
+static void
+remove_purged_words_from_dst_cand_array(dic_info *skk_dic,
+		struct skk_cand_array *src_ca,
+		struct skk_cand_array *dst_ca, const char *purged_cand)
+{
+  char **purged_words;
+  int nr_words;
+  int i, j;
+
+  purged_words = get_purged_words(purged_cand);
+  nr_words = nr_purged_words(purged_words);
+
+  for (i = 0; i < nr_words; i++) {
+    int dup = 0;
+
+    if (index_in_real_cands(src_ca, purged_words[i]) != -1)
+      continue;
+
+    for (j = 0; j < dst_ca->nr_real_cands; j++) {
+       if (!strcmp(purged_words[i], dst_ca->cands[j])) {
+	 dup = 1;
+	 break;
+       }
+    }
+    if (dup)
+      remove_candidate_from_array(skk_dic, dst_ca, j);
+  }
+  free_allocated_purged_words(purged_words);
+}
+
+static void
+merge_purged_cands(dic_info *skk_dic, struct skk_cand_array *src_ca,
+		   struct skk_cand_array *dst_ca, int src_nth, int dst_nth)
+{
+  char *src_cand = src_ca->cands[src_nth];
+  char *dst_cand = dst_ca->cands[dst_nth];
+  char **dst_purged_words, **src_purged_words;
+  int nr_dst_purged_words, nr_src_purged_words;
+  int i, j;
+
+  src_purged_words = get_purged_words(src_cand);
+  dst_purged_words = get_purged_words(dst_cand);
+  nr_src_purged_words = nr_purged_words(src_purged_words);
+  nr_dst_purged_words = nr_purged_words(dst_purged_words);
+
+  for (i = 0; i < nr_src_purged_words; i++) {
+    int dup = 0;
+    for (j = 0; j < nr_dst_purged_words; j++) {
+      if (!strcmp(src_purged_words[i], dst_purged_words[j])) {
+	dup = 1;
+	break;
+      }
+    }
+    if (!dup) {
+      push_purged_word(skk_dic, dst_ca, dst_nth, 1, src_purged_words[i]);
+      remove_purged_words_from_dst_cand_array(skk_dic, src_ca, dst_ca, src_ca->cands[src_nth]);
+    }
+  }
+  free_allocated_purged_words(dst_purged_words);
+  free_allocated_purged_words(src_purged_words);
+}
+
+static void
+merge_purged_cand_to_dst_array(dic_info *skk_dic,
+		struct skk_cand_array *src_ca,
+		struct skk_cand_array *dst_ca, char *purged_cand)
+{
+  remove_purged_words_from_dst_cand_array(skk_dic, src_ca, dst_ca, purged_cand);
+  merge_word_to_real_cand_array(dst_ca, purged_cand);
+}
+
+static void
+merge_word_to_dst_cand_array_with_purged_words(struct skk_cand_array *dst_ca,
+		struct skk_cand_array *src_ca, const char *src_cand)
+{
+  int i, nth;
+  char *tmp;
+
+  if (exist_in_purged_cand(dst_ca, src_cand) && !exist_in_purged_cand(src_ca, src_cand))
+    return;
+
+  push_back_candidate_to_array(dst_ca, src_cand);
+  nth = dst_ca->nr_cands - 1;
+
+  /* move word at the end of real cand array */
+  tmp = dst_ca->cands[nth];
+  if (nth >= dst_ca->nr_real_cands) {
+    for (i = nth; i > dst_ca->nr_real_cands; i--)
+      dst_ca->cands[i] = dst_ca->cands[i - 1];
+    dst_ca->cands[dst_ca->nr_real_cands] = tmp;
+    dst_ca->nr_real_cands++;
+  }
+}
+
+static void
+merge_real_candidate_array(dic_info *skk_dic,
+		           struct skk_cand_array *src_ca,
+			   struct skk_cand_array *dst_ca)
+{
+  int i, j;
+  int src_nr_real_cands = src_ca->nr_real_cands;
+  int dst_nr_real_cands = dst_ca->nr_real_cands;
+
+  if (!src_ca || !dst_ca)
+    return ;
+
+  for (i = 0; i < src_nr_real_cands; i++) {
+    int dup = 0;
+    int src_purged_cand_index = -1;
+    int dst_purged_cand_index = -1;
+
+    if (is_purged_cand(src_ca->cands[i]))
+      src_purged_cand_index = i;
+
+    for (j = 0; j < dst_nr_real_cands; j++) {
+      if (dst_purged_cand_index == -1 && is_purged_cand(dst_ca->cands[j]))
+	dst_purged_cand_index = j;
+      if (!strcmp(src_ca->cands[i], dst_ca->cands[j]))
+	dup = 1;
+    }
+
+    if (!dup) {
+      /* be careful! */
+      if (src_purged_cand_index != -1 && dst_purged_cand_index != -1)
+	merge_purged_cands(skk_dic, src_ca, dst_ca, src_purged_cand_index,
+			dst_purged_cand_index);
+      else if (src_purged_cand_index != -1 && dst_purged_cand_index == -1)
+	merge_purged_cand_to_dst_array(skk_dic, src_ca, dst_ca,
+			src_ca->cands[src_purged_cand_index]);
+      else if (src_purged_cand_index == -1 && dst_purged_cand_index != -1)
+	merge_word_to_dst_cand_array_with_purged_words(dst_ca, src_ca,
+			src_ca->cands[i]);
+      else
+	merge_word_to_real_cand_array(dst_ca, src_ca->cands[i]);
+    }
+  }
+}
+
+static uim_lisp
+skk_commit_candidate(uim_lisp skk_dic_, uim_lisp head_and_okuri_head_,
+		     uim_lisp okuri_, uim_lisp nth_, uim_lisp numeric_conv_)
+{
+  int nth;
+  struct skk_cand_array *ca, *subca;
+  char *str = NULL;
+  int i, j, k = 0;
+  uim_lisp numstr_;
+  const char *numstr;
+  int method_place = 0;
+  uim_lisp numlst_ = uim_scm_null();
+  int ignoring_indices[IGNORING_WORD_MAX + 1];
+  dic_info *skk_dic = NULL;
+  uim_lisp head_ = CAR(head_and_okuri_head_);
+  uim_lisp okuri_head_ = CDR(head_and_okuri_head_);
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  if (TRUEP(numeric_conv_))
+    numlst_ = skk_store_replaced_numeric_str(head_);
+
+  nth = C_INT(nth_);
+
+  if (!NULLP(numlst_))
+    ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 0, numeric_conv_);
+  else
+    ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 0, uim_scm_f());
+
+  if (!ca) {
+    if (!NULLP(numlst_))
+      return skk_commit_candidate(skk_dic_, head_and_okuri_head_, okuri_, nth_,
+		      uim_scm_f());
+    return uim_scm_f();
+  }
+
+  get_ignoring_indices(ca, ignoring_indices);
+
+  /* handle #4 method of numeric conversion */
+  if (!NULLP(numlst_)) {
+    for (i = 0; i < ca->nr_cands; i++) {
+      if (match_to_discarding_index(ignoring_indices, i))
+	continue;
+
+      if (find_numeric_conv_method4_mark(ca->cands[i], &method_place)) {
+	numstr_ = get_nth(method_place, numlst_);
+	numstr = REFER_C_STR(numstr_);
+	subca = find_cand_array(skk_dic, numstr, 0, NULL, 0);
+	if (subca) {
+	  for (j = 0; j < subca->nr_cands; j++) {
+	    if (k == nth) {
+	      str = ca->cands[i];
+	      /* reorder sub candidate */
+	      skk_commit_candidate(skk_dic_, CONS(numstr_, uim_scm_null()),
+			           uim_scm_null(), MAKE_INT(j), uim_scm_f());
+	      break;
+	    }
+	    k++;
+	  }
+	}
+	if (str)
+	  break;
+      } else {
+	if (k == nth) {
+	   str = ca->cands[i];
+	   break;
+	}
+	k++;
+      }
+    }
+    if (!str) {
+      if (nth >= k)
+	return skk_commit_candidate(skk_dic_, head_and_okuri_head_, okuri_,
+			MAKE_INT(nth - k), uim_scm_f());
+      return uim_scm_f();
+    }
+  } else {
+    for (i = 0; i < ca->nr_cands; i++) {
+      if (match_to_discarding_index(ignoring_indices, i))
+	continue;
+      if (k == nth) {
+	str = ca->cands[i];
+	break;
+      }
+      k++;
+    }
+    if (!str)
+      return uim_scm_f();
+  }
+  reorder_candidate(skk_dic, ca, str);
+
+  if (okuri_ != uim_scm_null()) {
+    struct skk_line *sl;
+    const char *okuri;
+    int found = 0;
+
+    okuri = REFER_C_STR(okuri_);
+    sl = ca->line;
+    for (i = 1; i < sl->nr_cand_array; i++) {
+      if (!strcmp(okuri, sl->cands[i].okuri)) {
+	found = 1;
+	break;
+      }
+    }
+    if (!found) {
+      if (!NULLP(numlst_))
+	ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 1, numeric_conv_);
+      else
+	ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 1, uim_scm_f());
+      reorder_candidate(skk_dic, ca, str);
+    } else {
+      /* also reorder base candidate array */
+      reorder_candidate(skk_dic, &sl->cands[0], str);
+    }
+  }
+
+  ca->line->state = SKK_LINE_NEED_SAVE | SKK_LINE_USE_FOR_COMPLETION;
+  move_line_to_cache_head(skk_dic, ca->line);
+
+  return uim_scm_f();
+}
+
+static void purge_candidate(dic_info *skk_dic, struct skk_cand_array *ca, int nth)
+{
+    char *str;
+    int i;
+
+    if (nth == -1)
+      return;
+
+    str = uim_strdup(ca->cands[nth]);
+
+    if ((i = get_purged_cand_index(ca)) == -1) {
+      /* new purged cand in the array */
+      push_purged_word(skk_dic, ca, nth, 0, str);
+    } else {
+      /* append the word to already existing purged cand and remove it own */
+      push_purged_word(skk_dic, ca, i, 1, str);
+      remove_candidate_from_array(skk_dic, ca, nth);
+    }
+
+#if 0
+    /* Disabled since we use okuri specific ignoing words */
+    if (ca->okuri) {
+      /* also purge the word in the base cand array */
+      int index = index_in_real_cands(&ca->line->cands[0], str);
+      if (index != -1)
+	purge_candidate(skk_dic, &ca->line->cands[0], index);
+    }
+#endif
+    free(str);
+}
+
+static uim_lisp
+skk_purge_candidate(uim_lisp skk_dic_, uim_lisp head_and_okuri_head_,
+		    uim_lisp okuri_, uim_lisp nth_, uim_lisp numeric_conv_)
+{
+  int nth = C_INT(nth_);
+  struct skk_cand_array *ca, *subca;
+  char *str = NULL;
+  int i, j, k = 0;
+  uim_lisp numstr_;
+  const char *numstr;
+  int method_place = 0;
+  uim_lisp numlst_ = uim_scm_null();
+  int ignoring_indices[IGNORING_WORD_MAX + 1];
+  dic_info *skk_dic = NULL;
+  uim_lisp head_ = CAR(head_and_okuri_head_);
+  uim_lisp okuri_head_ = CDR(head_and_okuri_head_);
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  if (TRUEP(numeric_conv_))
+    numlst_ = skk_store_replaced_numeric_str(head_);
+
+  if (!NULLP(numlst_))
+    ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 0, numeric_conv_);
+  else
+    ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 0, uim_scm_f());
+
+  if (!ca) {
+    if (!NULLP(numlst_))
+      return skk_purge_candidate(skk_dic_, head_and_okuri_head_, okuri_, nth_,
+		      uim_scm_f());
+    return uim_scm_f(); /* shouldn't happen */
+  }
+
+  get_ignoring_indices(ca, ignoring_indices);
+
+  /* handle #4 method of numeric conversion */
+  if (!NULLP(numlst_)) {
+    for (i = 0; i < ca->nr_cands; i++) {
+      if (match_to_discarding_index(ignoring_indices, i))
+	continue;
+
+      if (find_numeric_conv_method4_mark(ca->cands[i], &method_place)) {
+	numstr_ = get_nth(method_place, numlst_);
+	numstr = REFER_C_STR(numstr_);
+	subca = find_cand_array(skk_dic, numstr, 0, NULL, 0);
+	if (subca) {
+	  for (j = 0; j < subca->nr_cands; j++) {
+	    if (k == nth) {
+	      str = ca->cands[i];
+	      /*
+	       * don't purge word in sub candidate array
+	       * skk_purge_candidate(skk_dic_, numstr_, uim_scm_null(), uim_scm_null(), MAKE_INT(j), uim_scm_null());
+	       */
+	      break;
+	    }
+	    k++;
+	  }
+	}
+	if (str)
+	  break;
+      } else {
+	if (k == nth) {
+	   str = ca->cands[i];
+	   break;
+	}
+	k++;
+      }
+    }
+    if (!str) {
+      if (nth >= k)
+	skk_purge_candidate(skk_dic_, head_and_okuri_head_, okuri_,
+			MAKE_INT(nth - k), uim_scm_f());
+      return uim_scm_f();
+    }
+  } else {
+    for (i = 0; i < ca->nr_cands; i++) {
+      if (match_to_discarding_index(ignoring_indices, i))
+	continue;
+      if (k == nth)
+	break;
+      k++;
+    }
+  }
+  if (i < ca->nr_real_cands)
+    purge_candidate(skk_dic, ca, i);
+
+  return uim_scm_t();
+}
+
+static void
+learn_word_to_cand_array(dic_info *skk_dic, struct skk_cand_array *ca, const char *word)
+{
+  int i, nth = -1;
+  for (i = 0; i < ca->nr_cands; i++) {
+    if (!strcmp(word, ca->cands[i])) {
+      nth = i;
+      break;
+    }
+  }
+  if (nth == -1)
+    push_back_candidate_to_array(ca, word);
+
+  reorder_candidate(skk_dic, ca, word);
+  ca->line->state = SKK_LINE_NEED_SAVE | SKK_LINE_USE_FOR_COMPLETION;
+}
+
+static char *
+quote_word(const char *word, const char *prefix)
+{
+  char *str;
+  const char *p;
+  int len;
+
+  if (prefix)
+    str = uim_strdup(prefix);
+  else
+    str = uim_strdup("");
+
+  for (p = word; *p; p++) {
+    len = strlen(str);
+
+    switch (*p) {
+    case '/':
+	    str = uim_realloc(str, len + strlen("\\057") + 1);
+	    strcat(str, "\\057");
+	    break;
+    case '[':
+	    str = uim_realloc(str, len + strlen("[") + 1);
+	    strcat(str, "[");
+	    break;
+    case ']':
+	    str = uim_realloc(str, len + strlen("]") + 1);
+	    strcat(str, "]");
+	    break;
+    case '\n':
+	    str = uim_realloc(str, len + strlen("\\n") + 1);
+	    strcat(str, "\\n");
+	    break;
+    case '\r':
+	    str = uim_realloc(str, len + strlen("\\r") + 1);
+	    strcat(str, "\\r");
+	    break;
+    case '\\':
+	    str = uim_realloc(str, len + strlen("\\\\") + 1);
+	    strcat(str, "\\\\");
+	    break;
+    case ';':
+	    str = uim_realloc(str, len + strlen("\\073") + 1);
+	    strcat(str, "\\073");
+	    break;
+    case '"':
+	    str = uim_realloc(str, len + strlen("\\\"") + 1);
+	    strcat(str, "\\\"");
+	    break;
+    default:
+	    str = uim_realloc(str, len + 2);
+	    str[len] = *p;
+	    str[len + 1] = '\0';
+	    break;
+    }
+  }
+  len = strlen(str);
+  if (prefix) {
+    str = uim_realloc(str, len + strlen("\")") + 1);
+    strcat(str, "\")");
+  }
+
+  return str;
+}
+
+static char *
+sanitize_word(const char *str, const char *prefix)
+{
+  const char *p;
+  int is_space_only = 1;
+
+  if (!str || !strlen(str)) {
+    return NULL;
+  }
+  for (p = str; *p; p++) {
+    switch (*p) {
+    case '/':
+    case '[':
+    case ']':
+    case '\n':
+    case '\r':
+    case '\\':
+    case ';':
+    case '"':
+      return quote_word(str, prefix);
+    case ' ':
+      break;
+    default:
+      is_space_only = 0;
+      break;
+    }
+  }
+  if (is_space_only)
+    return NULL;
+
+  return uim_strdup(str);
+}
+
+static uim_lisp
+skk_learn_word(uim_lisp skk_dic_, uim_lisp head_and_okuri_head_,
+	       uim_lisp okuri_, uim_lisp word_, uim_lisp numeric_conv_)
+{
+  struct skk_cand_array *ca;
+  char *word;
+  const char *tmp;
+  dic_info *skk_dic = NULL;
+  uim_lisp head_ = CAR(head_and_okuri_head_);
+  uim_lisp okuri_head_ = CDR(head_and_okuri_head_);
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  tmp = REFER_C_STR(word_);
+  word = sanitize_word(tmp, "(concat \"");
+  if (!word)
+    return uim_scm_f();
+
+  ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, okuri_, 1, numeric_conv_);
+  if (ca)
+    learn_word_to_cand_array(skk_dic, ca, word);
+
+  tmp = REFER_C_STR(okuri_);
+  if (strlen(tmp)) {
+    ca = find_cand_array_lisp(skk_dic, head_, okuri_head_, uim_scm_null(), 1, numeric_conv_);
+    if (ca)
+      learn_word_to_cand_array(skk_dic, ca, word);
+  }
+  free(word);
+  return uim_scm_f();
+}
+
+static void
+reverse_cache(dic_info *di)
+{
+  struct skk_line *sl, *prev, *next;
+
+  prev= NULL;
+  sl = di->head.next;
+  while (sl) {
+    next = sl->next;
+    sl->next = prev;
+    prev = sl;
+    sl = next;
+  }
+  di->head.next = prev;
+}
+
+static void
+parse_dic_line(dic_info *di, char *line, int is_personal)
+{
+  char *buf, *sep;
+  struct skk_line *sl;
+  int i;
+
+  buf = uim_strdup(line);
+  sep = strchr(buf, ' ');
+
+  if (!sep || (sep == buf)) {
+    free(buf);
+    return;
+  }
+
+  *sep = '\0';
+  if ((!skk_isascii(buf[0]) || buf[0] == '>') && skk_islower(sep[-1])) {
+    /* okuri-ari entry */
+    char okuri_head = sep[-1];
+    sep[-1] = '\0';
+    sl = compose_line(di, buf, okuri_head, line);
+  } else {
+    sl = compose_line(di, buf, 0, line);
+  }
+  if (is_personal) {
+    sl->state = SKK_LINE_NEED_SAVE | SKK_LINE_USE_FOR_COMPLETION;
+    /* set nr_real_cands for the candidate array from personal dictionaly */
+    for (i = 0; i < sl->nr_cand_array; i++)
+      sl->cands[i].nr_real_cands = sl->cands[i].nr_cands;
+  } else {
+    sl->state = SKK_LINE_USE_FOR_COMPLETION;
+  }
+  add_line_to_cache_head(di, sl);
+  free(buf);
+}
+
+static void
+write_out_array(FILE *fp, struct skk_cand_array *ca)
+{
+  int i;
+  if (ca->okuri) {
+    fprintf(fp, "[%s/", ca->okuri);
+    for (i = 0; i < ca->nr_real_cands; i++)
+      fprintf(fp, "%s/", ca->cands[i]);
+    fprintf(fp, "]/");
+  } else {
+    for (i = 0; i < ca->nr_real_cands; i++)
+      fprintf(fp, "%s/", ca->cands[i]);
+  }
+}
+
+static void
+write_out_line(FILE *fp, struct skk_line *sl)
+{
+  struct skk_cand_array *ca;
+  int i;
+
+  fprintf(fp, "%s", sl->head);
+  if (sl->okuri_head) {
+    fprintf(fp, "%c /", sl->okuri_head);
+  } else {
+    fprintf(fp, " /");
+  }
+  for (i = 0; i < sl->nr_cand_array; i++) {
+    ca = &sl->cands[i];
+    write_out_array(fp, ca);
+  }
+  fprintf(fp, "\n");
+}
+
+static int
+open_lock(const char *name, int type)
+{
+  int fd;
+  struct flock fl;
+  char lock_fn[MAXPATHLEN];
+
+  snprintf(lock_fn, sizeof(lock_fn), "%s.lock", name);
+
+  fd = open(lock_fn, O_CREAT | O_RDWR, S_IRUSR | S_IWUSR);
+  if (fd == -1)
+    return fd;
+
+  fl.l_type = type;
+  fl.l_whence = SEEK_SET;
+  fl.l_start = 0;
+  fl.l_len = 0;
+  if (fcntl(fd, F_SETLKW, &fl) == -1) {
+    close(fd);
+    fd = -1;
+  }
+
+  return fd;
+}
+
+static void
+close_lock(int fd)
+{
+  struct flock fl;
+
+  if (fd < 0)
+    return;
+
+  fl.l_type = F_UNLCK;
+  fl.l_whence = SEEK_SET;
+  fl.l_start = 0;
+  fl.l_len = 0;
+
+  fcntl(fd, F_SETLKW, &fl);
+  close(fd);
+}
+
+static int
+read_dictionary_file(dic_info *di, const char *fn, int is_personal)
+{
+  struct stat st;
+  FILE *fp;
+  char buf[4096]; /* XXX */
+  int err_flag = 0;
+  int lock_fd;
+
+  if (!di)
+    return 0;
+
+  lock_fd = open_lock(fn, F_RDLCK);
+
+  if (stat(fn, &st) == -1) {
+    close_lock(lock_fd);
+    return 0;
+  }
+
+  fp = fopen(fn, "r");
+  if (!fp) {
+    close_lock(lock_fd);
+    return 0;
+  }
+
+  di->personal_dic_timestamp = st.st_mtime;
+
+  while (fgets(buf, 4096, fp)) { /* XXX */
+    int len = strlen(buf);
+    if (buf[len - 1] == '\n') {
+      if (err_flag == 0) {
+	if (buf[0] != ';') {
+	  buf[len - 1] = '\0';
+	  parse_dic_line(di, buf, is_personal);
+	}
+      } else {
+	/* erroneous line ends here */
+	err_flag = 0;
+      }
+    } else {
+      err_flag = 1;
+    }
+  }
+  fclose(fp);
+  close_lock(lock_fd);
+  reverse_cache(di);
+  return 1;
+}
+
+static uim_lisp
+skk_read_personal_dictionary(uim_lisp skk_dic_, uim_lisp fn_)
+{
+  const char *fn;
+  struct stat st;
+  uim_lisp ret;
+  dic_info *skk_dic = NULL;
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  fn = REFER_C_STR(fn_);
+  ret = (stat(fn, &st) != -1) ? uim_scm_t() : uim_scm_f();
+
+  update_personal_dictionary_cache_with_file(skk_dic, fn, 1);
+#if USE_SKK_JISYO_S_BUF
+  update_personal_dictionary_cache_with_file(skk_dic, SKK_JISYO_S, 0);
+#endif
+
+  return ret;
+}
+
+static void push_back_candidate_array_to_sl(struct skk_line *sl,
+				      struct skk_cand_array *src_ca)
+{
+  int i;
+  struct skk_cand_array *ca;
+
+  sl->nr_cand_array++;
+  sl->cands = uim_realloc(sl->cands,
+		  sizeof(struct skk_cand_array) * sl->nr_cand_array);
+  ca = &sl->cands[sl->nr_cand_array - 1];
+  ca->is_used = src_ca->is_used;
+  ca->nr_cands = src_ca->nr_cands;
+  ca->cands = uim_malloc(sizeof(char *) * src_ca->nr_cands);
+  for (i = 0; i < ca->nr_cands; i++)
+    ca->cands[i] = uim_strdup(src_ca->cands[i]);
+
+  ca->nr_real_cands = src_ca->nr_real_cands;
+  ca->okuri = uim_strdup(src_ca->okuri);
+  ca->line = sl;
+}
+
+static void compare_and_merge_skk_line(dic_info *skk_dic,
+		                       struct skk_line *dst_sl,
+				       struct skk_line *src_sl)
+{
+  int i, j;
+  struct skk_cand_array *dst_ca, *src_ca;
+
+  if (dst_sl == NULL || src_sl == NULL)
+    return;
+
+  src_ca = &src_sl->cands[0];
+  dst_ca = &dst_sl->cands[0];
+  /*
+   * check all candidate array since purged words may exist.
+   */
+  /* if (src_ca->nr_real_cands >= dst_ca->nr_real_cands) */
+    merge_real_candidate_array(skk_dic, src_ca, dst_ca);
+
+  for (i = 1; i < src_sl->nr_cand_array; i++) {
+    int dup = 0;
+    src_ca = &src_sl->cands[i];
+
+    for (j = 1; j < dst_sl->nr_cand_array; j++) {
+      dst_ca = &dst_sl->cands[j];
+      if (!strcmp(src_ca->okuri, dst_ca->okuri)) {
+	dup = 1;
+      /* if (src_ca->nr_real_cands >= dst_ca->nr_real_cands) */
+	  merge_real_candidate_array(skk_dic, src_ca, dst_ca);
+      }
+    }
+    if (!dup)
+      push_back_candidate_array_to_sl(dst_sl, src_ca);
+  }
+
+  dst_sl->state |= src_sl->state;
+}
+
+/* for merge sort */
+static int
+compare_entry(struct skk_line *p, struct skk_line *q)
+{
+  int ret;
+  ret = strcmp(p->head, q->head);
+
+  if (ret != 0)
+    return ret;
+  else
+    return p->okuri_head - q->okuri_head;
+}
+
+/*
+ * Retern lines with differential "midashi-go" between two personal
+ * dictionaly caches.  Also merge candidate arrays for line with same
+ * "midashi-go".  p and q are needed to be sorted.
+ */
+static struct skk_line *
+cache_line_diffs(dic_info *skk_dic, struct skk_line *p, struct skk_line *q, int *len)
+{
+  struct skk_line *r, *s, head;
+  int cmp;
+
+  for (r = &head; p && q; ) {
+    cmp = compare_entry(p, q);
+    if (cmp < 0) {
+      p = p->next;
+    } else if (cmp > 0) {
+      s = copy_skk_line(q);
+      r->next = s;
+      r = s;
+      q = q->next;
+      (*len)++;
+    } else {
+      compare_and_merge_skk_line(skk_dic, p, q);
+      p = p->next;
+      q = q->next;
+    }
+  }
+  while (q) {
+    s = copy_skk_line(q);
+    r->next = s;
+    r = s;
+    q = q->next;
+    (*len)++;
+  }
+  r->next = NULL;
+  return head.next;
+}
+
+/* for merge sort */
+static struct skk_line *
+lmerge(struct skk_line *p, struct skk_line *q)
+{
+  struct skk_line *r, head;
+
+  for (r = &head; p && q; ) {
+    if (compare_entry(p, q) < 0) {
+      r->next = p;
+      r = p;
+      p = p->next;
+    } else {
+      r->next = q;
+      r = q;
+      q = q->next;
+    }
+  }
+  r->next = (p ? p : q);
+  return head.next;
+}
+
+/* merge sort */
+static struct skk_line *
+lsort(struct skk_line *p)
+{
+  struct skk_line *q, *r;
+
+  if (p) {
+    q = p;
+    for (r = q->next; r && (r = r->next) != NULL; r = r->next)
+      q = q->next;
+    r = q->next;
+    q->next = NULL;
+    if (r)
+      p = lmerge(lsort(r), lsort(p));
+  }
+  return p;
+}
+
+static void
+update_personal_dictionary_cache_with_file(dic_info *skk_dic, const char *fn,
+		                           int is_personal)
+{
+  dic_info *di;
+  struct skk_line *sl, *tmp, *diff, **cache_array;
+  int i, diff_len = 0;
+
+  di = (dic_info *)uim_malloc(sizeof(dic_info));
+  di->cache_len = 0;
+  di->head.next = NULL;
+
+  if (!read_dictionary_file(di, fn, is_personal)) {
+    free(di);
+    return;
+  }
+
+  /* If no cache is available, just use new one. */
+  if (!skk_dic->head.next) {
+    skk_dic->head.next = di->head.next;
+    skk_dic->cache_len = di->cache_len;
+    skk_dic->cache_modified = di->cache_modified;
+    skk_dic->personal_dic_timestamp = di->personal_dic_timestamp;
+    free(di);
+    return;
+  }
+
+  /* keep original sequence of cache */
+  cache_array = (struct skk_line **)uim_malloc(sizeof(struct skk_line *)
+		  * skk_dic->cache_len);
+
+  i = 0;
+  sl = skk_dic->head.next;
+  while (sl) {
+    cache_array[i] = sl;
+    sl = sl->next;
+    i++;
+  }
+
+  /* get differential lines and merge candidate */
+  di->head.next = lsort(di->head.next);
+  skk_dic->head.next = lsort(skk_dic->head.next);
+  diff = cache_line_diffs(skk_dic, skk_dic->head.next, di->head.next, &diff_len);
+
+  /* revert sequence of the cache */
+  if (skk_dic->cache_len) {
+    sl = skk_dic->head.next = cache_array[0];
+    for (i = 0; i < skk_dic->cache_len - 1; i++) {
+      sl->next = cache_array[i + 1];
+      sl = sl->next;
+    }
+    sl->next = NULL;
+  }
+
+  if (is_personal) {
+    /* prepend differential lines at the top of the cache */
+    if (diff != NULL) {
+      sl = diff;
+      while (sl->next) {
+	sl = sl->next;
+      }
+      sl->next = skk_dic->head.next;
+      skk_dic->head.next = diff;
+      skk_dic->cache_len += diff_len;
+    }
+  } else {
+    /* append differential lines at the bottom of the cache */
+    if (skk_dic->head.next)
+      sl->next = diff;
+    else
+      skk_dic->head.next = diff;
+    skk_dic->cache_len += diff_len;
+  }
+
+  skk_dic->cache_modified = 1;
+
+  sl = di->head.next;
+  while (sl) {
+    tmp = sl;
+    sl = sl->next;
+    free_skk_line(tmp);
+  }
+  free(di);
+  free(cache_array);
+}
+
+static uim_lisp
+skk_save_personal_dictionary(uim_lisp skk_dic_, uim_lisp fn_)
+{
+  FILE *fp;
+  const char *fn = REFER_C_STR(fn_);
+  char tmp_fn[MAXPATHLEN];
+  struct skk_line *sl;
+  struct stat st;
+  int lock_fd = -1;
+  mode_t umask_val;
+  dic_info *skk_dic = NULL;
+
+  if (PTRP(skk_dic_))
+    skk_dic = C_PTR(skk_dic_);
+
+  if (!skk_dic || skk_dic->cache_modified == 0)
+    return uim_scm_f();
+
+  if (fn) {
+    if (stat(fn, &st) != -1) {
+      if (st.st_mtime != skk_dic->personal_dic_timestamp)
+	update_personal_dictionary_cache_with_file(skk_dic, fn, 1);
+    }
+
+    lock_fd = open_lock(fn, F_WRLCK);
+
+    snprintf(tmp_fn, sizeof(tmp_fn), "%s.tmp", fn);
+    umask_val = umask(S_IRGRP | S_IROTH | S_IWGRP | S_IWOTH);
+    fp = fopen(tmp_fn, "w");
+    umask(umask_val);
+    if (!fp)
+      goto error;
+
+  } else {
+    fp = stdout;
+  }
+
+  for (sl = skk_dic->head.next; sl; sl = sl->next) {
+    if (sl->state & SKK_LINE_NEED_SAVE)
+      write_out_line(fp, sl);
+  }
+
+  if (fflush(fp) != 0)
+    goto error;
+
+  if (fsync(fileno(fp)) != 0)
+    goto error;
+
+  if (fclose(fp) != 0)
+    goto error;
+
+  if (rename(tmp_fn, fn) != 0)
+    goto error;
+
+  if (stat(fn, &st) != -1) {
+    skk_dic->personal_dic_timestamp = st.st_mtime;
+    skk_dic->cache_modified = 0;
+  }
+
+error:
+  close_lock(lock_fd);
+  return uim_scm_f();
+}
+
+static uim_lisp
+skk_get_annotation(uim_lisp str_)
+{
+  const char *str, *sep;
+  uim_lisp res;
+
+  if (str_ == uim_scm_null())
+    return uim_scm_null();
+
+  str = REFER_C_STR(str_);
+  sep = strrchr(str, ';');
+  if (sep && (*(++sep) != '\0')) {
+    res = MAKE_STR(sep);
+  } else {
+    res = MAKE_STR("");
+  }
+  return res;
+}
+
+static uim_lisp
+skk_remove_annotation(uim_lisp str_)
+{
+  char *str, *sep;
+
+  if (str_ == uim_scm_null())
+    return uim_scm_null();
+
+  str = C_STR(str_);
+  sep = strrchr(str, ';');
+  if (sep && (*(sep + 1) != '\0')) {
+    *sep = '\0';
+  }
+  return MAKE_STR_DIRECTLY(str);
+}
+
+static char *
+eval_candidate_with_concat(const char *cand)
+{
+  char *p, *q, *str;
+  char *expanded_str;
+  size_t len;
+
+  if ((p = strstr(cand, "(concat \"")) == NULL)
+    return NULL;
+
+  /* check close paren */
+  q = strrchr(p, ')');
+  if (!q || (strstr(p, "\")") == NULL))
+    return NULL;
+
+  /* ignore make-string */
+  if (strstr(p, "make-string"))
+    return NULL;
+
+  /* get quoted str  */
+  len = (q - p + 1) - strlen("(concat \"\")");
+  str = uim_malloc(len + 1);
+  strlcpy(str, p + strlen("(concat \""), len + 1);
+
+  expanded_str = expand_str(str);
+  if (!expanded_str) {
+    free(str);
+    return NULL;
+  }
+  
+  /* get evaluated candidate */
+  len = p - cand + strlen(expanded_str);
+  if (len > strlen(str))
+    str = uim_realloc(str, len + 1);
+
+  if (p != cand) {
+    strlcpy(str, cand, p - cand + 1);
+    strcat(str, expanded_str);
+  } else {
+    strcpy(str, expanded_str);
+  }
+
+  free(expanded_str);
+  return str;
+}
+
+static uim_lisp
+skk_eval_candidate(uim_lisp str_)
+{
+  const char *cand;
+  char *str;
+
+  if (str_ == uim_scm_null())
+    return uim_scm_null();
+
+  cand = REFER_C_STR(str_);
+
+  /* eval concat only for now */
+  str = eval_candidate_with_concat(cand);
+  if (!str)
+    return str_;
+
+  return MAKE_STR_DIRECTLY(str);
+}
+
+/* only for siod */
+static uim_lisp
+skk_substring(uim_lisp str_, uim_lisp start_, uim_lisp end_)
+{
+  const char *str;
+  char *s;
+  int start;
+  int end;
+  int len;
+  int i, j = 0;
+
+  str = REFER_C_STR(str_);
+  start = C_INT(start_);
+  end = C_INT(end_);
+
+  if (!str || start < 0 || start > end)
+    return MAKE_STR("");
+
+  len = strlen(str);
+
+  if (end > len)
+    return MAKE_STR("");
+
+  s = uim_malloc(end - start + 1);
+
+  for (i = start; i < end; i++) {
+    s[j] = str[i];
+    j++;
+  }
+  s[j] = '\0';
+  return MAKE_STR_DIRECTLY(s);
+}
+
+static uim_lisp
+skk_look_open(uim_lisp fn_)
+{
+  const char *fn = REFER_C_STR(fn_);
+
+  if (use_look == 1 && skk_look_ctx)
+    uim_look_finish(skk_look_ctx);
+
+  if ((skk_look_ctx = uim_look_init()) == NULL) {
+    use_look = 0;
+    uim_fatal_error("uim_look_init() failed");
+    return uim_scm_f();
+  }
+
+  if (!uim_look_open_dict(fn, skk_look_ctx)) {
+    uim_look_finish(skk_look_ctx);
+    skk_look_ctx = NULL;
+    use_look = 0;
+    return uim_scm_f();
+  }
+
+  use_look = 1;
+  return uim_scm_t();
+}
+
+static uim_lisp
+skk_look_close()
+{
+  if (use_look && skk_look_ctx) {
+    uim_look_finish(skk_look_ctx);
+    skk_look_ctx = NULL;
+    use_look = 0;
+  }
+
+  return uim_scm_f();
+}
+
+static uim_lisp
+look_get_top_word(const char *str)
+{
+  char buf[512], *dict_str;
+  int i = 0;
+  size_t len;
+  uim_lisp ret_ = uim_scm_f();
+
+  while (str[i] != '\0') {
+    if (!skk_isalpha(str[i]))
+      return ret_;
+    i++;
+  }
+
+  if (!use_look)
+    return ret_;
+
+  dict_str = uim_strdup(str);
+
+  uim_look_reset(skk_look_ctx);
+  if (uim_look(dict_str, skk_look_ctx) != 0) {
+    len = strlen(str);
+    uim_look_set(skk_look_ctx);
+    while (uim_look_get(dict_str, buf, sizeof(buf), skk_look_ctx) != 0) {
+      /* don't use the word itself */
+      if (strcasecmp(buf, dict_str) != 0) {
+	/* overwrite upper and lower case */
+	if (len < strlen(buf))
+	  memcpy(buf, str, len);
+	ret_ = MAKE_STR(buf);
+	break;
+      }
+    }
+  }
+  free(dict_str);
+  return ret_;
+}
+
+static void
+look_get_comp(struct skk_comp_array *ca, const char *str)
+{
+  char buf[512], *dict_str;
+  int i = 0, nr_pre;
+  int *matched;
+  size_t len;
+
+  while (str[i] != '\0') {
+    if (!skk_isalpha(str[i]))
+      return;
+    i++;
+  }
+
+  if (!use_look)
+    return ;
+
+  dict_str = uim_strdup(str);
+
+  uim_look_reset(skk_look_ctx);
+  if (uim_look(dict_str, skk_look_ctx) == 0)
+    return;
+
+  nr_pre = ca->nr_comps;
+  matched = uim_malloc(sizeof(int) * nr_pre);
+  for (i = 0; i < nr_pre; i++)
+    matched[i] = 0;
+
+  uim_look_set(skk_look_ctx);
+  len = strlen(str);
+  while (uim_look_get(dict_str, buf, sizeof(buf), skk_look_ctx) != 0) {
+    int match = 0;
+
+    /* don't use the word itself */
+    if (strcasecmp(buf, dict_str) == 0)
+      continue;
+
+    /* overwrite upper and lower case */
+    if (len < strlen(buf))
+      memcpy(buf, str, len);
+
+    /* skip words already in the cache */
+    for (i = 0; i < nr_pre; i++) {
+      if (matched[i])
+	continue;
+      if (!strcasecmp(ca->comps[i], buf)) {
+	matched[i] = 1;
+	match = 1;
+	break;
+      }
+    }
+    if (!match) {
+      ca->nr_comps++;
+      ca->comps = uim_realloc(ca->comps, sizeof(char *) * ca->nr_comps);
+      ca->comps[ca->nr_comps - 1] = uim_strdup(buf);
+    }
+  }
+
+  free(matched);
+  free(dict_str);
+}
+
+void
+uim_plugin_instance_init(void)
+{
+  uim_scm_init_proc5("skk-lib-dic-open", skk_dic_open);
+  uim_scm_init_proc1("skk-lib-free-dic", skk_free_dic);
+  uim_scm_init_proc2("skk-lib-read-personal-dictionary", skk_read_personal_dictionary);
+  uim_scm_init_proc2("skk-lib-save-personal-dictionary", skk_save_personal_dictionary);
+  uim_scm_init_proc5("skk-lib-get-entry", skk_get_entry);
+  uim_scm_init_proc1("skk-lib-store-replaced-numstr", skk_store_replaced_numeric_str);
+  uim_scm_init_proc2("skk-lib-merge-replaced-numstr", skk_merge_replaced_numeric_str);
+  uim_scm_init_proc1("skk-lib-replace-numeric", skk_replace_numeric);
+  uim_scm_init_proc5("skk-lib-get-nth-candidate", skk_get_nth_candidate);
+  uim_scm_init_proc5("skk-lib-get-nr-candidates", skk_get_nr_candidates);
+  uim_scm_init_proc5("skk-lib-commit-candidate", skk_commit_candidate);
+  uim_scm_init_proc5("skk-lib-purge-candidate", skk_purge_candidate);
+  uim_scm_init_proc5("skk-lib-learn-word", skk_learn_word);
+  uim_scm_init_proc1("skk-lib-get-annotation", skk_get_annotation);
+  uim_scm_init_proc1("skk-lib-remove-annotation", skk_remove_annotation);
+  uim_scm_init_proc4("skk-lib-get-completion", skk_get_completion);
+  uim_scm_init_proc5("skk-lib-get-nth-completion", skk_get_nth_completion);
+  uim_scm_init_proc4("skk-lib-get-nr-completions", skk_get_nr_completions);
+  uim_scm_init_proc2("skk-lib-clear-completions", skk_clear_completions);
+  uim_scm_init_proc4("skk-lib-get-dcomp-word", skk_get_dcomp_word);
+  uim_scm_init_proc1("skk-lib-eval-candidate", skk_eval_candidate);
+  uim_scm_init_proc3("skk-lib-substring", skk_substring);
+  uim_scm_init_proc1("skk-lib-look-open", skk_look_open);
+  uim_scm_init_proc0("skk-lib-look-close", skk_look_close);
+}
+
+void
+uim_plugin_instance_quit(void)
+{
+}
+
+/* skkserv related */
+static int
+open_skkserv(const char *hostname, int portnum, int family)
+{
+  int sock = -1;
+  struct addrinfo hints, *aitop, *ai;
+  char port[BUFSIZ];
+  int error;
+  int enable_completion;
+
+  (void)snprintf(port, sizeof(port), "%d", portnum);
+
+  memset(&hints, 0, sizeof(hints));
+  hints.ai_family = family;
+  hints.ai_flags = AI_PASSIVE;
+  hints.ai_socktype = SOCK_STREAM;
+
+  if ((error = getaddrinfo(hostname, port, &hints, &aitop))) {
+    uim_notify_fatal("uim-skk: %s", gai_strerror(error));
+    return 0;
+  }
+
+  for (ai = aitop; ai; ai = ai->ai_next) {
+    if (ai->ai_family != AF_INET && ai->ai_family != AF_INET6)
+      continue;
+
+    if ((sock = socket(ai->ai_family, ai->ai_socktype, ai->ai_protocol)) < 0)
+      continue;
+
+    if (connect(sock, ai->ai_addr, ai->ai_addrlen) == 0)
+      break;
+
+    close(sock);
+    sock = -1;
+  }
+
+  freeaddrinfo(aitop);
+
+  if (sock == -1) {
+    uim_notify_fatal(_("uim-skk: connect to %s port %s failed"), hostname, port);
+    return 0;
+  }
+
+#if 0
+  uim_notify_info("uim-skk: SKKSERVER=%s", hostname);
+#endif
+  skkservsock = sock;
+  rserv = fdopen(sock, "r");
+  wserv = fdopen(sock, "w");
+
+  enable_completion =
+    uim_scm_symbol_value_bool("skk-skkserv-enable-completion?") ?
+      SKK_SERV_TRY_COMPLETION : 0;
+  return SKK_SERV_CONNECTED | enable_completion;
+}
+
+static void
+close_skkserv()
+{
+  if (skkservsock >= 0) {
+    fprintf(wserv, "0\n");
+    fflush(wserv);
+    close(skkservsock);
+    skkservsock = -1;
+  }
+}
+
+static void
+reset_is_used_flag_of_cache(dic_info *di)
+{
+  struct skk_line *sl;
+  int i;
+
+  sl = di->head.next;
+  while (sl) {
+    for (i = 0; i < sl->nr_cand_array; i++) {
+      struct skk_cand_array *ca = &sl->cands[i];
+      ca->is_used = 0;
+    }
+    sl = sl->next;
+  }
+}
+
+static void
+skkserv_disconnected(dic_info *di)
+{
+  di->skkserv_state &= ~SKK_SERV_CONNECTED;
+  reset_is_used_flag_of_cache(di);
+}
